<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAp-yyjD_Du7mdmT5imq4wnH17tpyBZBzg",
      authDomain: "actas-ineco-lav4.firebaseapp.com",
      projectId: "actas-ineco-lav4",
      storageBucket: "actas-ineco-lav4.appspot.com",
      messagingSenderId: "1043968671762",
      appId: "1:1043968671762:web:08cebe9ca7adbcaab658cb"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- FUNCIÓN MODIFICADA CON AJUSTE +1 ---
    function getISOWeek(date) {
        date = new Date(date || new Date());
        date.setHours(0, 0, 0, 0);
        // Ajuste al jueves de la semana actual
        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
        // El 4 de enero siempre está en la primera semana ISO
        var week1 = new Date(date.getFullYear(), 0, 4);
        // Calcular la semana estándar
        var currentWeek = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        
        // *** AQUÍ ESTÁ EL CAMBIO ***
        // Sumamos 1 artificialmente para forzar que sea Semana 3
        return currentWeek + 1;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const CURRENT_WEEK = getISOWeek(); // Ahora devolverá 3
        const TOTAL_WEEKS = 53;
        let actasData = [];
        
        // Colección 2026
        const actasCollection = db.collection('actas-2026');
        
        const tableContainers = {
            '1-20': document.getElementById('table-1-20'),
            '21-40': document.getElementById('table-21-40'),
            '41-53': document.getElementById('table-41-53')
        };
        const currentWeekValueEl = document.getElementById('current-week-value');
        const currentActaValueEl = document.getElementById('current-acta-value');
        const trackingSection = document.querySelector('.tracking-section');

        function updateActaInDb(week, newValue) {
            actasCollection.doc(String(week)).update({ acta: newValue })
                .catch(error => console.error("Error al actualizar: ", error));
        }

        function renderUI() {
            Object.values(tableContainers).forEach(c => c.innerHTML = '');
            for (const key in tableContainers) {
                const header = document.createElement('div');
                header.className = 'table-header';
                header.innerHTML = `<span>Semana</span><span>Acta</span>`;
                tableContainers[key].appendChild(header);
                const body = document.createElement('div');
                body.className = 'table-body';
                tableContainers[key].appendChild(body);
            }

            actasData.sort((a, b) => a.week - b.week);

            actasData.forEach(item => {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.dataset.week = item.week;
                if (item.week === CURRENT_WEEK) row.classList.add('current-week-row');

                row.innerHTML = `
                    <span class="week-number">${item.week}</span>
                    <div class="acta-cell">
                        <span class="acta-value">${item.acta}</span>
                        <input type="text" class="acta-input" value="${item.acta}">
                    </div>
                    <div class="action-icons">
                        <svg class="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M17.25,7.47L16.53,6.75L13.75,9.53V10.25H14.47L17.25,7.47M20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.67,3C17.42,3 17.17,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"></path></svg>
                        <svg class="icon-save" viewBox="0 0 24 24"><path fill="currentColor" d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"></path></svg>
                        <svg class="icon-cancel" viewBox="0 0 24 24"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"></path></svg>
                    </div>
                `;
                
                const targetContainer = item.week <= 20 ? '1-20' : item.week <= 40 ? '21-40' : '41-53';
                tableContainers[targetContainer].querySelector('.table-body').appendChild(row);
            });
            updateDisplayPanel();
        }

        function updateDisplayPanel() {
            const currentWeekData = actasData.find(d => d.week === CURRENT_WEEK);
            currentWeekValueEl.textContent = CURRENT_WEEK;
            currentActaValueEl.textContent = currentWeekData && currentWeekData.acta && currentWeekData.acta !== '' && currentWeekData.acta !== '*' ? currentWeekData.acta : '--';
        }

        function handleEditEvents(event) {
            const icon = event.target.closest('svg');
            if (!icon) return;
            const row = icon.closest('.table-row');
            const week = parseInt(row.dataset.week);
            if (icon.classList.contains('icon-edit')) {
                const currentlyEditing = document.querySelector('.table-row.is-editing');
                if (currentlyEditing) currentlyEditing.classList.remove('is-editing');
                row.classList.add('is-editing');
                const input = row.querySelector('.acta-input');
                input.focus();
                input.select();
            }
            if (icon.classList.contains('icon-save')) {
                const newValue = row.querySelector('.acta-input').value;
                updateActaInDb(week, newValue);
                row.classList.remove('is-editing');
            }
            if (icon.classList.contains('icon-cancel')) {
                row.classList.remove('is-editing');
            }
        }

        function getInitialSeedData() {
             const fullData = Array.from({ length: TOTAL_WEEKS }, (_, i) => { 
                return { week: i + 1, acta: '' }; 
             });
             return fullData;
        }

        function seedDatabase() {
            const batch = db.batch();
            getInitialSeedData().forEach(item => {
                const docRef = actasCollection.doc(String(item.week));
                batch.set(docRef, item);
            });
            batch.commit().catch(error => console.error("Error al poblar la DB: ", error));
        }

        actasCollection.orderBy('week').onSnapshot(snapshot => {
            if (snapshot.empty) {
                seedDatabase();
                return;
            }
            actasData = snapshot.docs.map(doc => doc.data());
            renderUI();
        });

        trackingSection.addEventListener('click', handleEditEvents);
    });
    </script>
