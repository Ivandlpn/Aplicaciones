<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INECO - Trivial Ferroviario de Alta Velocidad</title>
    <!-- Importar fuente Poppins de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Importar Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --ineco-azul-principal: rgb(26, 68, 136);
            --ineco-rojo-acento: rgb(203, 24, 35);
            --ineco-azul-claro: rgb(52, 99, 172);
            --ineco-azul-aun-mas-claro: rgb(107, 150, 207);
            --ineco-blanco-puro: rgb(255, 255, 255);
            --ineco-gris-oscuro: rgb(50, 50, 50);
            --ineco-gris-claro: rgb(230, 230, 230);
            --ineco-verde-correcto: rgb(76, 175, 80);
            --ineco-rojo-incorrecto: rgb(244, 67, 54);
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-image: linear-gradient(135deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 50%, var(--ineco-azul-aun-mas-claro) 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .game-container { background-color: var(--ineco-blanco-puro); border-radius: 20px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); width: 90%; max-width: 900px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .screen { width: 100%; min-height: 600px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; position: absolute; top: 0; left: 0; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; overflow-y: auto; }
        .screen.active { opacity: 1; pointer-events: all; position: relative; }
        .ineco-logo { position: absolute; top: 30px; left: 30px; font-weight: 600; font-size: 36px; color: var(--ineco-azul-principal); z-index: 10; }
        .btn { background-color: var(--ineco-azul-principal); color: var(--ineco-blanco-puro); border: none; padding: 15px 30px; border-radius: 10px; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.2em; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); margin: 10px; }
        .btn:hover { background-color: var(--ineco-azul-claro); transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 1.8em; color: var(--ineco-gris-oscuro); cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; z-index: 20; }
        .close-btn:hover { color: var(--ineco-rojo-acento); transform: scale(1.1); }
        #splash-screen { background: linear-gradient(180deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 100%); color: var(--ineco-blanco-puro); }
        #splash-screen .ineco-logo { color: var(--ineco-blanco-puro); }
        #splash-screen h1 { font-size: 3.5em; font-weight: 700; margin-bottom: 30px; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); }
        #player-config-screen, #round-config-screen { padding: 60px; justify-content: flex-start; }
        #player-config-screen h2, #round-config-screen h2 { font-size: 2.2em; color: var(--ineco-azul-principal); margin-bottom: 30px; }
        .player-count-selector, .round-count-selector { display: flex; align-items: center; margin-bottom: 30px; background-color: var(--ineco-gris-claro); border-radius: 15px; padding: 10px 20px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .player-count-selector button, .round-count-selector button { background-color: var(--ineco-azul-claro); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; }
        .player-count-selector span, .round-count-selector span { font-size: 1.8em; font-weight: 600; color: var(--ineco-azul-principal); margin: 0 20px; }
        #player-inputs { width: 100%; max-width: 600px; margin-bottom: 30px; }
        .player-input-group { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        .avatar-selector { width: 50px; height: 50px; border-radius: 50%; background-color: var(--ineco-gris-claro); cursor: pointer; font-size: 2em; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; flex-shrink: 0; }
        .avatar-selector:hover { transform: scale(1.1); }
        .player-input-group label { display: none; }
        .player-input-group input[type="text"] { flex-grow: 1; padding: 12px 15px; border: 2px solid var(--ineco-gris-claro); border-radius: 8px; }
        .player-input-group .random-name-btn { background-color: var(--ineco-rojo-acento); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; flex-shrink: 0; }
        #game-screen { padding: 30px; justify-content: flex-start; padding-top: 100px; }
        #current-player-turn-display { font-size: 1.5em; font-weight: 600; color: var(--ineco-blanco-puro); background-color: var(--ineco-azul-principal); position: absolute; left: 50%; transform: translateX(-50%); top: 55px; white-space: nowrap; z-index: 15; padding: 10px 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 10px; opacity: 0; }
        #current-player-turn-display.animate-in { animation: bounce-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        #current-player-turn-display .avatar-display { font-size: 1.2em; }
        @keyframes bounce-in { 0% { opacity: 0; transform: translateX(-50%) scale(0.3) translateY(-50px); } 50% { opacity: 1; transform: translateX(-50%) scale(1.1) translateY(0); } 70% { transform: translateX(-50%) scale(0.9) translateY(0); } 100% { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); } }
        #show-score-btn { position: absolute; top: 20px; right: 70px; background: none; border: none; font-size: 2em; color: var(--ineco-azul-principal); cursor: pointer; z-index: 20; }
        #question-area { background-color: var(--ineco-gris-claro); border-radius: 15px; padding: 30px; margin-bottom: 20px; width: 100%; box-shadow: inset 0 3px 8px rgba(0,0,0,0.15); }
        .category-display { font-size: 1.2em; font-weight: 500; color: var(--ineco-azul-principal); display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .category-display i { color: var(--ineco-rojo-acento); margin-right: 10px; }
        #question-text { font-size: 1.6em; font-weight: 600; color: var(--ineco-azul-principal); margin-bottom: 25px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .option-btn { background-color: var(--ineco-azul-claro); color: white; border: none; padding: 15px 20px; border-radius: 10px; font-size: 1.1em; text-align: left; cursor: pointer; }
        .option-btn:hover { background-color: var(--ineco-azul-principal); }
        .option-btn.correct { background-color: var(--ineco-verde-correcto); animation: pulse-correct 0.5s ease-out; }
        .option-btn.incorrect { background-color: var(--ineco-rojo-incorrecto); animation: shake-incorrect 0.5s ease-out; }
        @keyframes pulse-correct { 50% { transform: scale(1.03); } }
        @keyframes shake-incorrect { 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        #feedback-message { background-color: var(--ineco-azul-aun-mas-claro); color: white; padding: 15px; border-radius: 10px; margin-top: 20px; opacity: 0; transition: opacity 0.5s; position:relative; }
        #feedback-message.show { opacity: 1; }
        #close-feedback-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 1.5em; color: white; cursor: pointer; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 450px; position: relative; }
        .modal-content h3 { color: var(--ineco-azul-principal); margin-bottom: 20px; }
        #modal-score-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .score-card-modal { display: flex; align-items: center; gap: 15px; background-color: var(--ineco-gris-claro); padding: 12px; border-radius: 10px; border-left: 5px solid var(--ineco-azul-claro); opacity: 0; transform: translateX(-30px); animation: slideInFromLeft 0.5s ease-out forwards; }
        @keyframes slideInFromLeft { to { opacity: 1; transform: translateX(0); } }
        .score-card-modal.is-leader { border-left-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .score-card-modal.is-current-player { box-shadow: 0 0 15px var(--ineco-azul-aun-mas-claro); border-left-color: var(--ineco-azul-principal); }
        .score-card-rank { font-size: 1.5em; font-weight: 700; color: var(--ineco-gris-oscuro); min-width: 40px; text-align: center; flex-shrink: 0; }
        .score-card-rank .fa-crown { color: var(--gold); }
        .score-card-details { flex-grow: 1; }
        .score-card-name { font-weight: 600; font-size: 1.1em; color: var(--ineco-gris-oscuro); }
        .score-progress-bar-bg { background-color: #d1d1d1; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        .score-progress-bar-fg { background: linear-gradient(90deg, var(--ineco-azul-claro), var(--ineco-azul-principal)); height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease-out; }
        .score-card-score { font-size: 1.6em; font-weight: 700; color: var(--ineco-azul-principal); flex-shrink: 0; }
        #end-screen { justify-content: space-around; }
        #end-screen h2 { font-size: 2.5em; font-weight: 800; color: var(--ineco-azul-principal); animation: fadeInDown 0.8s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .winner-card { width: 100%; max-width: 500px; background: linear-gradient(45deg, var(--ineco-azul-principal), var(--ineco-azul-claro)); color: var(--ineco-blanco-puro); border-radius: 20px; padding: 25px; margin: 20px 0; border: 4px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px var(--gold); text-align: center; opacity: 0; transform: scale(0.8); }
        .winner-card.animate { animation: winner-card-appear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; animation-delay: 0.5s; }
        @keyframes winner-card-appear { to { opacity: 1; transform: scale(1); } }
        .winner-card h3 { font-size: 2em; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
        .winner-card .trophy-icon { font-size: 4em; color: var(--gold); margin: 15px 0; text-shadow: 0 0 15px white; }
        .winner-card .winner-name { font-size: 2.2em; font-weight: 800; margin-bottom: 5px; }
        .winner-card .winner-score { font-size: 1.5em; font-weight: 500; }
        .winner-card .winner-names-tie { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .winner-card .winner-names-tie .winner-name { font-size: 1.8em; }
        .podium-container { display: flex; align-items: flex-end; justify-content: center; gap: 10px; width: 100%; height: 200px; margin-top: 10px; margin-bottom: 20px; }
        .podium-place { width: 30%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; text-align: center; border-top-left-radius: 10px; border-top-right-radius: 10px; color: white; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(50px); animation: podium-rise 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .podium-place.gold { background-color: var(--gold); height: 100%; animation-delay: 1.2s; }
        .podium-place.silver { background-color: var(--silver); height: 80%; animation-delay: 1.4s; }
        .podium-place.bronze { background-color: var(--bronze); height: 60%; animation-delay: 1.6s; }
        @keyframes podium-rise { to { opacity: 1; transform: translateY(0); } }
        .podium-place .podium-name { font-size: 1.2em; font-weight: 700; word-break: break-word; }
        .podium-place .podium-score { font-size: 1em; font-weight: 500; }
        .podium-place .podium-rank { font-size: 2.5em; font-weight: 800; margin-bottom: 5px; }
        .podium-place .podium-rank i { text-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        .other-scores-list { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
        .player-card { display: flex; justify-content: space-between; align-items: center; background-color: var(--ineco-gris-claro); padding: 15px 20px; border-radius: 10px; opacity: 0; transform: scale(0.9); animation: card-appear 0.5s ease-out forwards; }
        @keyframes card-appear { to { opacity: 1; transform: scale(1); } }
        .player-card .rank { font-size: 1.2em; font-weight: 600; color: var(--ineco-gris-oscuro); }
        .player-card .name { font-size: 1.2em; font-weight: 500; }
        .player-card .score { font-size: 1.2em; font-weight: 700; color: var(--ineco-azul-principal); }
        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; border-radius: 2px; opacity: 0; animation: confetti-fall 4s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh); opacity: 0; } }
        #avatar-modal .modal-content { max-width: 700px; }
        .avatar-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .avatar-option { width: 80px; height: 80px; border-radius: 50%; background-color: var(--ineco-gris-claro); font-size: 3em; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
        .avatar-option:hover { background-color: var(--ineco-azul-claro); color: white; transform: scale(1.1); }
        @media (max-width: 768px) { .score-card-rank { font-size: 1.2em; min-width: 30px; } .score-card-name { font-size: 1em; } .score-card-score { font-size: 1.3em; } }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Contenido HTML de las pantallas -->
        <div class="ineco-logo">ineco</div>
        <div id="splash-screen" class="screen active">
            <h1>Trivial Ferroviario de Alta Velocidad</h1><button id="start-game-btn" class="btn">Iniciar Juego</button>
        </div>
        <div id="player-config-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <h2>Configuración de Partida</h2>
            <div class="player-count-selector"><button id="decrease-players-btn">-</button><span id="player-count">1</span><button id="increase-players-btn">+</button></div>
            <div id="player-inputs"></div>
            <button id="start-match-btn" class="btn">Empezar Partida</button>
        </div>
        <div id="round-config-screen" class="screen">
            <button class="close-btn" data-target-screen="player-config-screen">×</button>
            <h2>¿Cuántas preguntas por jugador?</h2>
            <div class="round-count-selector"><button id="decrease-rounds-btn">-</button><span id="round-count">5</span><button id="increase-rounds-btn">+</button></div>
            <button id="start-game-from-rounds-btn" class="btn">¡A Jugar!</button>
        </div>
        <div id="game-screen" class="screen">
            <button class="close-btn" data-target-screen="confirm-exit">×</button><button id="show-score-btn" class="fas fa-medal"></button><span id="current-player-turn-display"></span>
            <div id="question-area">
                <div class="category-display"><i id="category-icon" class="fas fa-question-circle"></i><span id="category-name">Categoría</span></div>
                <p id="question-text">Cargando pregunta...</p>
                <div id="options-grid" class="options-grid">
                    <button class="option-btn" data-option="A">A) Opción 1</button><button class="option-btn" data-option="B">B) Opción 2</button><button class="option-btn" data-option="C">C) Opción 3</button><button class="option-btn" data-option="D">D) Opción 4</button>
                </div>
            </div>
            <div id="feedback-message">
                <p id="feedback-text"></p><button id="close-feedback-btn" class="close-feedback-btn">×</button>
            </div>
        </div>
        <div id="end-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <div id="confetti-container"></div>
            <h2>¡Partida Terminada!</h2>
            <div id="winner-announcement-card"></div>
            <div id="podium-container" class="podium-container"></div>
            <div id="other-scores-container" class="other-scores-list"></div>
            <button id="play-again-btn" class="btn">Volver a Jugar</button>
        </div>
        <div id="score-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" data-target-screen="hide-modal">×</button>
                <h3>Clasificación Actual</h3>
                <ul id="modal-score-list"></ul>
            </div>
        </div>
        <div id="confirm-exit-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>¿Estás seguro que quieres salir?</h3><p>Se perderá el progreso actual de la partida.</p><button id="confirm-exit-yes" class="btn">Sí, salir</button><button id="confirm-exit-no" class="btn">No, continuar</button>
            </div>
        </div>
        <div id="avatar-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" id="close-avatar-modal">×</button>
                <h3>Elige tu Avatar</h3>
                <div id="avatar-gallery" class="avatar-gallery"></div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES Y REFERENCIAS ---
        let gameData = {}, players = [], currentPlayerIndex = 0, currentQuestionIndex = 0, questionsPerGame = 0, questionsPerPlayer = 5, shuffledQuestions = [], feedbackTimer = null;
        const availableAvatars = ['🚂', '🚄', '🛤️', '🚦', '🧑‍🔧', '🗺️', '🎫', '🌉', '🔩', '⏱️'];
        const randomRailwayNames = ["Traviesín", "Tunelillo", "Rielín", "Vibración Veloz", "Balasto Boss", "Catenaria Kid", "Señalino", "Durmiente Dinámico", "Fibra Óptica Fan", "Amolador As", "Bateadora Berta", "Inspector Hilario", "Durmiente Ágil", "Biela Veloz", "Trenelito", "Vía Láctea", "Pantógrafo Power", "Señor Señal", "Cat-enaria", "Ingeniero Rieles", "Desvío Divertido", "Terraplén Teo", "Túnelín el Astuto", "Puente Patán", "Balasto Brillante", "Soldador Sergio", "Frenada Fantástica", "Inspector Javier"];
        let usedRandomNames = new Set(), playerIndexToEdit = 0;
        const splashScreen = document.getElementById('splash-screen'), playerConfigScreen = document.getElementById('player-config-screen'), roundConfigScreen = document.getElementById('round-config-screen'), gameScreen = document.getElementById('game-screen'), endScreen = document.getElementById('end-screen'), startGameBtn = document.getElementById('start-game-btn'), decreasePlayersBtn = document.getElementById('decrease-players-btn'), increasePlayersBtn = document.getElementById('increase-players-btn'), playerCountSpan = document.getElementById('player-count'), playerInputsDiv = document.getElementById('player-inputs'), startMatchBtn = document.getElementById('start-match-btn'), decreaseRoundsBtn = document.getElementById('decrease-rounds-btn'), increaseRoundsBtn = document.getElementById('increase-rounds-btn'), roundCountSpan = document.getElementById('round-count'), startGameFromRoundsBtn = document.getElementById('start-game-from-rounds-btn'), currentPlayerTurnDisplay = document.getElementById('current-player-turn-display'), questionTextP = document.getElementById('question-text'), optionsGridDiv = document.getElementById('options-grid'), optionButtons = optionsGridDiv.querySelectorAll('.option-btn'), feedbackMessageDiv = document.getElementById('feedback-message'), feedbackTextP = document.getElementById('feedback-text'), closeFeedbackBtn = document.getElementById('close-feedback-btn'), winnerCardContainer = document.getElementById('winner-announcement-card'), playAgainBtn = document.getElementById('play-again-btn'), scoreModal = document.getElementById('score-modal'), modalScoreList = document.getElementById('modal-score-list'), showScoreBtn = document.getElementById('show-score-btn'), confirmExitModal = document.getElementById('confirm-exit-modal'), confirmExitYesBtn = document.getElementById('confirm-exit-yes'), confirmExitNoBtn = document.getElementById('confirm-exit-no'), avatarModal = document.getElementById('avatar-modal'), avatarGallery = document.getElementById('avatar-gallery'), closeAvatarModalBtn = document.getElementById('close-avatar-modal');
        let categoryIcon, categoryNameSpan;

        // --- FUNCIONES ---
        function showScreen(screenToShow) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); screenToShow.classList.add('active'); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function getRandomAvatar() { return availableAvatars[Math.floor(Math.random() * availableAvatars.length)]; }
        function getRandomRailwayName() { if (usedRandomNames.size === randomRailwayNames.length) usedRandomNames.clear(); let name; do { name = randomRailwayNames[Math.floor(Math.random() * randomRailwayNames.length)]; } while (usedRandomNames.has(name)); usedRandomNames.add(name); return name; }
        function updatePlayerInputs() { const playerCount = parseInt(playerCountSpan.textContent); playerInputsDiv.innerHTML = ''; for (let i = 0; i < playerCount; i++) { const group = document.createElement('div'); group.className = 'player-input-group'; group.innerHTML = `<div class="avatar-selector" data-player-index="${i}">${getRandomAvatar()}</div><input type="text" id="player-name-${i + 1}" value="Jugador ${i + 1}"><button type="button" class="random-name-btn" data-player-index="${i}">Aleatorio</button>`; playerInputsDiv.appendChild(group); } playerInputsDiv.querySelectorAll('.random-name-btn').forEach(btn => btn.onclick = () => { const index = btn.dataset.playerIndex; document.getElementById(`player-name-${parseInt(index) + 1}`).value = getRandomRailwayName(); document.querySelector(`.avatar-selector[data-player-index="${index}"]`).innerHTML = getRandomAvatar(); }); playerInputsDiv.querySelectorAll('.avatar-selector').forEach(selector => selector.onclick = () => { playerIndexToEdit = parseInt(selector.dataset.playerIndex); avatarModal.classList.add('active'); }); }
        function displayQuestion() { categoryIcon = document.getElementById('category-icon'); categoryNameSpan = document.getElementById('category-name'); feedbackMessageDiv.classList.remove('show'); if (feedbackTimer) clearTimeout(feedbackTimer); optionButtons.forEach(button => { button.disabled = true; button.classList.remove('correct', 'incorrect'); }); setTimeout(() => { if (currentQuestionIndex >= questionsPerGame) { endGame(); return; } const question = shuffledQuestions[currentQuestionIndex]; categoryNameSpan.textContent = question.category; switch (question.category) { case "Elementos Estructurales de la Vía": categoryIcon.className = 'fas fa-road'; break; case "Maquinaria y Herramientas": categoryIcon.className = 'fas fa-cogs'; break; case "Sistemas y Tecnologías": categoryIcon.className = 'fas fa-lightbulb'; break; default: categoryIcon.className = 'fas fa-question-circle'; } currentPlayerTurnDisplay.classList.remove('animate-in'); currentPlayerTurnDisplay.innerHTML = `<span class="avatar-display">${players[currentPlayerIndex].avatar}</span> <span>Turno de: ${players[currentPlayerIndex].name}</span>`; void currentPlayerTurnDisplay.offsetWidth; currentPlayerTurnDisplay.classList.add('animate-in'); questionTextP.textContent = question.pregunta; optionButtons.forEach((button, index) => { button.textContent = question.opciones[index]; button.disabled = false; }); }, 500); }
        function checkAnswer(selectedOption) { const q = shuffledQuestions[currentQuestionIndex]; const correct = q.respuestaCorrecta; const btn = optionsGridDiv.querySelector(`[data-option="${selectedOption}"]`); optionButtons.forEach(b => b.disabled = true); if (selectedOption.charAt(0) === correct) { players[currentPlayerIndex].score++; btn.classList.add('correct'); } else { btn.classList.add('incorrect'); optionsGridDiv.querySelector(`[data-option="${correct}"]`).classList.add('correct'); } feedbackTextP.textContent = q.explicacion; feedbackMessageDiv.classList.add('show'); feedbackTimer = setTimeout(nextTurn, 5000); }
        function nextTurn() { if (feedbackTimer) clearTimeout(feedbackTimer); feedbackMessageDiv.classList.remove('show'); currentQuestionIndex++; if (currentQuestionIndex >= questionsPerGame) { endGame(); return; } currentPlayerIndex = (currentPlayerIndex + 1) % players.length; displayQuestion(); }
        function startGame() { players = []; for (let i = 0; i < parseInt(playerCountSpan.textContent); i++) { const name = document.getElementById(`player-name-${i + 1}`).value.trim(); const avatar = document.querySelector(`.avatar-selector[data-player-index="${i}"]`).innerHTML; players.push({ name: name || `Jugador ${i+1}`, avatar, score: 0 }); } currentPlayerIndex = 0; currentQuestionIndex = 0; usedRandomNames.clear(); const allQuestions = []; for (const category in gameData.preguntas) { gameData.preguntas[category].forEach(q => allQuestions.push({ ...q, category })); } shuffledQuestions = shuffleArray(allQuestions).slice(0, questionsPerGame); showScreen(gameScreen); displayQuestion(); }
        function endGame() { showScreen(endScreen); players.sort((a, b) => b.score - a.score); const podiumContainer = document.getElementById('podium-container'); const otherScoresContainer = document.getElementById('other-scores-container'); podiumContainer.innerHTML = ''; otherScoresContainer.innerHTML = ''; winnerCardContainer.innerHTML = ''; if (players.length > 0) { const isTie = players.length > 1 && players[0].score === players[1].score; if (isTie) { const tiedWinners = players.filter(p => p.score === players[0].score); const winnerNamesHTML = tiedWinners.map(p => `<div class="winner-name">${p.avatar} ${p.name}</div>`).join(''); winnerCardContainer.innerHTML = `<div class="winner-card"><h3>¡EMPATE!</h3><div class="trophy-icon"><i class="fas fa-handshake"></i></div><div class="winner-names-tie">${winnerNamesHTML}</div><div class="winner-score">Con ${players[0].score} puntos</div></div>`; } else { const winner = players[0]; winnerCardContainer.innerHTML = `<div class="winner-card"><h3>¡GANADOR!</h3><div class="trophy-icon"><i class="fas fa-trophy"></i></div><div class="winner-name">${winner.avatar} ${winner.name}</div><div class="winner-score">Con ${winner.score} puntos</div></div>`; } document.querySelector('.winner-card').classList.add('animate'); } const podiumPlayers = players.slice(0, 3); const otherPlayers = players.slice(3); const podiumElements = []; podiumPlayers.forEach((player, index) => { const place = document.createElement('div'); let rankClass = '', rankIcon = '<i class="fas fa-medal"></i>'; if (index === 0) rankClass = 'gold'; else if (index === 1) rankClass = 'silver'; else if (index === 2) rankClass = 'bronze'; place.className = `podium-place ${rankClass}`; place.innerHTML = `<div class="podium-rank">${rankIcon}</div><div class="podium-name">${player.avatar} ${player.name}</div><div class="podium-score">${player.score} pts</div>`; podiumElements.push(place); }); if (podiumElements[1]) podiumContainer.appendChild(podiumElements[1]); if (podiumElements[0]) podiumContainer.appendChild(podiumElements[0]); if (podiumElements[2]) podiumContainer.appendChild(podiumElements[2]); otherPlayers.forEach((player, index) => { const card = document.createElement('div'); card.className = 'player-card'; card.style.animationDelay = `${1.8 + index * 0.2}s`; card.innerHTML = `<span class="rank">#${index + 4}</span><span class="name">${player.avatar} ${player.name}</span><span class="score">${player.score} puntos</span>`; otherScoresContainer.appendChild(card); }); generateConfetti(); }
        function generateConfetti() { const confettiContainer = document.getElementById('confetti-container'); /* ... código de confeti ... */ }
        function showScoreModal() { modalScoreList.innerHTML = ''; const sortedPlayers = [...players].sort((a, b) => b.score - a.score); const leaderScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0; sortedPlayers.forEach((player, index) => { const listItem = document.createElement('li'); listItem.className = 'score-card-modal'; listItem.style.animationDelay = `${index * 0.1}s`; let rankDisplay = `#${index + 1}`; if (index === 0 && leaderScore > 0) { listItem.classList.add('is-leader'); rankDisplay = '<i class="fas fa-crown"></i>'; } if (players[currentPlayerIndex] && players[currentPlayerIndex].name === player.name) { listItem.classList.add('is-current-player'); } const progress = leaderScore > 0 ? (player.score / leaderScore) * 100 : 0; listItem.innerHTML = `<div class="score-card-rank">${player.avatar}</div><div class="score-card-details"><span class="score-card-name">${player.name}</span><div class="score-progress-bar-bg"><div class="score-progress-bar-fg" style="width: ${progress}%;"></div></div></div><div class="score-card-score">${player.score}</div>`; modalScoreList.appendChild(listItem); }); scoreModal.classList.add('active'); }
        function hideScoreModal() { scoreModal.classList.remove('active'); }
        function showConfirmExitModal() { confirmExitModal.classList.add('active'); }
        function hideConfirmExitModal() { confirmExitModal.classList.remove('active'); }
        function displayUIMessage(message, type) { /* ... (código sin cambios) ... */ }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            fetch('preguntas.json').then(r => r.ok ? r.json() : Promise.reject('Error')).then(d => { gameData = d; initializeEventListeners(); }).catch(e => { console.error(e); splashScreen.innerHTML = `<h1>Error de Carga</h1><p>No se pudo cargar 'preguntas.json'.</p>`; });
            function initializeEventListeners() {
                const maxQuestionsAvailable = Object.values(gameData.preguntas).flat().length;
                startGameBtn.addEventListener('click', () => { showScreen(playerConfigScreen); updatePlayerInputs(); });
                decreasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) > 1) { playerCountSpan.textContent--; updatePlayerInputs(); } });
                increasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) < 5) { playerCountSpan.textContent++; updatePlayerInputs(); } });
                startMatchBtn.addEventListener('click', () => { showScreen(roundConfigScreen); });
                decreaseRoundsBtn.addEventListener('click', () => { let count = parseInt(roundCountSpan.textContent); if (count > 1) roundCountSpan.textContent = --count; });
                increaseRoundsBtn.addEventListener('click', () => { let count = parseInt(roundCountSpan.textContent); const max = Math.floor(maxQuestionsAvailable / players.length); if (count < max) roundCountSpan.textContent = ++count; });
                startGameFromRoundsBtn.addEventListener('click', () => { questionsPerPlayer = parseInt(roundCountSpan.textContent); questionsPerGame = questionsPerPlayer * players.length; startGame(); });
                optionButtons.forEach(b => b.addEventListener('click', e => checkAnswer(e.target.dataset.option)));
                showScoreBtn.addEventListener('click', showScoreModal);
                playAgainBtn.addEventListener('click', () => { winnerCardContainer.innerHTML = ''; showScreen(splashScreen); });
                document.querySelectorAll('.close-btn').forEach(b => b.addEventListener('click', e => { const target = e.target.dataset.targetScreen; if (target === 'confirm-exit') showConfirmExitModal(); else if (target === 'hide-modal') hideScoreModal(); else showScreen(document.getElementById(target)); }));
                confirmExitYesBtn.addEventListener('click', () => { hideConfirmExitModal(); showScreen(splashScreen); });
                confirmExitNoBtn.addEventListener('click', hideConfirmExitModal);
                closeFeedbackBtn.addEventListener('click', nextTurn);
                availableAvatars.forEach(avatar => { const option = document.createElement('div'); option.className = 'avatar-option'; option.innerHTML = avatar; option.onclick = () => { document.querySelector(`.avatar-selector[data-player-index="${playerIndexToEdit}"]`).innerHTML = avatar; avatarModal.classList.remove('active'); }; avatarGallery.appendChild(option); });
                closeAvatarModalBtn.addEventListener('click', () => avatarModal.classList.remove('active'));
            }
        });
    </script>
</body>
</html>
