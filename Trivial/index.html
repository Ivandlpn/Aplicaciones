<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivial Ferroviario de Alta Velocidad</title>
    <!-- Importar fuente Poppins de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Importar Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --azul-principal: rgb(26, 68, 136);
            --rojo-acento: rgb(203, 24, 35);
            --azul-claro: rgb(52, 99, 172);
            --azul-aun-mas-claro: rgb(107, 150, 207);
            --blanco-puro: rgb(255, 255, 255);
            --gris-oscuro: rgb(50, 50, 50);
            --gris-claro: rgb(230, 230, 230);
            --verde-correcto: rgb(76, 175, 80);
            --rojo-incorrecto: rgb(244, 67, 54);
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html {
            font-size: 16px;
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-image: linear-gradient(135deg, var(--azul-principal) 0%, var(--azul-claro) 50%, var(--azul-aun-mas-claro) 100%); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 1rem 0;
            overflow: hidden;
        }
        .game-container { 
            background-color: var(--blanco-puro); 
            border-radius: 20px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); 
            width: 90%; 
            max-width: 900px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            min-height: 600px;
        }
        .screen { 
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 40px; 
            text-align: center; 
            position: absolute; 
            top: 0; 
            left: 0; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.5s ease-in-out, transform 0.5s ease; 
            overflow-y: auto; 
        }
        .screen.active { opacity: 1; pointer-events: all; position: relative; transform: scale(1); }
        .screen:not(.active) { transform: scale(0.95); }
        
        .btn { 
            background-color: var(--azul-principal); 
            color: var(--blanco-puro); 
            border: none; 
            padding: 15px 30px; 
            border-radius: 10px; 
            font-family: 'Poppins', sans-serif; 
            font-weight: 600; 
            font-size: 1.2rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
            margin: 10px; 
        }
        .btn:hover { background-color: var(--azul-claro); transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .close-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: none; 
            border: none; 
            font-size: 1.8rem; 
            color: var(--gris-oscuro); 
            cursor: pointer; 
            transition: color 0.3s ease, transform 0.2s ease; 
            z-index: 20; 
        }
        .close-btn:hover { color: var(--rojo-acento); transform: scale(1.1); }
        #splash-screen { 
            background: linear-gradient(180deg, var(--azul-principal) 0%, var(--azul-claro) 100%); 
            color: var(--blanco-puro); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #splash-screen h1 { 
            font-size: 3.5rem; 
            font-weight: 700; 
            margin-bottom: 30px; 
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); 
        }
        /* Nueva animación de logo para la pantalla de inicio */
        .splash-logo {
            font-size: 6rem;
            color: var(--blanco-puro);
            margin-bottom: 20px;
            animation: train-pulse 2s infinite ease-in-out;
        }
        @keyframes train-pulse {
            0% { transform: scale(1); text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
            50% { transform: scale(1.05); text-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
            100% { transform: scale(1); text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        }
        #player-config-screen, #round-config-screen { padding: 60px 40px; justify-content: flex-start; }
        #player-config-screen h2, #round-config-screen h2 { 
            font-size: 2.2rem; 
            color: var(--azul-principal); 
            margin-bottom: 30px; 
        }
        .player-count-selector, .round-count-selector { 
            display: flex; 
            align-items: center; 
            margin-bottom: 30px; 
            background-color: var(--gris-claro); 
            border-radius: 15px; 
            padding: 10px 20px; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); 
        }
        .player-count-selector button, .round-count-selector button { 
            background-color: var(--azul-claro); 
            color: white; 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            cursor: pointer; 
        }
        .player-count-selector span, .round-count-selector span { 
            font-size: 1.8rem; 
            font-weight: 600; 
            color: var(--azul-principal); 
            margin: 0 20px; 
        }
        #player-inputs { width: 100%; max-width: 600px; margin-bottom: 30px; }
        .player-input-group { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        .player-input-group label { 
            font-weight: 500; 
            margin-right: 5px; 
            min-width: 80px; 
            text-align: right; 
        }
        .player-input-group input[type="text"] { 
            flex-grow: 1; 
            padding: 12px 15px; 
            border: 2px solid var(--gris-claro); 
            border-radius: 8px; 
            font-size: 1rem;
        }
        .player-input-group .random-name-btn { 
            background-color: var(--rojo-acento); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-left: 0; 
        }
        .player-input-group .player-color-input {
            width: 40px;
            height: 40px;
            border: none;
            padding: 0;
            border-radius: 8px;
            cursor: pointer;
            -webkit-appearance: none; 
            -moz-appearance: none;    
            appearance: none;
            background-color: transparent; 
        }
        .player-input-group .player-color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .player-input-group .player-color-input::-webkit-color-swatch { border: none; border-radius: 6px; }
        .player-input-group .player-color-input::-moz-color-swatch { border: none; border-radius: 6px; }

        /* Mejora visual: Header fijo para la pantalla de juego */
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--blanco-puro);
            border-bottom: 2px solid var(--gris-claro);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .game-header .header-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .game-header .header-group .btn-icon {
            background: none; 
            border: none; 
            font-size: 1.8rem; 
            color: var(--azul-principal); 
            cursor: pointer; 
            transition: transform 0.2s ease, color 0.3s ease;
        }
        .game-header .header-group .btn-icon:hover { transform: scale(1.1); color: var(--rojo-acento); }

        #game-screen { padding: 30px; padding-top: 100px; }
        
        /* Ajustes para el display del turno en el nuevo header */
        #current-player-turn-display {
            font-size: 1.2rem; 
            font-weight: 600; 
            color: var(--blanco-puro); 
            background-color: var(--azul-principal); 
            padding: 8px 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            opacity: 0; 
            width: auto;
            max-width: 60%;
            transition: all 0.3s ease-in-out;
        }
        #current-player-turn-display.animate-in { 
            animation: bounce-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }
        @keyframes bounce-in { 
            0% { opacity: 0; transform: scale(0.3); } 
            50% { opacity: 1; transform: scale(1.1); } 
            70% { transform: scale(0.9); } 
            100% { opacity: 1; transform: scale(1); } 
        }
        
        /* Botones de joker mejorados */
        .joker-btn {
            background-color: var(--rojo-acento);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .joker-btn:hover:not(:disabled) {
            background-color: rgb(230, 30, 45);
            transform: translateY(-2px);
        }
        .joker-btn:disabled {
            background-color: var(--gris-oscuro);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }
        
        #question-area { 
            background-color: var(--gris-claro); 
            border-radius: 15px; 
            padding: 30px; 
            margin-bottom: 20px; 
            width: 100%; 
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.15); 
        }
        .category-display { 
            font-size: 1.2rem; 
            font-weight: 500; 
            color: var(--azul-principal); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 15px; 
        }
        .category-display i { color: var(--rojo-acento); margin-right: 10px; font-size: 2rem; }
        .category-display i.animate-category { animation: category-pulse 0.8s ease-out; }
        @keyframes category-pulse { 0% { transform: scale(1); color: var(--rojo-acento); } 50% { transform: scale(1.2); color: var(--azul-principal); } 100% { transform: scale(1); color: var(--rojo-acento); } }
        #question-text { 
            font-size: 1.6rem; 
            font-weight: 600; 
            color: var(--azul-principal); 
            margin-bottom: 25px; 
            min-height: 80px;
        }
        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            width: 100%; 
        }
        .option-btn { 
            background-color: var(--azul-claro); 
            color: white; 
            border: none; 
            padding: 15px 20px; 
            border-radius: 10px; 
            font-size: 1.1rem; 
            text-align: left; 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        .option-btn:hover { background-color: var(--azul-principal); }
        .option-btn.correct { background-color: var(--verde-correcto); animation: pulse-correct 0.6s ease-out forwards; }
        @keyframes pulse-correct { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(76, 175, 80, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(76, 175, 80, 0.9); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(76, 175, 80, 0); } }
        .option-btn.incorrect { background-color: var(--rojo-incorrecto); animation: shake-incorrect 0.6s ease-out; }
        @keyframes shake-incorrect { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        #feedback-message { 
            background-color: var(--azul-aun-mas-claro); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 20px; 
            opacity: 0; 
            transition: opacity 0.5s; 
            position:relative; 
            width: 100%;
        }
        #feedback-message.show { opacity: 1; }
        #close-feedback-btn { 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            color: white; 
            cursor: pointer; 
        }
        .modal-overlay { 
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s; 
            padding: 1rem;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            width: 100%; 
            max-width: 450px; 
            position: relative; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { 
            color: var(--rojo-acento); 
            margin-bottom: 20px; 
            font-size: 2.2rem; 
            font-weight: 700; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); 
            text-transform: uppercase; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; 
        }
        #modal-score-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .score-card-modal { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background-color: var(--gris-claro); 
            padding: 12px; 
            border-radius: 10px; 
            border-left: 5px solid var(--azul-claro); 
            opacity: 0; 
            transform: translateX(-30px); 
            animation: slideInFromLeft 0.5s ease-out forwards; 
        }
        @keyframes slideInFromLeft { to { opacity: 1; transform: translateX(0); } }
        .score-card-modal.is-leader { border-left-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .score-card-modal.is-current-player { box-shadow: 0 0 15px var(--azul-aun-mas-claro); border-left-color: var(--azul-principal); }
        .score-card-rank { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--gris-oscuro); 
            min-width: 40px; 
            text-align: center; 
        }
        .score-card-rank .fa-crown { color: var(--gold); }
        .score-card-details { flex-grow: 1; }
        .score-card-name { font-weight: 600; font-size: 1.1rem; color: var(--gris-oscuro); }
        .score-progress-bar-bg { background-color: #d1d1d1; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        .score-progress-bar-fg { background: linear-gradient(90deg, var(--azul-claro), var(--azul-principal)); height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease-out; }
        .score-card-score { 
            font-size: 1.6rem; 
            font-weight: 700; 
            color: var(--azul-principal); 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .score-card-score .score-plus {
            font-size: 1.2rem;
            color: var(--verde-correcto);
            opacity: 0;
            transform: translateY(10px);
            animation: score-fly-up 0.8s forwards;
        }
        @keyframes score-fly-up {
            0% { opacity: 0; transform: translateY(10px); }
            50% { opacity: 1; transform: translateY(-10px); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        #end-screen { justify-content: space-around; }
        #end-screen h2 { 
            font-size: 2.5rem; 
            font-weight: 800; 
            color: var(--azul-principal); 
            animation: fadeInDown 0.8s ease-out; 
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .winner-card { 
            width: 100%; 
            max-width: 500px; 
            background: linear-gradient(45deg, var(--azul-principal), var(--azul-claro)); 
            color: var(--blanco-puro); 
            border-radius: 20px; 
            padding: 25px; 
            margin: 20px 0; 
            border: 4px solid var(--gold); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px var(--gold); 
            text-align: center; 
            opacity: 0; 
            transform: scale(0.8); 
        }
        .winner-card.animate { animation: winner-card-appear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; animation-delay: 0.5s; }
        @keyframes winner-card-appear { to { opacity: 1; transform: scale(1); } }
        .winner-card h3 { 
            font-size: 2rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }
        .winner-card .trophy-icon { 
            font-size: 4rem; 
            color: var(--gold); 
            margin: 15px 0; 
            text-shadow: 0 0 15px white; 
        }
        .winner-card .winner-name { 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin-bottom: 5px; 
        }
        .winner-card .winner-score { 
            font-size: 1.5rem; 
            font-weight: 500; 
        }
        .winner-card .winner-names-tie { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .winner-card .winner-names-tie .winner-name { font-size: 1.8rem; }
        .podium-container { 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            gap: 10px; 
            width: 100%; 
            height: 200px; 
            margin: 10px 0 20px; 
        }
        .podium-place { 
            width: 30%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-end; 
            text-align: center; 
            border-top-left-radius: 10px; 
            border-top-right-radius: 10px; 
            color: white; 
            padding: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            opacity: 0; 
            transform: translateY(50px); 
            position: relative;
        }
        .podium-place.gold { background-image: linear-gradient(180deg, var(--gold) 0%, #FFEA8D 100%); height: 100%; animation-delay: 1.2s; animation: podium-rise 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .podium-place.silver { background-image: linear-gradient(180deg, var(--silver) 0%, #E3E3E3 100%); height: 80%; animation-delay: 1.4s; animation: podium-rise 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .podium-place.bronze { background-image: linear-gradient(180deg, var(--bronze) 0%, #B96620 100%); height: 60%; animation-delay: 1.6s; animation: podium-rise 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes podium-rise { to { opacity: 1; transform: translateY(0); } }

        .podium-place .podium-name, .podium-place .podium-score {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .podium-place .podium-name { 
            font-size: 1.2rem; 
            font-weight: 700; 
            word-break: break-word; 
        }
        .podium-place .podium-score { 
            font-size: 1rem; 
            font-weight: 500; 
        }
        .podium-place .podium-rank { 
            font-size: 2.5rem; 
            font-weight: 800; 
            margin-bottom: 5px; 
        }
        .podium-place .podium-rank i { text-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        .other-scores-list { 
            width: 100%; 
            max-width: 600px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .player-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: var(--gris-claro); 
            padding: 15px 20px; 
            border-radius: 10px; 
            opacity: 0; 
            transform: scale(0.9); 
            animation: card-appear 0.5s ease-out forwards; 
        }
        @keyframes card-appear { to { opacity: 1; transform: scale(1); } }
        .player-card .rank { font-size: 1.2rem; font-weight: 600; color: var(--gris-oscuro); }
        .player-card .name { font-size: 1.2rem; font-weight: 500; }
        .player-card .score { font-size: 1.2rem; font-weight: 700; color: var(--azul-principal); }
        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; border-radius: 2px; opacity: 0; animation: confetti-fall 4s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh); opacity: 0; } }
        
        #timer-container { width: 100%; height: 10px; background-color: var(--gris-claro); border: 2px solid var(--azul-aun-mas-claro); border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, var(--rojo-acento), var(--azul-claro)); border-radius: 8px; transition: width 1s linear, background 1s ease; }
        
        .player-avatar-container { width: 50px; height: 50px; border-radius: 50%; background-color: var(--azul-claro); display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid var(--azul-principal); transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .player-avatar-container:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .player-avatar { font-size: 1.8rem; color: white; }

        #avatar-selection-modal .modal-content { max-width: 600px; }
        #avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 15px; margin-top: 20px; }
        .avatar-option { width: 100%; aspect-ratio: 1 / 1; border-radius: 50%; background-color: var(--gris-claro); display: flex; justify-content: center; align-items: center; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease; }
        .avatar-option:hover { background-color: var(--azul-aun-mas-claro); border-color: var(--azul-principal); transform: scale(1.05); }
        .avatar-option.selected { border-color: var(--rojo-acento); box-shadow: 0 0 15px rgba(203, 24, 35, 0.5); transform: scale(1.1); }
        .avatar-option i { font-size: 2.5rem; color: var(--azul-principal); }

        .player-score-avatar, .winner-avatar, .podium-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--azul-claro); display: flex; justify-content: center; align-items: center; margin-right: 10px; flex-shrink: 0; }
        .player-score-avatar i, .winner-avatar i, .podium-avatar i { font-size: 1.5rem; color: white; }
        
        .score-update-plus {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 800;
            color: var(--verde-correcto);
            opacity: 0;
            animation: score-update-pop 1s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }
        @keyframes score-update-pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -100%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1); opacity: 0; }
        }

        /* --- MEDIA QUERIES PARA RESPONSIVIDAD --- */
        @media (max-width: 768px) {
            .game-container {
                width: 95vw;
                min-height: 0;
                height: auto;
                max-height: 95vh;
                display: flex;
                flex-direction: column;
            }
            .screen {
                padding: 20px;
                min-height: 0;
                height: auto;
                position: relative;
                flex-grow: 1;
            }
            .screen.active {
                 display: flex;
            }
            .screen:not(.active) {
                display: none;
            }
            
            .close-btn { font-size: 1.5rem; top: 15px; right: 15px; }
            .game-header { padding: 10px 15px; }
            .game-header .header-group .btn-icon { font-size: 1.5rem; }
            #current-player-turn-display { font-size: 1rem; padding: 6px 12px; }
            .joker-btn { padding: 8px 15px; font-size: 0.9rem; }
            
            #splash-screen h1 { font-size: 2.5rem; }
            .btn { padding: 12px 25px; font-size: 1rem; margin: 8px; }
            
            #player-config-screen, #round-config-screen { padding: 40px 20px; }
            #player-config-screen h2, #round-config-screen h2 { font-size: 1.8rem; margin-bottom: 20px; }
            .player-count-selector, .round-count-selector { padding: 8px 15px; margin-bottom: 20px; }
            .player-count-selector button, .round-count-selector button { width: 35px; height: 35px; font-size: 1.2rem; }
            .player-count-selector span, .round-count-selector span { font-size: 1.5rem; margin: 0 15px; }
            
            #player-inputs { width: 100%; }
            .player-input-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            .player-input-group label { min-width: 60px; margin-right: 5px; font-size: 0.9rem; }
            .player-input-group input[type="text"] { padding: 10px 12px; font-size: 0.9rem; min-width: 120px; }
            .player-input-group .random-name-btn { padding: 8px 12px; font-size: 0.9rem; margin-left: auto; }
            .player-input-group .player-color-input { width: 35px; height: 35px; }
            
            #game-screen { padding-top: 80px; }
            #question-area { padding: 20px; margin-bottom: 15px; }
            .category-display { font-size: 1rem; margin-bottom: 10px; }
            .category-display i { font-size: 1.8rem; }
            #question-text { font-size: 1.3rem; margin-bottom: 20px; min-height: 60px; }
            
            .options-grid { grid-template-columns: 1fr; gap: 10px; }
            .option-btn { padding: 12px 15px; font-size: 1rem; }
            #feedback-message { padding: 12px; margin-top: 15px; }
            #feedback-text { font-size: 0.95rem; }
            #close-feedback-btn { font-size: 1.2rem; }

            #end-screen h2 { font-size: 2rem; }
            .winner-card { padding: 20px; margin: 15px 0; width: 100%; }
            .winner-card h3 { font-size: 1.6rem; }
            .winner-card .trophy-icon { font-size: 3rem; margin: 10px 0; }
            .winner-card .winner-name { font-size: 1.8rem; }
            .winner-card .winner-score { font-size: 1.2rem; }
            .podium-container { height: 150px; margin-top: 5px; margin-bottom: 15px; }
            .podium-place { padding: 8px; }
            .podium-place .podium-name { font-size: 1rem; }
            .podium-place .podium-score { font-size: 0.9rem; }
            .podium-place .podium-rank { font-size: 2rem; }
            .player-card { padding: 12px 15px; }
            .player-card .rank, .player-card .name, .player-card .score { font-size: 1rem; }
            .player-score-avatar, .winner-avatar, .podium-avatar { width: 35px; height: 35px; }
            .player-score-avatar i, .winner-avatar i, .podium-avatar i { font-size: 1.3rem; }

            .modal-content { padding: 20px; }
            .modal-content h3 { font-size: 1.8rem; gap: 8px; }
            .score-card-modal { padding: 10px; gap: 10px; }
            .score-card-rank { font-size: 1.2rem; min-width: 30px; }
            .score-card-name { font-size: 0.95rem; }
            .score-card-score { font-size: 1.3rem; }
            #avatar-grid { grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; }
            .avatar-option i { font-size: 2rem; }
        }

        @media (max-width: 480px) {
            body { padding: 0.5rem 0; }
            .screen { padding: 15px; }
            #splash-screen h1 { font-size: 2rem; }
            .btn { padding: 10px 20px; font-size: 0.9rem; }
            #player-config-screen h2, #round-config-screen h2 { font-size: 1.5rem; }
            .player-count-selector span, .round-count-selector span { font-size: 1.3rem; }
            .player-input-group label { min-width: auto; flex-basis: 100%; text-align: left; }
            .player-input-group { justify-content: space-between; }
            .player-input-group input[type="text"] { flex-grow: 1; }
            .player-input-group .random-name-btn { padding: 6px 10px; font-size: 0.8rem; }
            
            #question-text { font-size: 1.15rem; min-height: 50px; }
            .option-btn { padding: 10px 12px; font-size: 0.9rem; }
            #end-screen h2 { font-size: 1.8rem; }
            .winner-card h3 { font-size: 1.4rem; }
            .winner-card .winner-name { font-size: 1.6rem; }
            .winner-card .winner-score { font-size: 1.1rem; }
            .podium-container { height: 120px; }
            .podium-place .podium-name { font-size: 0.8rem; }
            .podium-place .podium-score { font-size: 0.7rem; }
            .modal-content h3 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Pantalla de inicio mejorada con un icono animado -->
        <div id="splash-screen" class="screen active">
            <i class="fas fa-train splash-logo"></i>
            <h1>Trivial Ferroviario de Alta Velocidad</h1>
            <button id="start-game-btn" class="btn">Iniciar Juego</button>
        </div>
        
        <div id="player-config-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <h2>Configuración de Partida</h2>
            <div class="player-count-selector">
                <button id="decrease-players-btn">-</button><span id="player-count">1</span><button id="increase-players-btn">+</button>
            </div>
            <div id="player-inputs"></div>
            <button id="start-match-btn" class="btn">Empezar Partida</button>
        </div>
        
        <div id="round-config-screen" class="screen">
            <button class="close-btn" data-target-screen="player-config-screen">×</button>
            <h2>¿Cuántas preguntas por jugador?</h2>
            <div class="round-count-selector">
                <button id="decrease-rounds-btn">-</button><span id="round-count">5</span><button id="increase-rounds-btn">+</button>
            </div>
            <button id="start-game-from-rounds-btn" class="btn">¡A Jugar!</button>
        </div>
        
        <div id="game-screen" class="screen">
            <!-- Nuevo header fijo para la pantalla de juego -->
            <div class="game-header">
                <div id="current-player-turn-display"></div>
                <div class="header-group">
                    <!-- Botón para el comodín 50/50 -->
                    <button id="fifty-fifty-btn" class="joker-btn" title="Elimina 2 respuestas incorrectas"><i class="fas fa-divide"></i> 50/50</button>
                    <button id="show-score-btn" class="fas fa-medal btn-icon"></button>
                    <button class="close-btn" data-target-screen="confirm-exit">×</button>
                </div>
            </div>
            
            <div id="question-area">
                <div id="timer-container">
                    <div id="timer-bar"></div>
                </div>
                <div class="category-display"><i id="category-icon" class="fas fa-question-circle"></i><span id="category-name">Categoría</span></div>
                <p id="question-text">Cargando pregunta...</p>
                <div id="options-grid" class="options-grid">
                    <button class="option-btn" data-option="A">A) Opción 1</button>
                    <button class="option-btn" data-option="B">B) Opción 2</button>
                    <button class="option-btn" data-option="C">C) Opción 3</button>
                    <button class="option-btn" data-option="D">D) Opción 4</button>
                </div>
            </div>
            
            <div id="feedback-message">
                <p id="feedback-text"></p>
                <button id="close-feedback-btn" class="close-feedback-btn">×</button>
            </div>
        </div>
        
        <div id="end-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <div id="confetti-container"></div>
            <h2>¡Partida Terminada!</h2>
            <div id="winner-announcement-card"></div>
            <div id="podium-container" class="podium-container"></div>
            <div id="other-scores-container" class="other-scores-list"></div>
            <button id="play-again-btn" class="btn">Volver a Jugar</button>
        </div>
        
        <div id="score-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" data-target-screen="hide-modal">×</button>
                <h3><i class="fas fa-trophy"></i> Clasificación Actual</h3>
                <ul id="modal-score-list"></ul>
            </div>
        </div>
        
        <div id="confirm-exit-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>¿Estás seguro que quieres salir?</h3>
                <p>Se perderá el progreso actual de la partida.</p>
                <button id="confirm-exit-yes" class="btn">Sí, salir</button>
                <button id="confirm-exit-no" class="btn">No, continuar</button>
            </div>
        </div>
        
        <div id="avatar-selection-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" data-target-screen="hide-avatar-modal">×</button>
                <h3>Elige tu Avatar</h3>
                <div id="avatar-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Declaración de variables globales y datos del juego.
        let gameData = {};
        let players = [];
        let currentPlayerIndex = 0;
        let currentQuestionIndex = 0;
        let questionsPerGame = 0;
        let questionsPerPlayer = 5;
        let shuffledQuestions = [];
        let feedbackTimer = null;

        const TIMER_DURATION = 20; 
        let timeRemaining = TIMER_DURATION;
        let questionTimer = null;

        const initialGameData = {
            "preguntas": {
                "Elementos Estructurales de la Vía": [
                    {
                        "pregunta": "¿Qué elemento de la vía férrea se encarga de transmitir las cargas de los carriles al balasto?",
                        "opciones": ["A) Carril", "B) Brida", "C) Traviesa", "D) Tirafondo"],
                        "respuestaCorrecta": "C",
                        "explicacion": "La traviesa es el elemento transversal que recibe la carga del carril y la transmite al balasto, manteniendo la geometría de la vía."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal del balasto en la superestructura de la vía?",
                        "opciones": ["A) Conducir la electricidad", "B) Drenar el agua y distribuir cargas", "C) Fijar los carriles directamente", "D) Absorber el ruido del tren"],
                        "respuestaCorrecta": "B",
                        "explicacion": "El balasto, compuesto por grava, drena el agua y distribuye uniformemente las cargas de las traviesas al terraplén."
                    },
                    {
                        "pregunta": "¿Qué tipo de carril se utiliza comúnmente en las líneas de alta velocidad en España?",
                        "opciones": ["A) UIC 54", "B) ASCE 60", "C) UIC 60", "D) RE 70"],
                        "respuestaCorrecta": "C",
                        "explicacion": "El carril UIC 60 es el estándar en las líneas de alta velocidad españolas debido a su mayor resistencia y capacidad para soportar grandes cargas."
                    }
                ],
                "Maquinaria y Herramientas": [
                    {
                        "pregunta": "¿Qué máquina se utiliza para compactar el balasto bajo las traviesas y mejorar la estabilidad de la vía?",
                        "opciones": ["A) Desguarnecedora", "B) Bateadora", "C) Perfiladora", "D) Soldadora de carril"],
                        "respuestaCorrecta": "B",
                        "explicacion": "La bateadora es una máquina fundamental para el mantenimiento de la vía, encargada de compactar el balasto y nivelar la vía."
                    },
                    {
                        "pregunta": "¿Cuál es la función de una perfiladora de balasto?",
                        "opciones": ["A) Excavar zanjas", "B) Distribuir y dar forma al balasto", "C) Cortar carriles", "D) Medir la geometría de la vía"],
                        "respuestaCorrecta": "B",
                        "explicacion": "La perfiladora de balasto se encarga de distribuir el balasto de manera uniforme y darle la forma adecuada en la sección transversal de la vía."
                    }
                ],
                "Sistemas y Tecnologías": [
                    {
                        "pregunta": "¿Qué sistema de señalización se utiliza en las líneas de alta velocidad europeas para controlar la velocidad y garantizar la seguridad?",
                        "opciones": ["A) ASFA", "B) LZB", "C) ERTMS", "D) ATP"],
                        "respuestaCorrecta": "C",
                        "explicacion": "El ERTMS (European Rail Traffic Management System) es el sistema de señalización y control de trenes estándar en Europa para las líneas de alta velocidad."
                    },
                    {
                        "pregunta": "¿Qué tecnología permite a los trenes de alta velocidad circular a velocidades muy elevadas sin contacto directo con el carril?",
                        "opciones": ["A) Levitation magnética (Maglev)", "B) Tracción diésel", "C) Frenado regenerativo", "D) Vía en placa"],
                        "respuestaCorrecta": "A",
                        "explicacion": "La levitación magnética o Maglev permite que el tren flote sobre la vía, eliminando la fricción y permitiendo velocidades extremas."
                    }
                ]
            }
        };

// Nombres divertidos y temáticos para los jugadores
const randomRailwayNames = [
    "Traviesín", "Tunelillo", "Rielín", "Vibración Veloz", "Balasto Boss",
    "Catenaria Kid", "Señalino", "Durmiente Dinámico", "Fibra Óptica Fan",
    "Amolador As", "Bateadora Berta", "Inspector Hilario", "Durmiente Ágil",
    "Biela Veloz", "Trenelito", "Vía Láctea", "Pantógrafo Power",
    "Señor Señal", "Cat-enaria", "Ingeniero Rieles", "Desvío Divertido",
    "Terraplén Teo", "Túnelín el Astuto", "Puente Patán", "Balasto Brillante",
    "Soldador Sergio", "Frenada Fantástica", "Inspector Javier",
    "Silbato Sonriente", "Vagón Valiente", "El Fantasma de la Estación",
    "El Conductor Loco", "La Locomotora Lenta", "El Vía-jero",
    "El Tren Expreso", "Maquinista Malabarista", "Controlador Caótico",
    "Portero Pato", "Despachador Demente", "El Ferrocarril Fugaz",
    "Estación Estelar", "Señor Vía", "Tren de la Suerte"
];
let usedRandomNames = new Set();

// Íconos de avatar basados en transporte, usando Font Awesome
const avatarIcons = [
    'fas fa-train', 'fas fa-locomotive', 'fas fa-subway', 'fas fa-tram',
    'fas fa-bus', 'fas fa-car-side', 'fas fa-plane', 'fas fa-ship',
    'fas fa-bicycle', 'fas fa-truck-ramp-box', 'fas fa-rocket', 'fas fa-motorcycle',
    'fas fa-shuttle-space', 'fas fa-helicopter', 'fas fa-bus-simple', 'fas fa-caravan'
];
let usedRandomAvatars = new Set();

// Paleta de colores más amplia y vibrante para los jugadores
const defaultPlayerColors = [
    '#FF6347', '#4682B4', '#32CD32', '#FFD700', '#8A2BE2', '#00CED1',
    '#FF8C00', '#DA70D6', '#ADFF2F', '#DC143C', '#FF4500', '#9932CC',
    '#20B2AA', '#FF1493', '#00BFFF', '#7FFF00', '#BA55D3', '#F4A460',
    '#FF69B4', '#00FFFF'
];
let usedRandomColors = new Set();

        // Se obtienen las referencias a los elementos del DOM.
        const splashScreen = document.getElementById('splash-screen');
        const playerConfigScreen = document.getElementById('player-config-screen');
        const roundConfigScreen = document.getElementById('round-config-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const decreasePlayersBtn = document.getElementById('decrease-players-btn');
        const increasePlayersBtn = document.getElementById('increase-players-btn');
        const playerCountSpan = document.getElementById('player-count');
        const playerInputsDiv = document.getElementById('player-inputs');
        const startMatchBtn = document.getElementById('start-match-btn');
        const decreaseRoundsBtn = document.getElementById('decrease-rounds-btn');
        const increaseRoundsBtn = document.getElementById('increase-rounds-btn');
        const roundCountSpan = document.getElementById('round-count');
        const startGameFromRoundsBtn = document.getElementById('start-game-from-rounds-btn');
        const currentPlayerTurnDisplay = document.getElementById('current-player-turn-display');
        const questionTextP = document.getElementById('question-text');
        const optionsGridDiv = document.getElementById('options-grid');
        const optionButtons = optionsGridDiv.querySelectorAll('.option-btn');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const feedbackTextP = document.getElementById('feedback-text');
        const closeFeedbackBtn = document.getElementById('close-feedback-btn');
        const winnerCardContainer = document.getElementById('winner-announcement-card');
        const playAgainBtn = document.getElementById('play-again-btn');
        const scoreModal = document.getElementById('score-modal');
        const modalScoreList = document.getElementById('modal-score-list');
        const showScoreBtn = document.getElementById('show-score-btn');
        const confirmExitModal = document.getElementById('confirm-exit-modal');
        const confirmExitYesBtn = document.getElementById('confirm-exit-yes');
        const confirmExitNoBtn = document.getElementById('confirm-exit-no');
        const fiftyFiftyBtn = document.getElementById('fifty-fifty-btn');
        let categoryIcon, categoryNameSpan;
        
        const timerBar = document.getElementById('timer-bar');

        const avatarSelectionModal = document.getElementById('avatar-selection-modal');
        const avatarGrid = document.getElementById('avatar-grid');
        let currentPlayerAvatarSelectionIndex = -1; 

        // Función para mostrar una pantalla y ocultar las demás
        function showScreen(screenToShow) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            screenToShow.classList.add('active'); 
        }
        
        // Funciones de utilidad para manejar datos
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        function getRandomRailwayName() {
            if (usedRandomNames.size === randomRailwayNames.length) usedRandomNames.clear();
            let name;
            do { name = randomRailwayNames[Math.floor(Math.random() * randomRailwayNames.length)]; } while (usedRandomNames.has(name));
            usedRandomNames.add(name);
            return name;
        }

        function getRandomAvatar() {
            if (usedRandomAvatars.size === avatarIcons.length) usedRandomAvatars.clear();
            let avatar;
            do { avatar = avatarIcons[Math.floor(Math.random() * avatarIcons.length)]; } while (usedRandomAvatars.has(avatar));
            usedRandomAvatars.add(avatar);
            return avatar;
        }

        function getRandomColor() {
            if (usedRandomColors.size === defaultPlayerColors.length) usedRandomColors.clear();
            let color;
            do { color = defaultPlayerColors[Math.floor(Math.random() * defaultPlayerColors.length)]; } while (usedRandomColors.has(color));
            usedRandomColors.add(color);
            return color;
        }

        // Crea los inputs de los jugadores de forma dinámica
        function updatePlayerInputs() {
            const playerCount = parseInt(playerCountSpan.textContent);
            playerInputsDiv.innerHTML = '';
            while (players.length < playerCount) { players.push({ name: `Jugador ${players.length + 1}`, score: 0, hasFiftyFiftyJoker: true, avatar: getRandomAvatar(), color: getRandomColor() }); }
            while (players.length > playerCount) { players.pop(); }
            for (let i = 0; i < playerCount; i++) {
                const player = players[i];
                const group = document.createElement('div');
                group.className = 'player-input-group';
                group.innerHTML = `
                    <label for="player-name-${i + 1}">Jugador ${i + 1}:</label>
                    <div class="player-avatar-container" data-player-index="${i}" style="background-color: ${player.color};">
                        <i class="player-avatar ${player.avatar}"></i>
                    </div>
                    <input type="text" id="player-name-${i + 1}" value="${player.name}">
                    <input type="color" id="player-color-${i + 1}" value="${player.color}" class="player-color-input">
                    <button type="button" class="random-name-btn" data-player-index="${i}"><i class="fas fa-dice"></i></button>
                `;
                playerInputsDiv.appendChild(group);
            }
            playerInputsDiv.querySelectorAll('.random-name-btn').forEach(btn => {
                btn.onclick = () => {
                    const playerIndex = parseInt(btn.dataset.playerIndex);
                    const newName = getRandomRailwayName();
                    const newAvatar = getRandomAvatar();
                    const newColor = getRandomColor();
                    document.getElementById(`player-name-${playerIndex + 1}`).value = newName;
                    document.getElementById(`player-color-${playerIndex + 1}`).value = newColor;
                    players[playerIndex].name = newName;
                    players[playerIndex].avatar = newAvatar;
                    players[playerIndex].color = newColor;
                    const avatarContainer = document.querySelector(`.player-avatar-container[data-player-index="${playerIndex}"]`);
                    avatarContainer.style.backgroundColor = newColor;
                    avatarContainer.querySelector('.player-avatar').className = `player-avatar ${newAvatar}`;
                };
            });
            playerInputsDiv.querySelectorAll('.player-avatar-container').forEach(avatarContainer => {
                // CORRECCIÓN: Se cambió `event.currentTarget.dataset.player-index` a `event.currentTarget.dataset.playerIndex` para acceder al atributo de datos correctamente.
                avatarContainer.onclick = (event) => { openAvatarSelectionModal(parseInt(event.currentTarget.dataset.playerIndex)); };
            });
            playerInputsDiv.querySelectorAll('.player-color-input').forEach(input => {
                input.onchange = (event) => {
                    const playerIndex = parseInt(event.target.id.replace('player-color-', '')) - 1;
                    players[playerIndex].color = event.target.value;
                    const avatarContainer = document.querySelector(`.player-avatar-container[data-player-index="${playerIndex}"]`);
                    avatarContainer.style.backgroundColor = event.target.value;
                };
            });
        }
        
        // Lógica del temporizador
        function updateTimer() {
            timeRemaining--;
            const percentage = (timeRemaining / TIMER_DURATION) * 100;
            timerBar.style.width = `${percentage}%`;
            if (timeRemaining <= TIMER_DURATION / 2) { timerBar.style.background = `linear-gradient(90deg, var(--rojo-incorrecto), var(--rojo-acento))`; }
            if (timeRemaining <= 0) { timeUp(); }
        }

        // Muestra la pregunta actual y el turno del jugador
        function displayQuestion() {
            if (questionTimer) clearInterval(questionTimer);
            categoryIcon = document.getElementById('category-icon');
            categoryNameSpan = document.getElementById('category-name');
            feedbackMessageDiv.classList.remove('show');
            if (feedbackTimer) clearTimeout(feedbackTimer);
            optionButtons.forEach(button => { button.disabled = true; button.classList.remove('correct', 'incorrect'); button.style.visibility = 'visible'; });
            
            const currentPlayer = players[currentPlayerIndex];
            fiftyFiftyBtn.disabled = !currentPlayer.hasFiftyFiftyJoker;

            timeRemaining = TIMER_DURATION;
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            timerBar.style.background = `linear-gradient(90deg, var(--rojo-acento), var(--azul-claro))`;
            
            setTimeout(() => {
                if (currentQuestionIndex >= shuffledQuestions.length) { endGame(); return; }
                const question = shuffledQuestions[currentQuestionIndex];
                categoryNameSpan.textContent = question.category; 
                categoryIcon.classList.remove('animate-category');
                void categoryIcon.offsetWidth; 
                switch (question.category) {
                    case "Elementos Estructurales de la Vía": categoryIcon.className = 'fas fa-road animate-category'; break;
                    case "Maquinaria y Herramientas": categoryIcon.className = 'fas fa-cogs animate-category'; break;
                    case "Sistemas y Tecnologías": categoryIcon.className = 'fas fa-lightbulb animate-category'; break;
                    default: categoryIcon.className = 'fas fa-question-circle animate-category';
                }
                
                currentPlayerTurnDisplay.classList.remove('animate-in');
                currentPlayerTurnDisplay.innerHTML = `<div class="player-score-avatar" style="background-color: ${currentPlayer.color};"><i class="${currentPlayer.avatar}"></i></div> Turno de: ${currentPlayer.name}`;
                currentPlayerTurnDisplay.style.backgroundColor = currentPlayer.color;
                void currentPlayerTurnDisplay.offsetWidth;
                currentPlayerTurnDisplay.classList.add('animate-in');
                questionTextP.textContent = question.pregunta;
                optionButtons.forEach((button, index) => { button.textContent = question.opciones[index]; button.disabled = false; });
                
                timerBar.style.transition = 'width 1s linear, background 1s ease';
                questionTimer = setInterval(updateTimer, 1000);
            }, 500);
        }

        // Verifica la respuesta seleccionada
        function checkAnswer(selectedOption) {
            clearInterval(questionTimer);
            const q = shuffledQuestions[currentQuestionIndex];
            const correct = q.respuestaCorrecta;
            const btn = optionsGridDiv.querySelector(`[data-option="${selectedOption}"]`);
            optionButtons.forEach(b => b.disabled = true);
            if (selectedOption === correct) {
                players[currentPlayerIndex].score++;
                btn.classList.add('correct');
                // Animación visual de puntuación
                const scoreUpdate = document.createElement('div');
                scoreUpdate.className = 'score-update-plus';
                scoreUpdate.textContent = '+1';
                gameScreen.appendChild(scoreUpdate);
                setTimeout(() => scoreUpdate.remove(), 1000);
            } else {
                btn.classList.add('incorrect');
                const correctButton = optionsGridDiv.querySelector(`[data-option="${correct}"]`);
                if (correctButton) { correctButton.classList.add('correct'); }
            }
            feedbackTextP.textContent = q.explicacion;
            feedbackMessageDiv.classList.add('show');
            feedbackTimer = setTimeout(nextTurn, 5000);
        }
        
        // Maneja el fin del tiempo
        function timeUp() {
            clearInterval(questionTimer);
            const q = shuffledQuestions[currentQuestionIndex];
            const correct = q.respuestaCorrecta;
            optionButtons.forEach(b => b.disabled = true);
            const correctButton = optionsGridDiv.querySelector(`[data-option="${correct}"]`);
            if (correctButton) { correctButton.classList.add('correct'); }
            feedbackTextP.textContent = "¡Se acabó el tiempo! " + q.explicacion;
            feedbackMessageDiv.classList.add('show');
            feedbackTimer = setTimeout(nextTurn, 5000);
        }

        // Pasa al siguiente turno o finaliza el juego
        function nextTurn() {
            if (feedbackTimer) clearTimeout(feedbackTimer);
            if(questionTimer) clearInterval(questionTimer);
            feedbackMessageDiv.classList.remove('show');
            currentQuestionIndex++;
            if (currentQuestionIndex >= shuffledQuestions.length) { endGame(); return; }
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            displayQuestion();
        }
        
        // Inicia el juego
        function startGame() { 
            players.forEach(p => { 
                p.score = 0; 
                p.hasFiftyFiftyJoker = true;
            }); 
            currentPlayerIndex = 0; 
            currentQuestionIndex = 0; 
            usedRandomNames.clear(); 
            usedRandomAvatars.clear(); 
            usedRandomColors.clear(); 
            const allQuestions = []; 
            for (const category in gameData.preguntas) { 
                gameData.preguntas[category].forEach(q => allQuestions.push({ ...q, category })); 
            } 
            shuffledQuestions = shuffleArray(allQuestions).slice(0, questionsPerGame); 
            showScreen(gameScreen); 
            displayQuestion(); 
        }
        
        // Lógica para el final del juego y el podio
        function endGame() {
            if (questionTimer) clearInterval(questionTimer);
            showScreen(endScreen);
            players.sort((a, b) => b.score - a.score);
            const podiumContainer = document.getElementById('podium-container');
            const otherScoresContainer = document.getElementById('other-scores-container');
            podiumContainer.innerHTML = '';
            otherScoresContainer.innerHTML = '';
            winnerCardContainer.innerHTML = '';

            if (players.length > 0) {
                const isTie = players.length > 1 && players[0].score === players[1].score;
                if (isTie) {
                    const tiedWinners = players.filter(p => p.score === players[0].score);
                    const winnerNamesHTML = tiedWinners.map(p => `<div class="winner-name">${p.name}</div>`).join('');
                    winnerCardContainer.innerHTML = `<div class="winner-card" style="border-color: var(--silver);"><h3>¡EMPATE!</h3><div class="trophy-icon"><i class="fas fa-handshake"></i></div><div class="winner-names-tie">${winnerNamesHTML}</div><div class="winner-score">Con ${players[0].score} puntos</div></div>`;
                } else {
                    const winner = players[0];
                    winnerCardContainer.innerHTML = `<div class="winner-card" style="border-color: ${winner.color};"><h3>¡GANADOR!</h3><div class="trophy-icon"><i class="fas fa-trophy"></i></div><div class="winner-avatar" style="background-color: ${winner.color};"><i class="${winner.avatar}"></i></div><div class="winner-name">${winner.name}</div><div class="winner-score">Con ${winner.score} puntos</div></div>`;
                }
                document.querySelector('.winner-card').classList.add('animate');
            }

            const podiumPlayers = players.slice(0, 3);
            const podiumElementsWithRank = [];
            podiumPlayers.forEach((player, index) => {
                const place = document.createElement('div');
                let rankClass = '', rankIconHtml = '<i class="fas fa-medal"></i>';
                if (index === 0) { rankClass = 'gold'; rankIconHtml = '<i class="fas fa-trophy"></i>'; }
                else if (index === 1) { rankClass = 'silver'; }
                else if (index === 2) { rankClass = 'bronze'; }
                place.className = `podium-place`;
                place.innerHTML = `<div class="podium-rank">${rankIconHtml}</div><div class="podium-avatar" style="background-color: ${player.color};"><i class="${player.avatar}"></i></div><div class="podium-name">${player.name}</div><div class="podium-score">${player.score} pts</div>`;
                podiumElementsWithRank.push({ element: place, rankClass: rankClass });
            });
            const sortedPodiumElementsToAppend = [];
            if (podiumElementsWithRank[1]) sortedPodiumElementsToAppend.push(podiumElementsWithRank[1]);
            if (podiumElementsWithRank[0]) sortedPodiumElementsToAppend.push(podiumElementsWithRank[0]);
            if (podiumElementsWithRank[2]) sortedPodiumElementsToAppend.push(podiumElementsWithRank[2]);
            sortedPodiumElementsToAppend.forEach(item => { podiumContainer.appendChild(item.element); void item.element.offsetWidth; item.element.classList.add(item.rankClass); });

            if (players.length > 3) {
                const otherPlayers = players.slice(3);
                otherPlayers.forEach((player, index) => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.style.animationDelay = `${1.8 + index * 0.2}s`;
                    card.innerHTML = `<span class="rank">#${index + 4}</span><div class="player-score-avatar" style="background-color: ${player.color};"><i class="${player.avatar}"></i></div><span class="name">${player.name}</span><span class="score">${player.score} puntos</span>`;
                    otherScoresContainer.appendChild(card);
                });
            }
            generateConfetti();
        }

        // Genera la animación de confeti
        function generateConfetti() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = `${Math.random() * 100}%`;
                piece.style.animationDelay = `${Math.random() * 2}s`;
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(piece);
            }
        }
        
        // Muestra la clasificación actual en un modal
        function showScoreModal() {
            modalScoreList.innerHTML = '';
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            const leaderScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0;
            const maxQuestionsPerPlayer = questionsPerPlayer;
            sortedPlayers.forEach((player, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'score-card-modal';
                listItem.style.animationDelay = `${index * 0.1}s`;
                listItem.style.borderLeftColor = player.color;
                let rankDisplay = `#${index + 1}`;
                if (index === 0 && leaderScore > 0) { listItem.classList.add('is-leader'); rankDisplay = '<i class="fas fa-crown"></i>'; }
                if (players[currentPlayerIndex] && players[currentPlayerIndex].name === player.name) { listItem.classList.add('is-current-player'); }
                const progress = maxQuestionsPerPlayer > 0 ? (player.score / maxQuestionsPerPlayer) * 100 : 0;
                listItem.innerHTML = `
                    <div class="score-card-rank">${rankDisplay}</div>
                    <div class="player-score-avatar" style="background-color: ${player.color};"><i class="${player.avatar}"></i></div>
                    <div class="score-card-details">
                        <span class="score-card-name">${player.name}</span>
                        <div class="score-progress-bar-bg">
                            <div class="score-progress-bar-fg" style="width: ${progress}%; background: linear-gradient(90deg, ${player.color}, ${lightenColor(player.color, 30)}); "></div>
                        </div>
                    </div>
                    <div class="score-card-score">${player.score}</div>`;
                modalScoreList.appendChild(listItem);
            });
            scoreModal.classList.add('active');
        }
        
        // Funciones para manejar los modales
        function lightenColor(hex, percent) {
            var f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=(f>>8)&0x00FF,B=(f)&0x0000FF;
            return "#"+(0x1000000+(Math.round((t-R)*p/100)+R)*0x10000+(Math.round((t-G)*p/100)+G)*0x100+(Math.round((t-B)*p/100)+B)).toString(16).slice(1);
        }
        function hideScoreModal() { scoreModal.classList.remove('active'); }
        function showConfirmExitModal() { confirmExitModal.classList.add('active'); }
        function hideConfirmExitModal() { confirmExitModal.classList.remove('active'); }
        
        function openAvatarSelectionModal(playerIndex) {
            currentPlayerAvatarSelectionIndex = playerIndex;
            avatarGrid.innerHTML = '';
            avatarIcons.forEach(iconClass => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.innerHTML = `<i class="${iconClass}"></i>`;
                option.dataset.iconClass = iconClass;
                if (players[playerIndex].avatar === iconClass) { option.classList.add('selected'); }
                option.onclick = () => { selectAvatar(playerIndex, iconClass); };
                avatarGrid.appendChild(option);
            });
            avatarSelectionModal.classList.add('active');
        }

        function selectAvatar(playerIndex, iconClass) {
            players[playerIndex].avatar = iconClass;
            document.querySelector(`.player-avatar-container[data-player-index="${playerIndex}"] .player-avatar`).className = `player-avatar ${iconClass}`;
            hideAvatarSelectionModal();
        }

        function hideAvatarSelectionModal() {
            avatarSelectionModal.classList.remove('active');
            currentPlayerAvatarSelectionIndex = -1;
        }

        // Lógica del comodín 50/50
        function useFiftyFiftyJoker() {
            const currentPlayer = players[currentPlayerIndex];
            if (!currentPlayer.hasFiftyFiftyJoker) return;

            currentPlayer.hasFiftyFiftyJoker = false;
            fiftyFiftyBtn.disabled = true;

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.respuestaCorrecta;
            
            const incorrectOptions = ['A', 'B', 'C', 'D'].filter(opt => opt !== correctAnswer);
            
            const optionsToHide = shuffleArray(incorrectOptions).slice(0, 2);

            optionsToHide.forEach(opt => {
                const button = optionsGridDiv.querySelector(`[data-option="${opt}"]`);
                if (button) {
                    button.style.visibility = 'hidden';
                    button.disabled = true;
                }
            });
        }
        
        // Event listeners para la interacción del usuario
        document.addEventListener('DOMContentLoaded', () => {
            gameData = initialGameData;
            
            const maxQuestionsAvailable = Object.values(gameData.preguntas).flat().length;
            
            startGameBtn.addEventListener('click', () => { showScreen(playerConfigScreen); updatePlayerInputs(); });
            decreasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) > 1) { playerCountSpan.textContent--; updatePlayerInputs(); } });
            increasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) < 10) { playerCountSpan.textContent++; updatePlayerInputs(); } });
            
            startMatchBtn.addEventListener('click', () => { 
                let valid = true; 
                for (let i = 0; i < parseInt(playerCountSpan.textContent); i++) { 
                    const input = document.getElementById(`player-name-${i + 1}`); 
                    const name = input.value.trim(); 
                    if (!name) { valid = false; input.style.borderColor = 'red'; } 
                    else { input.style.borderColor = ''; players[i].name = name; } 
                } 
                if (valid) {
                    const maxRoundsPerPlayer = players.length > 0 ? Math.floor(maxQuestionsAvailable / players.length) : 0;
                    let currentRoundCount = parseInt(roundCountSpan.textContent);
                    if (currentRoundCount > maxRoundsPerPlayer) { roundCountSpan.textContent = maxRoundsPerPlayer; }
                    else if (currentRoundCount === 0 && maxRoundsPerPlayer > 0) { roundCountSpan.textContent = 1; }
                    showScreen(roundConfigScreen); 
                }
            });

            decreaseRoundsBtn.addEventListener('click', () => { let count = parseInt(roundCountSpan.textContent); if (count > 1) roundCountSpan.textContent = --count; });
            increaseRoundsBtn.addEventListener('click', () => { 
                let count = parseInt(roundCountSpan.textContent); 
                const max = players.length > 0 ? Math.floor(maxQuestionsAvailable / players.length) : 0;
                if (count < max) roundCountSpan.textContent = ++count; 
            });
            startGameFromRoundsBtn.addEventListener('click', () => { questionsPerPlayer = parseInt(roundCountSpan.textContent); questionsPerGame = questionsPerPlayer * players.length; startGame(); });
            optionButtons.forEach(b => b.addEventListener('click', e => checkAnswer(e.target.dataset.option)));
            showScoreBtn.addEventListener('click', showScoreModal);
            playAgainBtn.addEventListener('click', () => { winnerCardContainer.innerHTML = ''; showScreen(splashScreen); });
            
            document.querySelectorAll('.close-btn').forEach(b => b.addEventListener('click', e => { 
                const target = e.target.dataset.targetScreen; 
                if (target === 'confirm-exit') showConfirmExitModal(); 
                else if (target === 'hide-modal') hideScoreModal(); 
                else if (target === 'hide-avatar-modal') hideAvatarSelectionModal();
                else showScreen(document.getElementById(target)); 
            }));
            
            confirmExitYesBtn.addEventListener('click', () => { 
                if (questionTimer) clearInterval(questionTimer);
                hideConfirmExitModal(); 
                showScreen(splashScreen); 
            });
            
            confirmExitNoBtn.addEventListener('click', hideConfirmExitModal);
            closeFeedbackBtn.addEventListener('click', nextTurn);
            fiftyFiftyBtn.addEventListener('click', useFiftyFiftyJoker);
        });
    </script>
</body>
</html>
