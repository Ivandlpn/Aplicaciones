<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INECO - Trivial Ferroviario de Alta Velocidad</title>
    <!-- Importar fuente Poppins de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Importar Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Definición de variables CSS para los colores de la marca INECO */
        :root {
            --ineco-azul-principal: rgb(26, 68, 136);
            --ineco-rojo-acento: rgb(203, 24, 35);
            --ineco-azul-claro: rgb(52, 99, 172);
            --ineco-azul-aun-mas-claro: rgb(107, 150, 207);
            --ineco-blanco-puro: rgb(255, 255, 255);
            --ineco-gris-oscuro: rgb(50, 50, 50);
            --ineco-gris-claro: rgb(230, 230, 230);
            --ineco-verde-correcto: rgb(76, 175, 80); /* Verde para respuestas correctas */
            --ineco-rojo-incorrecto: rgb(244, 67, 54); /* Rojo para respuestas incorrectas */
        }

        /* Estilos globales y reseteo básico */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Gradiente más dinámico y textura sutil de líneas que evocan vías de tren */
            background-image:
                linear-gradient(0deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(135deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 50%, var(--ineco-azul-aun-mas-claro) 100%);
            background-size: 20px 20px; /* Tamaño del patrón */
            color: var(--ineco-gris-oscuro);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }

        /* Contenedor principal del juego */
        .game-container {
            background-color: var(--ineco-blanco-puro);
            border-radius: 20px;
            /* Sombra mejorada */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Mantiene el overflow oculto para el contenedor principal */
            position: relative;
            transition: all 0.5s ease-in-out;
        }

        /* Estilos para las diferentes pantallas del juego */
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow-y: auto; /* Permite el scroll vertical dentro de cada pantalla si el contenido es largo */
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            position: relative; /* Para que ocupe espacio cuando está activo */
            flex-grow: 1; /* Permite que la pantalla activa crezca para llenar el espacio disponible */
        }

        /* Animaciones de entrada/salida */
        .screen.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }

        .screen.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para el logo INECO */
        .ineco-logo {
            position: absolute;
            top: 30px;
            left: 30px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Poppins Semibold */
            font-size: 36px; /* Ajustado para ser visible pero no abrumador */
            color: var(--ineco-azul-principal);
            padding-left: 1.2em; /* Equivalente a la altura de la 'n' para la zona de exclusión */
            padding-top: 0.2em;
            z-index: 10;
        }

        /* Estilos para botones generales */
        .btn {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Poppins Semibold */
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 10px;
        }

        .btn:hover {
            background-color: var(--ineco-azul-claro);
            transform: translateY(-3px);
            /* Sombra con glow en hover */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 15px var(--ineco-azul-principal);
        }

        .btn:active {
            transform: translateY(0);
            /* Sombra de botón presionado */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Botón de cerrar (X) */
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--ineco-gris-oscuro);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
        }

        .close-btn:hover {
            color: var(--ineco-rojo-acento);
            transform: scale(1.1);
        }
        
        /* Ajuste para el botón de cerrar en splash-screen si es necesario */
        #splash-screen .close-btn {
            color: var(--ineco-blanco-puro); /* Blanco sobre fondo oscuro */
        }
        #splash-screen .close-btn:hover {
            color: var(--ineco-gris-claro);
        }


        /* Estilos específicos de la pantalla de inicio (Splash Screen) */
        #splash-screen {
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 100%);
            color: var(--ineco-blanco-puro);
            border-radius: 20px; /* Asegura que el gradiente se vea redondeado */
        }

        #splash-screen .ineco-logo {
            color: var(--ineco-blanco-puro); /* Logo blanco sobre fondo oscuro */
        }

        #splash-screen h1 {
            font-size: 3.5em; /* H1: 36-48px */
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Estilos de la pantalla de configuración de jugadores */
        #player-config-screen, #round-config-screen {
            padding: 60px;
            justify-content: flex-start;
            align-items: center;
        }

        #player-config-screen h2, #round-config-screen h2 {
            font-size: 2.2em; /* H2: 28-34px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }

        .player-count-selector, .round-count-selector {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 10px 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .player-count-selector button, .round-count-selector button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .player-count-selector button:hover, .round-count-selector button:hover {
            background-color: var(--ineco-azul-principal);
        }

        .player-count-selector span, .round-count-selector span {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--ineco-azul-principal);
            margin: 0 20px;
        }

        #player-inputs {
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .player-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-input-group label {
            font-weight: 500; /* Poppins Medium */
            margin-right: 15px;
            color: var(--ineco-gris-oscuro);
            min-width: 80px;
            text-align: right;
        }

        .player-input-group input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 2px solid var(--ineco-gris-claro);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            color: var(--ineco-gris-oscuro);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .player-input-group input[type="text"]:focus {
            outline: none;
            border-color: var(--ineco-azul-claro);
            /* Sombra de foco mejorada */
            box-shadow: 0 0 0 4px rgba(52, 99, 172, 0.5);
        }

        .player-input-group .random-name-btn {
            background-color: var(--ineco-rojo-acento);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* Evita que el texto se rompa */
        }

        .player-input-group .random-name-btn:hover {
            background-color: rgb(170, 20, 29); /* Rojo un poco más oscuro */
        }

        /* Estilos de la pantalla de juego */
        #game-screen {
            padding: 30px;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
            justify-content: flex-start;
            align-items: center; /* Center items horizontally */
            position: relative;
            padding-top: 100px; /* Give space for logo, buttons, and player turn display */
        }

        /* Botón para abrir el marcador */
        #show-score-btn {
            position: absolute;
            top: 20px; /* Alineado con el close-btn */
            right: 70px; /* Desplazado a la izquierda para no solaparse con la X */
            background: none;
            border: none;
            font-size: 2em; /* Tamaño del icono */
            color: var(--ineco-azul-principal);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px; /* Para hacer el área de clic más grande */
            border-radius: 50%;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
        }

        #show-score-btn:hover {
            color: var(--ineco-rojo-acento);
            transform: scale(1.1);
        }

        /* Estilos para el contenedor de la pregunta */
        #question-area {
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            width: 100%;
            /* Sombra mejorada */
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden; /* Para animaciones de texto */
            display: flex; /* Usar flexbox para organizar elementos internos */
            flex-direction: column; /* Apilar elementos verticalmente */
            align-items: center; /* Centrar contenido horizontalmente */
        }

        /* Estilos para la categoría dentro de la tarjeta de pregunta */
        #question-area .category-display {
            font-size: 1.2em; /* Un poco más pequeño que el original de la cabecera */
            font-weight: 500;
            color: var(--ineco-azul-principal);
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* Espacio entre la categoría y la pregunta */
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Línea divisoria sutil */
            width: 100%; /* Ocupa todo el ancho de la tarjeta */
            justify-content: center; /* Centrar el texto de la categoría */
        }

        #question-area .category-display i {
            margin-right: 10px;
            font-size: 1em; /* Ajustar tamaño del icono */
            color: var(--ineco-rojo-acento);
        }

        #question-text {
            font-size: 1.6em; /* H3: 22-26px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 25px;
            line-height: 1.4;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        #question-text.fade-out-text {
            opacity: 0;
            transform: translateY(-20px);
        }

        #question-text.fade-in-text {
            opacity: 1;
            transform: translateY(0);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .option-btn {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1em; /* Cuerpo: 16-18px */
            font-weight: 500; /* Poppins Medium */
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .option-btn:hover {
            background-color: var(--ineco-azul-principal);
            transform: translateY(-2px);
            /* Sombra con glow en hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 0 10px var(--ineco-azul-principal);
        }

        .option-btn:active {
            transform: translateY(0);
            /* Sombra de botón presionado */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .option-btn.correct {
            background-color: var(--ineco-verde-correcto);
            animation: pulse-correct 0.5s ease-out forwards;
        }

        .option-btn.incorrect {
            background-color: var(--ineco-rojo-incorrecto);
            animation: shake-incorrect 0.5s ease-out forwards;
        }

        @keyframes pulse-correct {
            0% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
            50% { transform: scale(1.03); box-shadow: 0 0 20px var(--ineco-verde-correcto); }
            100% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
        }

        @keyframes shake-incorrect {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        /* Mensaje de feedback (explicación) */
        #feedback-message {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1em;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            /* Sombra mejorada */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: left;
            position: relative; /* Necesario para posicionar el botón de cerrar */
        }

        #feedback-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para el botón de cerrar la explicación */
        #close-feedback-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.5em; /* Tamaño del icono */
            color: var(--ineco-blanco-puro);
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            padding: 5px; /* Aumenta el área de clic */
            line-height: 1; /* Alineación vertical de la 'X' */
        }

        #close-feedback-btn:hover {
            transform: scale(1.1);
            color: var(--ineco-gris-claro);
        }

        /* Estilos de la pantalla de fin de juego */
        #end-screen {
            padding: 60px;
            justify-content: center;
            align-items: center;
            position: relative; /* Necesario para el confeti */
            overflow: hidden; /* Asegura que el confeti no se salga del contenedor */
        }

        #end-screen h2 {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
        }

        #end-screen h3 {
            font-size: 2.8em; /* Aumentado para mayor impacto */
            font-weight: 800; /* Extra bold */
            color: var(--ineco-rojo-acento);
            margin-bottom: 30px;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.4);
            animation: winner-bounce 0.8s ease-out forwards; /* Animación de rebote */
        }

        /* Animación para el texto del ganador */
        @keyframes winner-bounce {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        #final-scores {
            width: 100%;
            max-width: 500px;
            margin-bottom: 40px;
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .final-player-score {
            display: flex;
            justify-content: space-between;
            font-size: 1.3em;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }

        .final-player-score:last-child {
            border-bottom: none;
        }

        .final-player-score .name {
            font-weight: 500;
            color: var(--ineco-gris-oscuro);
        }

        .final-player-score .score {
            font-weight: 600;
            color: var(--ineco-azul-principal);
        }

        /* Estilos para el confeti */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none; /* Permite que los clics pasen a través */
            z-index: 999;
            opacity: 0; /* Oculto por defecto */
            transition: opacity 0.5s ease-in-out;
        }

        #confetti-container.show-confetti {
            opacity: 1;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards, confetti-rotate 2s infinite linear;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes confetti-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el modal del marcador */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semitransparente oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--ineco-blanco-puro);
            border-radius: 15px;
            padding: 30px;
            /* Sombra mejorada */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 450px;
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            font-size: 1.8em;
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* --- CAMBIO: NUEVOS ESTILOS PARA EL INDICADOR DE TURNO ESPECTACULAR --- */
        #current-player-turn-display {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--ineco-blanco-puro);
            background-color: var(--ineco-azul-principal);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 55px;
            white-space: nowrap;
            z-index: 15;
            padding: 10px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0; /* Inicialmente oculto para la animación */
        }

        #current-player-turn-display.animate-in {
            animation: bounce-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes bounce-in {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.3) translateY(-50px);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.1) translateY(0);
            }
            70% {
                transform: translateX(-50%) scale(0.9) translateY(0);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) scale(1) translateY(0);
            }
        }

        /* Estilos responsivos */
        @media (max-width: 768px) {
            .game-container { width: 95%; min-height: 500px; }
            .ineco-logo { font-size: 28px; top: 20px; left: 20px; padding-left: 1em; }
            #splash-screen h1 { font-size: 2.5em; }
            .btn { padding: 12px 25px; font-size: 1em; }
            #player-config-screen h2, #round-config-screen h2 { font-size: 1.8em; }
            .player-count-selector, .round-count-selector { padding: 8px 15px; }
            .player-count-selector button, .round-count-selector button { width: 35px; height: 35px; font-size: 1.2em; }
            .player-count-selector span, .round-count-selector span { font-size: 1.5em; margin: 0 15px; }
            .player-input-group { flex-direction: column; align-items: flex-start; }
            .player-input-group label { margin-bottom: 5px; text-align: left; }
            .player-input-group input[type="text"] { width: 100%; margin-bottom: 10px; }
            .player-input-group .random-name-btn { width: 100%; margin-left: 0; }
            #question-text { font-size: 1.3em; }
            .options-grid { grid-template-columns: 1fr; }
            .option-btn { padding: 12px 15px; font-size: 1em; }
            .final-player-score { font-size: 1.1em; }
            .close-btn { font-size: 1.5em; top: 15px; right: 15px; }
            #show-score-btn { font-size: 1.8em; top: 10px; right: 50px; }
            .modal-content { padding: 20px; }
            .modal-content h3 { font-size: 1.5em; }
            .modal-content ul li { font-size: 1em; }
        }

        @media (max-width: 480px) {
            #splash-screen h1 { font-size: 2em; }
            #question-text { font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Logo INECO, visible en todas las pantallas -->
        <div class="ineco-logo">ineco</div>

        <!-- Simple Message Display for UI feedback -->
        <div id="ui-message" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--ineco-rojo-acento); color: var(--ineco-blanco-puro); padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; display: none;">
            <span id="ui-message-text"></span>
        </div>

        <!-- Pantalla de Inicio (Splash Screen) -->
        <div id="splash-screen" class="screen active">
            <h1>Trivial Ferroviario de Alta Velocidad</h1>
            <button id="start-game-btn" class="btn">Iniciar Juego</button>
        </div>

        <!-- Pantalla de Configuración de Jugadores -->
        <div id="player-config-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <h2>Configuración de Partida</h2>
            <div class="player-count-selector">
                <button id="decrease-players-btn">-</button>
                <span id="player-count">1</span>
                <button id="increase-players-btn">+</button>
            </div>
            <div id="player-inputs"></div>
            <button id="start-match-btn" class="btn">Empezar Partida</button>
        </div>

        <!-- Pantalla de Configuración de Rondas -->
        <div id="round-config-screen" class="screen">
            <button class="close-btn" data-target-screen="player-config-screen">×</button>
            <h2>¿Cuántas preguntas por jugador?</h2>
            <div class="round-count-selector">
                <button id="decrease-rounds-btn">-</button>
                <span id="round-count">5</span>
                <button id="increase-rounds-btn">+</button>
            </div>
            <button id="start-game-from-rounds-btn" class="btn">¡A Jugar!</button>
        </div>

        <!-- Pantalla de Juego Principal -->
        <div id="game-screen" class="screen">
            <button class="close-btn" data-target-screen="confirm-exit">×</button>
            <button id="show-score-btn" class="fas fa-medal"></button>
            <span id="current-player-turn-display"></span>
            <div id="question-area">
                <div class="category-display">
                    <i id="category-icon" class="fas fa-question-circle"></i>
                    <span id="category-name">Categoría</span>
                </div>
                <p id="question-text">Cargando pregunta...</p>
                <div id="options-grid" class="options-grid">
                    <button class="option-btn" data-option="A">A) Opción 1</button>
                    <button class="option-btn" data-option="B">B) Opción 2</button>
                    <button class="option-btn" data-option="C">C) Opción 3</button>
                    <button class="option-btn" data-option="D">D) Opción 4</button>
                </div>
            </div>
            <div id="feedback-message">
                <p id="feedback-text"></p>
                <button id="close-feedback-btn" class="close-feedback-btn">×</button>
            </div>
        </div>

        <!-- Pantalla de Fin de Juego -->
        <div id="end-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">×</button>
            <div id="confetti-container"></div>
            <h2>¡Partida Terminada!</h2>
            <h3 id="winner-display"></h3>
            <div id="final-scores"></div>
            <button id="play-again-btn" class="btn">Volver a Jugar</button>
        </div>

        <!-- Modal del Marcador -->
        <div id="score-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" data-target-screen="hide-modal">×</button>
                <h3>Clasificación Actual</h3>
                <ul id="modal-score-list"></ul>
            </div>
        </div>

        <!-- Modal de Confirmación de Salida -->
        <div id="confirm-exit-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>¿Estás seguro que quieres salir?</h3>
                <p>Se perderá el progreso actual de la partida.</p>
                <button id="confirm-exit-yes" class="btn">Sí, salir</button>
                <button id="confirm-exit-no" class="btn">No, continuar</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS (Se cargará desde preguntas.json) ---
        let gameData = {};

        // --- VARIABLES GLOBALES DEL JUEGO ---
        let players = [];
        let currentPlayerIndex = 0;
        let currentQuestionIndex = 0;
        let questionsPerGame = 0;
        let questionsPerPlayer = 5;
        let shuffledQuestions = [];
        let feedbackTimer = null;
        const randomRailwayNames = ["Traviesín", "Tunelillo", "Rielín", "Vibración Veloz", "Balasto Boss", "Catenaria Kid", "Señalino", "Durmiente Dinámico", "Fibra Óptica Fan", "Amolador As", "Bateadora Berta", "Inspector Hilario", "Durmiente Ágil", "Biela Veloz", "Trenelito", "Vía Láctea", "Pantógrafo Power", "Señor Señal", "Cat-enaria", "Ingeniero Rieles", "Desvío Divertido", "Terraplén Teo", "Túnelín el Astuto", "Puente Patán", "Balasto Brillante", "Soldador Sergio", "Frenada Fantástica", "Inspector Javier"];
        let usedRandomNames = new Set();

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const splashScreen = document.getElementById('splash-screen');
        const playerConfigScreen = document.getElementById('player-config-screen');
        const roundConfigScreen = document.getElementById('round-config-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const decreasePlayersBtn = document.getElementById('decrease-players-btn');
        const increasePlayersBtn = document.getElementById('increase-players-btn');
        const playerCountSpan = document.getElementById('player-count');
        const playerInputsDiv = document.getElementById('player-inputs');
        const startMatchBtn = document.getElementById('start-match-btn');
        const decreaseRoundsBtn = document.getElementById('decrease-rounds-btn');
        const increaseRoundsBtn = document.getElementById('increase-rounds-btn');
        const roundCountSpan = document.getElementById('round-count');
        const startGameFromRoundsBtn = document.getElementById('start-game-from-rounds-btn');
        const currentPlayerTurnDisplay = document.getElementById('current-player-turn-display');
        const questionTextP = document.getElementById('question-text');
        const optionsGridDiv = document.getElementById('options-grid');
        const optionButtons = optionsGridDiv.querySelectorAll('.option-btn');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const feedbackTextP = document.getElementById('feedback-text');
        const closeFeedbackBtn = document.getElementById('close-feedback-btn');
        const winnerDisplayH3 = document.getElementById('winner-display');
        const finalScoresDiv = document.getElementById('final-scores');
        const playAgainBtn = document.getElementById('play-again-btn');
        const confettiContainer = document.getElementById('confetti-container');
        const scoreModal = document.getElementById('score-modal');
        const modalScoreList = document.getElementById('modal-score-list');
        const showScoreBtn = document.getElementById('show-score-btn');
        const confirmExitModal = document.getElementById('confirm-exit-modal');
        const confirmExitYesBtn = document.getElementById('confirm-exit-yes');
        const confirmExitNoBtn = document.getElementById('confirm-exit-no');
        let categoryIcon, categoryNameSpan;

        // --- FUNCIONES ---
        function showScreen(screenToShow) { const allScreens = [splashScreen, playerConfigScreen, roundConfigScreen, gameScreen, endScreen]; allScreens.forEach(screen => { screen.classList.toggle('active', screen === screenToShow); }); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function getRandomRailwayName() { if (usedRandomNames.size === randomRailwayNames.length) { usedRandomNames.clear(); } let name; do { name = randomRailwayNames[Math.floor(Math.random() * randomRailwayNames.length)]; } while (usedRandomNames.has(name)); usedRandomNames.add(name); return name; }
        function updatePlayerInputs() { const playerCount = parseInt(playerCountSpan.textContent); playerInputsDiv.innerHTML = ''; for (let i = 0; i < playerCount; i++) { const playerInputGroup = document.createElement('div'); playerInputGroup.classList.add('player-input-group'); playerInputGroup.innerHTML = `<label for="player-name-${i + 1}">Jugador ${i + 1}:</label><input type="text" id="player-name-${i + 1}" placeholder="Introduce tu nombre" value="Jugador ${i + 1}"><button type="button" class="random-name-btn" data-player-index="${i}">Nombre Aleatorio</button>`; playerInputsDiv.appendChild(playerInputGroup); } playerInputsDiv.querySelectorAll('.random-name-btn').forEach(button => { button.addEventListener('click', () => { const index = button.dataset.playerIndex; document.getElementById(`player-name-${parseInt(index) + 1}`).value = getRandomRailwayName(); }); }); }
        
        function displayQuestion() {
            categoryIcon = document.getElementById('category-icon');
            categoryNameSpan = document.getElementById('category-name');
            feedbackMessageDiv.classList.remove('show');
            if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
            optionButtons.forEach(button => { button.disabled = true; button.classList.remove('correct', 'incorrect'); });
            questionTextP.classList.add('fade-out-text');

            setTimeout(() => {
                if (currentQuestionIndex >= questionsPerGame) { endGame(); return; }
                const question = shuffledQuestions[currentQuestionIndex];
                categoryNameSpan.textContent = question.category;
                switch (question.category) {
                    case "Elementos Estructurales de la Vía": categoryIcon.className = 'fas fa-road'; break;
                    case "Maquinaria y Herramientas": categoryIcon.className = 'fas fa-cogs'; break;
                    case "Sistemas y Tecnologías": categoryIcon.className = 'fas fa-lightbulb'; break;
                    default: categoryIcon.className = 'fas fa-question-circle';
                }
                
                // CAMBIO: Lógica para animar el turno del jugador
                currentPlayerTurnDisplay.classList.remove('animate-in');
                currentPlayerTurnDisplay.innerHTML = `<i class="fas fa-user-circle"></i> Turno de: ${players[currentPlayerIndex].name}`;
                void currentPlayerTurnDisplay.offsetWidth;
                currentPlayerTurnDisplay.classList.add('animate-in');
                
                questionTextP.textContent = question.pregunta;
                questionTextP.classList.remove('fade-out-text');
                questionTextP.classList.add('fade-in-text');
                optionButtons.forEach((button, index) => { button.textContent = question.opciones[index]; button.disabled = false; });
            }, 500);
        }

        function checkAnswer(selectedOption) { const currentQuestion = shuffledQuestions[currentQuestionIndex]; const correctOption = currentQuestion.respuestaCorrecta; const selectedButton = optionsGridDiv.querySelector(`[data-option="${selectedOption}"]`); optionButtons.forEach(button => button.disabled = true); if (selectedOption === correctOption) { players[currentPlayerIndex].score++; selectedButton.classList.add('correct'); } else { selectedButton.classList.add('incorrect'); optionsGridDiv.querySelector(`[data-option="${correctOption}"]`).classList.add('correct'); } feedbackTextP.textContent = currentQuestion.explicacion; feedbackMessageDiv.classList.add('show'); if (feedbackTimer) { clearTimeout(feedbackTimer); } feedbackTimer = setTimeout(() => { nextTurn(); }, 5000); }
        function nextTurn() { if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; } optionButtons.forEach(button => { button.classList.remove('correct', 'incorrect'); button.disabled = false; }); feedbackMessageDiv.classList.remove('show'); currentQuestionIndex++; if (currentQuestionIndex >= questionsPerGame) { endGame(); return; } currentPlayerIndex = (currentPlayerIndex + 1) % players.length; displayQuestion(); }
        function startGame() { players.forEach(p => p.score = 0); currentPlayerIndex = 0; currentQuestionIndex = 0; usedRandomNames.clear(); let allQuestions = []; for (const category in gameData.preguntas) { gameData.preguntas[category].forEach(q => allQuestions.push({ ...q, category })); } shuffledQuestions = shuffleArray(allQuestions).slice(0, questionsPerGame); showScreen(gameScreen); displayQuestion(); }
        function endGame() { showScreen(endScreen); players.sort((a, b) => b.score - a.score); winnerDisplayH3.style.animation = 'none'; void winnerDisplayH3.offsetWidth; winnerDisplayH3.style.animation = null; if (players.length > 0) { winnerDisplayH3.textContent = `¡El ganador es ${players[0].name} con ${players[0].score} puntos!`; if (players.length > 1 && players[0].score === players[1].score) { const tiedWinners = players.filter(p => p.score === players[0].score).map(p => p.name).join(' y '); winnerDisplayH3.textContent = `¡Empate! Los ganadores son ${tiedWinners} con ${players[0].score} puntos!`; } } generateConfetti(); finalScoresDiv.innerHTML = ''; players.forEach(player => { const scoreDiv = document.createElement('div'); scoreDiv.className = 'final-player-score'; scoreDiv.innerHTML = `<span class="name">${player.name}</span> <span class="score">${player.score} puntos</span>`; finalScoresDiv.appendChild(scoreDiv); }); }
        function generateConfetti() { /* ... código confeti sin cambios ... */ }
        function displayUIMessage(message, type = 'info') { /* ... código ui message sin cambios ... */ }
        function showScoreModal() { /* ... código modal sin cambios ... */ }
        function hideScoreModal() { scoreModal.classList.remove('active'); }
        function showConfirmExitModal() { confirmExitModal.classList.add('active'); }
        function hideConfirmExitModal() { confirmExitModal.classList.remove('active'); }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            fetch('preguntas.json').then(r => r.ok ? r.json() : Promise.reject('err')).then(d => { gameData = d; initializeEventListeners(); }).catch(e => { console.error("Error cargando preguntas:", e); splashScreen.innerHTML = `<h1>Error de Carga</h1><p>No se pudieron cargar las preguntas.</p>`; });
            
            function initializeEventListeners() {
                const maxQuestionsAvailable = Object.values(gameData.preguntas).flat().length;
                startGameBtn.addEventListener('click', () => { showScreen(playerConfigScreen); updatePlayerInputs(); });
                decreasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) > 1) { playerCountSpan.textContent--; updatePlayerInputs(); } });
                increasePlayersBtn.addEventListener('click', () => { if (parseInt(playerCountSpan.textContent) < 5) { playerCountSpan.textContent++; updatePlayerInputs(); } });
                startMatchBtn.addEventListener('click', () => { players = []; let allNamesEntered = true; for (let i = 0; i < parseInt(playerCountSpan.textContent); i++) { const nameInput = document.getElementById(`player-name-${i + 1}`); const name = nameInput.value.trim(); if (name === "") { allNamesEntered = false; nameInput.style.borderColor = 'rgb(203, 24, 35)'; } else { nameInput.style.borderColor = 'rgb(230, 230, 230)'; players.push({ name, score: 0 }); } } if (allNamesEntered && players.length > 0) { showScreen(roundConfigScreen); const maxAllowed = Math.floor(maxQuestionsAvailable / players.length); questionsPerPlayer = Math.min(questionsPerPlayer, maxAllowed) || 1; roundCountSpan.textContent = questionsPerPlayer; } });
                decreaseRoundsBtn.addEventListener('click', () => { if (questionsPerPlayer > 1) { questionsPerPlayer--; roundCountSpan.textContent = questionsPerPlayer; } });
                increaseRoundsBtn.addEventListener('click', () => { const maxAllowed = Math.floor(maxQuestionsAvailable / players.length); if (questionsPerPlayer < maxAllowed) { questionsPerPlayer++; roundCountSpan.textContent = questionsPerPlayer; } else { displayUIMessage(`No hay suficientes preguntas para ${questionsPerPlayer + 1} rondas.`, 'info'); } });
                startGameFromRoundsBtn.addEventListener('click', () => { questionsPerGame = questionsPerPlayer * players.length; startGame(); });
                optionButtons.forEach(button => { button.addEventListener('click', (event) => checkAnswer(event.target.dataset.option)); });
                showScoreBtn.addEventListener('click', showScoreModal);
                playAgainBtn.addEventListener('click', () => showScreen(splashScreen));
                document.querySelectorAll('.close-btn').forEach(button => { button.addEventListener('click', (event) => { const target = event.target.dataset.targetScreen; if (target === 'confirm-exit') { showConfirmExitModal(); } else if (target === 'hide-modal') { hideScoreModal(); } else { showScreen(document.getElementById(target)); } }); });
                confirmExitYesBtn.addEventListener('click', () => { hideConfirmExitModal(); showScreen(splashScreen); });
                confirmExitNoBtn.addEventListener('click', hideConfirmExitModal);
                closeFeedbackBtn.addEventListener('click', nextTurn);
            }
        });
    </script>
</body>
</html>