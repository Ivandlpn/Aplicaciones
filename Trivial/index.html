<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivial Ferroviario INECO</title>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables de colores INECO */
        :root {
            --ineco-azul-principal: rgb(26, 68, 136);
            --ineco-rojo-acento: rgb(203, 24, 35);
            --ineco-azul-claro: rgb(52, 99, 172);
            --ineco-azul-aun-mas-claro: rgb(107, 150, 207);
            --ineco-blanco-puro: rgb(255, 255, 255);
            --ineco-gris-oscuro: rgb(50, 50, 50);
            --ineco-gris-claro: rgb(230, 230, 230);
            --ineco-verde-correcto: rgb(76, 175, 80); /* Verde para respuestas correctas */
            --ineco-rojo-incorrecto: rgb(244, 67, 54); /* Rojo para respuestas incorrectas */

            /* Fuentes */
            --font-poppins: 'Poppins', sans-serif;
        }

        /* Estilos generales */
        body {
            font-family: var(--font-poppins);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--ineco-azul-principal) 70%, var(--ineco-rojo-acento) 100%);
            color: var(--ineco-gris-oscuro);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll horizontal */
            transition: background 0.5s ease-in-out;
        }

        #app-container {
            background-color: var(--ineco-blanco-puro);
            border-radius: 20px; /* Formas redondeadas clave */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 900px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            opacity: 0; /* Inicialmente oculto para animación de carga */
            transform: translateY(20px);
            animation: fadeInScale 0.8s forwards ease-out;
        }

        /* Animación de entrada general */
        @keyframes fadeInScale {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header */
        header {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            z-index: 10;
        }

        .logo {
            font-family: var(--font-poppins);
            font-weight: 600; /* Poppins Semibold para el logo */
            font-size: 2.2em;
            color: var(--ineco-blanco-puro); /* Logo blanco sobre fondo oscuro */
            padding-left: 1.5em; /* Espacio de exclusión, aprox altura de 'n' */
            position: relative;
        }
        /* Simulación de la 'n' para el espacio de exclusión */
        .logo::before {
            content: 'n';
            visibility: hidden;
            font-size: 1em; /* Misma altura que la 'n' real */
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .header-buttons {
            display: flex;
            gap: 15px; /* Espacio entre los botones del header */
        }

        .sound-toggle, .exit-game-button, .leaderboard-button { /* Clase para botones de icono en header */
            background: none;
            border: none;
            color: var(--ineco-blanco-puro);
            font-size: 1.8em;
            cursor: pointer;
            transition: color 0.3s ease;
            outline: none;
        }
        .sound-toggle:hover, .exit-game-button:hover, .leaderboard-button:hover {
            color: var(--ineco-rojo-acento);
        }

        /* Estilos de pantallas */
        .screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(100%); /* Preparado para slide-in */
            box-sizing: border-box;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
            position: relative; /* Para que ocupe espacio en el flexbox */
        }

        /* Splash Screen */
        #splash-screen {
            background: url('https://placehold.co/900x600/1A4488/FFFFFF?text=Trivial+Ferroviario') no-repeat center center / cover;
            color: var(--ineco-blanco-puro);
            justify-content: space-around;
            padding: 80px 40px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #splash-screen h2 {
            font-size: 3.5em; /* H1: 36-48px */
            font-weight: 600; /* Poppins Semibold */
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Player Setup Screen */
        #player-setup {
            background-color: var(--ineco-blanco-puro);
        }
        #player-setup h2 {
            font-size: 2.5em; /* H2: 28-34px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }
        .player-count-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .player-count-selector button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 10px; /* Redondeado */
            padding: 10px 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .player-count-selector button:hover {
            background-color: var(--ineco-rojo-acento);
        }
        .player-count-selector span {
            font-size: 2em;
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-azul-principal);
        }
        #player-inputs {
            display: flex;
            flex-wrap: wrap; /* Para responsive */
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            max-height: 300px; /* Limita altura para scroll si hay muchos jugadores */
            overflow-y: auto; /* Permite scroll */
            padding: 10px;
            width: 100%;
        }
        .player-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            min-width: 200px; /* Ancho mínimo para cada grupo */
        }
        .player-input-group input {
            padding: 12px 15px;
            border: 2px solid var(--ineco-azul-claro);
            border-radius: 10px; /* Redondeado */
            font-size: 1.1em;
            font-family: var(--font-poppins);
            color: var(--ineco-gris-oscuro);
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .player-input-group input:focus {
            outline: none;
            border-color: var(--ineco-rojo-acento);
        }
        .player-input-group button {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 8px; /* Redondeado */
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .player-input-group button:hover {
            background-color: var(--ineco-rojo-acento);
        }
        .player-setup-buttons { /* Nuevo contenedor para botones en player-setup */
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Game Screen */
        #game-screen {
            background-color: var(--ineco-blanco-puro);
            justify-content: flex-start;
            padding-top: 20px;
        }
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .game-info div {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500; /* Poppins Medium */
            font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .question-container {
            background-color: var(--ineco-gris-claro);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            width: 90%;
            max-width: 800px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.05);
            text-align: left;
            position: relative;
        }
        .question-container h3 {
            font-size: 1.8em; /* H3: 22-26px */
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .category-tag {
            background-color: var(--ineco-rojo-acento);
            color: var(--ineco-blanco-puro);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            position: absolute;
            top: -15px;
            left: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 90%;
            max-width: 800px;
        }
        .option-button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 12px; /* Redondeado */
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 400; /* Poppins Regular */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-align: left;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .option-button:hover {
            background-color: var(--ineco-rojo-acento);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        .option-button.correct {
            background-color: var(--ineco-verde-correcto);
            animation: pulseCorrect 0.5s ease-in-out;
        }
        .option-button.incorrect {
            background-color: var(--ineco-rojo-incorrecto);
            animation: shake 0.5s ease-in-out;
        }

        /* Animaciones de respuesta */
        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Feedback Message */
        #feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--ineco-blanco-puro);
            padding: 30px 40px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        #feedback-message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        #feedback-message p {
            margin: 0 0 15px 0;
        }
        #feedback-message .explanation {
            font-size: 0.8em;
            font-weight: 400;
            color: var(--ineco-gris-claro);
            margin-top: 10px;
            max-width: 400px;
        }

        /* End Screen */
        #end-screen {
            background-color: var(--ineco-blanco-puro);
        }
        #end-screen h2 {
            font-size: 3em; /* H1 */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }
        #end-screen h3 {
            font-size: 2em; /* H2 */
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-rojo-acento);
            margin-bottom: 20px;
        }
        .final-scores {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .player-score-card {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            text-align: center;
            position: relative; /* Para posicionar el botón de cerrar */
        }
        .player-score-card span {
            display: block;
            font-size: 1.2em;
            font-weight: 500; /* Poppins Medium */
            margin-bottom: 5px;
        }
        .player-score-card strong {
            font-size: 2.5em;
            font-weight: 700; /* Poppins Bold */
        }
        .close-card-btn { /* Estilo para el botón 'X' en las tarjetas de puntuación */
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: var(--ineco-blanco-puro);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .close-card-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--ineco-rojo-acento);
        }
        .end-screen-buttons { /* Nuevo contenedor para botones en end-screen */
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Botones generales */
        .btn-primary {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 15px; /* Muy redondeado */
            padding: 15px 35px;
            font-size: 1.3em; /* Semibold */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px; /* Espaciado */
        }
        .btn-primary:hover {
            background-color: var(--ineco-rojo-acento);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* Leaderboard Modal */
        #leaderboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #leaderboard-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .leaderboard-content {
            background-color: var(--ineco-blanco-puro);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            max-height: 80vh; /* Limitar altura para scroll si hay muchos jugadores */
            overflow-y: auto;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        #leaderboard-modal.show .leaderboard-content {
            transform: translateY(0);
        }
        .leaderboard-content h2 {
            color: var(--ineco-azul-principal);
            font-size: 2.5em;
            margin-bottom: 25px;
            font-weight: 600;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--ineco-gris-claro);
            text-align: left;
            font-size: 1.1em;
        }
        .leaderboard-table th {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            font-weight: 600;
            position: sticky; /* Encabezado pegajoso para scroll */
            top: 0;
            z-index: 1;
        }
        .leaderboard-table tbody tr:nth-child(even) {
            background-color: var(--ineco-gris-claro);
        }
        .leaderboard-table tbody tr:hover {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            cursor: default;
        }
        .leaderboard-table td:first-child { /* Columna de rango */
            font-weight: 700;
            color: var(--ineco-rojo-acento);
        }
        .leaderboard-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--ineco-gris-oscuro);
            font-size: 2em;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .leaderboard-close-btn:hover {
            color: var(--ineco-rojo-acento);
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            #app-container {
                width: 95%;
                min-height: 500px;
                margin: 20px 0;
            }
            header {
                padding: 15px 20px;
            }
            .logo {
                font-size: 1.8em;
                padding-left: 1em;
            }
            .sound-toggle, .exit-game-button, .leaderboard-button {
                font-size: 1.5em;
            }
            .screen {
                padding: 20px;
            }
            #splash-screen h2 {
                font-size: 2.5em;
            }
            #player-setup h2, #end-screen h2 {
                font-size: 2em;
            }
            .player-count-selector {
                gap: 10px;
            }
            .player-count-selector button {
                padding: 8px 12px;
                font-size: 1.2em;
            }
            .player-count-selector span {
                font-size: 1.5em;
            }
            #player-inputs {
                flex-direction: column;
                max-height: 250px;
                padding: 5px; /* Reducir padding */
            }
            .player-input-group {
                width: 90%; /* Aumentar ancho para ocupar más espacio */
                max-width: none;
            }
            .player-input-group input {
                max-width: 100%; /* Asegurar que el input no desborde */
            }
            .player-setup-buttons, .end-screen-buttons {
                flex-direction: column; /* Apilar botones en móvil */
                gap: 15px;
            }
            .game-info {
                flex-direction: column; /* Apilar elementos en móvil */
                gap: 10px; /* Espacio entre elementos apilados */
                padding: 0 10px; /* Reducir padding lateral */
            }
            .game-info div {
                padding: 8px 15px; /* Reducir padding */
                font-size: 1em;
            }
            .question-container {
                padding: 20px; /* Reducir padding */
            }
            .question-container h3 {
                font-size: 1.4em;
            }
            .option-button {
                padding: 12px 20px;
                font-size: 1em;
            }
            #feedback-message {
                padding: 20px 30px;
                font-size: 1.2em;
            }
            #feedback-message .explanation {
                font-size: 0.7em;
            }
            .final-scores {
                flex-direction: column;
                gap: 15px; /* Reducir espacio */
            }
            .player-score-card {
                min-width: unset;
                width: 85%; /* Ajustar ancho */
                padding: 15px 20px; /* Reducir padding */
            }
            .player-score-card strong {
                font-size: 2em;
            }
            .btn-primary {
                padding: 12px 25px;
                font-size: 1.1em;
            }
            .leaderboard-content {
                padding: 20px;
            }
            .leaderboard-content h2 {
                font-size: 2em;
            }
            .leaderboard-table th, .leaderboard-table td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .leaderboard-close-btn {
                font-size: 1.5em;
            }
        }

        @media (max-width: 480px) {
            #app-container {
                border-radius: 10px;
            }
            header {
                padding: 10px 15px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }
            .logo {
                font-size: 1.5em;
                padding-left: 0.8em;
            }
            .sound-toggle, .exit-game-button, .leaderboard-button {
                font-size: 1.2em;
            }
            #splash-screen h2 {
                font-size: 2em;
            }
            #player-setup h2, #end-screen h2 {
                font-size: 1.8em;
            }
            .question-container h3 {
                font-size: 1.2em;
            }
            .option-button {
                font-size: 0.9em;
            }
            .btn-primary {
                font-size: 1em;
            }
            .player-input-group {
                width: 95%; /* Ajuste final para pantallas muy pequeñas */
            }
            #player-inputs {
                padding: 0; /* Eliminar padding en pantallas muy pequeñas */
            }
            .leaderboard-table th, .leaderboard-table td {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 class="logo">ineco</h1>
            <div class="header-buttons">
                <button id="soundToggle" class="sound-toggle">
                    <i class="fas fa-volume-mute"></i> <!-- Icono de sonido apagado por defecto -->
                </button>
                <button id="leaderboardButton" class="leaderboard-button">
                    <i class="fas fa-trophy"></i>
                </button>
                <button id="exitGameButton" class="exit-game-button">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
        </header>

        <!-- Pantalla de Inicio -->
        <section id="splash-screen" class="screen active">
            <h2>Trivial Ferroviario</h2>
            <button id="startGameButton" class="btn-primary">Iniciar Juego</button>
        </section>

        <!-- Configuración de Jugadores -->
        <section id="player-setup" class="screen">
            <h2>Configuración de Jugadores</h2>
            <div class="player-count-selector">
                <button id="decreasePlayers">-</button>
                <span>Jugadores: <span id="playerCount">1</span></span>
                <button id="increasePlayers">+</button>
            </div>
            <div id="player-inputs">
                <!-- Los campos de jugador se generarán aquí -->
            </div>
            <div class="player-setup-buttons">
                <button id="startQuizButton" class="btn-primary">Empezar Partida</button>
                <button id="backToSplashFromSetup" class="btn-primary">Volver</button>
            </div>
        </section>

        <!-- Pantalla de Juego -->
        <section id="game-screen" class="screen">
            <div class="game-info">
                <div id="currentPlayerInfo">Turno de: Jugador 1</div>
                <div id="categoryInfo">Categoría:</div>
                <div id="scoreInfo">Puntuación: 0</div>
            </div>
            <div class="question-container">
                <span class="category-tag" id="currentCategoryTag"></span>
                <h3 id="questionText">Cargando pregunta...</h3>
            </div>
            <div id="optionsContainer" class="options-container">
                <button class="option-button" data-option="A">Opción A</button>
                <button class="option-button" data-option="B">Opción B</button>
                <button class="option-button" data-option="C">Opción C</button>
                <button class="option-button" data-option="D">Opción D</button>
            </div>
        </section>

        <!-- Pantalla de Fin de Juego -->
        <section id="end-screen" class="screen">
            <h2>¡Partida Terminada!</h2>
            <h3 id="winnerMessage"></h3>
            <div class="final-scores" id="finalScores">
                <!-- Las puntuaciones finales se generarán aquí -->
            </div>
            <div class="end-screen-buttons">
                <button id="restartGameButton" class="btn-primary">Volver a Jugar</button>
                <button id="closeGameButton" class="btn-primary">Cerrar</button>
            </div>
        </section>

        <!-- Mensaje de Feedback (Correcto/Incorrecto) -->
        <div id="feedback-message">
            <p id="feedbackText"></p>
            <p class="explanation" id="explanationText"></p>
        </div>

        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal">
            <div class="leaderboard-content">
                <button id="leaderboardCloseBtn" class="leaderboard-close-btn">
                    <i class="fas fa-times"></i>
                </button>
                <h2>Clasificación</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Pos.</th>
                            <th>Nombre</th>
                            <th>Correctas</th>
                            <th>Puntos</th>
                            <th>Preguntas Vistas</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <!-- Contenido de la clasificación se generará aquí -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Datos de las preguntas (JSON incrustado)
        const questionsData = {
            "preguntas": {
                "Elementos Estructurales de la Vía": [
                    {
                        "pregunta": "¿Cuál es la función principal del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "Asegurar la conductividad eléctrica de los carriles.",
                            "Transmitir las cargas de los trenes al terreno y asegurar la estabilidad de la vía.",
                            "Reducir la fricción entre la rueda y el carril.",
                            "Actuar como aislante térmico."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El balasto distribuye las cargas de las traviesas al terraplén, proporciona drenaje y contribuye a la estabilidad lateral y longitudinal de la vía, esencial para las altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué técnica se utiliza comúnmente para el mantenimiento del perfil del carril y la eliminación de defectos superficiales en vías de alta velocidad?",
                        "opciones": [
                            "Bateo de balasto.",
                            "Reemplazo completo de carril.",
                            "Esmerilado o amolado de carril.",
                            "Engrasado de las sujeciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El esmerilado de carril permite restaurar el perfil óptimo, eliminar ondulaciones y grietas superficiales, prolongando la vida útil del carril y mejorando la calidad de rodadura."
                    },
                    {
                        "pregunta": "¿Qué tipo de sujeción es más común en las vías de alta velocidad para asegurar la rigidez y el aislamiento eléctrico?",
                        "opciones": [
                            "Brida metálica.",
                            "Sujeción rígida con tornillos de banco.",
                            "Sujeción elástica con almohadilla de caucho y grapas.",
                            "Clavos de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las sujeciones elásticas, como las de tipo Pandrol o Vossloh, proporcionan una fijación constante del carril a la traviesa, absorben vibraciones y garantizan el aislamiento eléctrico, crucial para los sistemas de señalización."
                    },
                    {
                        "pregunta": "¿Cuál es la principal diferencia entre una traviesa monobloque y una bibloque en términos de su comportamiento en la vía de alta velocidad?",
                        "opciones": [
                            "La monobloque es más flexible y la bibloque más rígida.",
                            "La monobloque es de madera y la bibloque de hormigón.",
                            "La monobloque ofrece mayor rigidez transversal y mejor comportamiento frente a la deformación lateral.",
                            "La bibloque permite un menor ancho de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las traviesas monobloque de hormigón pretensado son el estándar en alta velocidad debido a su mayor masa y rigidez, que optimizan la transmisión de cargas y la estabilidad geométrica de la vía."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de los cordones de soldadura en los carriles de una vía de alta velocidad?",
                        "opciones": [
                            "Aumentar la resistencia a la abrasión del carril.",
                            "Unir los tramos de carril de forma continua para evitar juntas y mejorar la rodadura.",
                            "Facilitar la dilatación térmica de los carriles.",
                            "Servir como punto de anclaje para los sistemas de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La soldadura continua de carril (CRC) elimina las juntas, lo que mejora el confort de viaje, reduce el ruido y las vibraciones, y minimiza el mantenimiento de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué se busca optimizar al realizar una compactación dinámica del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "La capacidad de drenaje del balasto.",
                            "La resistencia del balasto a la pulverización.",
                            "La uniformidad de la densidad y la resistencia al asiento de la banqueta de balasto.",
                            "La temperatura del balasto para evitar dilataciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La compactación dinámica mejora la estabilidad y la resistencia del balasto, asegurando que la geometría de la vía se mantenga estable bajo las cargas dinámicas de los trenes de alta velocidad."
                    },
                    {
                        "pregunta": "¿Cuál es el objetivo principal del mantenimiento de la explanación y el terraplén en una línea de alta velocidad?",
                        "opciones": [
                            "Mejorar el paisaje circundante.",
                            "Asegurar la estabilidad geotécnica de la plataforma y el drenaje adecuado.",
                            "Reducir el coste de construcción de la vía.",
                            "Facilitar la instalación de la catenaria."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Una plataforma estable y un buen drenaje son fundamentales para evitar asientos diferenciales y deformaciones de la vía, que comprometerían la seguridad y el confort a altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué tipo de sistema de drenaje es crucial en túneles de alta velocidad para evitar la acumulación de agua?",
                        "opciones": [
                            "Acequias a cielo abierto.",
                            "Bombas de achique manuales.",
                            "Cunetas, colectores y pozos de bombeo integrados en la infraestructura.",
                            "Filtración natural a través del balasto."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El drenaje en túneles es vital para prevenir la inundación, la corrosión de elementos metálicos y el deterioro de la infraestructura, asegurando la operatividad de la línea."
                    },
                    {
                        "pregunta": "¿Qué función cumple la capa de subbalasto en la superestructura de una vía de alta velocidad?",
                        "opciones": [
                            "Aislar térmicamente el balasto.",
                            "Evitar la mezcla del balasto con el material del terraplén y mejorar la distribución de cargas.",
                            "Actuar como elemento conductor de la señalización.",
                            "Soportar directamente el peso de los trenes."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El subbalasto actúa como una capa de transición entre el balasto y la explanación, impidiendo la contaminación del balasto y mejorando la uniformidad de la transmisión de tensiones."
                    },
                    {
                        "pregunta": "¿Qué se entiende por 'recalzado' de traviesas en el mantenimiento ferroviario?",
                        "opciones": [
                            "El proceso de añadir una nueva traviesa a la vía.",
                            "La sustitución de los carriles sobre las traviesas existentes.",
                            "La adición de balasto bajo las traviesas para mejorar el apoyo y la nivelación.",
                            "La limpieza de la superficie de las traviesas."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El recalzado consiste en introducir balasto debajo de las traviesas, generalmente mediante bateadoras, para corregir la nivelación y alineación de la vía."
                    }
                ],
                "Maquinaria y Herramientas": [
                    {
                        "pregunta": "¿Cuál es la función principal de una bateadora pesada en el mantenimiento de vías de alta velocidad?",
                        "opciones": [
                            "Soldar automáticamente los carriles.",
                            "Limpiar la superficie de los carriles.",
                            "Compactar el balasto bajo las traviesas para corregir la geometría de la vía.",
                            "Inspeccionar visualmente el estado de la catenaria."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las bateadoras son máquinas esenciales para el mantenimiento de la geometría de la vía (alineación, nivelación, peralte) mediante la vibración y compactación del balasto."
                    },
                    {
                        "pregunta": "¿Qué equipo se utiliza para medir con precisión la altura y la flecha de la catenaria en una línea de alta velocidad?",
                        "opciones": [
                            "Un nivel óptico y una mira topográfica.",
                            "Un carro de auscultación de catenaria o drones con sistemas láser.",
                            "Un voltímetro de alta tensión.",
                            "Un dinamómetro."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La precisión en la medición de la catenaria es crítica para asegurar el correcto contacto con el pantógrafo a altas velocidades y evitar desprendimientos."
                    },
                    {
                        "pregunta": "¿Cuál es la principal ventaja de utilizar detectores de defectos por ultrasonidos en los carriles de alta velocidad?",
                        "opciones": [
                            "Identificar la temperatura de la superficie del carril.",
                            "Detectar fisuras internas y defectos ocultos que no son visibles a simple vista.",
                            "Medir la resistencia eléctrica del carril.",
                            "Determinar la composición química del acero del carril."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los ultrasonidos permiten un mantenimiento predictivo, detectando fallos incipientes antes de que se propaguen y comprometan la seguridad."
                    },
                    {
                        "pregunta": "¿Qué tipo de máquina es fundamental para el reperfilado de los carriles, mejorando la interacción rueda-carril y reduciendo el ruido?",
                        "opciones": [
                            "Una desguarnecedora.",
                            "Una perfiladora de carril (o amoladora de grandes dimensiones).",
                            "Una soldadora aluminotérmica.",
                            "Una bateadora ligera."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La perfiladora restaura la forma óptima de la cabeza del carril, mejorando la calidad de la rodadura y prolongando la vida útil del carril y de las ruedas."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de una máquina desguarnecedora en el mantenimiento de la vía?",
                        "opciones": [
                            "Retirar los residuos de balasto y limpiar la plataforma de la vía.",
                            "Soldar tramos de carril largos.",
                            "Perforar las traviesas para instalar sujeciones.",
                            "Transportar material de obra."
                        ],
                        "respuestaCorrecta": "A",
                        "explicacion": "La desguarnecedora limpia el balasto sucio o contaminado, lo que es vital para mantener la capacidad de drenaje y la elasticidad de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué herramienta manual es esencial para comprobar el apriete correcto de los tornillos en las uniones de carril o sujeciones?",
                        "opciones": [
                            "Un martillo de bola.",
                            "Una llave de grifa.",
                            "Una llave dinamométrica.",
                            "Un taladro percutor."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La llave dinamométrica asegura que el par de apriete sea el especificado, evitando tanto aflojamientos como sobretensiones que puedan dañar los elementos."
                    },
                    {
                        "pregunta": "¿Qué tipo de vehículo auxiliar se utiliza para el transporte de personal y pequeñas herramientas a lo largo de la vía?",
                        "opciones": [
                            "Un tren de obras.",
                            "Una locomotora de línea.",
                            "Una dresina o vagoneta de vía.",
                            "Un tren de socorro."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las dresinas son vehículos ligeros y versátiles, diseñados para moverse sobre la vía con rapidez y eficacia en operaciones de inspección y pequeño mantenimiento."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal de los trenes de auscultación en alta velocidad?",
                        "opciones": [
                            "Transportar viajeros a alta velocidad.",
                            "Medir y registrar continuamente los parámetros geométricos y dinámicos de la vía y la catenaria.",
                            "Realizar operaciones de soldadura en movimiento.",
                            "Apagar incendios en la infraestructura."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los trenes de auscultación son clave para el mantenimiento predictivo, permitiendo identificar anomalías y planificar intervenciones antes de que surjan problemas críticos."
                    },
                    {
                        "pregunta": "¿Qué se mide con una galga de vía?",
                        "opciones": [
                            "La altura de la catenaria.",
                            "El ancho de la vía (entre caras activas de los carriles).",
                            "La temperatura del carril.",
                            "La tensión de los cables de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El ancho de vía es un parámetro crítico para la seguridad y el confort, especialmente en alta velocidad, y su control es fundamental."
                    },
                    {
                        "pregunta": "¿Qué tipo de soldadura se utiliza más comúnmente para unir tramos de carril de forma rápida y eficiente en campo?",
                        "opciones": [
                            "Soldadura por resistencia eléctrica.",
                            "Soldadura TIG.",
                            "Soldadura aluminotérmica.",
                            "Soldadura por arco sumergido."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La soldadura aluminotérmica es ampliamente utilizada por su rapidez y por no requerir equipos eléctricos complejos en campo, aunque la soldadura por resistencia es el método preferido en talleres para la fabricación de carril continuo."
                    }
                ]
            }
        };

        // Referencias a elementos del DOM
        const appContainer = document.getElementById('app-container');
        const splashScreen = document.getElementById('splash-screen');
        const playerSetupScreen = document.getElementById('player-setup');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameButton = document.getElementById('startGameButton');
        const startQuizButton = document.getElementById('startQuizButton');
        const restartGameButton = document.getElementById('restartGameButton');
        const closeGameButton = document.getElementById('closeGameButton');
        const backToSplashFromSetup = document.getElementById('backToSplashFromSetup');
        const exitGameButton = document.getElementById('exitGameButton');
        const soundToggle = document.getElementById('soundToggle');
        const leaderboardButton = document.getElementById('leaderboardButton');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardCloseBtn = document.getElementById('leaderboardCloseBtn');
        const leaderboardTableBody = document.getElementById('leaderboardTableBody');

        const decreasePlayersBtn = document.getElementById('decreasePlayers');
        const increasePlayersBtn = document.getElementById('increasePlayers');
        const playerCountSpan = document.getElementById('playerCount');
        const playerInputsDiv = document.getElementById('player-inputs');

        const currentPlayerInfo = document.getElementById('currentPlayerInfo');
        const categoryInfo = document.getElementById('categoryInfo');
        const scoreInfo = document.getElementById('scoreInfo');
        const questionText = document.getElementById('questionText');
        const currentCategoryTag = document.getElementById('currentCategoryTag');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackText = document.getElementById('feedbackText');
        const explanationText = document.getElementById('explanationText');
        const winnerMessage = document.getElementById('winnerMessage');
        const finalScoresDiv = document.getElementById('finalScores');

        // Variables de estado del juego
        let players = [];
        let currentPlayerIndex = 0;
        let currentQuestionIndex = 0;
        let currentCategory = '';
        let availableQuestions = {}; // Copia de preguntas para gestionar las ya usadas
        let gameStarted = false;
        let soundOn = false; // Estado del sonido

        // Sonidos
        const correctSound = new Audio('https://www.soundjay.com/buttons/beep-07.mp3'); // Sonido de respuesta correcta
        const incorrectSound = new Audio('https://www.soundjay.com/buttons/beep-04.mp3'); // Sonido de respuesta incorrecta
        const clickSound = new Audio('https://www.soundjay.com/buttons/button-1.mp3'); // Sonido de click de botón

        // --- Funciones de Utilidad ---

        // Función para reproducir sonido si está activado
        function playSound(audio) {
            if (soundOn) {
                audio.play();
            }
        }

        // Función para cambiar de pantalla
        function showScreen(screenToShow) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            screenToShow.classList.add('active');
        }

        // Función para generar un ID de usuario único (para la clasificación)
        function generateUniqueId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para guardar la clasificación en localStorage
        function saveLeaderboard(entry) {
            let leaderboard = JSON.parse(localStorage.getItem('inecoTrivialLeaderboard')) || [];
            leaderboard.push(entry);
            // Ordenar por puntos (descendente) y luego por preguntas vistas (descendente)
            leaderboard.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return b.questionsSeen - a.questionsSeen;
            });
            // Limitar a los 10 mejores resultados
            leaderboard = leaderboard.slice(0, 10);
            localStorage.setItem('inecoTrivialLeaderboard', JSON.stringify(leaderboard));
        }

        // Función para cargar y mostrar la clasificación
        function loadLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('inecoTrivialLeaderboard')) || [];
            leaderboardTableBody.innerHTML = ''; // Limpiar tabla
            if (leaderboard.length === 0) {
                leaderboardTableBody.innerHTML = '<tr><td colspan="5">No hay datos en la clasificación aún.</td></tr>';
                return;
            }
            leaderboard.forEach((entry, index) => {
                const row = leaderboardTableBody.insertRow();
                row.insertCell(0).textContent = index + 1; // Posición
                row.insertCell(1).textContent = entry.name;
                row.insertCell(2).textContent = entry.correctAnswers;
                row.insertCell(3).textContent = entry.score;
                row.insertCell(4).textContent = entry.questionsSeen;
            });
        }

        // --- Lógica del Juego ---

        // Inicializa el juego
        function initializeGame() {
            players = [];
            currentPlayerIndex = 0;
            currentQuestionIndex = 0;
            gameStarted = false;
            // Reiniciar preguntas disponibles para una nueva partida
            availableQuestions = JSON.parse(JSON.stringify(questionsData.preguntas));
            showScreen(splashScreen);
        }

        // Genera los campos de entrada para los nombres de los jugadores
        function generatePlayerInputs(count) {
            playerInputsDiv.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const playerInputGroup = document.createElement('div');
                playerInputGroup.className = 'player-input-group';
                playerInputGroup.innerHTML = `
                    <label for="player${i + 1}">Jugador ${i + 1}:</label>
                    <input type="text" id="player${i + 1}" placeholder="Nombre del Jugador ${i + 1}" value="Jugador ${i + 1}">
                `;
                playerInputsDiv.appendChild(playerInputGroup);
            }
        }

        // Comienza la partida desde la configuración de jugadores
        function startQuiz() {
            players = [];
            let allNamesValid = true;
            for (let i = 0; i < parseInt(playerCountSpan.textContent); i++) {
                const input = document.getElementById(`player${i + 1}`);
                const name = input.value.trim();
                if (name === '') {
                    allNamesValid = false;
                    input.style.borderColor = varineco-rojo-incorrecto; // Resaltar campo vacío
                } else {
                    input.style.borderColor = ''; // Restablecer borde
                    players.push({
                        id: generateUniqueId(), // Asignar un ID único
                        name: name,
                        score: 0,
                        correctAnswers: 0,
                        questionsSeen: 0,
                        answeredQuestions: [] // Para evitar repetir preguntas
                    });
                }
            }

            if (!allNamesValid) {
                showFeedback('Por favor, introduce todos los nombres de los jugadores.', false, '');
                return;
            }

            gameStarted = true;
            availableQuestions = JSON.parse(JSON.stringify(questionsData.preguntas)); // Resetear preguntas
            nextQuestion();
            showScreen(gameScreen);
        }

        // Muestra la siguiente pregunta o termina el juego
        function nextQuestion() {
            if (!gameStarted) return; // Asegurarse de que el juego está activo

            const currentPlayer = players[currentPlayerIndex];
            currentPlayerInfo.textContent = `Turno de: ${currentPlayer.name}`;
            scoreInfo.textContent = `Puntuación: ${currentPlayer.score}`;

            let categories = Object.keys(availableQuestions);
            if (categories.length === 0) {
                // Todas las preguntas han sido usadas o no hay preguntas disponibles
                endGame();
                return;
            }

            // Seleccionar una categoría aleatoria de las disponibles
            currentCategory = categories[Math.floor(Math.random() * categories.length)];
            let questionsInCategory = availableQuestions[currentCategory];

            // Filtrar preguntas que el jugador actual ya ha respondido
            let unansweredQuestions = questionsInCategory.filter(q => !currentPlayer.answeredQuestions.includes(q.pregunta));

            if (unansweredQuestions.length === 0) {
                // Si no quedan preguntas sin responder en esta categoría para este jugador,
                // intentar con otra categoría o terminar el juego si no hay más opciones.
                delete availableQuestions[currentCategory]; // Eliminar categoría vacía para este jugador
                nextQuestion(); // Intentar con la siguiente pregunta/categoría
                return;
            }

            // Seleccionar una pregunta aleatoria de las no respondidas
            currentQuestionIndex = Math.floor(Math.random() * unansweredQuestions.length);
            const question = unansweredQuestions[currentQuestionIndex];

            questionText.textContent = question.pregunta;
            currentCategoryTag.textContent = currentCategory;
            optionsContainer.innerHTML = ''; // Limpiar opciones anteriores

            question.opciones.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.dataset.option = option.charAt(0); // Asigna A, B, C o D
                button.onclick = () => checkAnswer(button, question.respuestaCorrecta, question.explicacion);
                optionsContainer.appendChild(button);
            });
            currentPlayer.questionsSeen++; // Incrementar preguntas vistas para el jugador actual
        }


        // Comprueba la respuesta del jugador
        function checkAnswer(selectedButton, correctAnswer, explanation) {
            playSound(clickSound); // Sonido al hacer click en una opción

            const selectedOption = selectedButton.dataset.option;
            const isCorrect = selectedOption === correctAnswer;
            const allOptionButtons = optionsContainer.querySelectorAll('.option-button');

            // Deshabilitar todos los botones de opción para evitar múltiples clicks
            allOptionButtons.forEach(button => {
                button.disabled = true;
                if (button.dataset.option === correctAnswer) {
                    button.classList.add('correct');
                } else if (button === selectedButton) {
                    button.classList.add('incorrect');
                }
            });

            const currentPlayer = players[currentPlayerIndex];
            const currentQuestion = availableQuestions[currentCategory].find(q => q.pregunta === questionText.textContent);

            if (isCorrect) {
                currentPlayer.score += 10; // Sumar puntos
                currentPlayer.correctAnswers++;
                playSound(correctSound);
                showFeedback('¡Correcto!', true, explanation);
            } else {
                playSound(incorrectSound);
                showFeedback('¡Incorrecto!', false, explanation);
            }

            // Marcar la pregunta como respondida por este jugador
            if (currentQuestion) {
                currentPlayer.answeredQuestions.push(currentQuestion.pregunta);
            }

            // Pasar al siguiente jugador después de un breve retraso
            setTimeout(() => {
                currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                nextQuestion();
            }, 2000); // Esperar 2 segundos antes de la siguiente pregunta
        }

        // Muestra el mensaje de feedback (correcto/incorrecto)
        function showFeedback(message, isCorrect, explanation) {
            feedbackText.textContent = message;
            explanationText.textContent = explanation;
            feedbackMessage.classList.remove('correct', 'incorrect'); // Limpiar clases anteriores
            feedbackMessage.classList.add(isCorrect ? 'correct' : 'incorrect', 'show');

            setTimeout(() => {
                feedbackMessage.classList.remove('show');
            }, 1800); // Mostrar por 1.8 segundos
        }

        // Termina el juego y muestra la pantalla final
        function endGame() {
            gameStarted = false;
            showScreen(endScreen);
            displayFinalScores();
            determineWinner();
            // Guardar las puntuaciones de cada jugador en la clasificación
            players.forEach(player => {
                saveLeaderboard({
                    name: player.name,
                    score: player.score,
                    correctAnswers: player.correctAnswers,
                    questionsSeen: player.questionsSeen
                });
            });
        }

        // Muestra las puntuaciones finales en la pantalla de fin de juego
        function displayFinalScores() {
            finalScoresDiv.innerHTML = '';
            players.forEach(player => {
                const scoreCard = document.createElement('div');
                scoreCard.className = 'player-score-card';
                scoreCard.innerHTML = `
                    <span>${player.name}</span>
                    <strong>${player.score}</strong>
                    <span>Puntos</span>
                    <button class="close-card-btn" data-player-id="${player.id}"><i class="fas fa-times"></i></button>
                `;
                finalScoresDiv.appendChild(scoreCard);
            });

            // Añadir event listeners a los botones de cerrar tarjeta
            finalScoresDiv.querySelectorAll('.close-card-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const playerIdToRemove = event.currentTarget.dataset.playerId;
                    players = players.filter(p => p.id !== playerIdToRemove);
                    displayFinalScores(); // Volver a renderizar las tarjetas
                });
            });
        }

        // Determina y muestra el ganador
        function determineWinner() {
            if (players.length === 0) {
                winnerMessage.textContent = "No hay jugadores para determinar un ganador.";
                return;
            }

            // Ordenar jugadores por puntuación de mayor a menor
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

            if (sortedPlayers.length > 0) {
                const topScore = sortedPlayers[0].score;
                const winners = sortedPlayers.filter(player => player.score === topScore);

                if (winners.length === 1) {
                    winnerMessage.textContent = `¡El ganador es ${winners[0].name} con ${winners[0].score} puntos!`;
                } else {
                    const winnerNames = winners.map(player => player.name).join(' y ');
                    winnerMessage.textContent = `¡Empate entre ${winnerNames} con ${topScore} puntos!`;
                }
            } else {
                winnerMessage.textContent = "No hay puntuaciones para determinar un ganador.";
            }
        }


        // --- Event Listeners ---

        // Pantalla de inicio -> Configuración de jugadores
        startGameButton.addEventListener('click', () => {
            playSound(clickSound);
            showScreen(playerSetupScreen);
            generatePlayerInputs(parseInt(playerCountSpan.textContent));
        });

        // Configuración de jugadores -> Empezar partida
        startQuizButton.addEventListener('click', () => {
            playSound(clickSound);
            startQuiz();
        });

        // Configuración de jugadores -> Volver a pantalla de inicio
        backToSplashFromSetup.addEventListener('click', () => {
            playSound(clickSound);
            showScreen(splashScreen);
        });

        // Fin de juego -> Volver a jugar
        restartGameButton.addEventListener('click', () => {
            playSound(clickSound);
            initializeGame(); // Reinicia el estado del juego y vuelve a la pantalla de inicio
        });

        // Fin de juego -> Cerrar (volver a inicio)
        closeGameButton.addEventListener('click', () => {
            playSound(clickSound);
            initializeGame(); // Reinicia el estado del juego y vuelve a la pantalla de inicio
        });

        // Botón de salir del juego en el header (desde cualquier pantalla)
        exitGameButton.addEventListener('click', () => {
            playSound(clickSound);
            if (confirm('¿Estás seguro de que quieres salir de la partida actual y volver al inicio?')) {
                initializeGame();
            }
        });

        // Control de sonido
        soundToggle.addEventListener('click', () => {
            soundOn = !soundOn;
            soundToggle.innerHTML = soundOn ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            playSound(clickSound); // Sonido de confirmación del toggle
        });

        // Botones de aumentar/disminuir jugadores
        decreasePlayersBtn.addEventListener('click', () => {
            playSound(clickSound);
            let count = parseInt(playerCountSpan.textContent);
            if (count > 1) {
                count--;
                playerCountSpan.textContent = count;
                generatePlayerInputs(count);
            }
        });

        increasePlayersBtn.addEventListener('click', () => {
            playSound(clickSound);
            let count = parseInt(playerCountSpan.textContent);
            if (count < 4) { // Límite de 4 jugadores
                count++;
                playerCountSpan.textContent = count;
                generatePlayerInputs(count);
            }
        });

        // Botón de clasificación
        leaderboardButton.addEventListener('click', () => {
            playSound(clickSound);
            loadLeaderboard();
            leaderboardModal.classList.add('show');
        });

        // Cerrar modal de clasificación
        leaderboardCloseBtn.addEventListener('click', () => {
            playSound(clickSound);
            leaderboardModal.classList.remove('show');
        });

        // Inicializar el juego al cargar la página
        window.onload = initializeGame;

    </script>
</body>
</html>
