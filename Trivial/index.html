
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivial Ferroviario INECO</title>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables de colores INECO */
        :root {
            --ineco-azul-principal: rgb(26, 68, 136);
            --ineco-rojo-acento: rgb(203, 24, 35);
            --ineco-azul-claro: rgb(52, 99, 172);
            --ineco-azul-aun-mas-claro: rgb(107, 150, 207);
            --ineco-blanco-puro: rgb(255, 255, 255);
            --ineco-gris-oscuro: rgb(50, 50, 50);
            --ineco-gris-claro: rgb(230, 230, 230);
            --ineco-verde-correcto: rgb(76, 175, 80); /* Verde para respuestas correctas */
            --ineco-rojo-incorrecto: rgb(244, 67, 54); /* Rojo para respuestas incorrectas */

            /* Fuentes */
            --font-poppins: 'Poppins', sans-serif;
        }

        /* Estilos generales */
        body {
            font-family: var(--font-poppins);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--ineco-azul-principal) 70%, var(--ineco-rojo-acento) 100%);
            color: var(--ineco-gris-oscuro);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll horizontal */
            transition: background 0.5s ease-in-out;
        }

        #app-container {
            background-color: var(--ineco-blanco-puro);
            border-radius: 20px; /* Formas redondeadas clave */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 900px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            opacity: 0; /* Inicialmente oculto para animación de carga */
            transform: translateY(20px);
            animation: fadeInScale 0.8s forwards ease-out;
        }

        /* Animación de entrada general */
        @keyframes fadeInScale {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header */
        header {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            z-index: 10;
        }

        .logo {
            font-family: var(--font-poppins);
            font-weight: 600; /* Poppins Semibold para el logo */
            font-size: 2.2em;
            color: var(--ineco-blanco-puro); /* Logo blanco sobre fondo oscuro */
            padding-left: 1.5em; /* Espacio de exclusión, aprox altura de 'n' */
            position: relative;
        }
        /* Simulación de la 'n' para el espacio de exclusión */
        .logo::before {
            content: 'n';
            visibility: hidden;
            font-size: 1em; /* Misma altura que la 'n' real */
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .header-buttons {
            display: flex;
            gap: 15px; /* Espacio entre los botones del header */
        }

        .sound-toggle, .exit-game-button { /* Clase para botones de icono en header */
            background: none;
            border: none;
            color: var(--ineco-blanco-puro);
            font-size: 1.8em;
            cursor: pointer;
            transition: color 0.3s ease;
            outline: none;
        }
        .sound-toggle:hover, .exit-game-button:hover {
            color: var(--ineco-rojo-acento);
        }

        /* Estilos de pantallas */
        .screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(100%); /* Preparado para slide-in */
            box-sizing: border-box;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
            position: relative; /* Para que ocupe espacio en el flexbox */
        }

        /* Splash Screen */
        #splash-screen {
            background: url('https://placehold.co/900x600/1A4488/FFFFFF?text=Trivial+Ferroviario') no-repeat center center / cover;
            color: var(--ineco-blanco-puro);
            justify-content: space-around;
            padding: 80px 40px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        #splash-screen h2 {
            font-size: 3.5em; /* H1: 36-48px */
            font-weight: 600; /* Poppins Semibold */
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Player Setup Screen */
        #player-setup {
            background-color: var(--ineco-blanco-puro);
        }
        #player-setup h2 {
            font-size: 2.5em; /* H2: 28-34px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }
        .player-count-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .player-count-selector button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 10px; /* Redondeado */
            padding: 10px 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .player-count-selector button:hover {
            background-color: var(--ineco-rojo-acento);
        }
        .player-count-selector span {
            font-size: 2em;
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-azul-principal);
        }
        #player-inputs {
            display: flex;
            flex-wrap: wrap; /* Para responsive */
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            max-height: 300px; /* Limita altura para scroll si hay muchos jugadores */
            overflow-y: auto; /* Permite scroll */
            padding: 10px;
            width: 100%;
        }
        .player-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            min-width: 200px; /* Ancho mínimo para cada grupo */
        }
        .player-input-group input {
            padding: 12px 15px;
            border: 2px solid var(--ineco-azul-claro);
            border-radius: 10px; /* Redondeado */
            font-size: 1.1em;
            font-family: var(--font-poppins);
            color: var(--ineco-gris-oscuro);
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .player-input-group input:focus {
            outline: none;
            border-color: var(--ineco-rojo-acento);
        }
        .player-input-group button {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 8px; /* Redondeado */
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .player-input-group button:hover {
            background-color: var(--ineco-rojo-acento);
        }
        .player-setup-buttons { /* Nuevo contenedor para botones en player-setup */
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Game Screen */
        #game-screen {
            background-color: var(--ineco-blanco-puro);
            justify-content: flex-start;
            padding-top: 20px;
        }
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .game-info div {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500; /* Poppins Medium */
            font-size: 1.1em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .question-container {
            background-color: var(--ineco-gris-claro);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            width: 90%;
            max-width: 800px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.05);
            text-align: left;
            position: relative;
        }
        .question-container h3 {
            font-size: 1.8em; /* H3: 22-26px */
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .category-tag {
            background-color: var(--ineco-rojo-acento);
            color: var(--ineco-blanco-puro);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            position: absolute;
            top: -15px;
            left: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 90%;
            max-width: 800px;
        }
        .option-button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 12px; /* Redondeado */
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 400; /* Poppins Regular */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-align: left;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .option-button:hover {
            background-color: var(--ineco-rojo-acento);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        .option-button.correct {
            background-color: var(--ineco-verde-correcto);
            animation: pulseCorrect 0.5s ease-in-out;
        }
        .option-button.incorrect {
            background-color: var(--ineco-rojo-incorrecto);
            animation: shake 0.5s ease-in-out;
        }

        /* Animaciones de respuesta */
        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Feedback Message */
        #feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--ineco-blanco-puro);
            padding: 30px 40px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        #feedback-message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        #feedback-message p {
            margin: 0 0 15px 0;
        }
        #feedback-message .explanation {
            font-size: 0.8em;
            font-weight: 400;
            color: var(--ineco-gris-claro);
            margin-top: 10px;
            max-width: 400px;
        }

        /* End Screen */
        #end-screen {
            background-color: var(--ineco-blanco-puro);
        }
        #end-screen h2 {
            font-size: 3em; /* H1 */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }
        #end-screen h3 {
            font-size: 2em; /* H2 */
            font-weight: 500; /* Poppins Medium */
            color: var(--ineco-rojo-acento);
            margin-bottom: 20px;
        }
        .final-scores {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .player-score-card {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            text-align: center;
        }
        .player-score-card span {
            display: block;
            font-size: 1.2em;
            font-weight: 500; /* Poppins Medium */
            margin-bottom: 5px;
        }
        .player-score-card strong {
            font-size: 2.5em;
            font-weight: 700; /* Poppins Bold */
        }
        .end-screen-buttons { /* Nuevo contenedor para botones en end-screen */
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Botones generales */
        .btn-primary {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            border: none;
            border-radius: 15px; /* Muy redondeado */
            padding: 15px 35px;
            font-size: 1.3em; /* Semibold */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px; /* Espaciado */
        }
        .btn-primary:hover {
            background-color: var(--ineco-rojo-acento);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #app-container {
                width: 95%;
                min-height: 500px;
                margin: 20px 0;
            }
            header {
                padding: 15px 20px;
            }
            .logo {
                font-size: 1.8em;
                padding-left: 1em;
            }
            .sound-toggle, .exit-game-button {
                font-size: 1.5em;
            }
            .screen {
                padding: 20px;
            }
            #splash-screen h2 {
                font-size: 2.5em;
            }
            #player-setup h2, #end-screen h2 {
                font-size: 2em;
            }
            .player-count-selector {
                gap: 10px;
            }
            .player-count-selector button {
                padding: 8px 12px;
                font-size: 1.2em;
            }
            .player-count-selector span {
                font-size: 1.5em;
            }
            #player-inputs {
                flex-direction: column;
                max-height: 250px;
                padding: 5px; /* Reducir padding */
            }
            .player-input-group {
                width: 90%; /* Aumentar ancho para ocupar más espacio */
                max-width: none;
            }
            .player-input-group input {
                max-width: 100%; /* Asegurar que el input no desborde */
            }
            .player-setup-buttons, .end-screen-buttons {
                flex-direction: column; /* Apilar botones en móvil */
                gap: 15px;
            }
            .game-info {
                flex-direction: column; /* Apilar elementos en móvil */
                gap: 10px; /* Espacio entre elementos apilados */
                padding: 0 10px; /* Reducir padding lateral */
            }
            .game-info div {
                padding: 8px 15px; /* Reducir padding */
                font-size: 1em;
            }
            .question-container {
                padding: 20px; /* Reducir padding */
            }
            .question-container h3 {
                font-size: 1.4em;
            }
            .option-button {
                padding: 12px 20px;
                font-size: 1em;
            }
            #feedback-message {
                padding: 20px 30px;
                font-size: 1.2em;
            }
            #feedback-message .explanation {
                font-size: 0.7em;
            }
            .final-scores {
                flex-direction: column;
                gap: 15px; /* Reducir espacio */
            }
            .player-score-card {
                min-width: unset;
                width: 85%; /* Ajustar ancho */
                padding: 15px 20px; /* Reducir padding */
            }
            .player-score-card strong {
                font-size: 2em;
            }
            .btn-primary {
                padding: 12px 25px;
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            #app-container {
                border-radius: 10px;
            }
            header {
                padding: 10px 15px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }
            .logo {
                font-size: 1.5em;
                padding-left: 0.8em;
            }
            .sound-toggle, .exit-game-button {
                font-size: 1.2em;
            }
            #splash-screen h2 {
                font-size: 2em;
            }
            #player-setup h2, #end-screen h2 {
                font-size: 1.8em;
            }
            .question-container h3 {
                font-size: 1.2em;
            }
            .option-button {
                font-size: 0.9em;
            }
            .btn-primary {
                font-size: 1em;
            }
            .player-input-group {
                width: 95%; /* Ajuste final para pantallas muy pequeñas */
            }
            #player-inputs {
                padding: 0; /* Eliminar padding en pantallas muy pequeñas */
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 class="logo">ineco</h1>
            <div class="header-buttons">
                <button id="soundToggle" class="sound-toggle">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button id="exitGameButton" class="exit-game-button">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
        </header>

        <!-- Pantalla de Inicio -->
        <section id="splash-screen" class="screen active">
            <h2>Trivial Ferroviario</h2>
            <button id="startGameButton" class="btn-primary">Iniciar Juego</button>
        </section>

        <!-- Configuración de Jugadores -->
        <section id="player-setup" class="screen">
            <h2>Configuración de Jugadores</h2>
            <div class="player-count-selector">
                <button id="decreasePlayers">-</button>
                <span>Jugadores: <span id="playerCount">1</span></span>
                <button id="increasePlayers">+</button>
            </div>
            <div id="player-inputs">
                <!-- Los campos de jugador se generarán aquí -->
            </div>
            <div class="player-setup-buttons">
                <button id="startQuizButton" class="btn-primary">Empezar Partida</button>
                <button id="backToSplashFromSetup" class="btn-primary">Volver</button>
            </div>
        </section>

        <!-- Pantalla de Juego -->
        <section id="game-screen" class="screen">
            <div class="game-info">
                <div id="currentPlayerInfo">Turno de: Jugador 1</div>
                <div id="categoryInfo">Categoría:</div>
                <div id="scoreInfo">Puntuación: 0</div>
            </div>
            <div class="question-container">
                <span class="category-tag" id="currentCategoryTag"></span>
                <h3 id="questionText">Cargando pregunta...</h3>
            </div>
            <div id="optionsContainer" class="options-container">
                <button class="option-button" data-option="A">Opción A</button>
                <button class="option-button" data-option="B">Opción B</button>
                <button class="option-button" data-option="C">Opción C</button>
                <button class="option-button" data-option="D">Opción D</button>
            </div>
        </section>

        <!-- Pantalla de Fin de Juego -->
        <section id="end-screen" class="screen">
            <h2>¡Partida Terminada!</h2>
            <h3 id="winnerMessage"></h3>
            <div class="final-scores" id="finalScores">
                <!-- Las puntuaciones finales se generarán aquí -->
            </div>
            <div class="end-screen-buttons">
                <button id="restartGameButton" class="btn-primary">Volver a Jugar</button>
                <button id="closeGameButton" class="btn-primary">Cerrar</button>
            </div>
        </section>

        <!-- Mensaje de Feedback (Correcto/Incorrecto) -->
        <div id="feedback-message">
            <p id="feedbackText"></p>
            <p class="explanation" id="explanationText"></p>
        </div>
    </div>

    <script>
        // Datos de las preguntas (JSON incrustado)
        const questionsData = {
            "preguntas": {
                "Elementos Estructurales de la Vía": [
                    {
                        "pregunta": "¿Cuál es la función principal del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "Asegurar la conductividad eléctrica de los carriles.",
                            "Transmitir las cargas de los trenes al terreno y asegurar la estabilidad de la vía.",
                            "Reducir la fricción entre la rueda y el carril.",
                            "Actuar como aislante térmico."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El balasto distribuye las cargas de las traviesas al terraplén, proporciona drenaje y contribuye a la estabilidad lateral y longitudinal de la vía, esencial para las altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué técnica se utiliza comúnmente para el mantenimiento del perfil del carril y la eliminación de defectos superficiales en vías de alta velocidad?",
                        "opciones": [
                            "Bateo de balasto.",
                            "Reemplazo completo de carril.",
                            "Esmerilado o amolado de carril.",
                            "Engrasado de las sujeciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El esmerilado de carril permite restaurar el perfil óptimo, eliminar ondulaciones y grietas superficiales, prolongando la vida útil del carril y mejorando la calidad de rodadura."
                    },
                    {
                        "pregunta": "¿Qué tipo de sujeción es más común en las vías de alta velocidad para asegurar la rigidez y el aislamiento eléctrico?",
                        "opciones": [
                            "Brida metálica.",
                            "Sujeción rígida con tornillos de banco.",
                            "Sujeción elástica con almohadilla de caucho y grapas.",
                            "Clavos de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las sujeciones elásticas, como las de tipo Pandrol o Vossloh, proporcionan una fijación constante del carril a la traviesa, absorben vibraciones y garantizan el aislamiento eléctrico, crucial para los sistemas de señalización."
                    },
                    {
                        "pregunta": "¿Cuál es la principal diferencia entre una traviesa monobloque y una bibloque en términos de su comportamiento en la vía de alta velocidad?",
                        "opciones": [
                            "La monobloque es más flexible y la bibloque más rígida.",
                            "La monobloque es de madera y la bibloque de hormigón.",
                            "La monobloque ofrece mayor rigidez transversal y mejor comportamiento frente a la deformación lateral.",
                            "La bibloque permite un menor ancho de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las traviesas monobloque de hormigón pretensado son el estándar en alta velocidad debido a su mayor masa y rigidez, que optimizan la transmisión de cargas y la estabilidad geométrica de la vía."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de los cordones de soldadura en los carriles de una vía de alta velocidad?",
                        "opciones": [
                            "Aumentar la resistencia a la abrasión del carril.",
                            "Unir los tramos de carril de forma continua para evitar juntas y mejorar la rodadura.",
                            "Facilitar la dilatación térmica de los carriles.",
                            "Servir como punto de anclaje para los sistemas de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La soldadura continua de carril (CRC) elimina las juntas, lo que mejora el confort de viaje, reduce el ruido y las vibraciones, y minimiza el mantenimiento de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué se busca optimizar al realizar una compactación dinámica del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "La capacidad de drenaje del balasto.",
                            "La resistencia del balasto a la pulverización.",
                            "La uniformidad de la densidad y la resistencia al asiento de la banqueta de balasto.",
                            "La temperatura del balasto para evitar dilataciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La compactación dinámica mejora la estabilidad y la resistencia del balasto, asegurando que la geometría de la vía se mantenga estable bajo las cargas dinámicas de los trenes de alta velocidad."
                    },
                    {
                        "pregunta": "¿Cuál es el objetivo principal del mantenimiento de la explanación y el terraplén en una línea de alta velocidad?",
                        "opciones": [
                            "Mejorar el paisaje circundante.",
                            "Asegurar la estabilidad geotécnica de la plataforma y el drenaje adecuado.",
                            "Reducir el coste de construcción de la vía.",
                            "Facilitar la instalación de la catenaria."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Una plataforma estable y un buen drenaje son fundamentales para evitar asientos diferenciales y deformaciones de la vía, que comprometerían la seguridad y el confort a altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué tipo de sistema de drenaje es crucial en túneles de alta velocidad para evitar la acumulación de agua?",
                        "opciones": [
                            "Acequias a cielo abierto.",
                            "Bombas de achique manuales.",
                            "Cunetas, colectores y pozos de bombeo integrados en la infraestructura.",
                            "Filtración natural a través del balasto."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El drenaje en túneles es vital para prevenir la inundación, la corrosión de elementos metálicos y el deterioro de la infraestructura, asegurando la operatividad de la línea."
                    },
                    {
                        "pregunta": "¿Qué función cumple la capa de subbalasto en la superestructura de una vía de alta velocidad?",
                        "opciones": [
                            "Aislar térmicamente el balasto.",
                            "Evitar la mezcla del balasto con el material del terraplén y mejorar la distribución de cargas.",
                            "Actuar como elemento conductor de la señalización.",
                            "Soportar directamente el peso de los trenes."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El subbalasto actúa como una capa de transición entre el balasto y la explanación, impidiendo la contaminación del balasto y mejorando la uniformidad de la transmisión de tensiones."
                    },
                    {
                        "pregunta": "¿Qué se entiende por 'recalzado' de traviesas en el mantenimiento ferroviario?",
                        "opciones": [
                            "El proceso de añadir una nueva traviesa a la vía.",
                            "La sustitución de los carriles sobre las traviesas existentes.",
                            "La adición de balasto bajo las traviesas para mejorar el apoyo y la nivelación.",
                            "La limpieza de la superficie de las traviesas."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El recalzado consiste en introducir balasto debajo de las traviesas, generalmente mediante bateadoras, para corregir la nivelación y alineación de la vía."
                    }
                ],
                "Maquinaria y Herramientas": [
                    {
                        "pregunta": "¿Cuál es la función principal de una bateadora pesada en el mantenimiento de vías de alta velocidad?",
                        "opciones": [
                            "Soldar automáticamente los carriles.",
                            "Limpiar la superficie de los carriles.",
                            "Compactar el balasto bajo las traviesas para corregir la geometría de la vía.",
                            "Inspeccionar visualmente el estado de la catenaria."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las bateadoras son máquinas esenciales para el mantenimiento de la geometría de la vía (alineación, nivelación, peralte) mediante la vibración y compactación del balasto."
                    },
                    {
                        "pregunta": "¿Qué equipo se utiliza para medir con precisión la altura y la flecha de la catenaria en una línea de alta velocidad?",
                        "opciones": [
                            "Un nivel óptico y una mira topográfica.",
                            "Un carro de auscultación de catenaria o drones con sistemas láser.",
                            "Un voltímetro de alta tensión.",
                            "Un dinamómetro."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La precisión en la medición de la catenaria es crítica para asegurar el correcto contacto con el pantógrafo a altas velocidades y evitar desprendimientos."
                    },
                    {
                        "pregunta": "¿Cuál es la principal ventaja de utilizar detectores de defectos por ultrasonidos en los carriles de alta velocidad?",
                        "opciones": [
                            "Identificar la temperatura de la superficie del carril.",
                            "Detectar fisuras internas y defectos ocultos que no son visibles a simple vista.",
                            "Medir la resistencia eléctrica del carril.",
                            "Determinar la composición química del acero del carril."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los ultrasonidos permiten un mantenimiento predictivo, detectando fallos incipientes antes de que se propaguen y comprometan la seguridad."
                    },
                    {
                        "pregunta": "¿Qué tipo de máquina es fundamental para el reperfilado de los carriles, mejorando la interacción rueda-carril y reduciendo el ruido?",
                        "opciones": [
                            "Una desguarnecedora.",
                            "Una perfiladora de carril (o amoladora de grandes dimensiones).",
                            "Una soldadora aluminotérmica.",
                            "Una bateadora ligera."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La perfiladora restaura la forma óptima de la cabeza del carril, mejorando la calidad de la rodadura y prolongando la vida útil del carril y de las ruedas."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de una máquina desguarnecedora en el mantenimiento de la vía?",
                        "opciones": [
                            "Retirar los residuos de balasto y limpiar la plataforma de la vía.",
                            "Soldar tramos de carril largos.",
                            "Perforar las traviesas para instalar sujeciones.",
                            "Transportar material de obra."
                        ],
                        "respuestaCorrecta": "A",
                        "explicacion": "La desguarnecedora limpia el balasto sucio o contaminado, lo que es vital para mantener la capacidad de drenaje y la elasticidad de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué herramienta manual es esencial para comprobar el apriete correcto de los tornillos en las uniones de carril o sujeciones?",
                        "opciones": [
                            "Un martillo de bola.",
                            "Una llave de grifa.",
                            "Una llave dinamométrica.",
                            "Un taladro percutor."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La llave dinamométrica asegura que el par de apriete sea el especificado, evitando tanto aflojamientos como sobretensiones que puedan dañar los elementos."
                    },
                    {
                        "pregunta": "¿Qué tipo de vehículo auxiliar se utiliza para el transporte de personal y pequeñas herramientas a lo largo de la vía?",
                        "opciones": [
                            "Un tren de obras.",
                            "Una locomotora de línea.",
                            "Una dresina o vagoneta de vía.",
                            "Un tren de socorro."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las dresinas son vehículos ligeros y versátiles, diseñados para moverse sobre la vía con rapidez y eficacia en operaciones de inspección y pequeño mantenimiento."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal de los trenes de auscultación en alta velocidad?",
                        "opciones": [
                            "Transportar viajeros a alta velocidad.",
                            "Medir y registrar continuamente los parámetros geométricos y dinámicos de la vía y la catenaria.",
                            "Realizar operaciones de soldadura en movimiento.",
                            "Apagar incendios en la infraestructura."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los trenes de auscultación son clave para el mantenimiento predictivo, permitiendo identificar anomalías y planificar intervenciones antes de que surjan problemas críticos."
                    },
                    {
                        "pregunta": "¿Qué se mide con una galga de vía?",
                        "opciones": [
                            "La altura de la catenaria.",
                            "El ancho de la vía (entre caras activas de los carriles).",
                            "La temperatura del carril.",
                            "La tensión de los cables de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El ancho de vía es un parámetro crítico para la seguridad y el confort, especialmente en alta velocidad, y su control es fundamental."
                    },
                    {
                        "pregunta": "¿Qué tipo de soldadura se utiliza más comúnmente para unir tramos de carril de forma rápida y eficiente en campo?",
                        "opciones": [
                            "Soldadura por resistencia eléctrica.",
                            "Soldadura TIG.",
                            "Soldadura aluminotérmica.",
                            "Soldadura por arco sumergido."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La soldadura aluminotérmica es ampliamente utilizada por su rapidez y por no requerir equipos eléctricos complejos en campo, aunque la soldadura por resistencia es el método preferido en talleres para la fabricación de carriles largos."
                    }
                ],
                "Sistemas y Tecnologías": [
                    {
                        "pregunta": "¿Qué sistema de señalización y control de trenes es el estándar europeo para las líneas de alta velocidad?",
                        "opciones": [
                            "ASFA (Anuncio de Señales y Frenado Automático).",
                            "ERTMS (European Rail Traffic Management System).",
                            "CTC (Control de Tráfico Centralizado).",
                            "ATO (Automatic Train Operation)."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "ERTMS, con sus niveles ETCS (European Train Control System) y GSM-R (Global System for Mobile Communications – Railway), es el sistema interoperable que permite la circulación segura de trenes de alta velocidad a través de diferentes países europeos."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal de los circuitos de vía en una línea ferroviaria electrificada de alta velocidad?",
                        "opciones": [
                            "Suministrar energía a los trenes.",
                            "Detectar la presencia de trenes y la integridad del carril para la señalización.",
                            "Calentar los carriles en invierno.",
                            "Comunicar al maquinista la velocidad máxima permitida."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los circuitos de vía son fundamentales para la detección de ocupación y la supervisión de la continuidad del carril, enviando información al enclavamiento y al sistema de señalización."
                    },
                    {
                        "pregunta": "¿Qué característica principal tiene la catenaria rígida frente a la catenaria flexible en túneles de alta velocidad?",
                        "opciones": [
                            "Mayor flexibilidad para adaptarse a las curvas.",
                            "Menor coste de instalación inicial.",
                            "Mayor resistencia al fuego y menor necesidad de mantenimiento.",
                            "Mayor facilidad para la detección de averías."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La catenaria rígida es preferida en túneles por su robustez, menor número de puntos de fijación y su resistencia a las deformaciones por la onda de presión generada por los trenes de alta velocidad."
                    },
                    {
                        "pregunta": "¿Qué se utiliza para la transmisión de datos y voz en el sistema GSM-R de las líneas de alta velocidad?",
                        "opciones": [
                            "Cables de cobre coaxiales.",
                            "Ondas de radio de baja frecuencia.",
                            "Fibra óptica y radioenlaces digitales.",
                            "Señales luminosas."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La fibra óptica es la 'columna vertebral' de las comunicaciones en alta velocidad, proporcionando el ancho de banda y la fiabilidad necesarios para GSM-R, SCADA y otros sistemas."
                    },
                    {
                        "pregunta": "¿Cuál es el principal objetivo de un sistema SCADA (Supervisory Control And Data Acquisition) en la infraestructura de alta velocidad?",
                        "opciones": [
                            "Controlar las taquillas de las estaciones.",
                            "Gestionar y supervisar remotamente las instalaciones fijas como subestaciones, sistemas de ventilación o iluminación.",
                            "Automatizar la limpieza de los trenes.",
                            "Regular el flujo de pasajeros en los andenes."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "SCADA permite a los operadores monitorizar y controlar la infraestructura desde un centro de control, facilitando la detección de anomalías y la respuesta rápida."
                    },
                    {
                        "pregunta": "¿Qué tipo de pruebas se realizan periódicamente en los sistemas de balizas ERTMS para asegurar su correcto funcionamiento?",
                        "opciones": [
                            "Pruebas de resistencia mecánica.",
                            "Pruebas de impermeabilidad.",
                            "Pruebas de lectura y escritura de telegramas, y calibración de frecuencia.",
                            "Pruebas de impacto a alta velocidad."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las balizas transmiten información vital al tren, por lo que su correcta calibración y funcionamiento son esenciales para la seguridad operativa."
                    },
                    {
                        "pregunta": "¿Qué es la 'zona de paso' en un sistema de electrificación ferroviario y por qué es crítica para el mantenimiento?",
                        "opciones": [
                            "El espacio por donde pasan los trenes.",
                            "Un tramo de vía sin catenaria para maniobras.",
                            "El punto donde se unen dos zonas de alimentación eléctrica diferentes con distinto potencial, requiriendo un aislamiento o cambio de tensión.",
                            "La zona de amortiguación de ruido."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La zona de paso requiere procedimientos específicos para los trenes (bajada de pantógrafo, desconexión de tracción) y un mantenimiento riguroso de sus elementos (aisladores, seccionadores) para evitar cortocircuitos y arcos eléctricos."
                    },
                    {
                        "pregunta": "¿Cuál es la función de un contador de ejes en un sistema de señalización?",
                        "opciones": [
                            "Contar el número de trenes que circulan por una sección.",
                            "Determinar si una sección de vía está libre u ocupada contando los ejes que entran y salen.",
                            "Medir el desgaste de las ruedas del tren.",
                            "Calcular la velocidad del tren."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los contadores de ejes son una alternativa a los circuitos de vía para la detección de ocupación, especialmente en túneles o en zonas con problemas de drenaje, ofreciendo una alta fiabilidad."
                    },
                    {
                        "pregunta": "¿Qué se entiende por 'seccionamiento' de la catenaria y cuándo se utiliza en mantenimiento?",
                        "opciones": [
                            "La división física de la catenaria en tramos.",
                            "La interrupción deliberada del suministro eléctrico a un tramo de catenaria para realizar trabajos de mantenimiento con seguridad.",
                            "La conexión de dos tramos de catenaria para formar un bucle.",
                            "El proceso de reparación de una catenaria rota."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El seccionamiento es una medida de seguridad fundamental que garantiza que el personal de mantenimiento pueda trabajar en la catenaria sin riesgo eléctrico, mediante la apertura de seccionadores y la puesta a tierra."
                    },
                    {
                        "pregunta": "¿Qué sistema se utiliza para monitorizar la salud estructural de puentes y viaductos en tiempo real en líneas de alta velocidad?",
                        "opciones": [
                            "Cámaras de seguridad de CCTV.",
                            "Sistemas de auscultación continua con sensores (fibra óptica, acelerómetros, etc.).",
                            "Inspecciones visuales diarias por parte del maquinista.",
                            "Análisis de la composición del hormigón."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La monitorización estructural permite detectar cualquier anomalía o deterioro en tiempo real, facilitando el mantenimiento predictivo y asegurando la integridad de las grandes estructuras."
                    }
                ],
                "Operaciones y Personal": [
                    {
                        "pregunta": "¿Cuál es el objetivo principal del mantenimiento predictivo en una línea de alta velocidad?",
                        "opciones": [
                            "Reparar los fallos una vez que ocurren.",
                            "Realizar el mantenimiento a intervalos fijos, sin importar el estado del componente.",
                            "Detectar fallos incipientes y predecir cuándo ocurrirán, para intervenir antes de que se produzcan averías.",
                            "Reducir el personal de mantenimiento."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El mantenimiento predictivo, basado en la monitorización de la condición, es fundamental en alta velocidad para maximizar la disponibilidad de la infraestructura y minimizar las interrupciones del servicio."
                    },
                    {
                        "pregunta": "¿Qué tipo de plan de mantenimiento se basa en la programación de tareas a intervalos regulares o tras un determinado uso, independientemente del estado real del componente?",
                        "opciones": [
                            "Mantenimiento correctivo.",
                            "Mantenimiento predictivo.",
                            "Mantenimiento de oportunidad.",
                            "Mantenimiento preventivo programado."
                        ],
                        "respuestaCorrecta": "D",
                        "explicacion": "El mantenimiento preventivo programado busca evitar fallos mediante intervenciones programadas, como revisiones o sustituciones de componentes por tiempo o kilómetros."
                    },
                    {
                        "pregunta": "¿Qué rol del personal ferroviario es el encargado de verificar la correcta aplicación de la normativa de seguridad y el estado de la vía en un tramo asignado?",
                        "opciones": [
                            "Maquinista.",
                            "Factor de circulación.",
                            "Inspector de vía.",
                            "Agente comercial."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El inspector de vía es una figura clave en el mantenimiento, cuya función es realizar revisiones periódicas y detectar anomalías en la superestructura y la infraestructura."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal del 'jefe de equipo' en una brigada de mantenimiento de vía?",
                        "opciones": [
                            "Conducir la maquinaria de vía.",
                            "Gestionar los recursos humanos y materiales, y asegurar la correcta ejecución de los trabajos y la seguridad.",
                            "Realizar la limpieza de las herramientas.",
                            "Elaborar los informes financieros del proyecto."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El jefe de equipo es el responsable directo de la operación y la seguridad de su equipo en la ejecución de las tareas de mantenimiento."
                    },
                    {
                        "pregunta": "¿Qué es un 'corte de vía' y cuándo se aplica en el mantenimiento de alta velocidad?",
                        "opciones": [
                            "Un tramo de vía en el que no hay balasto.",
                            "Una interrupción programada de la circulación ferroviaria en un tramo para permitir la realización de trabajos de mantenimiento de gran envergadura.",
                            "Un tramo de vía sin electrificación.",
                            "Un punto donde la vía se divide en dos."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los cortes de vía son esenciales para realizar trabajos que requieren la ausencia de tráfico, como el reemplazo masivo de carriles, la intervención en estructuras o el bateo profundo."
                    },
                    {
                        "pregunta": "¿Qué documento de seguridad es fundamental consultar antes de iniciar cualquier trabajo en la vía?",
                        "opciones": [
                            "El menú de la cantina.",
                            "El parte meteorológico.",
                            "El Plan de Autoprotección y las consignas de seguridad del tramo.",
                            "El horario de los trenes de mercancías."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La seguridad es prioritaria. Los planes y consignas detallan los riesgos, las medidas preventivas y los procedimientos a seguir para trabajar de forma segura en el entorno ferroviario."
                    },
                    {
                        "pregunta": "¿Qué es el sistema de 'consignación y descargo' en el mantenimiento ferroviario?",
                        "opciones": [
                            "Un sistema para gestionar el inventario de materiales.",
                            "El procedimiento que asegura la desenergización de una instalación antes de intervenir y su energización segura al finalizar el trabajo.",
                            "Un método para el transporte de balasto.",
                            "El registro de las horas trabajadas por el personal."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La consignación eléctrica (o de otros tipos de energía) es un procedimiento crítico para garantizar que el personal no sea expuesto a riesgos eléctricos o mecánicos durante el mantenimiento."
                    },
                    {
                        "pregunta": "¿Qué ventaja principal ofrece el mantenimiento basado en la condición (monitorización) para las líneas de alta velocidad?",
                        "opciones": [
                            "Reduce la necesidad de personal de mantenimiento.",
                            "Permite optimizar las intervenciones, actuando solo cuando es necesario, reduciendo costes y maximizando la disponibilidad.",
                            "Elimina por completo la necesidad de inspecciones visuales.",
                            "Prolonga indefinidamente la vida útil de los componentes sin reemplazo."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Al actuar solo cuando la condición del activo lo requiere, se evitan mantenimientos innecesarios y se previene la aparición de averías, lo que es crucial para la eficiencia y fiabilidad de la alta velocidad."
                    },
                    {
                        "pregunta": "¿Qué importancia tiene la 'trazabilidad' en los trabajos de mantenimiento de una infraestructura de alta velocidad?",
                        "opciones": [
                            "Ayuda a los trenes a seguir el trazado de la vía.",
                            "Permite seguir el origen y el historial de cada componente o intervención, fundamental para la gestión de activos y la resolución de problemas.",
                            "Determina la velocidad máxima permitida en una curva.",
                            "Define el ancho de la plataforma ferroviaria."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La trazabilidad es vital para el control de calidad, la gestión de la garantía y el análisis de fallos, asegurando que se utilizan los componentes correctos y que las intervenciones están documentadas."
                    },
                    {
                        "pregunta": "¿Cuál es el objetivo de los 'Equipos de Protección Individual (EPIs)' en el entorno ferroviario?",
                        "opciones": [
                            "Proteger el material rodante de la corrosión.",
                            "Proteger al trabajador de riesgos que no pueden eliminarse o reducirse suficientemente por otros medios.",
                            "Proteger la vía de actos vandálicos.",
                            "Proteger el medio ambiente de la contaminación."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los EPIs son la última barrera de protección para el personal, e incluyen elementos como cascos, guantes, calzado de seguridad y ropa de alta visibilidad."
                    }
                ]
            }
        };

        // Nombres de jugadores aleatorios
        const playerNamesList = [
            "Traviesín", "Tunelillo", "Rielín", "Vibración Veloz", "Balasto Boss",
            "Catenaria Kid", "Señalino", "Durmiente Dinámico", "Fibra Óptica Fan", "Amolador As",
            "Bateadora Berta", "Inspector Hilario", "Durmiente Ágil", "Biela Veloz", "Trenelito",
            "Vía Láctea", "Pantógrafo Power", "Señor Señal", "Cat-enaria", "Ingeniero Rieles",
            "Desvío Divertido", "Terraplén Teo", "Túnelín el Astuto", "Puente Patán", "Balasto Brillante",
            "Soldador Sergio", "Frenada Fantástica", "Inspector Javier"
        ];

        // Elementos del DOM
        const appContainer = document.getElementById('app-container');
        const splashScreen = document.getElementById('splash-screen');
        const playerSetupScreen = document.getElementById('player-setup');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameButton = document.getElementById('startGameButton');
        const soundToggle = document.getElementById('soundToggle');
        const soundIcon = soundToggle.querySelector('i');
        const exitGameButton = document.getElementById('exitGameButton'); // Nuevo botón de salir
        const decreasePlayersBtn = document.getElementById('decreasePlayers');
        const increasePlayersBtn = document.getElementById('increasePlayers');
        const playerCountSpan = document.getElementById('playerCount');
        const playerInputsDiv = document.getElementById('player-inputs');
        const startQuizButton = document.getElementById('startQuizButton');
        const backToSplashFromSetupButton = document.getElementById('backToSplashFromSetup'); // Nuevo botón de volver
        const currentPlayerInfo = document.getElementById('currentPlayerInfo');
        const categoryInfo = document.getElementById('categoryInfo');
        const scoreInfo = document.getElementById('scoreInfo');
        const questionText = document.getElementById('questionText');
        const currentCategoryTag = document.getElementById('currentCategoryTag');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackText = document.getElementById('feedbackText');
        const explanationText = document.getElementById('explanationText');
        const winnerMessage = document.getElementById('winnerMessage');
        const finalScoresDiv = document.getElementById('finalScores');
        const restartGameButton = document.getElementById('restartGameButton');
        const closeGameButton = document.getElementById('closeGameButton'); // Nuevo botón de cerrar

        // Variables de juego
        let currentPlayerCount = 1;
        let players = [];
        let currentQuestionIndex = 0;
        let currentPlayerIndex = 0;
        let shuffledQuestions = [];
        let isSoundOn = true;

        // Audios (precargados para evitar latencia)
        // Se han actualizado las URLs de audio a fuentes más fiables con políticas CORS permisivas.
        const audioCorrect = new Audio('https://s3.amazonaws.com/freecodecamp/drums/Kick_n_Hat.mp3'); // Sonido de acierto
        const audioIncorrect = new Audio('https://s3.amazonaws.com/freecodecamp/drums/Dsc_Oh.mp3'); // Sonido de error
        const audioClick = new Audio('https://s3.amazonaws.com/freecodecamp/drums/Heater-1.mp3'); // Sonido de click general

        // Función para reproducir sonido
        function playSound(audio) {
            if (isSoundOn) {
                audio.currentTime = 0; // Reiniciar para poder reproducir rápido
                audio.play().catch(e => console.error("Error al reproducir audio:", e));
            }
        }

        // Función para alternar sonido
        soundToggle.addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            soundIcon.className = isSoundOn ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            playSound(audioClick);
            // Silenciar o activar todos los audios si ya están cargados
            audioCorrect.muted = !isSoundOn;
            audioIncorrect.muted = !isSoundOn;
            audioClick.muted = !isSoundOn;
        });

        // Función para mostrar una pantalla con animación
        function showScreen(screenToShow) {
            const screens = [splashScreen, playerSetupScreen, gameScreen, endScreen];
            screens.forEach(screen => {
                if (screen === screenToShow) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
            // Ajustar el color de fondo del body según la pantalla principal
            if (screenToShow === splashScreen) {
                document.body.style.background = 'linear-gradient(135deg, var(--ineco-azul-principal) 70%, var(--ineco-rojo-acento) 100%)';
            } else {
                document.body.style.background = 'var(--ineco-azul-principal)'; /* Fondo azul sólido para otras pantallas */
            }
        }

        // --- Lógica de la Pantalla de Configuración de Jugadores ---

        // Generar campos de entrada para jugadores
        function generatePlayerInputs() {
            playerInputsDiv.innerHTML = ''; // Limpiar campos existentes
            for (let i = 0; i < currentPlayerCount; i++) {
                const playerGroup = document.createElement('div');
                playerGroup.className = 'player-input-group';
                playerGroup.innerHTML = `
                    <input type="text" placeholder="Nombre Jugador ${i + 1}" id="player${i + 1}Name" value="Jugador ${i + 1}">
                    <button class="random-name-btn" data-player-id="${i + 1}">Nombre Aleatorio</button>
                `;
                playerInputsDiv.appendChild(playerGroup);
            }

            // Añadir event listeners a los nuevos botones de nombre aleatorio
            document.querySelectorAll('.random-name-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    playSound(audioClick);
                    const playerId = event.target.dataset.playerId;
                    const inputField = document.getElementById(`player${playerId}Name`);
                    assignRandomName(inputField);
                });
            });
        }

        // Asignar nombre aleatorio
        function assignRandomName(inputField) {
            const randomIndex = Math.floor(Math.random() * playerNamesList.length);
            inputField.value = playerNamesList[randomIndex];
        }

        // Control de número de jugadores
        decreasePlayersBtn.addEventListener('click', () => {
            playSound(audioClick);
            if (currentPlayerCount > 1) {
                currentPlayerCount--;
                playerCountSpan.textContent = currentPlayerCount;
                generatePlayerInputs();
            }
        });

        increasePlayersBtn.addEventListener('click', () => {
            playSound(audioClick);
            if (currentPlayerCount < 5) {
                currentPlayerCount++;
                playerCountSpan.textContent = currentPlayerCount;
                generatePlayerInputs();
            }
        });

        // --- Lógica de Inicio de Partida ---

        // Mezclar array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Preparar preguntas para el juego
        function prepareQuestions() {
            shuffledQuestions = [];
            const categories = Object.keys(questionsData.preguntas);
            // Para cada categoría, mezclar sus preguntas
            categories.forEach(category => {
                const categoryQuestions = questionsData.preguntas[category].map(q => ({ ...q, category: category }));
                shuffledQuestions = shuffledQuestions.concat(shuffleArray(categoryQuestions));
            });
            // Mezclar todas las preguntas juntas para un orden aleatorio entre categorías
            shuffledQuestions = shuffleArray(shuffledQuestions);
            // Limitar el número total de preguntas si es necesario (ej. 2 preguntas por jugador)
            const totalQuestionsDesired = currentPlayerCount * 2; // Ejemplo: 2 preguntas por jugador
            if (shuffledQuestions.length > totalQuestionsDesired) {
                shuffledQuestions = shuffledQuestions.slice(0, totalQuestionsDesired);
            }
        }

        // Iniciar el juego
        startQuizButton.addEventListener('click', () => {
            playSound(audioClick);
            players = [];
            let allNamesValid = true;
            for (let i = 0; i < currentPlayerCount; i++) {
                const playerNameInput = document.getElementById(`player${i + 1}Name`);
                const name = playerNameInput.value.trim(); 
                if (name === "") {
                    showFeedback("Por favor, introduce un nombre para todos los jugadores.", "error", 2000);
                    allNamesValid = false;
                    break;
                }
                players.push({ name: name, score: 0 });
            }

            if (allNamesValid) {
                currentQuestionIndex = 0;
                currentPlayerIndex = 0;
                prepareQuestions(); // Prepara y mezcla las preguntas
                showScreen(gameScreen);
                displayQuestion();
            }
        });

        // Función para mostrar feedback (correcto/incorrecto)
        function showFeedback(message, type, duration = 1500, explanation = "") {
            feedbackText.textContent = message;
            explanationText.textContent = explanation;
            feedbackMessage.style.backgroundColor = type === 'correct' ? 'var(--ineco-verde-correcto)' : 'var(--ineco-rojo-incorrecto)';
            feedbackMessage.classList.add('show');
            setTimeout(() => {
                feedbackMessage.classList.remove('show');
            }, duration);
        }

        // --- Lógica de la Pantalla de Juego ---

        // Mostrar la pregunta actual
        function displayQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                endGame();
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const currentPlayer = players[currentPlayerIndex];

            currentPlayerInfo.textContent = `Turno de: ${currentPlayer.name}`;
            scoreInfo.textContent = `Puntuación: ${currentPlayer.score}`;
            categoryInfo.textContent = `Categoría: ${currentQuestion.category}`;
            currentCategoryTag.textContent = currentQuestion.category;
            questionText.textContent = currentQuestion.pregunta;

            optionsContainer.innerHTML = ''; // Limpiar opciones anteriores
            currentQuestion.opciones.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.className = 'option-button';
                const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
                optionButton.dataset.option = optionLetter;
                optionButton.textContent = `${optionLetter}. ${option}`;
                optionButton.addEventListener('click', () => checkAnswer(optionLetter));
                optionsContainer.appendChild(optionButton);
            });
        }

        // Comprobar respuesta
        function checkAnswer(selectedOption) {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const currentPlayer = players[currentPlayerIndex];
            const optionButtons = optionsContainer.querySelectorAll('.option-button');

            // Desactivar botones para evitar múltiples clics
            optionButtons.forEach(button => button.disabled = true);

            if (selectedOption === currentQuestion.respuestaCorrecta) {
                currentPlayer.score += 10; // Sumar puntos
                scoreInfo.textContent = `Puntuación: ${currentPlayer.score}`;
                showFeedback("¡Correcto!", "correct", 2500, currentQuestion.explicacion);
                playSound(audioCorrect);
                // Resaltar la opción correcta
                optionButtons.forEach(button => {
                    if (button.dataset.option === selectedOption) {
                        button.classList.add('correct');
                    }
                });
            } else {
                showFeedback("¡Incorrecto!", "incorrect", 3000, `La respuesta correcta era ${currentQuestion.respuestaCorrecta}. ${currentQuestion.explicacion}`);
                playSound(audioIncorrect);
                // Resaltar la opción incorrecta y la correcta
                optionButtons.forEach(button => {
                    if (button.dataset.option === selectedOption) {
                        button.classList.add('incorrect');
                    }
                    if (button.dataset.option === currentQuestion.respuestaCorrecta) {
                        button.classList.add('correct'); // Mostrar cuál era la correcta
                    }
                });
            }

            setTimeout(() => {
                currentQuestionIndex++;
                nextTurn();
            }, 3500); // Esperar un poco para que el usuario vea el feedback
        }

        // Pasar al siguiente turno/jugador
        function nextTurn() {
            currentPlayerIndex++;
            if (currentPlayerIndex >= players.length) {
                currentPlayerIndex = 0; // Volver al primer jugador
            }

            displayQuestion(); // Mostrar la siguiente pregunta o finalizar el juego
        }

        // --- Lógica de la Pantalla de Fin de Juego ---

        function endGame() {
            showScreen(endScreen);
            // Determinar el ganador
            players.sort((a, b) => b.score - a.score); // Ordenar por puntuación descendente
            const winner = players[0];
            winnerMessage.textContent = `¡El ganador es ${winner.name} con ${winner.score} puntos!`;

            // Mostrar puntuaciones finales
            finalScoresDiv.innerHTML = '';
            players.forEach(player => {
                const scoreCard = document.createElement('div');
                scoreCard.className = 'player-score-card';
                scoreCard.innerHTML = `
                    <span>${player.name}</span>
                    <strong>${player.score}</strong>
                `;
                finalScoresDiv.appendChild(scoreCard);
            });
        }

        // Reiniciar el juego (resetea el estado y vuelve a la pantalla de inicio)
        function restartGame() {
            // Resetear variables de juego
            currentPlayerCount = 1;
            players = [];
            currentQuestionIndex = 0;
            currentPlayerIndex = 0;
            shuffledQuestions = [];

            // Resetear UI
            playerCountSpan.textContent = currentPlayerCount;
            generatePlayerInputs(); // Generar un campo de jugador por defecto
            showScreen(splashScreen);
        }

        // --- Inicialización del Juego ---
        function initGame() {
            showScreen(splashScreen);
            generatePlayerInputs(); // Generar el campo inicial de jugador
            appContainer.style.opacity = '1'; // Mostrar el contenedor principal
            appContainer.style.transform = 'translateY(0)';
        }

        // Event Listeners iniciales
        startGameButton.addEventListener('click', () => {
            playSound(audioClick);
            showScreen(playerSetupScreen);
        });

        // Nuevos Event Listeners para los botones de navegación
        backToSplashFromSetupButton.addEventListener('click', () => {
            playSound(audioClick);
            showScreen(splashScreen);
        });

        exitGameButton.addEventListener('click', () => {
            playSound(audioClick);
            restartGame(); // Salir del juego y reiniciar estado
        });

        restartGameButton.addEventListener('click', () => {
            playSound(audioClick);
            restartGame(); // Reutilizar la función para reiniciar y volver al inicio
        });

        closeGameButton.addEventListener('click', () => {
            playSound(audioClick);
            restartGame(); // Cerrar la partida y volver al inicio
        });

        // Iniciar la aplicación cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
