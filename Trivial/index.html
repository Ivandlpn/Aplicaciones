<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INECO - Trivial Ferroviario de Alta Velocidad</title>
    <!-- Importar fuente Poppins de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Importar Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Definición de variables CSS para los colores de la marca INECO */
        :root {
            --ineco-azul-principal: rgb(26, 68, 136);
            --ineco-rojo-acento: rgb(203, 24, 35);
            --ineco-azul-claro: rgb(52, 99, 172);
            --ineco-azul-aun-mas-claro: rgb(107, 150, 207);
            --ineco-blanco-puro: rgb(255, 255, 255);
            --ineco-gris-oscuro: rgb(50, 50, 50);
            --ineco-gris-claro: rgb(230, 230, 230);
            --ineco-verde-correcto: rgb(76, 175, 80); /* Verde para respuestas correctas */
            --ineco-rojo-incorrecto: rgb(244, 67, 54); /* Rojo para respuestas incorrectas */
        }

        /* Estilos globales y reseteo básico */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 100%);
            color: var(--ineco-gris-oscuro);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Eliminado overflow: hidden; para permitir el scroll en el body */
            position: relative;
        }

        /* Contenedor principal del juego */
        .game-container {
            background-color: var(--ineco-blanco-puro);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 900px;
            /* Eliminado min-height: 600px; para permitir altura dinámica */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Mantiene el overflow oculto para el contenedor principal */
            position: relative;
            transition: all 0.5s ease-in-out;
        }

        /* Estilos para las diferentes pantallas del juego */
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow-y: auto; /* Permite el scroll vertical dentro de cada pantalla si el contenido es largo */
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            position: relative; /* Para que ocupe espacio cuando está activo */
            flex-grow: 1; /* Permite que la pantalla activa crezca para llenar el espacio disponible */
        }

        /* Animaciones de entrada/salida */
        .screen.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }

        .screen.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para el logo INECO */
        .ineco-logo {
            position: absolute;
            top: 30px;
            left: 30px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Poppins Semibold */
            font-size: 36px; /* Ajustado para ser visible pero no abrumador */
            color: var(--ineco-azul-principal);
            padding-left: 1.2em; /* Equivalente a la altura de la 'n' para la zona de exclusión */
            padding-top: 0.2em;
            z-index: 10;
        }

        /* Estilos para botones generales */
        .btn {
            background-color: var(--ineco-azul-principal);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600; /* Poppins Semibold */
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 10px;
        }

        .btn:hover {
            background-color: var(--ineco-azul-claro);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Botón de cerrar (X) */
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--ineco-gris-oscuro);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
        }

        .close-btn:hover {
            color: var(--ineco-rojo-acento);
            transform: scale(1.1);
        }
        
        /* Ajuste para el botón de cerrar en splash-screen si es necesario */
        #splash-screen .close-btn {
            color: var(--ineco-blanco-puro); /* Blanco sobre fondo oscuro */
        }
        #splash-screen .close-btn:hover {
            color: var(--ineco-gris-claro);
        }


        /* Estilos específicos de la pantalla de inicio (Splash Screen) */
        #splash-screen {
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, var(--ineco-azul-principal) 0%, var(--ineco-azul-claro) 100%);
            color: var(--ineco-blanco-puro);
            border-radius: 20px; /* Asegura que el gradiente se vea redondeado */
        }

        #splash-screen .ineco-logo {
            color: var(--ineco-blanco-puro); /* Logo blanco sobre fondo oscuro */
        }

        #splash-screen h1 {
            font-size: 3.5em; /* H1: 36-48px */
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Estilos de la pantalla de configuración de jugadores */
        #player-config-screen, #round-config-screen {
            padding: 60px;
            justify-content: flex-start;
            align-items: center;
        }

        #player-config-screen h2, #round-config-screen h2 {
            font-size: 2.2em; /* H2: 28-34px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 30px;
        }

        .player-count-selector, .round-count-selector {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 10px 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .player-count-selector button, .round-count-selector button {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .player-count-selector button:hover, .round-count-selector button:hover {
            background-color: var(--ineco-azul-principal);
        }

        .player-count-selector span, .round-count-selector span {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--ineco-azul-principal);
            margin: 0 20px;
        }

        #player-inputs {
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .player-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-input-group label {
            font-weight: 500; /* Poppins Medium */
            margin-right: 15px;
            color: var(--ineco-gris-oscuro);
            min-width: 80px;
            text-align: right;
        }

        .player-input-group input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 2px solid var(--ineco-gris-claro);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            color: var(--ineco-gris-oscuro);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .player-input-group input[type="text"]:focus {
            outline: none;
            border-color: var(--ineco-azul-claro);
            box-shadow: 0 0 0 3px rgba(52, 99, 172, 0.3);
        }

        .player-input-group .random-name-btn {
            background-color: var(--ineco-rojo-acento);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* Evita que el texto se rompa */
        }

        .player-input-group .random-name-btn:hover {
            background-color: rgb(170, 20, 29); /* Rojo un poco más oscuro */
        }

        /* Estilos de la pantalla de juego */
        #game-screen {
            padding: 30px;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
            justify-content: flex-start;
            align-items: center; /* Center items horizontally */
            position: relative;
            padding-top: 100px; /* Give space for logo, buttons, and player turn display */
        }

        /* Estilo para el texto del turno del jugador */
        #current-player-turn-display {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--ineco-azul-principal);
            position: absolute; /* Posicionamiento absoluto para centrarlo */
            left: 50%;
            transform: translateX(-50%);
            top: 60px; /* Ajusta según sea necesario para que no se solape con el logo y botones */
            white-space: nowrap; /* Evita que el texto se rompa en varias líneas */
            z-index: 15; /* Asegura que esté por encima del logo si se solapan */
        }

        /* Botón de cerrar (X) */
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--ineco-gris-oscuro);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
        }

        .close-btn:hover {
            color: var(--ineco-rojo-acento);
            transform: scale(1.1);
        }

        /* Botón para abrir el marcador */
        #show-score-btn {
            position: absolute;
            top: 20px; /* Alineado con el close-btn */
            right: 70px; /* Desplazado a la izquierda para no solaparse con la X */
            background: none;
            border: none;
            font-size: 2em; /* Tamaño del icono */
            color: var(--ineco-azul-principal);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px; /* Para hacer el área de clic más grande */
            border-radius: 50%;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
        }

        #show-score-btn:hover {
            color: var(--ineco-rojo-acento);
            transform: scale(1.1);
        }

        /* El marcador en línea se ha eliminado, pero mantenemos las clases si se usan en el modal */
        .score-board {
            display: none; /* Ocultar el marcador en la pantalla de juego */
        }

        .player-score {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--ineco-gris-oscuro);
            display: flex;
            align-items: center;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .player-score.current-turn {
            color: var(--ineco-rojo-acento);
            font-weight: 600;
            transform: scale(1.1);
        }

        .player-score span:first-child {
            margin-right: 5px;
        }

        /* Estilos para el contenedor de la pregunta */
        #question-area {
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            width: 100%;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden; /* Para animaciones de texto */
            display: flex; /* Usar flexbox para organizar elementos internos */
            flex-direction: column; /* Apilar elementos verticalmente */
            align-items: center; /* Centrar contenido horizontalmente */
        }

        /* Estilos para la categoría dentro de la tarjeta de pregunta */
        #question-area .category-display {
            font-size: 1.2em; /* Un poco más pequeño que el original de la cabecera */
            font-weight: 500;
            color: var(--ineco-azul-principal);
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* Espacio entre la categoría y la pregunta */
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Línea divisoria sutil */
            width: 100%; /* Ocupa todo el ancho de la tarjeta */
            justify-content: center; /* Centrar el texto de la categoría */
        }

        #question-area .category-display i {
            margin-right: 10px;
            font-size: 1em; /* Ajustar tamaño del icono */
            color: var(--ineco-rojo-acento);
        }

        #question-text {
            font-size: 1.6em; /* H3: 22-26px */
            font-weight: 600; /* Poppins Semibold */
            color: var(--ineco-azul-principal);
            margin-bottom: 25px;
            line-height: 1.4;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        #question-text.fade-out-text {
            opacity: 0;
            transform: translateY(-20px);
        }

        #question-text.fade-in-text {
            opacity: 1;
            transform: translateY(0);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .option-btn {
            background-color: var(--ineco-azul-claro);
            color: var(--ineco-blanco-puro);
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1em; /* Cuerpo: 16-18px */
            font-weight: 500; /* Poppins Medium */
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .option-btn:hover {
            background-color: var(--ineco-azul-principal);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .option-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .option-btn.correct {
            background-color: var(--ineco-verde-correcto);
            animation: pulse-correct 0.5s ease-out forwards;
        }

        .option-btn.incorrect {
            background-color: var(--ineco-rojo-incorrecto);
            animation: shake-incorrect 0.5s ease-out forwards;
        }

        @keyframes pulse-correct {
            0% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
            50% { transform: scale(1.03); box-shadow: 0 0 20px var(--ineco-verde-correcto); }
            100% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
        }

        @keyframes shake-incorrect {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        /* Mensaje de feedback (explicación) */
        #feedback-message {
            background-color: var(--ineco-azul-aun-mas-claro);
            color: var(--ineco-blanco-puro);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1em;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            text-align: left;
            position: relative; /* Necesario para posicionar el botón de cerrar */
        }

        #feedback-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para el botón de cerrar la explicación */
        #close-feedback-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.5em; /* Tamaño del icono */
            color: var(--ineco-blanco-puro);
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            padding: 5px; /* Aumenta el área de clic */
            line-height: 1; /* Alineación vertical de la 'X' */
        }

        #close-feedback-btn:hover {
            transform: scale(1.1);
            color: var(--ineco-gris-claro);
        }

        /* Estilos de la pantalla de fin de juego */
        #end-screen {
            padding: 60px;
            justify-content: center;
            align-items: center;
            position: relative; /* Necesario para el confeti */
            overflow: hidden; /* Asegura que el confeti no se salga del contenedor */
        }

        #end-screen h2 {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
        }

        #end-screen h3 {
            font-size: 2.8em; /* Aumentado para mayor impacto */
            font-weight: 800; /* Extra bold */
            color: var(--ineco-rojo-acento);
            margin-bottom: 30px;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.4);
            animation: winner-bounce 0.8s ease-out forwards; /* Animación de rebote */
        }

        /* Animación para el texto del ganador */
        @keyframes winner-bounce {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        #final-scores {
            width: 100%;
            max-width: 500px;
            margin-bottom: 40px;
            background-color: var(--ineco-gris-claro);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .final-player-score {
            display: flex;
            justify-content: space-between;
            font-size: 1.3em;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }

        .final-player-score:last-child {
            border-bottom: none;
        }

        .final-player-score .name {
            font-weight: 500;
            color: var(--ineco-gris-oscuro);
        }

        .final-player-score .score {
            font-weight: 600;
            color: var(--ineco-azul-principal);
        }

        /* Estilos para el confeti */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none; /* Permite que los clics pasen a través */
            z-index: 999;
            opacity: 0; /* Oculto por defecto */
            transition: opacity 0.5s ease-in-out;
        }

        #confetti-container.show-confetti {
            opacity: 1;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards, confetti-rotate 2s infinite linear;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes confetti-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el modal del marcador */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semitransparente oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--ineco-blanco-puro);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            font-size: 1.8em;
            color: var(--ineco-azul-principal);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .modal-content ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--ineco-gris-claro);
            font-size: 1.2em;
            color: var(--ineco-gris-oscuro);
        }

        .modal-content ul li:last-child {
            border-bottom: none;
        }

        .modal-content ul li .player-name-modal {
            font-weight: 500;
        }

        .modal-content ul li .player-score-modal {
            font-weight: 600;
            color: var(--ineco-azul-principal);
        }

        /* Estilos responsivos */
        @media (max-width: 768px) {
            .game-container {
                width: 95%;
                min-height: 500px; /* Mantener un min-height para móviles si es necesario */
            }

            .ineco-logo {
                font-size: 28px;
                top: 20px;
                left: 20px;
                padding-left: 1em;
            }

            #splash-screen h1 {
                font-size: 2.5em;
            }

            .btn {
                padding: 12px 25px;
                font-size: 1em;
            }

            #player-config-screen h2, #round-config-screen h2 {
                font-size: 1.8em;
            }

            .player-count-selector, .round-count-selector {
                padding: 8px 15px;
            }

            .player-count-selector button, .round-count-selector button {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }

            .player-count-selector span, .round-count-selector span {
                font-size: 1.5em;
                margin: 0 15px;
            }

            .player-input-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-input-group label {
                margin-bottom: 5px;
                text-align: left;
            }

            .player-input-group input[type="text"] {
                width: 100%;
                margin-bottom: 10px;
            }

            .player-input-group .random-name-btn {
                width: 100%;
                margin-left: 0;
            }

            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .game-header .category-display {
                font-size: 1.2em;
            }

            .score-board {
                width: 100%;
                justify-content: space-around;
                gap: 10px;
            }

            .player-score {
                font-size: 0.9em;
            }

            #question-text {
                font-size: 1.3em;
            }

            .options-grid {
                grid-template-columns: 1fr; /* Una columna en móviles */
            }

            .option-btn {
                padding: 12px 15px;
                font-size: 1em;
            }

            #feedback-message {
                font-size: 0.9em;
            }

            #end-screen h2 {
                font-size: 2em;
            }

            #end-screen h3 {
                font-size: 1.5em;
            }

            .final-player-score {
                font-size: 1.1em;
            }

            .close-btn {
                font-size: 1.5em;
                top: 15px;
                right: 15px;
            }

            #show-score-btn {
                font-size: 1.8em;
                top: 10px;
                right: 50px; /* Ajustado para móviles */
            }

            .modal-content {
                padding: 20px;
            }

            .modal-content h3 {
                font-size: 1.5em;
            }

            .modal-content ul li {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
            }
            .screen {
                padding: 20px;
            }
            .ineco-logo {
                font-size: 24px;
                top: 15px;
                left: 15px;
            }
            #splash-screen h1 {
                font-size: 2em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            #player-config-screen h2, #round-config-screen h2 {
                font-size: 1.5em;
            }
            #question-text {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Logo INECO, visible en todas las pantallas -->
        <div class="ineco-logo">ineco</div>

        <!-- Simple Message Display for UI feedback -->
        <div id="ui-message" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--ineco-rojo-acento); color: var(--ineco-blanco-puro); padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; display: none;">
            <span id="ui-message-text"></span>
        </div>

        <!-- Pantalla de Inicio (Splash Screen) -->
        <div id="splash-screen" class="screen active">
            <h1>Trivial Ferroviario de Alta Velocidad</h1>
            <button id="start-game-btn" class="btn">Iniciar Juego</button>
        </div>

        <!-- Pantalla de Configuración de Jugadores -->
        <div id="player-config-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">&times;</button>
            <h2>Configuración de Partida</h2>
            <div class="player-count-selector">
                <button id="decrease-players-btn">-</button>
                <span id="player-count">1</span>
                <button id="increase-players-btn">+</button>
            </div>
            <div id="player-inputs">
                <!-- Los campos de entrada de jugadores se generarán aquí dinámicamente -->
            </div>
            <button id="start-match-btn" class="btn">Empezar Partida</button>
        </div>

        <!-- Pantalla de Configuración de Rondas -->
        <div id="round-config-screen" class="screen">
            <button class="close-btn" data-target-screen="player-config-screen">&times;</button>
            <h2>¿Cuántas preguntas por jugador?</h2>
            <div class="round-count-selector">
                <button id="decrease-rounds-btn">-</button>
                <span id="round-count">5</span> <!-- Valor por defecto: 5 preguntas por jugador -->
                <button id="increase-rounds-btn">+</button>
            </div>
            <button id="start-game-from-rounds-btn" class="btn">¡A Jugar!</button>
        </div>

        <!-- Pantalla de Juego Principal -->
        <div id="game-screen" class="screen">
            <button class="close-btn" data-target-screen="confirm-exit">&times;</button> <!-- Confirmación para salir -->
            <button id="show-score-btn" class="fas fa-medal"></button> <!-- Botón para el marcador -->
            <span id="current-player-turn-display"></span> <!-- Nuevo elemento para el turno del jugador -->
            <!-- El game-header ya no contiene la categoría, solo se mantiene si hay otros elementos en el futuro -->
            <!-- <div class="game-header"></div> -->
            <div id="question-area">
                <div class="category-display"> <!-- La categoría ahora está dentro de question-area -->
                    <i id="category-icon" class="fas fa-question-circle"></i>
                    <span id="category-name">Categoría</span>
                </div>
                <p id="question-text">Cargando pregunta...</p>
                <div id="options-grid" class="options-grid">
                    <button class="option-btn" data-option="A">A) Opción 1</button>
                    <button class="option-btn" data-option="B">B) Opción 2</button>
                    <button class="option-btn" data-option="C">C) Opción 3</button>
                    <button class="option-btn" data-option="D">D) Opción 4</button>
                </div>
            </div>
            <div id="feedback-message">
                <p id="feedback-text"></p>
                <button id="close-feedback-btn" class="close-feedback-btn">&times;</button>
            </div>
        </div>

        <!-- Pantalla de Fin de Juego -->
        <div id="end-screen" class="screen">
            <button class="close-btn" data-target-screen="splash-screen">&times;</button>
            <div id="confetti-container"></div> <!-- Contenedor para el confeti -->
            <h2>¡Partida Terminada!</h2>
            <h3 id="winner-display"></h3>
            <div id="final-scores">
                <!-- Las puntuaciones finales se mostrarán aquí -->
            </div>
            <button id="play-again-btn" class="btn">Volver a Jugar</button>
        </div>

        <!-- Modal del Marcador -->
        <div id="score-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" data-target-screen="hide-modal">&times;</button>
                <h3>Clasificación Actual</h3>
                <ul id="modal-score-list">
                    <!-- Las puntuaciones se cargarán aquí dinámicamente -->
                </ul>
            </div>
        </div>

        <!-- Modal de Confirmación de Salida (para game-screen) -->
        <div id="confirm-exit-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>¿Estás seguro que quieres salir?</h3>
                <p>Se perderá el progreso actual de la partida.</p>
                <button id="confirm-exit-yes" class="btn">Sí, salir</button>
                <button id="confirm-exit-no" class="btn">No, continuar</button>
            </div>
        </div>

    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS ---
        const gameData = {
            "preguntas": {
                "Elementos Estructurales de la Vía": [
                    {
                        "pregunta": "¿Cuál es la función principal del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "Asegurar la conductividad eléctrica de los carriles.",
                            "Transmitir las cargas de los trenes al terreno y asegurar la estabilidad de la vía.",
                            "Reducir la fricción entre la rueda y el carril.",
                            "Actuar como aislante térmico."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El balasto distribuye las cargas de las traviesas al terraplén, proporciona drenaje y contribuye a la estabilidad lateral y longitudinal de la vía, esencial para las altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué técnica se utiliza comúnmente para el mantenimiento del perfil del carril y la eliminación de defectos superficiales en vías de alta velocidad?",
                        "opciones": [
                            "Bateo de balasto.",
                            "Reemplazo completo de carril.",
                            "Esmerilado o amolado de carril.",
                            "Engrasado de las sujeciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El esmerilado de carril permite restaurar el perfil óptimo, eliminar ondulaciones y grietas superficiales, prolongando la vida útil del carril y mejorando la calidad de rodadura."
                    },
                    {
                        "pregunta": "¿Qué tipo de sujeción es más común en las vías de alta velocidad para asegurar la rigidez y el aislamiento eléctrico?",
                        "opciones": [
                            "Brida metálica.",
                            "Sujeción rígida con tornillos de banco.",
                            "Sujeción elástica con almohadilla de caucho y grapas.",
                            "Clavos de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las sujeciones elásticas, como las de tipo Pandrol o Vossloh, proporcionan una fijación constante del carril a la traviesa, absorben vibraciones y garantizan el aislamiento eléctrico, crucial para los sistemas de señalización."
                    },
                    {
                        "pregunta": "¿Cuál es la principal diferencia entre una traviesa monobloque y una bibloque en términos de su comportamiento en la vía de alta velocidad?",
                        "opciones": [
                            "La monobloque es más flexible y la bibloque más rígida.",
                            "La monobloque es de madera y la bibloque de hormigón.",
                            "La monobloque ofrece mayor rigidez transversal y mejor comportamiento frente a la deformación lateral.",
                            "La bibloque permite un menor ancho de vía."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las traviesas monobloque de hormigón pretensado son el estándar en alta velocidad debido a su mayor masa y rigidez, que optimizan la transmisión de cargas y la estabilidad geométrica de la vía."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de los cordones de soldadura en los carriles de una vía de alta velocidad?",
                        "opciones": [
                            "Aumentar la resistencia a la abrasión del carril.",
                            "Unir los tramos de carril de forma continua para evitar juntas y mejorar la rodadura.",
                            "Facilitar la dilatación térmica de los carriles.",
                            "Servir como punto de anclaje para los sistemas de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La soldadura continua de carril (CRC) elimina las juntas, lo que mejora el confort de viaje, reduce el ruido y las vibraciones, y minimiza el mantenimiento de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué se busca optimizar al realizar una compactación dinámica del balasto en una vía de alta velocidad?",
                        "opciones": [
                            "La capacidad de drenaje del balasto.",
                            "La resistencia del balasto a la pulverización.",
                            "La uniformidad de la densidad y la resistencia al asiento de la banqueta de balasto.",
                            "La temperatura del balasto para evitar dilataciones."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La compactación dinámica mejora la estabilidad y la resistencia del balasto, asegurando que la geometría de la vía se mantenga estable bajo las cargas dinámicas de los trenes de alta velocidad."
                    },
                    {
                        "pregunta": "¿Cuál es el objetivo principal del mantenimiento de la explanación y el terraplén en una línea de alta velocidad?",
                        "opciones": [
                            "Mejorar el paisaje circundante.",
                            "Asegurar la estabilidad geotécnica de la plataforma y el drenaje adecuado.",
                            "Reducir el coste de construcción de la vía.",
                            "Facilitar la instalación de la catenaria."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Una plataforma estable y un buen drenaje son fundamentales para evitar asientos diferenciales y deformaciones de la vía, que comprometerían la seguridad y el confort a altas velocidades."
                    },
                    {
                        "pregunta": "¿Qué tipo de sistema de drenaje es crucial en túneles de alta velocidad para evitar la acumulación de agua?",
                        "opciones": [
                            "Acequias a cielo abierto.",
                            "Bombas de achique manuales.",
                            "Cunetas, colectores y pozos de bombeo integrados en la infraestructura.",
                            "Filtración natural a través del balasto."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El drenaje en túneles es vital para prevenir la inundación, la corrosión de elementos metálicos y el deterioro de la infraestructura, asegurando la operatividad de la línea."
                    },
                    {
                        "pregunta": "¿Qué función cumple la capa de subbalasto en la superestructura de una vía de alta velocidad?",
                        "opciones": [
                            "Aislar térmicamente el balasto.",
                            "Evitar la mezcla del balasto con el material del terraplén y mejorar la distribución de cargas.",
                            "Actuar como elemento conductor de la señalización.",
                            "Soportar directamente el peso de los trenes."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El subbalasto actúa como una capa de transición entre el balasto y la explanación, impidiendo la contaminación del balasto y mejorando la uniformidad de la transmisión de tensiones."
                    },
                    {
                        "pregunta": "¿Qué se entiende por 'recalzado' de traviesas en el mantenimiento ferroviario?",
                        "opciones": [
                            "El proceso de añadir una nueva traviesa a la vía.",
                            "La sustitución de los carriles sobre las traviesas existentes.",
                            "La adición de balasto bajo las traviesas para mejorar el apoyo y la nivelación.",
                            "La limpieza de la superficie de las traviesas."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "El recalzado consiste en introducir balasto debajo de las traviesas, generalmente mediante bateadoras, para corregir la nivelación y alineación de la vía."
                    }
                ],
                "Maquinaria y Herramientas": [
                    {
                        "pregunta": "¿Cuál es la función principal de una bateadora pesada en el mantenimiento de vías de alta velocidad?",
                        "opciones": [
                            "Soldar automáticamente los carriles.",
                            "Limpiar la superficie de los carriles.",
                            "Compactar el balasto bajo las traviesas para corregir la geometría de la vía.",
                            "Inspeccionar visualmente el estado de la catenaria."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las bateadoras son máquinas esenciales para el mantenimiento de la geometría de la vía (alineación, nivelación, peralte) mediante la vibración y compactación del balasto."
                    },
                    {
                        "pregunta": "¿Qué equipo se utiliza para medir con precisión la altura y la flecha de la catenaria en una línea de alta velocidad?",
                        "opciones": [
                            "Un nivel óptico y una mira topográfica.",
                            "Un carro de auscultación de catenaria o drones con sistemas láser.",
                            "Un voltímetro de alta tensión.",
                            "Un dinamómetro."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La precisión en la medición de la catenaria es crítica para asegurar el correcto contacto con el pantógrafo a altas velocidades y evitar desprendimientos."
                    },
                    {
                        "pregunta": "¿Cuál es la principal ventaja de utilizar detectores de defectos por ultrasonidos en los carriles de alta velocidad?",
                        "opciones": [
                            "Identificar la temperatura de la superficie del carril.",
                            "Detectar fisuras internas y defectos ocultos que no son visibles a simple vista.",
                            "Medir la resistencia eléctrica del carril.",
                            "Determinar la composición química del acero del carril."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los ultrasonidos permiten un mantenimiento predictivo, detectando fallos incipientes antes de que se propaguen y comprometan la seguridad."
                    },
                    {
                        "pregunta": "¿Qué tipo de máquina es fundamental para el reperfilado de los carriles, mejorando la interacción rueda-carril y reduciendo el ruido?",
                        "opciones": [
                            "Una desguarnecedora.",
                            "Una perfiladora de carril (o amoladora de grandes dimensiones).",
                            "Una soldadora aluminotérmica.",
                            "Una bateadora ligera."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La perfiladora restaura la forma óptima de la cabeza del carril, mejorando la calidad de la rodadura y prolongando la vida útil del carril y de las ruedas."
                    },
                    {
                        "pregunta": "¿Cuál es el propósito de una máquina desguarnecedora en el mantenimiento de la vía?",
                        "opciones": [
                            "Retirar los residuos de balasto y limpiar la plataforma de la vía.",
                            "Soldar tramos de carril largos.",
                            "Perforar las traviesas para instalar sujeciones.",
                            "Transportar material de obra."
                        ],
                        "respuestaCorrecta": "A",
                        "explicacion": "La desguarnecedora limpia el balasto sucio o contaminado, lo que es vital para mantener la capacidad de drenaje y la elasticidad de la superestructura."
                    },
                    {
                        "pregunta": "¿Qué herramienta manual es esencial para comprobar el apriete correcto de los tornillos en las uniones de carril o sujeciones?",
                        "opciones": [
                            "Un martillo de bola.",
                            "Una llave de grifa.",
                            "Una llave dinamométrica.",
                            "Un taladro percutor."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La llave dinamométrica asegura que el par de apriete sea el especificado, evitando tanto aflojamientos como sobretensiones que puedan dañar los elementos."
                    },
                    {
                        "pregunta": "¿Qué tipo de vehículo auxiliar se utiliza para el transporte de personal y pequeñas herramientas a lo largo de la vía?",
                        "opciones": [
                            "Un tren de obras.",
                            "Una locomotora de línea.",
                            "Una dresina o vagoneta de vía.",
                            "Un tren de socorro."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las dresinas son vehículos ligeros y versátiles, diseñados para moverse sobre la vía con rapidez y eficacia en operaciones de inspección y pequeño mantenimiento."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal de los trenes de auscultación en alta velocidad?",
                        "opciones": [
                            "Transportar viajeros a alta velocidad.",
                            "Medir y registrar continuamente los parámetros geométricos y dinámicos de la vía y la catenaria.",
                            "Realizar operaciones de soldadura en movimiento.",
                            "Apagar incendios en la infraestructura."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los trenes de auscultación son clave para el mantenimiento predictivo, permitiendo identificar anomalías y planificar intervenciones antes de que surjan problemas críticos."
                    },
                    {
                        "pregunta": "¿Qué se mide con una galga de vía?",
                        "opciones": [
                            "La altura de la catenaria.",
                            "El ancho de la vía (entre caras activas de los carriles).",
                            "La temperatura del carril.",
                            "La tensión de los cables de señalización."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El ancho de vía es un parámetro crítico para la seguridad y el confort, especialmente en alta velocidad, y su control es fundamental."
                    },
                    {
                        "pregunta": "¿Qué tipo de soldadura se utiliza más comúnmente para unir tramos de carril de forma rápida y eficiente en campo?",
                        "opciones": [
                            "Soldadura por resistencia eléctrica.",
                            "Soldadura TIG.",
                            "Soldadura aluminotérmica.",
                            "Soldadura por arco sumergido."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La soldadura aluminotérmica es ampliamente utilizada por su rapidez y por no requerir equipos eléctricos complejos en campo, aunque la soldadura por resistencia es el método preferido en talleres para la fabricación de carriles largos."
                    }
                ],
                "Sistemas y Tecnologías": [
                    {
                        "pregunta": "¿Qué sistema de señalización y control de trenes es el estándar europeo para las líneas de alta velocidad?",
                        "opciones": [
                            "ASFA (Anuncio de Señales y Frenado Automático).",
                            "ERTMS (European Rail Traffic Management System).",
                            "CTC (Control de Tráfico Centralizado).",
                            "ATO (Automatic Train Operation)."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "ERTMS, con sus niveles ETCS (European Train Control System) y GSM-R (Global System for Mobile Communications – Railway), es el sistema interoperable que permite la circulación segura de trenes de alta velocidad a través de diferentes países europeos."
                    },
                    {
                        "pregunta": "¿Cuál es la función principal de los circuitos de vía en una línea ferroviaria electrificada de alta velocidad?",
                        "opciones": [
                            "Suministrar energía a los trenes.",
                            "Detectar la presencia de trenes y la integridad del carril para la señalización.",
                            "Calentar los carriles en invierno.",
                            "Comunicar al maquinista la velocidad máxima permitida."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los circuitos de vía son fundamentales para la detección de ocupación y la supervisión de la continuidad del carril, enviando información al enclavamiento y al sistema de señalización."
                    },
                    {
                        "pregunta": "¿Qué característica principal tiene la catenaria rígida frente a la catenaria flexible en túneles de alta velocidad?",
                        "opciones": [
                            "Mayor flexibilidad para adaptarse a las curvas.",
                            "Menor coste de instalación inicial.",
                            "Mayor resistencia al fuego y menor necesidad de mantenimiento.",
                            "Mayor facilidad para la detección de averías."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La catenaria rígida es preferida en túneles por su robustez, menor número de puntos de fijación y su resistencia a las deformaciones por la onda de presión generada por los trenes de alta velocidad."
                    },
                    {
                        "pregunta": "¿Qué se utiliza para la transmisión de datos y voz en el sistema GSM-R de las líneas de alta velocidad?",
                        "opciones": [
                            "Cables de cobre coaxiales.",
                            "Ondas de radio de baja frecuencia.",
                            "Fibra óptica y radioenlaces digitales.",
                            "Señales luminosas."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La fibra óptica es la 'columna vertebral' de las comunicaciones en alta velocidad, proporcionando el ancho de banda y la fiabilidad necesarios para GSM-R, SCADA y otros sistemas."
                    },
                    {
                        "pregunta": "¿Cuál es el principal objetivo de un sistema SCADA (Supervisory Control And Data Acquisition) en la infraestructura de alta velocidad?",
                        "opciones": [
                            "Controlar las taquillas de las estaciones.",
                            "Gestionar y supervisar remotamente las instalaciones fijas como subestaciones, sistemas de ventilación o iluminación.",
                            "Automatizar la limpieza de los trenes.",
                            "Regular el flujo de pasajeros en los andenes."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "SCADA permite a los operadores monitorizar y controlar la infraestructura desde un centro de control, facilitando la detección de anomalías y la respuesta rápida."
                    },
                    {
                        "pregunta": "¿Qué tipo de pruebas se realizan periódicamente en los sistemas de balizas ERTMS para asegurar su correcto funcionamiento?",
                        "opciones": [
                            "Pruebas de resistencia mecánica.",
                            "Pruebas de impermeabilidad.",
                            "Pruebas de lectura y escritura de telegramas, y calibración de frecuencia.",
                            "Pruebas de impacto a alta velocidad."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "Las balizas transmiten información vital al tren, por lo que su correcta calibración y funcionamiento son esenciales para la seguridad operativa."
                    },
                    {
                        "pregunta": "¿Qué es la 'zona de paso' en un sistema de electrificación ferroviario y por qué es crítica para el mantenimiento?",
                        "opciones": [
                            "El espacio por donde pasan los trenes.",
                            "Un tramo de vía sin catenaria para maniobras.",
                            "El punto donde se unen dos zonas de alimentación eléctrica diferentes con distinto potencial, requiriendo un aislamiento o cambio de tensión.",
                            "La zona de amortiguación de ruido."
                        ],
                        "respuestaCorrecta": "C",
                        "explicacion": "La zona de paso requiere procedimientos específicos para los trenes (bajada de pantógrafo, desconexión de tracción) y un mantenimiento riguroso de sus elementos (aisladores, seccionadores) para evitar cortocircuitos y arcos eléctricos."
                    },
                    {
                        "pregunta": "¿Cuál es la función de un contador de ejes en un sistema de señalización?",
                        "opciones": [
                            "Contar el número de trenes que circulan por una sección.",
                            "Determinar si una sección de vía está libre u ocupada contando los ejes que entran y salen.",
                            "Medir el desgaste de las ruedas del tren.",
                            "Calcular la velocidad del tren."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "Los contadores de ejes son una alternativa a los circuitos de vía para la detección de ocupación, especialmente en túneles o en zonas con problemas de drenaje, ofreciendo una alta fiabilidad."
                    },
                    {
                        "pregunta": "¿Qué se entiende por 'seccionamiento' de la catenaria y cuándo se utiliza en mantenimiento?",
                        "opciones": [
                            "La división física de la catenaria en tramos.",
                            "La interrupción deliberada del suministro eléctrico a un tramo de catenaria para realizar trabajos de mantenimiento con seguridad.",
                            "La conexión de dos tramos de catenaria para formar un bucle.",
                            "El proceso de reparación de una catenaria rota."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "El seccionamiento es una medida de seguridad fundamental que garantiza que el personal de mantenimiento pueda trabajar en la catenaria sin riesgo eléctrico, mediante la apertura de seccionadores y la puesta a tierra."
                    },
                    {
                        "pregunta": "¿Qué sistema se utiliza para monitorizar la salud estructural de puentes y viaductos en tiempo real en líneas de alta velocidad?",
                        "opciones": [
                            "Cámaras de seguridad de CCTV.",
                            "Sistemas de auscultación continua con sensores (fibra óptica, acelerómetros, etc.).",
                            "Inspecciones visuales diarias por parte del maquinista.",
                            "Análisis de la composición del hormigón."
                        ],
                        "respuestaCorrecta": "B",
                        "explicacion": "La monitorización estructural permite detectar cualquier anomalía o deterioro en tiempo real, facilitando el mantenimiento predictivo y asegurando la integridad de las grandes estructuras."
                    }
                ]
            }
        };

        // --- VARIABLES GLOBALES DEL JUEGO ---
        let players = []; // Almacena los objetos de jugador { name: string, score: number }
        let currentPlayerIndex = 0; // Índice del jugador actual
        let currentQuestionIndex = 0; // Índice de la pregunta actual en el array shuffledQuestions
        let questionsPerGame = 0; // Número total de preguntas por partida (se establecerá dinámicamente)
        let questionsPerPlayer = 5; // Número de preguntas por jugador (valor por defecto, mínimo 1)
        let shuffledQuestions = []; // Array de preguntas mezcladas para la partida actual
        let feedbackTimer = null; // Variable para almacenar el ID del temporizador de la explicación

        // Nombres aleatorios divertidos relacionados con el ferrocarril
        const randomRailwayNames = [
            "Traviesín", "Tunelillo", "Rielín", "Vibración Veloz", "Balasto Boss",
            "Catenaria Kid", "Señalino", "Durmiente Dinámico", "Fibra Óptica Fan", "Amolador As",
            "Bateadora Berta", "Inspector Hilario", "Durmiente Ágil", "Biela Veloz", "Trenelito",
            "Vía Láctea", "Pantógrafo Power", "Señor Señal", "Cat-enaria", "Ingeniero Rieles",
            "Desvío Divertido", "Terraplén Teo", "Túnelín el Astuto", "Puente Patán", "Balasto Brillante",
            "Soldador Sergio", "Frenada Fantástica", "Inspector Javier"
        ];
        let usedRandomNames = new Set(); // Para evitar nombres repetidos en la misma partida

        const maxQuestionsAvailable = Object.values(gameData.preguntas).flat().length; // Total de 40 preguntas

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const splashScreen = document.getElementById('splash-screen');
        const playerConfigScreen = document.getElementById('player-config-screen');
        const roundConfigScreen = document.getElementById('round-config-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');

        const startGameBtn = document.getElementById('start-game-btn');
        const decreasePlayersBtn = document.getElementById('decrease-players-btn');
        const increasePlayersBtn = document.getElementById('increase-players-btn');
        const playerCountSpan = document.getElementById('player-count');
        const playerInputsDiv = document.getElementById('player-inputs');
        const startMatchBtn = document.getElementById('start-match-btn');

        const decreaseRoundsBtn = document.getElementById('decrease-rounds-btn');
        const increaseRoundsBtn = document.getElementById('increase-rounds-btn');
        const roundCountSpan = document.getElementById('round-count');
        const startGameFromRoundsBtn = document.getElementById('start-game-from-rounds-btn');

        const currentPlayerTurnDisplay = document.getElementById('current-player-turn-display'); // Nuevo elemento
        const questionTextP = document.getElementById('question-text');
        const optionsGridDiv = document.getElementById('options-grid');
        const optionButtons = optionsGridDiv.querySelectorAll('.option-btn');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const feedbackTextP = document.getElementById('feedback-text'); // Nuevo elemento para el texto de la explicación
        const closeFeedbackBtn = document.getElementById('close-feedback-btn'); // Nuevo botón de cerrar explicación

        const winnerDisplayH3 = document.getElementById('winner-display');
        const finalScoresDiv = document.getElementById('final-scores');
        const playAgainBtn = document.getElementById('play-again-btn');
        const confettiContainer = document.getElementById('confetti-container'); // Nueva referencia al contenedor de confeti

        const scoreModal = document.getElementById('score-modal'); // Referencia al modal del marcador
        const modalScoreList = document.getElementById('modal-score-list'); // Lista dentro del modal
        const showScoreBtn = document.getElementById('show-score-btn'); // Botón para abrir el marcador
        const confirmExitModal = document.getElementById('confirm-exit-modal'); // Modal de confirmación de salida
        const confirmExitYesBtn = document.getElementById('confirm-exit-yes');
        const confirmExitNoBtn = document.getElementById('confirm-exit-no');

        // Referencias a elementos de categoría que ahora están dentro de #question-area
        let categoryIcon;
        let categoryNameSpan;


        // Colores de confeti basados en la paleta INECO
        const inecoConfettiColors = [
            'var(--ineco-rojo-acento)',
            'var(--ineco-azul-principal)',
            'var(--ineco-azul-claro)',
            'var(--ineco-blanco-puro)'
        ];

        // --- FUNCIONES DE UTILIDAD ---

        /**
         * Muestra una pantalla específica y oculta las demás.
         * Aplica transiciones de fade.
         * @param {HTMLElement} screenToShow El elemento de la pantalla a mostrar.
         */
        function showScreen(screenToShow) {
            const allScreens = [splashScreen, playerConfigScreen, roundConfigScreen, gameScreen, endScreen];
            allScreens.forEach(screen => {
                if (screen === screenToShow) {
                    screen.classList.remove('fade-out');
                    screen.classList.add('active', 'fade-in');
                } else {
                    screen.classList.remove('active', 'fade-in');
                    screen.classList.add('fade-out');
                }
            });
        }

        /**
         * Mezcla un array (algoritmo de Fisher-Yates).
         * @param {Array} array El array a mezclar.
         * @returns {Array} El array mezclado.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Obtiene un nombre de ferrocarril aleatorio y único.
         * @returns {string} Un nombre de ferrocarril aleatorio.
         */
        function getRandomRailwayName() {
            if (usedRandomNames.size === randomRailwayNames.length) {
                // Si todos los nombres han sido usados, reiniciar el set
                usedRandomNames.clear();
            }
            let name;
            do {
                name = randomRailwayNames[Math.floor(Math.random() * randomRailwayNames.length)];
            } while (usedRandomNames.has(name));
            usedRandomNames.add(name);
            return name;
        }

        /**
         * Actualiza los campos de entrada de nombre de jugador según el número de jugadores.
         */
        function updatePlayerInputs() {
            const playerCount = parseInt(playerCountSpan.textContent);
            playerInputsDiv.innerHTML = ''; // Limpiar campos existentes
            for (let i = 0; i < playerCount; i++) {
                const playerInputGroup = document.createElement('div');
                playerInputGroup.classList.add('player-input-group');
                playerInputGroup.innerHTML = `
                    <label for="player-name-${i + 1}">Jugador ${i + 1}:</label>
                    <input type="text" id="player-name-${i + 1}" placeholder="Introduce tu nombre" value="Jugador ${i + 1}">
                    <button type="button" class="random-name-btn" data-player-index="${i}">Nombre Aleatorio</button>
                `;
                playerInputsDiv.appendChild(playerInputGroup);
            }

            // Añadir event listeners a los nuevos botones de nombre aleatorio
            playerInputsDiv.querySelectorAll('.random-name-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const index = button.dataset.playerIndex;
                    document.getElementById(`player-name-${parseInt(index) + 1}`).value = getRandomRailwayName();
                });
            });
        }

        /**
         * Muestra la pregunta actual y sus opciones.
         */
        function displayQuestion() {
            // Asegurarse de que las referencias a categoryIcon y categoryNameSpan estén actualizadas
            // Esto es importante porque los elementos se movieron dentro de #question-area
            categoryIcon = document.getElementById('category-icon');
            categoryNameSpan = document.getElementById('category-name');

            // Ocultar mensaje de feedback
            feedbackMessageDiv.classList.remove('show');
            feedbackTextP.textContent = ''; // Limpiar el texto de la explicación
            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
                feedbackTimer = null;
            }


            // Deshabilitar botones de opción para evitar clicks dobles durante la transición
            optionButtons.forEach(button => {
                button.disabled = true;
                button.classList.remove('correct', 'incorrect'); // Limpiar estilos de respuesta anterior
            });

            // Animación de salida del texto de la pregunta
            questionTextP.classList.add('fade-out-text');

            setTimeout(() => {
                // Comprobar si se han agotado las preguntas para el juego
                if (currentQuestionIndex >= questionsPerGame) {
                    endGame();
                    return;
                }

                const question = shuffledQuestions[currentQuestionIndex];
                const category = question.category;

                // Actualizar icono y nombre de categoría
                categoryNameSpan.textContent = category;
                switch (category) {
                    case "Elementos Estructurales de la Vía":
                        categoryIcon.className = 'fas fa-road'; // Vía
                        break;
                    case "Maquinaria y Herramientas":
                        categoryIcon.className = 'fas fa-cogs'; // Engranajes
                        break;
                    case "Sistemas y Tecnologías":
                        categoryIcon.className = 'fas fa-lightbulb'; // Bombilla (tecnología)
                        break;
                    case "Operaciones y Personal":
                        categoryIcon.className = 'fas fa-users'; // Personas
                        break;
                    default:
                        categoryIcon.className = 'fas fa-question-circle'; // Icono por defecto
                }

                // Actualizar el texto del turno del jugador
                currentPlayerTurnDisplay.textContent = `Turno de: ${players[currentPlayerIndex].name}`;

                questionTextP.textContent = question.pregunta;
                questionTextP.classList.remove('fade-out-text');
                questionTextP.classList.add('fade-in-text'); // Animación de entrada

                optionButtons.forEach((button, index) => {
                    button.textContent = question.opciones[index];
                    button.disabled = false; // Habilitar botones de nuevo
                });
            }, 500); // Esperar a que termine la animación de salida
        }

        /**
         * Comprueba la respuesta seleccionada por el jugador.
         * @param {string} selectedOption La letra de la opción seleccionada (A, B, C, D).
         */
        function checkAnswer(selectedOption) {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const correctOption = currentQuestion.respuestaCorrecta;
            const selectedButton = optionsGridDiv.querySelector(`[data-option="${selectedOption}"]`);

            // Deshabilitar todos los botones de opción para evitar múltiples clicks
            optionButtons.forEach(button => button.disabled = true);

            if (selectedOption === correctOption) {
                players[currentPlayerIndex].score++;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
                // Resaltar la respuesta correcta si la seleccionada es incorrecta
                optionsGridDiv.querySelector(`[data-option="${correctOption}"]`).classList.add('correct');
            }

            // Mostrar explicación
            feedbackTextP.textContent = currentQuestion.explicacion; // Asignar el texto al nuevo párrafo
            feedbackMessageDiv.classList.add('show');

            // Limpiar cualquier temporizador existente antes de establecer uno nuevo
            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
            }
            // Esperar un momento antes de pasar a la siguiente pregunta/turno (5 segundos)
            feedbackTimer = setTimeout(() => {
                nextTurn();
            }, 5000); // 5 segundos para leer la explicación y ver la animación
        }

        /**
         * Pasa al siguiente turno o a la siguiente pregunta.
         */
        function nextTurn() {
            // Limpiar el temporizador si está activo (por si se llama nextTurn antes de tiempo)
            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
                feedbackTimer = null;
            }

            // Limpiar clases de animación y feedback
            optionButtons.forEach(button => {
                button.classList.remove('correct', 'incorrect');
                button.disabled = false;
            });
            feedbackMessageDiv.classList.remove('show');
            feedbackTextP.textContent = ''; // Limpiar el texto de la explicación

            // Incrementar el índice de la pregunta para que el siguiente jugador obtenga una nueva
            currentQuestionIndex++;
            
            // Comprobar si se han agotado las preguntas para el juego
            if (currentQuestionIndex >= questionsPerGame) {
                endGame();
                return;
            }

            // Cambiamos al siguiente jugador
            currentPlayerIndex++;
            if (currentPlayerIndex >= players.length) {
                currentPlayerIndex = 0; // Volver al primer jugador
            }
            
            displayQuestion();
        }

        /**
         * Inicia el juego.
         */
        function startGame() {
            players.forEach(player => player.score = 0); // Reiniciar puntuaciones
            currentPlayerIndex = 0;
            currentQuestionIndex = 0;
            usedRandomNames.clear(); // Limpiar nombres usados para nueva partida

            // Recopilar todas las preguntas de todas las categorías
            let allQuestions = [];
            for (const category in gameData.preguntas) {
                gameData.preguntas[category].forEach(q => {
                    allQuestions.push({ ...q, category: category }); // Añadir la categoría a cada pregunta
                });
            }

            // Mezclar todas las preguntas y seleccionar el número deseado
            // questionsPerGame ya está establecido por el usuario en roundConfigScreen
            shuffledQuestions = shuffleArray(allQuestions).slice(0, questionsPerGame);

            showScreen(gameScreen);
            displayQuestion();
        }

        /**
         * Genera y anima piezas de confeti.
         */
        function generateConfetti() {
            confettiContainer.innerHTML = ''; // Limpiar confeti anterior
            confettiContainer.classList.add('show-confetti');

            for (let i = 0; i < 50; i++) { // Generar 50 piezas de confeti
                const confettiPiece = document.createElement('div');
                confettiPiece.classList.add('confetti-piece');
                confettiPiece.style.left = `${Math.random() * 100}%`; // Posición horizontal aleatoria
                confettiPiece.style.backgroundColor = inecoConfettiColors[Math.floor(Math.random() * inecoConfettiColors.length)]; // Color aleatorio de INECO
                confettiPiece.style.animationDelay = `${Math.random() * 0.8}s`; // Retraso aleatorio
                confettiPiece.style.animationDuration = `${3 + Math.random() * 2}s`; // Duración aleatoria
                confettiPiece.style.width = `${8 + Math.random() * 7}px`; // Tamaño aleatorio
                confettiPiece.style.height = `${8 + Math.random() * 7}px`; // Tamaño aleatorio
                if (Math.random() > 0.5) {
                    confettiPiece.style.borderRadius = '50%'; // Algunas piezas redondas
                }
                confettiContainer.appendChild(confettiPiece);
            }

            // Eliminar el confeti después de un tiempo para limpiar el DOM
            setTimeout(() => {
                confettiContainer.classList.remove('show-confetti');
                setTimeout(() => confettiContainer.innerHTML = '', 600); // Esperar a que termine la transición de opacidad
            }, 4000); // Confeti visible por 4 segundos
        }

        /**
         * Termina el juego y muestra la pantalla de resultados.
         */
        function endGame() {
            showScreen(endScreen);
            // Ordenar jugadores por puntuación de mayor a menor
            players.sort((a, b) => b.score - a.score);

            // Reiniciar animación del ganador para que se ejecute de nuevo
            winnerDisplayH3.style.animation = 'none';
            void winnerDisplayH3.offsetWidth; // Trigger reflow
            winnerDisplayH3.style.animation = null;

            winnerDisplayH3.textContent = `¡El ganador es ${players[0].name} con ${players[0].score} puntos!`;
            if (players.length > 1 && players[0].score === players[1].score) {
                const tiedWinners = players.filter(p => p.score === players[0].score).map(p => p.name).join(' y ');
                winnerDisplayH3.textContent = `¡Empate! Los ganadores son ${tiedWinners} con ${players[0].score} puntos!`;
            } else if (players.length === 1) {
                winnerDisplayH3.textContent = `¡Has terminado la partida con ${players[0].score} puntos!`;
            }

            generateConfetti(); // Disparar el confeti

            finalScoresDiv.innerHTML = '';
            players.forEach(player => {
                const scoreDiv = document.createElement('div');
                scoreDiv.classList.add('final-player-score');
                scoreDiv.innerHTML = `<span class="name">${player.name}</span> <span class="score">${player.score} puntos</span>`;
                finalScoresDiv.appendChild(scoreDiv);
            });
        }

        /**
         * Muestra un mensaje temporal en la UI.
         * @param {string} message El texto del mensaje.
         * @param {string} type El tipo de mensaje ('success', 'error', 'info').
         */
        function displayUIMessage(message, type = 'info') {
            const uiMessageDiv = document.getElementById('ui-message');
            const uiMessageTextSpan = document.getElementById('ui-message-text');

            uiMessageTextSpan.textContent = message;
            uiMessageDiv.style.display = 'block';
            uiMessageDiv.style.opacity = '1';
            uiMessageDiv.style.transform = 'translateX(-50%) translateY(0)';

            // Set background color based on type
            switch(type) {
                case 'success':
                    uiMessageDiv.style.backgroundColor = 'var(--ineco-verde-correcto)';
                    break;
                case 'error':
                    uiMessageDiv.style.backgroundColor = 'var(--ineco-rojo-acento)';
                    break;
                case 'info':
                default:
                    uiMessageDiv.style.backgroundColor = 'var(--ineco-azul-aun-mas-claro)';
                    break;
            }

            setTimeout(() => {
                uiMessageDiv.style.opacity = '0';
                uiMessageDiv.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => {
                    uiMessageDiv.style.display = 'none';
                }, 500); // Esperar a que el fade out se complete antes de ocultar
            }, 3000); // Mensaje visible por 3 segundos
        }

        /**
         * Muestra el modal del marcador con las puntuaciones actuales.
         */
        function showScoreModal() {
            modalScoreList.innerHTML = '';
            // Clonar el array de jugadores y ordenarlo para el modal, sin afectar el orden original del juego
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

            sortedPlayers.forEach((player, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span class="player-name-modal">${player.name}</span> <span class="player-score-modal">${player.score} puntos</span>`;
                // Resaltar el jugador actual en el modal
                if (players[currentPlayerIndex] && players[currentPlayerIndex].name === player.name) {
                    listItem.classList.add('current-turn');
                }
                modalScoreList.appendChild(listItem);
            });
            scoreModal.classList.add('active');
        }

        /**
         * Oculta el modal del marcador.
         */
        function hideScoreModal() {
            scoreModal.classList.remove('active');
        }

        /**
         * Muestra el modal de confirmación de salida.
         */
        function showConfirmExitModal() {
            confirmExitModal.classList.add('active');
        }

        /**
         * Oculta el modal de confirmación de salida.
         */
        function hideConfirmExitModal() {
            confirmExitModal.classList.remove('active');
        }


        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen(splashScreen); // Mostrar la pantalla de inicio al cargar

            // --- EVENT LISTENERS ---
            // Pantalla de Inicio
            startGameBtn.addEventListener('click', () => {
                showScreen(playerConfigScreen);
                updatePlayerInputs(); // Inicializar campos de jugador
            });

            // Pantalla de Configuración de Jugadores
            decreasePlayersBtn.addEventListener('click', () => {
                let count = parseInt(playerCountSpan.textContent);
                if (count > 1) {
                    count--;
                    playerCountSpan.textContent = count;
                    updatePlayerInputs();
                }
            });

            increasePlayersBtn.addEventListener('click', () => {
                let count = parseInt(playerCountSpan.textContent);
                if (count < 5) { // Máximo 5 jugadores
                    count++;
                    playerCountSpan.textContent = count;
                    updatePlayerInputs();
                }
            });

            startMatchBtn.addEventListener('click', () => {
                players = [];
                const playerCount = parseInt(playerCountSpan.textContent);
                let allNamesEntered = true;
                for (let i = 0; i < playerCount; i++) {
                    const nameInput = document.getElementById(`player-name-${i + 1}`);
                    const name = nameInput.value.trim();
                    if (name === "") {
                        allNamesEntered = false;
                        // Ahora usamos los valores RGB directos para el borde
                        nameInput.style.borderColor = 'rgb(203, 24, 35)'; // Rojo INECO
                        nameInput.placeholder = "¡Nombre requerido!";
                    } else {
                        // Ahora usamos los valores RGB directos para el borde
                        nameInput.style.borderColor = 'rgb(230, 230, 230)'; // Gris claro INECO
                        players.push({ name: name, score: 0 });
                    }
                }

                if (allNamesEntered && players.length > 0) {
                    showScreen(roundConfigScreen);
                    // Asegurar que questionsPerPlayer sea un valor válido para el número actual de jugadores
                    const maxQuestionsPerPersonAllowed = Math.floor(maxQuestionsAvailable / players.length);
                    questionsPerPlayer = Math.min(questionsPerPlayer, maxQuestionsPerPersonAllowed);
                    questionsPerPlayer = Math.max(questionsPerPlayer, 1); // Asegurar mínimo 1 pregunta por persona
                    roundCountSpan.textContent = questionsPerPlayer;
                } else {
                    console.warn("Por favor, introduce los nombres de todos los jugadores.");
                    displayUIMessage("Por favor, introduce los nombres de todos los jugadores.", 'error');
                }
            });

            // Pantalla de Configuración de Rondas
            decreaseRoundsBtn.addEventListener('click', () => {
                let count = parseInt(roundCountSpan.textContent);
                if (count > 1) { // Mínimo 1 pregunta por jugador
                    count--;
                    roundCountSpan.textContent = count;
                    questionsPerPlayer = count;
                }
            });

            increaseRoundsBtn.addEventListener('click', () => {
                let count = parseInt(roundCountSpan.textContent);
                const maxQuestionsPerPersonAllowed = Math.floor(maxQuestionsAvailable / players.length);
                if (count < maxQuestionsPerPersonAllowed) { // Máximo el número total de preguntas disponibles dividido por el número de jugadores
                    count++;
                    roundCountSpan.textContent = count;
                    questionsPerPlayer = count;
                }
            });

            startGameFromRoundsBtn.addEventListener('click', () => {
                questionsPerGame = questionsPerPlayer * players.length; // Establecer el número total de preguntas
                startGame(); // Iniciar el juego
            });


            // Pantalla de Juego
            optionButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    checkAnswer(event.target.dataset.option);
                });
            });

            // Botón para mostrar el marcador
            showScoreBtn.addEventListener('click', showScoreModal);

            // Pantalla de Fin de Juego
            playAgainBtn.addEventListener('click', () => {
                showScreen(splashScreen); // Volver a la pantalla de inicio
            });

            // Manejo de los botones de cerrar (X)
            document.querySelectorAll('.close-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetScreen = event.target.dataset.targetScreen;
                    if (targetScreen === 'confirm-exit') {
                        showConfirmExitModal();
                    } else if (targetScreen === 'hide-modal') {
                        hideScoreModal();
                    }
                    else {
                        showScreen(document.getElementById(targetScreen));
                    }
                });
            });

            // Manejo de los botones del modal de confirmación de salida
            confirmExitYesBtn.addEventListener('click', () => {
                hideConfirmExitModal();
                showScreen(splashScreen); // Volver a la pantalla de inicio
            });

            confirmExitNoBtn.addEventListener('click', () => {
                hideConfirmExitModal();
            });

            // Event listener para el nuevo botón de cerrar la explicación
            closeFeedbackBtn.addEventListener('click', () => {
                nextTurn(); // Llama a nextTurn para limpiar y avanzar
            });
        });
    </script>
</body>
</html>
