<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comanda Almuerzo ‚òï</title>
    <style>
        /* --- Reset y Fuentes --- */
        :root {
            --primary-color: #FF6B6B; /* Coral vivo */
            --secondary-color: #FFD166; /* Amarillo soleado */
            --accent-color: #06D6A0; /* Verde menta fresco */
            --text-color: #4A4A4A; /* Gris oscuro para texto */
            --bg-color: #F7F7F7; /* Gris muy claro para fondo */
            --card-bg-color: #FFFFFF; /* Blanco para tarjetas */
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overscroll-behavior-y: contain; /* Evita el "pull-to-refresh" en m√≥viles */
        }

        /* --- Contenedor Principal --- */
        #app-container {
            max-width: 500px; /* Optimizado para m√≥viles */
            margin: 0 auto;
            background-color: var(--card-bg-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        header h1 {
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        header h1 .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Para scroll si el contenido es largo */
        }

        /* --- Secciones de Pasos --- */
        .step-section {
            display: none; /* Ocultar por defecto */
            animation: fadeIn 0.5s ease-out;
        }
        .step-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .step-title .icon {
            margin-right: 10px;
            font-size: 1.3em;
        }

        /* --- Categor√≠as y Items --- */
        .category-block {
            background-color: #fff;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .category-block h3 {
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .item-button, .ingredient-button, .modal-option-button {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 2px solid transparent;
            padding: 12px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            font-weight: 400;
            transition: all 0.2s ease-in-out;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        .item-button .item-icon, .ingredient-button .item-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .item-button:hover, .ingredient-button:hover, .modal-option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .item-button.selected, .ingredient-button.selected, .modal-option-button.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: 600;
            transform: scale(1.05);
        }
        
        .item-button.added-feedback {
            animation: pulseFeedback 0.5s ease-out;
        }
        @keyframes pulseFeedback {
            0% { transform: scale(1); background-color: var(--accent-color); color: white; }
            50% { transform: scale(1.1); background-color: var(--accent-color); color: white; }
            100% { transform: scale(1); background-color: var(--bg-color); color: var(--text-color);}
        }


        /* Food specific */
        .food-type-selector {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
        }
        .food-type-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            flex-grow: 1;
            margin: 0 5px;
            text-align: center;
        }
        .food-type-button:first-child { margin-left: 0; }
        .food-type-button:last-child { margin-right: 0; }

        .food-type-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--box-shadow);
        }
        .food-type-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #ingredients-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #ingredients-container h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        .action-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .action-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            background-color: #E55A5A;
        }


        /* --- Resumen (General y en Pasos) --- */
        #summary-list, #drinks-summary-list-step1, #food-summary-list-step2 { /* Estilos comunes para listas de resumen */
            list-style: none;
            padding: 0;
        }
        #summary-list li, #drinks-summary-list-step1 li, #food-summary-list-step2 li {
            background-color: #fff;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--accent-color);
            font-size: 0.90em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #summary-list li .item-text-content, 
        #drinks-summary-list-step1 li .item-text-content,
        #food-summary-list-step2 li .item-text-content {
            flex-grow: 1;
        }

        #summary-list li strong, 
        #drinks-summary-list-step1 li strong,
        #food-summary-list-step2 li strong { /* Si se usa strong en los res√∫menes de paso */
            color: var(--primary-color);
        }

        #summary-list .summary-category { /* Solo para el resumen final */
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 8px;
            color: var(--text-color);
            background-color: transparent;
            border-left: none;
            padding-left: 0;
        }
        #summary-list .summary-category:first-child {
            margin-top: 0;
        }

        #summary-list .item-details,
        #drinks-summary-list-step1 .item-details { /* Detalles tambi√©n para resumen de bebidas */
            font-size: 0.85em; /* Un poco m√°s peque√±o para detalles */
            color: #555;
            display: block;
            padding-left: 10px;
        }
        
        .remove-item-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.3em;
            cursor: pointer;
            padding: 0 5px;
            margin-left:10px;
        }
        .remove-item-btn:hover {
            color: #E55A5A;
        }


        /* --- Navegaci√≥n Inferior --- */
        nav {
            padding: 15px 20px;
            background-color: #fff;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            position: sticky;
            bottom: 0;
            z-index: 100;
        }
        .nav-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .nav-button:hover {
            background-color: #F0C150;
        }
        .nav-button:active {
            transform: scale(0.95);
        }
        .nav-button#confirm-order-btn {
            background-color: var(--accent-color);
            color: white;
        }
        .nav-button#confirm-order-btn:hover {
            background-color: #05B288;
        }
        .nav-button:disabled {
            background-color: #ccc;
            color: #888;
            cursor: not-allowed;
        }

        /* --- Modal --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeInModal 0.3s ease-out;
        }
        .modal.visible { 
            display: flex; 
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px;
            box-shadow: var(--box-shadow);
            position: relative;
            animation: slideInModal 0.4s ease-out;
        }
        
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }


        .close-modal-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-modal-button:hover,
        .close-modal-button:focus {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .coffee-option-group {
            margin-bottom: 15px;
        }
        .coffee-option-group.hidden {
            display: none;
        }
        .coffee-option-group h4 {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        #coffee-modal-title {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        #add-custom-coffee-btn {
            width: 100%;
            margin-top: 15px;
        }

        /* Message Modal Styles */
        #message-modal .modal-content {
            text-align: center;
        }
        #message-modal h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        #message-modal p {
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        #message-modal .action-button {
            margin-top: 0;
        }

    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1><span class="icon">üçΩÔ∏è</span>Comanda R√°pida</h1>
        </header>

        <main>
            <!-- Paso 1: Bebidas -->
            <section id="step-drinks" class="step-section active">
                <h2 class="step-title"><span class="icon">ü•§</span>Paso 1: Bebidas</h2>
                
                <div class="category-block">
                    <h3>Caf√©s</h3>
                    <div class="item-grid">
                        <button class="item-button" data-type="drink" data-name="Caf√© Solo" data-is-coffee="true"><span class="item-icon">‚òï</span>Solo</button>
                        <button class="item-button" data-type="drink" data-name="Cortado" data-is-coffee="true"><span class="item-icon">‚òï</span>Cortado</button>
                        <button class="item-button" data-type="drink" data-name="Caf√© con Leche" data-is-coffee="true"><span class="item-icon">‚òï</span>Con Leche</button>
                        <button class="item-button" data-type="drink" data-name="Americano" data-is-coffee="true"><span class="item-icon">‚òï</span>Americano</button>
                        <button class="item-button" data-type="drink" data-name="Descafeinado" data-is-coffee="true"><span class="item-icon">‚òï</span>Descafeinado</button>
                        <button class="item-button" data-type="drink" data-name="Capuchino" data-is-coffee="true"><span class="item-icon">‚òï</span>Capuchino</button>
                    </div>
                </div>

                <div class="category-block">
                    <h3>Refrescos</h3>
                    <div class="item-grid">
                        <button class="item-button" data-type="drink" data-name="Coca-Cola"><span class="item-icon">ü•§</span>Coca-Cola</button>
                        <button class="item-button" data-type="drink" data-name="Fanta Naranja"><span class="item-icon">üçä</span>F. Naranja</button>
                        <button class="item-button" data-type="drink" data-name="Fanta Lim√≥n"><span class="item-icon">üçã</span>F. Lim√≥n</button>
                        <button class="item-button" data-type="drink" data-name="Sprite"><span class="item-icon">ü•§</span>Sprite</button>
                        <button class="item-button" data-type="drink" data-name="Kas Naranja"><span class="item-icon">üçä</span>K. Naranja</button>
                        <button class="item-button" data-type="drink" data-name="Kas Lim√≥n"><span class="item-icon">üçã</span>K. Lim√≥n</button>
                        <button class="item-button" data-type="drink" data-name="Aquarius"><span class="item-icon">üíß</span>Aquarius</button>
                        <button class="item-button" data-type="drink" data-name="T√≥nica"><span class="item-icon">üç∏</span>T√≥nica</button>
                    </div>
                </div>

                <div class="category-block">
                    <h3>Agua</h3>
                    <div class="item-grid">
                        <button class="item-button" data-type="drink" data-name="Agua Peque√±a"><span class="item-icon">üíß</span>Peq.</button>
                        <button class="item-button" data-type="drink" data-name="Agua Grande"><span class="item-icon">üíß</span>Gde.</button>
                        <button class="item-button" data-type="drink" data-name="Agua con Gas"><span class="item-icon">üíß</span>Con Gas</button>
                    </div>
                </div>

                <div class="category-block">
                    <h3>Alcoh√≥licas</h3>
                    <div class="item-grid">
                        <button class="item-button" data-type="drink" data-name="Cerveza Ca√±a"><span class="item-icon">üç∫</span>Ca√±a</button>
                        <button class="item-button" data-type="drink" data-name="Cerveza Jarra"><span class="item-icon">üç∫</span>Jarra</button>
                        <button class="item-button" data-type="drink" data-name="Cerveza Botella"><span class="item-icon">üç∫</span>Botella</button>
                        <button class="item-button" data-type="drink" data-name="Vino Tinto (copa)"><span class="item-icon">üç∑</span>V. Tinto</button>
                        <button class="item-button" data-type="drink" data-name="Vino Blanco (copa)"><span class="item-icon">ü•Ç</span>V. Blanco</button>
                        <button class="item-button" data-type="drink" data-name="Vino Rosado (copa)"><span class="item-icon">üç∑</span>V. Rosado</button>
                        <button class="item-button" data-type="drink" data-name="Vermut"><span class="item-icon">ü•É</span>Vermut</button>
                    </div>
                </div>

                <!-- Resumen de Bebidas en Paso 1 -->
                <div id="current-drinks-order-summary" class="category-block" style="margin-top: 20px;">
                    <h3>Bebidas a√±adidas:</h3>
                    <ul id="drinks-summary-list-step1">
                        <li class="placeholder-drink-item">A√∫n no has a√±adido bebidas.</li>
                    </ul>
                </div>
            </section>

            <!-- Paso 2: Comida -->
            <section id="step-food" class="step-section">
                <h2 class="step-title"><span class="icon">ü•™</span>Paso 2: Comida</h2>
                
                <div class="food-type-selector">
                    <button class="food-type-button" data-food-category="Tostada">Tostada</button>
                    <button class="food-type-button" data-food-category="Bocadillo">Bocadillo</button>
                    <button class="food-type-button" data-food-category="Medio Bocadillo">Medio Bocadillo</button>
                </div>

                <div id="ingredients-container" class="hidden">
                    <h4 id="current-food-item-title">Selecciona ingredientes para: </h4>
                    <div class="item-grid" id="ingredients-grid">
                        <!-- Ingredientes se cargar√°n aqu√≠ por JS -->
                    </div>
                    <div class="action-buttons">
                        <button id="add-food-item-btn" class="action-button">A√±adir <span id="current-food-type-btn-label"></span> a la comanda</button>
                    </div>
                </div>

                <div id="current-food-order-summary" class="category-block" style="margin-top: 20px;">
                    <h3>Comida a√±adida:</h3>
                    <ul id="food-summary-list-step2">
                        <li class="placeholder-food-item">A√∫n no has a√±adido comida.</li>
                    </ul>
                </div>
            </section>

            <!-- Paso 3: Resumen y Confirmaci√≥n -->
            <section id="step-summary" class="step-section">
                <h2 class="step-title"><span class="icon">üßæ</span>Paso 3: Resumen de la Comanda</h2>
                <ul id="summary-list">
                    <!-- Resumen se cargar√° aqu√≠ por JS -->
                </ul>
            </section>
        </main>

        <nav>
            <button id="prev-step-btn" class="nav-button" disabled>Anterior</button>
            <button id="next-step-btn" class="nav-button">Siguiente</button>
            <button id="confirm-order-btn" class="nav-button hidden">Confirmar Pedido</button>
        </nav>
    </div>

    <!-- Modal para Opciones de Caf√© -->
    <div id="coffee-options-modal" class="modal"> 
        <div class="modal-content">
            <span id="close-coffee-modal-btn" class="close-modal-button">√ó</span>
            <h3 id="coffee-modal-title">Personaliza tu Caf√©</h3>
            
            <div id="milk-options-container" class="coffee-option-group">
                <h4>Tipo de Leche:</h4>
                <div class="options-grid" id="milk-options-grid"></div>
            </div>
            <div id="cup-options-container" class="coffee-option-group">
                <h4>Tipo de Vaso/Taza:</h4>
                <div class="options-grid" id="cup-options-grid"></div>
            </div>
            <div id="temperature-options-container" class="coffee-option-group">
                <h4>Temperatura:</h4>
                <div class="options-grid" id="temperature-options-grid"></div>
            </div>
            
            <button id="add-custom-coffee-btn" class="action-button">A√±adir Caf√© a la Comanda</button>
        </div>
    </div>

    <!-- Modal para Mensajes Generales -->
    <div id="message-modal" class="modal"> 
        <div class="modal-content">
            <span id="close-message-modal-btn" class="close-modal-button">√ó</span>
            <h3 id="message-modal-title"></h3>
            <p id="message-modal-text"></p>
            <button id="message-modal-ok-btn" class="action-button">Aceptar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Estado de la Aplicaci√≥n ---
            let currentStep = 0;
            const order = {
                drinks: [], 
                food: []    
            };
            let currentFoodSelection = {
                type: null,
                ingredients: []
            };
            let currentCoffeeCustomization = {
                name: null,
                milk: null,
                cup: null,
                temp: null
            };

            // --- Selectores del DOM ---
            const stepSections = document.querySelectorAll('.step-section');
            const prevStepBtn = document.getElementById('prev-step-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const confirmOrderBtn = document.getElementById('confirm-order-btn');

            const drinkButtons = document.querySelectorAll('.item-button[data-type="drink"]');

            const foodTypeButtons = document.querySelectorAll('.food-type-button');
            const ingredientsContainer = document.getElementById('ingredients-container');
            const ingredientsGrid = document.getElementById('ingredients-grid');
            const currentFoodItemTitle = document.getElementById('current-food-item-title');
            const addFoodItemBtn = document.getElementById('add-food-item-btn');
            const currentFoodTypeBtnLabel = document.getElementById('current-food-type-btn-label');
            const foodSummaryListStep2 = document.getElementById('food-summary-list-step2');
            let placeholderFoodItem = foodSummaryListStep2.querySelector('.placeholder-food-item');

            // Resumen de bebidas en Paso 1
            const drinksSummaryListStep1 = document.getElementById('drinks-summary-list-step1');
            let placeholderDrinkItem = drinksSummaryListStep1.querySelector('.placeholder-drink-item');


            const summaryList = document.getElementById('summary-list');

            // Modals
            const coffeeModal = document.getElementById('coffee-options-modal');
            const coffeeModalTitle = document.getElementById('coffee-modal-title');
            const closeCoffeeModalBtn = document.getElementById('close-coffee-modal-btn');
            const milkOptionsContainer = document.getElementById('milk-options-container');
            const milkOptionsGrid = document.getElementById('milk-options-grid');
            const cupOptionsGrid = document.getElementById('cup-options-grid');
            const temperatureOptionsGrid = document.getElementById('temperature-options-grid');
            const addCustomCoffeeBtn = document.getElementById('add-custom-coffee-btn');

            const messageModal = document.getElementById('message-modal');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalText = document.getElementById('message-modal-text');
            const closeMessageModalBtn = document.getElementById('close-message-modal-btn');
            const messageModalOkBtn = document.getElementById('message-modal-ok-btn');

            // --- Datos ---
            const ingredientsList = [
                "Jam√≥n Serrano", "Jam√≥n York", "Queso Curado", "Queso Fresco", "Queso Brie", "Queso Cabra",
                "Tomate Rodajas", "Tomate Triturado", "Aceite de Oliva", "Mantequilla", "Mermelada",
                "Tortilla Espa√±ola", "Tortilla Francesa", "Bacon Crujiente", "Lomo Adobado",
                "Pechuga de Pollo Plancha", "Pechuga de Pollo Empanada", "Pimientos Verdes Fritos", "Pimientos Rojos Asados",
                "At√∫n", "Anchoas", "Salm√≥n Ahumado", "Lechuga", "Cebolla Caramelizada", "Cebolla Cruda",
                "Huevo Frito", "Huevo Duro", "Mayonesa", "Alioli", "Mostaza y Miel", "Hummus", "Aguacate", "Vegetal Variado"
            ];

            const coffeeOptionsData = {
                milkTypes: [
                    "Entera", "Semidesnatada", "Desnatada", "Sin Lactosa",
                    "Soja", "Avena", "Almendra", "Coco", "Arroz"
                ],
                cupTypes: ["Taza Peque√±a", "Taza Mediana", "Taza Grande", "Vaso Cristal"],
                temperatures: ["Muy Caliente", "Caliente", "Templado", "Del Tiempo", "Con Hielo"],
                noMilkCoffees: ["Caf√© Solo", "Americano"]
            };

            // --- Funciones de Modal ---
            function showModal(modalElement) {
                modalElement.classList.add('visible');
            }
            function hideModal(modalElement) {
                modalElement.classList.remove('visible');
            }
            
            // --- L√≥gica de Navegaci√≥n ---
            function updateNavigation() {
                stepSections.forEach((section, index) => {
                    section.classList.toggle('active', index === currentStep);
                });
                prevStepBtn.disabled = currentStep === 0;
                nextStepBtn.classList.toggle('hidden', currentStep === stepSections.length - 1);
                confirmOrderBtn.classList.toggle('hidden', currentStep !== stepSections.length - 1);
                if (currentStep === 2) renderSummary();
            }

            nextStepBtn.addEventListener('click', () => {
                if (currentStep < stepSections.length - 1) {
                    currentStep++;
                    updateNavigation();
                }
            });

            prevStepBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateNavigation();
                }
            });
            
            function resetApp() {
                order.drinks = [];
                order.food = [];
                currentFoodSelection = { type: null, ingredients: [] };
                currentCoffeeCustomization = { name: null, milk: null, cup: null, temp: null };
                
                document.querySelectorAll('.modal-option-button.selected').forEach(btn => btn.classList.remove('selected'));
                foodTypeButtons.forEach(btn => btn.classList.remove('active'));
                ingredientsContainer.classList.add('hidden');
                document.querySelectorAll('.ingredient-button.selected').forEach(btn => btn.classList.remove('selected'));
                
                renderDrinksSummaryStep1(); // Limpiar resumen de bebidas en paso 1
                renderFoodSummaryStep2(); 
                if(currentStep === 2) renderSummary(); 
                currentStep = 0;
                updateNavigation();
            }

            confirmOrderBtn.addEventListener('click', () => {
                let modalSummaryText = '';
                if (order.drinks.length > 0) {
                    modalSummaryText += 'Bebidas:\n';
                    order.drinks.forEach(drink => {
                        let drinkDetails = `- ${drink.name}`;
                        if (drink.milk && drink.milk !== "No Aplica") drinkDetails += `, Leche: ${drink.milk}`;
                        if (drink.cup) drinkDetails += `, Vaso: ${drink.cup}`;
                        if (drink.temp) drinkDetails += `, Temp: ${drink.temp}`;
                        modalSummaryText += drinkDetails + '\n';
                    });
                }
                if (order.food.length > 0) {
                    modalSummaryText += '\nComida:\n';
                    order.food.forEach(f => {
                        modalSummaryText += `- ${f.type} con ${f.ingredients.join(', ') || 'nada'}\n`;
                    });
                }

                if (modalSummaryText.trim() === '') {
                    modalSummaryText = 'La comanda est√° vac√≠a. Nada que confirmar.';
                     showMessageModalAlert('Comanda Vac√≠a', modalSummaryText);
                } else {
                    modalSummaryText += '\nGracias. Se enviar√° a cocina (simulado).';
                    showMessageModalAlert('¬°Comanda Confirmada!', modalSummaryText, resetApp);
                }
            });

            // --- L√≥gica de Bebidas ---
            function giveAddedFeedback(buttonElement) {
                buttonElement.classList.add('added-feedback');
                setTimeout(() => {
                    buttonElement.classList.remove('added-feedback');
                }, 500); 
            }
            
            drinkButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const name = button.dataset.name;
                    const isCoffee = button.dataset.isCoffee === "true";

                    if (isCoffee) {
                        openCoffeeOptionsModal(name);
                    } else {
                        order.drinks.push({ id: Date.now(), name: name, type: 'drink' });
                        giveAddedFeedback(button);
                        renderDrinksSummaryStep1(); // Actualizar resumen de bebidas en Paso 1
                    }
                });
            });

            // --- Resumen de Bebidas en Paso 1 ---
            function renderDrinksSummaryStep1() {
                drinksSummaryListStep1.innerHTML = ''; // Limpiar lista
                if (!placeholderDrinkItem && drinksSummaryListStep1.parentElement) { 
                    placeholderDrinkItem = document.createElement('li');
                    placeholderDrinkItem.classList.add('placeholder-drink-item');
                    placeholderDrinkItem.textContent = "A√∫n no has a√±adido bebidas.";
                }

                if (order.drinks.length === 0) {
                    if (placeholderDrinkItem) {
                        placeholderDrinkItem.classList.remove('hidden');
                        if (!drinksSummaryListStep1.contains(placeholderDrinkItem)) {
                            drinksSummaryListStep1.appendChild(placeholderDrinkItem);
                        }
                    }
                } else {
                    if (placeholderDrinkItem) placeholderDrinkItem.classList.add('hidden');

                    order.drinks.forEach(drink => {
                        const li = document.createElement('li');
                        const textSpan = document.createElement('span');
                        textSpan.classList.add('item-text-content');
                        
                        let mainText = `<strong>${drink.name}</strong>`;
                        let detailsText = '';
                        if (drink.milk && drink.milk !== "No Aplica") detailsText += `Leche: ${drink.milk}, `;
                        if (drink.cup) detailsText += `Vaso: ${drink.cup}, `;
                        if (drink.temp) detailsText += `Temp: ${drink.temp}`;
                        
                        if (detailsText) {
                            mainText += `<span class="item-details">${detailsText.replace(/, $/, '')}</span>`;
                        }
                        textSpan.innerHTML = mainText;
                        li.appendChild(textSpan);

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'üóëÔ∏è';
                        removeBtn.classList.add('remove-item-btn');
                        removeBtn.onclick = () => {
                            order.drinks = order.drinks.filter(d => d.id !== drink.id);
                            renderDrinksSummaryStep1(); // Re-renderizar este resumen
                            if (currentStep === 2) renderSummary(); // Si estamos en resumen final, actualizarlo tambi√©n
                        };
                        li.appendChild(removeBtn);
                        drinksSummaryListStep1.appendChild(li);
                    });
                }
            }


            // --- L√≥gica del Modal de Caf√© ---
            function populateModalOptionsGrid(gridElement, optionsArray, propertyToUpdate, coffeeName) {
                gridElement.innerHTML = ''; 
                
                const shouldHideMilkGroup = propertyToUpdate === 'milk' && coffeeOptionsData.noMilkCoffees.includes(coffeeName);
                
                if (propertyToUpdate === 'milk') {
                    milkOptionsContainer.classList.toggle('hidden', shouldHideMilkGroup);
                    if (shouldHideMilkGroup) {
                        currentCoffeeCustomization.milk = "No Aplica";
                        return; 
                    }
                }
                
                optionsArray.forEach(optionText => {
                    const btn = document.createElement('button');
                    btn.classList.add('modal-option-button');
                    btn.textContent = optionText;
                    btn.dataset.value = optionText;
                    
                    if (currentCoffeeCustomization[propertyToUpdate] === optionText) {
                        btn.classList.add('selected');
                    }

                    btn.addEventListener('click', () => {
                        gridElement.querySelectorAll('.modal-option-button.selected').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        currentCoffeeCustomization[propertyToUpdate] = optionText;
                    });
                    gridElement.appendChild(btn);
                });

                if (!currentCoffeeCustomization[propertyToUpdate] && gridElement.firstChild && 
                    !(propertyToUpdate === 'milk' && currentCoffeeCustomization.milk === "No Aplica")) {
                     gridElement.firstChild.click();
                }
            }

            function openCoffeeOptionsModal(coffeeName) {
                currentCoffeeCustomization = { name: coffeeName, milk: null, cup: null, temp: null };
                coffeeModalTitle.textContent = `Personaliza tu ${coffeeName}`;
                milkOptionsContainer.classList.remove('hidden'); // Asegurar que est√© visible por defecto

                populateModalOptionsGrid(milkOptionsGrid, coffeeOptionsData.milkTypes, 'milk', coffeeName);
                populateModalOptionsGrid(cupOptionsGrid, coffeeOptionsData.cupTypes, 'cup', coffeeName);
                populateModalOptionsGrid(temperatureOptionsGrid, coffeeOptionsData.temperatures, 'temp', coffeeName);
                
                showModal(coffeeModal);
            }
            
            closeCoffeeModalBtn.addEventListener('click', () => hideModal(coffeeModal));
            coffeeModal.addEventListener('click', (event) => { 
                if (event.target === coffeeModal) {
                    hideModal(coffeeModal);
                }
            });

            addCustomCoffeeBtn.addEventListener('click', () => {
                const isMilkRequired = !coffeeOptionsData.noMilkCoffees.includes(currentCoffeeCustomization.name);
                const isMilkSelectedOrNotApplicable = 
                    (isMilkRequired && currentCoffeeCustomization.milk && currentCoffeeCustomization.milk !== "No Aplica") ||
                    !isMilkRequired;

                if (currentCoffeeCustomization.name && 
                    isMilkSelectedOrNotApplicable && 
                    currentCoffeeCustomization.cup && 
                    currentCoffeeCustomization.temp) {
                    
                    order.drinks.push({ id: Date.now(), ...currentCoffeeCustomization, type: 'drink' });
                    hideModal(coffeeModal);
                    renderDrinksSummaryStep1(); // Actualizar resumen de bebidas en Paso 1

                    const originalCoffeeButton = Array.from(drinkButtons).find(btn => btn.dataset.name === currentCoffeeCustomization.name);
                    if (originalCoffeeButton) giveAddedFeedback(originalCoffeeButton);

                } else {
                    let errorFields = [];
                    if (isMilkRequired && (!currentCoffeeCustomization.milk || currentCoffeeCustomization.milk === "No Aplica")) {
                         errorFields.push('Tipo de Leche');
                    }
                    if (!currentCoffeeCustomization.cup) errorFields.push('Tipo de Vaso');
                    if (!currentCoffeeCustomization.temp) errorFields.push('Temperatura');
                    showMessageModalAlert('Selecci√≥n Incompleta', `Por favor, selecciona: ${errorFields.join(', ')}.`);
                }
            });

            // --- L√≥gica de Comida ---
            foodTypeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const foodCategory = button.dataset.foodCategory;
                    currentFoodSelection.type = foodCategory;
                    currentFoodSelection.ingredients = []; 

                    foodTypeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentFoodItemTitle.textContent = `Ingredientes para: ${foodCategory}`;
                    currentFoodTypeBtnLabel.textContent = foodCategory;
                    ingredientsContainer.classList.remove('hidden');
                    renderIngredients();
                });
            });

            function renderIngredients() {
                ingredientsGrid.innerHTML = ''; 
                ingredientsList.forEach(ingredient => {
                    const btn = document.createElement('button');
                    btn.classList.add('ingredient-button');
                    btn.textContent = ingredient;
                    btn.dataset.name = ingredient;

                    if (currentFoodSelection.ingredients.includes(ingredient)) {
                        btn.classList.add('selected');
                    }
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        const ingredientName = btn.dataset.name;
                        if (btn.classList.contains('selected')) {
                            if (!currentFoodSelection.ingredients.includes(ingredientName)) {
                                currentFoodSelection.ingredients.push(ingredientName);
                            }
                        } else {
                            currentFoodSelection.ingredients = currentFoodSelection.ingredients.filter(i => i !== ingredientName);
                        }
                    });
                    ingredientsGrid.appendChild(btn);
                });
            }

            addFoodItemBtn.addEventListener('click', () => {
                if (!currentFoodSelection.type) {
                    showMessageModalAlert('Selecci√≥n Incompleta', 'Por favor, selecciona un tipo de comida.');
                    return;
                }
                order.food.push({ id: Date.now(), ...currentFoodSelection });
                renderFoodSummaryStep2();

                currentFoodSelection.type = null;
                currentFoodSelection.ingredients = [];
                foodTypeButtons.forEach(btn => btn.classList.remove('active'));
                ingredientsContainer.classList.add('hidden');
            });

            function renderFoodSummaryStep2() {
                foodSummaryListStep2.innerHTML = '';
                 if (!placeholderFoodItem && foodSummaryListStep2.parentElement) { 
                    placeholderFoodItem = document.createElement('li');
                    placeholderFoodItem.classList.add('placeholder-food-item');
                    placeholderFoodItem.textContent = "A√∫n no has a√±adido comida.";
                }

                if (order.food.length === 0) {
                    if(placeholderFoodItem) {
                        placeholderFoodItem.classList.remove('hidden'); 
                        if (!foodSummaryListStep2.contains(placeholderFoodItem)) { 
                           foodSummaryListStep2.appendChild(placeholderFoodItem);
                        }
                    }
                } else {
                    if(placeholderFoodItem) placeholderFoodItem.classList.add('hidden');

                    order.food.forEach((item) => {
                        const li = document.createElement('li');
                        const textSpan = document.createElement('span'); // Contenedor para el texto
                        textSpan.classList.add('item-text-content');

                        const ingredientsText = item.ingredients.length > 0 ? item.ingredients.join(', ') : 'sola';
                        textSpan.innerHTML = `<strong>${item.type}</strong> con ${ingredientsText}`; // Usar strong para el tipo
                        li.appendChild(textSpan);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'üóëÔ∏è';
                        removeBtn.classList.add('remove-item-btn'); 
                        removeBtn.onclick = () => {
                            order.food = order.food.filter(foodItem => foodItem.id !== item.id); 
                            renderFoodSummaryStep2(); 
                            if(currentStep === 2) renderSummary();
                        };
                        li.appendChild(removeBtn);
                        foodSummaryListStep2.appendChild(li);
                    });
                }
            }

            // --- L√≥gica de Resumen Final ---
            function renderSummary() {
                summaryList.innerHTML = ''; 

                if (order.drinks.length === 0 && order.food.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Tu comanda est√° vac√≠a. ¬°A√±ade algo delicioso!';
                    summaryList.appendChild(li);
                    return;
                }

                if (order.drinks.length > 0) {
                    const drinksCategory = document.createElement('li');
                    drinksCategory.classList.add('summary-category');
                    drinksCategory.innerHTML = '<strong><span class="icon">ü•§</span>Bebidas:</strong>';
                    summaryList.appendChild(drinksCategory);

                    order.drinks.forEach(drink => {
                        const li = document.createElement('li');
                        const textSpan = document.createElement('span');
                        textSpan.classList.add('item-text-content');

                        let mainText = `<strong>${drink.name}</strong>`;
                        let detailsText = '';
                        if (drink.milk && drink.milk !== "No Aplica") detailsText += `Leche: ${drink.milk}, `;
                        if (drink.cup) detailsText += `Vaso: ${drink.cup}, `;
                        if (drink.temp) detailsText += `Temp: ${drink.temp}`;
                        
                        if (detailsText) {
                            mainText += `<span class="item-details">${detailsText.replace(/, $/, '')}</span>`;
                        }
                        textSpan.innerHTML = mainText;
                        li.appendChild(textSpan);

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'üóëÔ∏è';
                        removeBtn.classList.add('remove-item-btn');
                        removeBtn.onclick = () => {
                            order.drinks = order.drinks.filter(d => d.id !== drink.id);
                            renderSummary(); 
                            renderDrinksSummaryStep1(); // Actualizar resumen del paso 1 tambi√©n
                        };
                        li.appendChild(removeBtn);
                        summaryList.appendChild(li);
                    });
                }

                if (order.food.length > 0) {
                    const foodCategory = document.createElement('li');
                    foodCategory.classList.add('summary-category');
                    foodCategory.innerHTML = '<strong><span class="icon">ü•™</span>Comida:</strong>';
                    summaryList.appendChild(foodCategory);

                    order.food.forEach(f_item => { 
                        const li = document.createElement('li');
                        const textSpan = document.createElement('span');
                        textSpan.classList.add('item-text-content');

                        textSpan.innerHTML = `<strong>${f_item.type}</strong>`;
                        if (f_item.ingredients.length > 0) {
                            textSpan.innerHTML += `<span class="item-details">Ingredientes: ${f_item.ingredients.join(', ')}</span>`;
                        } else {
                            textSpan.innerHTML += `<span class="item-details">(sola/sin ingredientes extra)</span>`;
                        }
                        li.appendChild(textSpan);

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'üóëÔ∏è';
                        removeBtn.classList.add('remove-item-btn');
                        removeBtn.onclick = () => {
                            order.food = order.food.filter(foodItm => foodItm.id !== f_item.id);
                            renderSummary();
                            renderFoodSummaryStep2(); // Actualizar resumen del paso 2 tambi√©n
                        };
                        li.appendChild(removeBtn);
                        summaryList.appendChild(li);
                    });
                }
            }

            // --- Custom Message Modal ---
            function showMessageModalAlert(title, message, callback = null) {
                messageModalTitle.textContent = title;
                messageModalText.innerHTML = message.replace(/\n/g, '<br>');
                
                const newOkBtn = messageModalOkBtn.cloneNode(true);
                messageModalOkBtn.parentNode.replaceChild(newOkBtn, messageModalOkBtn);
                messageModalOkBtn = newOkBtn;

                const newCloseMessageBtn = closeMessageModalBtn.cloneNode(true);
                closeMessageModalBtn.parentNode.replaceChild(newCloseMessageBtn, closeMessageModalBtn);
                closeMessageModalBtn = newCloseMessageBtn;
                
                const handleOk = () => {
                    hideModal(messageModal);
                    if (callback) callback();
                };
                const handleClose = () => {
                    hideModal(messageModal);
                };
                
                messageModalOkBtn.addEventListener('click', handleOk, { once: true });
                closeMessageModalBtn.addEventListener('click', handleClose, { once: true });

                if (messageModal._outsideClickListener) {
                    messageModal.removeEventListener('click', messageModal._outsideClickListener);
                }
                messageModal._outsideClickListener = (event) => {
                    if (event.target === messageModal) {
                       handleClose();
                       messageModal.removeEventListener('click', messageModal._outsideClickListener);
                    }
                };
                messageModal.addEventListener('click', messageModal._outsideClickListener);
                showModal(messageModal);
            }

            // --- Inicializaci√≥n ---
            hideModal(coffeeModal);
            hideModal(messageModal);

            updateNavigation(); 
            renderDrinksSummaryStep1(); // Renderizar resumen de bebidas al inicio
            renderFoodSummaryStep2(); 
        });
    </script>
</body>
</html>