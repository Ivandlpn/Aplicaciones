<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuSa Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Playful Harmony -->
    <!-- Application Structure Plan: A single-page application (SPA) using a view-switching mechanism. DIVs for each screen (main-menu, trivia-menu, trivia-player-selection, trivia-game, tictactoe-menu, tictactoe-player-selection, tictactoe-game, memory-menu, memory-player-selection, memory-game, guess-number-menu, guess-number-player-selection, guess-number-game, simon-menu, simon-player-selection, simon-game, paint-by-number-menu, paint-by-number-player-selection, paint-by-number-game) are toggled between hidden/visible. This creates a fluid, app-like experience without page reloads, which is ideal for kids. The flow is: Main Menu -> Select Game Menu -> Select Player/Mode -> Play -> Return to Game Menu/Main Menu. High scores are now integrated directly into the game screens for single-player modes. This structure is user-friendly and technically simple for a single-file app. -->
    <!-- Visualization & Content Choices: Main Menu uses large, animated HTML buttons with Unicode icons for intuitive navigation. Game menus (Trivia, Tic-Tac-Toe, Memory, Guess the Number, Simon Says, Paint by Number) allow mode selection (1 or 2 players). New player selection screens for Trivia, Tic-Tac-Toe, Memory, Guess the Number, Simon Says, and Paint by Number. Trivia uses HTML text blocks and a feedback modal for an interactive learning loop, now with turn-based scoring and player names for 2 players. Tic-Tac-Toe uses a CSS grid and X/O symbols for a thematic and asset-free experience, with player names for both 1-player (vs AI) and 2-player modes, now displaying 🤖 instead of IA. The Memory game uses a CSS grid with 3D flip animations on the cards for engagement, now with turn-based logic and player names for 2 players. Added a 'pop' animation for matched memory cards. Guess the Number provides feedback and tracks attempts. Simon Says introduces a sequence of colored buttons for memory challenge. Paint by Number uses a grid and color palette for artistic play. High scores and current game scores are now directly visible on the game screen for single-player modes, styled with normal, clean scoreboards. All interactions are handled by Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        /* Ensure UTF-8 encoding for proper character display */
        @charset "UTF-8";

        body {
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, h3, .font-display {
            font-family: 'Fredoka One', cursive;
        }
        .card {
            perspective: 1000px; /* Added for 3D flip effect */
        }
        .card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            z-index: 2; /* Ensures this face (star) is on top initially */
        }
        .card-back {
            transform: rotateY(180deg);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            z-index: 1; /* Ensures this face (emoji) is behind initially */
        }
        .bg-pattern {
            background-color: #FEF3C7; /* amber-100 */
            background-image:
                radial-gradient(circle at 100% 0, #FBBF24, transparent 20%),
                radial-gradient(circle at 0 100%, #34D399, transparent 20%);
        }
        .btn-game {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, filter 0.2s ease-out; /* Added filter to transition */
        }
        .btn-game:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-game:active {
            transform: translateY(0px) scale(0.97); /* Slight scale down, no translateY on active */
            box-shadow: 0 2px 5px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.05); /* Reduced shadow for pressed look */
            filter: brightness(0.85); /* Slightly darker */
        }
        /* Renamed modal-enter/leave to be more generic for screen transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .scale-up-center {
            animation: scale-up-center 0.4s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;
        }
        @keyframes scale-up-center {
            0% { transform: scale(0.5); }
            100% { transform: scale(1); }
        }

        /* New animation for matched cards */
        .card.is-matched {
            animation: card-pop 0.3s ease-out;
        }
        @keyframes card-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Themed backgrounds for app-container */
        .bg-trivia-theme {
            background-color: #ECFDF5; /* emerald-50, very light green */
            transition: background-color 0.3s ease-in-out; /* Smooth transition for background color */
        }
        .bg-tictactoe-theme {
            background-color: #EFF6FF; /* sky-50, very light blue */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-memory-theme {
            background-color: #FFF1F2; /* rose-50, very light red */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-guess-number-theme {
            background-color: #F0FDF4; /* green-50, very light green */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-simon-theme {
            background-color: #FDF2F8; /* pink-50, very light pink */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-paint-by-number-theme {
            background-color: #FDF6F0; /* orange-50, very light orange */
            transition: background-color 0.3s ease-in-out;
        }

        /* New styles for Trivia answer feedback */
        .trivia-answer-button.correct {
            background-color: #34D399; /* emerald-500 */
            color: white;
            box-shadow: 0 0 15px #34D399; /* Green glow */
            transform: scale(1.02);
            transition: all 0.3s ease-out;
        }
        .trivia-answer-button.incorrect {
            background-color: #EF4444; /* red-500 */
            color: white;
            opacity: 0.6;
            transform: scale(0.98);
            transition: all 0.3s ease-out;
        }
        .trivia-answer-button.disabled {
            pointer-events: none; /* Disable clicks during feedback */
        }

        /* New styles for Tic-Tac-Toe win animation */
        .win-highlight {
            animation: pulse-glow 1s infinite alternate; /* Pulse and glow animation */
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0px #34D399; /* No glow */
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px #34D399, 0 0 30px #34D399; /* Strong glow */
                transform: scale(1.05); /* Slight pulse */
            }
            100% {
                box-shadow: 0 0 0px #34D399; /* No glow */
                transform: scale(1);
            }
        }

        /* New styles for Memory card shuffling animation */
        .card.is-shuffling {
            animation: shuffle-card 1.2s ease-out forwards;
            opacity: 0; /* Start invisible */
        }

        @keyframes shuffle-card {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(0.8);
                opacity: 0;
            }
            25% {
                transform: translate(10px, -5px) rotate(5deg) scale(0.9);
                opacity: 0.5;
            }
            50% {
                transform: translate(-10px, 5px) rotate(-5deg) scale(1.05);
                opacity: 1;
            }
            75% {
                transform: translate(5px, -10px) rotate(3deg) scale(0.95);
                opacity: 0.7;
            }
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        /* New animations for Trivia game over */
        .win-animation {
            animation: win-celebrate 1.5s ease-out forwards;
        }

        @keyframes win-celebrate {
            0% {
                transform: scale(0.8);
                opacity: 0;
                color: #34D399; /* emerald-500 */
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
                color: #10B981; /* darker emerald */
                text-shadow: 0 0 15px #34D399;
            }
            100% {
                transform: scale(1);
                opacity: 1;
                color: #34D399;
                text-shadow: none;
            }
        }

        .lose-animation {
            animation: lose-shake 0.8s ease-in-out forwards;
            color: #EF4444; /* red-500 */
        }

        @keyframes lose-shake {
            0% { transform: translateX(0); opacity: 1; }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
            100% { transform: translateX(0); opacity: 0.7; }
        }

        .tie-animation {
            animation: tie-pulse 1s infinite alternate;
            color: #FBBF24; /* amber-500 */
        }

        @keyframes tie-pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.05); opacity: 0.9; }
        }

        /* New styles for Memory board themes */
        .memory-board-theme-sports {
            background-color: #D1FAE5; /* emerald-100 */
            border-radius: 1rem; /* Rounded corners for the board */
            padding: 0.5rem; /* Little padding inside */
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-animals {
            background-color: #FEFCE8; /* yellow-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-symbols {
            background-color: #FEE2E2; /* red-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-flags {
            background-color: #E0F2FE; /* blue-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }

        /* Simon Says specific styles */
        .simon-button {
            width: 100%;
            height: 100%;
            border-radius: 1rem; /* Rounded corners */
            transition: background-color 0.2s ease-out, transform 0.1s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .simon-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .simon-button.highlight {
            filter: brightness(1.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        /* Specific colors for Simon buttons */
        .simon-red { background-color: #EF4444; } /* Red */
        .simon-green { background-color: #22C55E; } /* Green */
        .simon-blue { background-color: #3B82F6; } /* Blue */
        .simon-yellow { background-color: #F59E0B; } /* Yellow */

        .simon-red.highlight { background-color: #F87171; }
        .simon-green.highlight { background-color: #4ADE80; }
        .simon-blue.highlight { background-color: #60A5FA; }
        .simon-yellow.highlight { background-color: #FCD34D; }

        /* Paint by Number specific styles */
        .paint-grid-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: #f3f4f6; /* gray-100 */
            transition: background-color 0.1s ease-out;
            cursor: pointer;
        }
        .paint-grid-cell.painted {
            border: 1px solid rgba(0,0,0,0.2);
            color: transparent; /* Hide number when painted */
        }
        .color-palette-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px; /* full rounded */
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-palette-button.selected {
            border-color: #3B82F6; /* blue-500 */
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); /* blue-500 with transparency */
        }

        /* New animation for completed paint cells */
        @keyframes paint-cell-flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.3); } /* Brighter flash */
            100% { filter: brightness(1); }
        }
        .paint-grid-cell.highlight-completed {
            animation: paint-cell-flash 0.5s ease-out forwards; /* Quick flash */
        }
    </style>
</head>
<body class="bg-amber-100 text-slate-800 min-h-screen flex items-center justify-center p-4 bg-pattern">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden">
        
        <!-- Main Menu Screen -->
        <div id="main-menu" class="p-6 md:p-8">
            <h1 class="text-5xl md:text-6xl text-center font-display text-amber-600 drop-shadow-lg">HuSa Games</h1>
            <p class="text-center text-slate-600 mt-2 mb-8">¡Elige un juego y a divertirse!</p>
            
            <div class="space-y-4">
                <button onclick="showScreen('trivia-menu')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">❓</span> Preguntas y Respuestas
                </button>
                <button onclick="showScreen('tictactoe-menu')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">❌</span> Tres en Raya
                </button>
                <button onclick="showScreen('memory-menu')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">🃏</span> Memocartas
                </button>
                <button onclick="showScreen('guess-number-menu')" class="btn-game w-full bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">🔢</span> Adivina el Número
                </button>
                <button onclick="showScreen('simon-menu')" class="btn-game w-full bg-fuchsia-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">🧠</span> Simon Dice
                </button>
                <button onclick="showScreen('paint-by-number-menu')" class="btn-game w-full bg-orange-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3 text-3xl drop-shadow-md">🎨</span> Pintar por Números
                </button>
            </div>
        </div>

        <!-- Trivia Menu Screen -->
        <div id="trivia-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-emerald-600">Preguntas y Respuestas</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('trivia-player-selection')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="startTrivia('multi')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
            </div>
        </div>

        <!-- Trivia Player Selection Screen -->
        <div id="trivia-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('trivia-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-emerald-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startTrivia('single', 'Hugo')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo
                </button>
                <button onclick="startTrivia('single', 'Saúl')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl
                </button>
            </div>
        </div>

        <!-- Trivia Game Screen -->
        <div id="trivia-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('trivia-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-emerald-600">Trivia</h2>
                <!-- This div will now dynamically show single or multi-player scores -->
                <div id="trivia-score-container" class="text-lg font-bold bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full">
                    <!-- Content set by JS -->
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="trivia-progress-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
            </div>
            <!-- This div is for multi-player turn indicator, will remain -->
            <div id="trivia-player-turn" class="text-center text-emerald-700 font-semibold mb-3 hidden">
                <span id="trivia-current-player-turn"></span>
            </div>
            <div id="trivia-content">
                <div class="bg-white p-4 rounded-lg shadow-inner mb-4">
                    <p id="trivia-category" class="text-sm text-slate-500 mb-2"></p>
                    <p id="trivia-question" class="text-lg font-semibold"></p>
                </div>
                <div id="trivia-answers" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>
        
        <!-- Tic-Tac-Toe Menu Screen -->
        <div id="tictactoe-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-sky-600">Tres en Raya</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('tictactoe-player-selection')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="startTicTacToe('human')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Hugo vs Saúl)
                </button>
            </div>
        </div>

        <!-- Tic-Tac-Toe Player Selection Screen -->
        <div id="tictactoe-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('tictactoe-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-sky-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startTicTacToe('ai', 'Hugo')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo vs <span class="text-3xl drop-shadow-md">🤖</span>
                </button>
                <button onclick="startTicTacToe('ai', 'Saúl')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl vs <span class="text-3xl drop-shadow-md">🤖</span>
                </button>
            </div>
        </div>

        <!-- Tic-Tac-Toe Game Screen -->
        <div id="tictactoe-game" class="hidden p-6">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('tictactoe-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                 <h2 id="tictactoe-status" class="text-xl text-center font-display text-sky-600"></h2>
                <button onclick="resetTicTacToe()" class="text-sky-500 hover:text-sky-700 font-bold active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar</button>
            </div>
            <div id="tictactoe-board" class="grid grid-cols-3 gap-2 aspect-square max-w-sm mx-auto">
                <!-- Cells will be generated by JS -->
            </div>
        </div>

        <!-- Memory Menu Screen -->
        <div id="memory-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-rose-600">Memocartas</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('memory-player-selection')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="startMemoryGame('multi')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
            </div>
        </div>

        <!-- Memory Player Selection Screen -->
        <div id="memory-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('memory-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-rose-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startMemoryGame('single', 'Hugo')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo
                </button>
                <button onclick="startMemoryGame('single', 'Saúl')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl
                </button>
            </div>
        </div>

        <!-- Memory Game Screen -->
        <div id="memory-game" class="hidden p-4">
             <div class="flex justify-between items-center mb-2">
                <button onclick="showScreen('memory-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-rose-600">Memocartas</h2>
                 <div class="flex items-center space-x-4">
                    <div id="memory-attempts-display" class="text-lg font-bold bg-rose-100 text-rose-800 px-3 py-1 rounded-full">
                        Intentos: <span id="memory-attempts">0</span>
                    </div>
                    <div id="memory-timer-display" class="text-lg font-bold bg-rose-100 text-rose-800 px-3 py-1 rounded-full hidden">
                        Tiempo: <span id="memory-timer">00:00</span>
                    </div>
                 </div>
            </div>
            <div id="memory-player-turn" class="text-center text-rose-700 font-semibold mb-3 hidden">
                <span id="memory-current-player-turn"></span><br>
                <span class="text-base font-semibold">Hugo: <span id="memory-player1-matched">0</span> | Saúl: <span id="memory-player2-matched">0</span></span>
            </div>
            <div id="memory-highscore-display" class="text-center text-rose-600 font-semibold mb-3 hidden">
                <span id="memory-highscore-label"></span> <span id="memory-highscore-value">N/A</span>
            </div>
            <div id="memory-board" class="grid grid-cols-4 gap-2 md:gap-3">
                <!-- Cards will be generated by JS -->
            </div>
        </div>

        <!-- Guess the Number Menu Screen -->
        <div id="guess-number-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-green-600">Adivina el Número</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('guess-number-player-selection')" class="btn-game w-full bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <!-- For now, 2 players mode is not implemented for this game -->
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Guess the Number Player Selection Screen -->
        <div id="guess-number-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('guess-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-green-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startGameGuessNumber('single', 'Hugo')" class="btn-game w-full bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo
                </button>
                <button onclick="startGameGuessNumber('single', 'Saúl')" class="btn-game w-full bg-lime-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl
                </button>
            </div>
        </div>

        <!-- Guess the Number Game Screen -->
        <div id="guess-number-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('guess-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-green-600">Adivina el Número</h2>
                <div class="text-lg font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full">
                    Intentos: <span id="guess-number-attempts">0</span>
                </div>
            </div>
            <div id="guess-number-highscore-display" class="text-center text-green-600 font-semibold mb-3">
                Mejor: <span id="guess-number-highscore-value">N/A</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-4 text-center">
                <p class="text-lg font-semibold mb-2">Estoy pensando en un número entre 1 y 100.</p>
                <p id="guess-number-feedback" class="text-xl font-bold text-slate-700 min-h-[2rem] flex items-center justify-center"></p>
            </div>
            <div class="flex space-x-2 mb-4">
                <input type="number" id="guess-number-input" class="flex-grow p-3 rounded-lg border-2 border-green-300 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 text-center text-2xl font-bold" placeholder="Tu número" min="1" max="100">
                <button onclick="checkGuess()" class="bg-green-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">¡Adivinar!</button>
            </div>
            <button onclick="resetGuessNumberGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Juego</button>
        </div>

        <!-- Simon Says Menu Screen -->
        <div id="simon-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-fuchsia-600">Simon Dice</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('simon-player-selection')" class="btn-game w-full bg-fuchsia-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Simon Says Player Selection Screen -->
        <div id="simon-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('simon-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-fuchsia-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startSimonGame('single', 'Hugo')" class="btn-game w-full bg-fuchsia-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo
                </button>
                <button onclick="startSimonGame('single', 'Saúl')" class="btn-game w-full bg-pink-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl
                </button>
            </div>
        </div>

        <!-- Simon Says Game Screen -->
        <div id="simon-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('simon-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-fuchsia-600">Simon Dice</h2>
                <div class="text-lg font-bold bg-fuchsia-100 text-fuchsia-800 px-3 py-1 rounded-full">
                    Nivel: <span id="simon-level">0</span>
                </div>
            </div>
            <div id="simon-highscore-display" class="text-center text-fuchsia-600 font-semibold mb-3">
                Mejor: <span id="simon-highscore-value">N/A</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-4 text-center aspect-square flex items-center justify-center flex-col">
                <p id="simon-feedback" class="text-xl font-bold text-slate-700 min-h-[2rem] flex items-center justify-center mb-4">¡Pulsa "Empezar" para jugar!</p>
                <div id="simon-buttons-container" class="grid grid-cols-2 gap-4 w-full max-w-xs aspect-square">
                    <button id="simon-red" class="simon-button simon-red"></button>
                    <button id="simon-green" class="simon-button simon-green"></button>
                    <button id="simon-blue" class="simon-button simon-blue"></button>
                    <button id="simon-yellow" class="simon-button simon-yellow"></button>
                </div>
                <button id="simon-start-button" onclick="startSimonRound()" class="mt-6 bg-fuchsia-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Empezar</button>
            </div>
            <button onclick="resetSimonGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Juego</button>
        </div>

        <!-- Paint by Number Menu Screen -->
        <div id="paint-by-number-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-orange-600">Pintar por Números</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showScreen('paint-by-number-player-selection')" class="btn-game w-full bg-orange-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Paint by Number Player Selection Screen -->
        <div id="paint-by-number-player-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('paint-by-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl mr-4 active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-orange-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre:</p>
            <div class="space-y-4">
                <button onclick="startPaintByNumberGame('single', 'Hugo')" class="btn-game w-full bg-orange-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Hugo
                </button>
                <button onclick="startPaintByNumberGame('single', 'Saúl')" class="btn-game w-full bg-amber-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    Saúl
                </button>
            </div>
        </div>

        <!-- Paint by Number Game Screen -->
        <div id="paint-by-number-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('paint-by-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-orange-600">Pintar</h2>
                <div class="text-lg font-bold bg-orange-100 text-orange-800 px-3 py-1 rounded-full">
                    Progreso: <span id="paint-by-number-progress">0%</span>
                </div>
            </div>
            <!-- Removed the high score display for Paint by Number -->
            <div id="paint-grid-container" class="w-full aspect-square bg-white rounded-lg shadow-inner overflow-hidden mb-4 grid">
                <!-- Grid cells will be generated by JS -->
            </div>
            <div id="color-palette" class="flex justify-center space-x-2 md:space-x-4 mb-4">
                <!-- Color buttons will be generated by JS -->
            </div>
            <button onclick="resetPaintByNumberGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Imagen</button>
        </div>


        <!-- Modal for Trivia Feedback -->
        <div id="trivia-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
                <h3 id="modal-title" class="text-4xl font-display mb-2"></h3>
                <p id="modal-explanation" class="text-slate-600 mb-6"></p>
                <button id="modal-next-btn" class="w-full bg-amber-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Siguiente</button>
            </div>
        </div>

        <!-- Modal for Game Over -->
        <div id="gameover-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
                <h3 id="gameover-title" class="text-4xl font-display mb-2"></h3>
                <p id="gameover-message" class="text-slate-600 mb-6"></p>
                <div class="flex flex-col space-y-2">
                    <button id="gameover-restart-btn" class="w-full bg-amber-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Jugar de nuevo</button>
                    <button id="gameover-menu-btn" class="w-full bg-slate-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Volver al menú</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const screens = {
            mainMenu: document.getElementById('main-menu'),
            triviaMenu: document.getElementById('trivia-menu'),
            triviaPlayerSelection: document.getElementById('trivia-player-selection'),
            triviaGame: document.getElementById('trivia-game'),
            tictactoeMenu: document.getElementById('tictactoe-menu'),
            tictactoePlayerSelection: document.getElementById('tictactoe-player-selection'),
            tictactoeGame: document.getElementById('tictactoe-game'),
            memoryMenu: document.getElementById('memory-menu'),
            memoryPlayerSelection: document.getElementById('memory-player-selection'),
            memoryGame: document.getElementById('memory-game'),
            guessNumberMenu: document.getElementById('guess-number-menu'),
            guessNumberPlayerSelection: document.getElementById('guess-number-player-selection'),
            guessNumberGame: document.getElementById('guess-number-game'),
            simonMenu: document.getElementById('simon-menu'),
            simonPlayerSelection: document.getElementById('simon-player-selection'),
            simonGame: document.getElementById('simon-game'),
            paintByNumberMenu: document.getElementById('paint-by-number-menu'),
            paintByNumberPlayerSelection: document.getElementById('paint-by-number-player-selection'),
            paintByNumberGame: document.getElementById('paint-by-number-game'),
        };
        
        const modals = {
            trivia: document.getElementById('trivia-modal'),
            gameOver: document.getElementById('gameover-modal')
        };

        let currentScreen = 'main-menu'; // Tracks the ID of the currently visible screen

        function showScreen(screenId) {
            const targetScreen = document.getElementById(screenId);
            if (!targetScreen) return;

            const currentScreenElement = document.getElementById(currentScreen);
            const appContainer = document.getElementById('app-container'); // Get app container

            // Remove all specific theme classes from appContainer
            appContainer.classList.remove('bg-trivia-theme', 'bg-tictactoe-theme', 'bg-memory-theme', 'bg-guess-number-theme', 'bg-simon-theme', 'bg-paint-by-number-theme');
            // Re-add the default translucent white for screens that, that don't have a specific theme
            appContainer.classList.add('bg-white/70');

            // Apply theme based on screenId
            if (screenId.startsWith('trivia')) { // Check if screenId starts with 'trivia'
                appContainer.classList.add('bg-trivia-theme');
                appContainer.classList.remove('bg-white/70'); // Remove default translucent white if theme is applied
            } else if (screenId.startsWith('tictactoe')) { // Check if screenId starts with 'tictactoe'
                appContainer.classList.add('bg-tictactoe-theme');
                appContainer.classList.remove('bg-white/70');
            } else if (screenId.startsWith('memory')) { // Check if screenId starts with 'memory'
                appContainer.classList.add('bg-memory-theme');
                appContainer.classList.remove('bg-white/70');
            } else if (screenId.startsWith('guess-number')) { // New theme for Guess the Number
                appContainer.classList.add('bg-guess-number-theme');
                appContainer.classList.remove('bg-white/70');
            } else if (screenId.startsWith('simon')) { // New theme for Simon Says
                appContainer.classList.add('bg-simon-theme');
                appContainer.classList.remove('bg-white/70');
            } else if (screenId.startsWith('paint-by-number')) { // New theme for Paint by Number
                appContainer.classList.add('bg-paint-by-number-theme');
                appContainer.classList.remove('bg-white/70');
            }
            // For 'main-menu', it will default back to bg-white/70 after removal above.

            if (currentScreenElement && currentScreenElement !== targetScreen) {
                // Apply fade-out animation to the current screen
                currentScreenElement.classList.add('fade-out');
                currentScreenElement.classList.remove('fade-in'); // Ensure no lingering fade-in

                // After the fade-out animation completes, hide the current screen and show the new one
                setTimeout(() => {
                    currentScreenElement.classList.add('hidden');
                    currentScreenElement.classList.remove('fade-out'); // Clean up fade-out class

                    // Show the target screen with fade-in animation
                    targetScreen.classList.remove('hidden');
                    targetScreen.classList.add('fade-in');
                    targetScreen.classList.remove('fade-out'); // Ensure no lingering fade-out

                    currentScreen = screenId; // Update the current screen tracker
                }, 300); // This timeout duration should match the CSS animation duration
            } else if (currentScreenElement !== targetScreen) { // This handles the initial load or if currentScreen is somehow not set
                // Directly show the target screen with fade-in animation
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('fade-in');
                targetScreen.classList.remove('fade-out'); // Clean up
                currentScreen = screenId; // Update the current screen tracker
            }
            // If targetScreen is already currentScreen, do nothing.
        }

        function showModal(modalId, options = {}) {
            const modal = modals[modalId];
            if (!modal) return;

            if (modalId === 'trivia') {
                document.getElementById('modal-title').textContent = options.title;
                document.getElementById('modal-title').className = `text-4xl font-display mb-2 ${options.correct ? 'text-emerald-500' : 'text-rose-500'}`;
                document.getElementById('modal-explanation').innerHTML = options.explanation;
                document.getElementById('modal-next-btn').onclick = options.nextCallback;
            } else if (modalId === 'gameOver') {
                const titleElement = document.getElementById('gameover-title');
                const messageElement = document.getElementById('gameover-message');

                // Clear any previous animation classes
                titleElement.classList.remove('win-animation', 'lose-animation', 'tie-animation');
                messageElement.classList.remove('win-animation', 'lose-animation', 'tie-animation');


                titleElement.textContent = options.title;
                messageElement.textContent = options.message;

                // Reset styles first to avoid bleed-over from previous calls
                titleElement.style.fontSize = '';
                titleElement.style.color = '';
                titleElement.style.textShadow = '';
                titleElement.style.fontFamily = '';
                messageElement.style.fontSize = '';
                messageElement.style.color = '';
                messageElement.style.textShadow = '';

                if (options.game === 'tictactoe' && options.win) { // Apply special styling for Tic-Tac-Toe win
                    titleElement.style.fontSize = '3.5rem';
                    titleElement.style.color = '#34D399'; /* Emerald green */
                    titleElement.style.textShadow = '0 0 10px #34D399, 0 0 20px #34D399, 0 0 30px #34D399';
                    titleElement.style.fontFamily = "'Press Start 2P', cursive";

                    messageElement.style.fontSize = '1.5rem';
                    messageElement.style.color = '#10B981'; /* Darker emerald */
                    messageElement.style.textShadow = '0 0 5px #10B981';
                } else if (options.game === 'trivia') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        messageElement.classList.add('win-animation');
                    } else if (options.lose) {
                        titleElement.classList.add('lose-animation');
                        messageElement.classList.add('lose-animation');
                    } else if (options.tie) {
                        titleElement.classList.add('tie-animation');
                        messageElement.classList.add('tie-animation');
                    }
                } else if (options.game === 'guess-number') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#16A34A'; /* green-600 */
                    } else { // Should not happen in guess number, but for consistency
                        titleElement.classList.add('lose-animation');
                        titleElement.style.color = '#DC2626'; /* red-600 */
                    }
                } else if (options.game === 'simon') {
                    if (options.win) { // Simon game win means reached a new high level
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#C026D3'; /* fuchsia-600 */
                    } else { // Simon game lose
                        titleElement.classList.add('lose-animation');
                        titleElement.style.color = '#DC2626'; /* red-600 */
                    }
                } else if (options.game === 'paint-by-number') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#F97316'; /* orange-600 */
                    } else {
                        // Not really a lose state for paint by number, but for consistency
                        titleElement.classList.add('tie-animation');
                        titleElement.style.color = '#FBBF24'; /* amber-500 */
                    }
                }

                document.getElementById('gameover-restart-btn').onclick = options.restartCallback;
                document.getElementById('gameover-menu-btn').onclick = () => {
                    closeModal('gameOver');
                    // Determine which menu to go back to based on the game
                    if (options.game === 'trivia') showScreen('trivia-menu');
                    else if (options.game === 'memory') showScreen('memory-menu');
                    else if (options.game === 'tictactoe') showScreen('tictactoe-menu');
                    else if (options.game === 'guess-number') showScreen('guess-number-menu');
                    else if (options.game === 'simon') showScreen('simon-menu');
                    else if (options.game === 'paint-by-number') showScreen('paint-by-number-menu');
                    else showScreen('main-menu'); // Default fallback
                };
            }
            
            modal.classList.remove('hidden', 'fade-out'); // Use generic fade-out
            modal.classList.add('fade-in'); // Use generic fade-in
        }

        function closeModal(modalId) {
            const modal = modals[modalId];
            if (!modal) return;
            
            modal.classList.add('fade-out'); // Use generic fade-out
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('fade-in', 'fade-out'); // Clean up generic classes
            }, 300);
        }

        function saveTriviaHighScore(playerName, score) {
            const key = `highscore_trivia_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '0');
            console.log(`[Trivia] Saving high score for ${playerName}. New score: ${score}, Current best: ${currentHighScore}`);
            if (score > currentHighScore) {
                localStorage.setItem(key, score);
                console.log(`[Trivia] New high score saved: ${score} for ${playerName}`);
            } else {
                console.log(`[Trivia] No new high score for ${playerName}. Score: ${score}, Current best: ${currentHighScore}`);
            }
        }

        function saveMemoryHighScore(playerName, value, isTime = false) {
            const key = `highscore_memory_${playerName}`;
            // For time, lower is better. For attempts, lower is better.
            // So, for time, we store seconds. For attempts, we store count.
            // The comparison logic remains the same: if new value is less than current, update.
            const currentHighScore = parseInt(localStorage.getItem(key) || (isTime ? '999999' : '999')); // Default high value for time/attempts
            console.log(`[Memocartas] Saving high score for ${playerName}. New value: ${value}, Current best: ${currentHighScore}, Is Time: ${isTime}`);
            if (value < currentHighScore) {
                localStorage.setItem(key, value);
                console.log(`[Memocartas] New high score saved: ${value} for ${playerName}`);
            } else {
                console.log(`[Memocartas] No new high score for ${playerName}. Value: ${value}, Current best: ${currentHighScore}`);
            }
        }

        // --- Trivia Game Logic ---
        const initialTriviaQuestions = [ // Renamed to initialTriviaQuestions
            { category: "Ciencia", question: "¿Cuál es el planeta más grande de nuestro sistema solar?", answers: ["Júpiter", "Saturno", "Tierra", "Marte"], correct: 0, explanation: "Júpiter es tan grande que todos los demás planetas del sistema solar podrían caber dentro de él." },
            { category: "Deportes", question: "¿Cuántos jugadores tiene un equipo de fútbol en el campo?", answers: ["11", "9", "7", "12"], correct: 0, explanation: "Un equipo de fútbol estándar tiene 11 jugadores en el campo, incluyendo al portero." },
            { category: "Animales", question: "Verdadero o Falso: El guepardo es el animal terrestre más rápido.", answers: ["Verdadero", "Falso"], correct: 0, explanation: "¡Es cierto! El guepardo puede alcanzar velocidades de hasta 120 km/h en distancias cortas." },
            { category: "Historia", question: "¿Quién descubrió América en 1492?", answers: ["Marco Polo", "Vasco de Gama", "Cristóbal Colón", "Hernán Cortés"], correct: 2, explanation: "Cristóbal Colón llegó a América en 1492, aunque él creía haber llegado a las Indias." },
            { category: "Geografía", question: "¿Cuál es el río más largo del mundo?", answers: ["Nilo", "Amazonas", "Misisipi", "Yangtsé"], correct: 1, explanation: "El río Amazonas en Sudamérica es considerado el más largo y caudaloso del mundo." },
            { category: "Matemáticas", question: "¿Cuánto es 12 x 12?", answers: ["124", "132", "144", "156"], correct: 2, explanation: "12 multiplicado por 12 es igual a 144. ¡Buen cálculo!" },
            { category: "Animales", question: "¿Cuál es el mamífero más grande del mundo?", answers: ["Elefante", "Jirafa", "Ballena Azul", "Rinoceronte"], correct: 2, explanation: "La Ballena Azul es el animal más grande que ha existido jamás, ¡más grande que cualquier dinosaurio!" },
            { category: "Deportes", question: "Verdadero o Falso: Los Juegos Olímpicos se celebran cada 5 años.", answers: ["Verdadero", "Falso"], correct: 1, explanation: "Falso. Los Juegos Olímpicos de Verano e Invierno se celebran cada 4 años." },
            // New questions about Málaga
            { category: "Historia de Málaga", question: "¿Qué famoso artista nació en Málaga?", answers: ["Pablo Picasso", "Salvador Dalí", "Francisco Goya", "Diego Velázquez"], correct: 0, explanation: "Pablo Picasso, uno de los artistas más influyentes del siglo XX, nació en Málaga." },
            { category: "Historia de Málaga", question: "¿Cómo se llama la fortaleza palaciega de origen musulmán en Málaga?", answers: ["La Alhambra", "La Alcazaba", "El Generalife", "El Real Alcázar"], correct: 1, explanation: "La Alcazaba es una impresionante fortaleza palaciega de la época musulmana en Málaga." },
            { category: "Historia de Málaga", question: "¿Qué civilización fundó Malaka, el primer asentamiento en la actual Málaga?", answers: ["Romanos", "Griegos", "Fenicios", "Visigodos"], correct: 2, explanation: "Los fenicios fundaron Malaka, el origen de la ciudad de Málaga, alrededor del siglo VIII a.C." },
            { category: "Historia de Málaga", question: "¿Qué importante evento histórico ocurrió en Málaga en 1487?", answers: ["La Batalla de Las Navas de Tolosa", "La Conquista por los Reyes Católicos", "La Invasión Napoleónica", "La Peste Negra"], correct: 1, explanation: "En 1487, Málaga fue conquistada por los Reyes Católicos, marcando el fin del dominio musulmán en la ciudad." },
            { category: "Historia de Málaga", question: "¿Qué ruinas romanas se encuentran al pie de la Alcazaba de Málaga?", answers: ["Anfiteatro de Mérida", "Acueducto de Segovia", "Teatro Romano", "Templo de Diana"], correct: 2, explanation: "El Teatro Romano de Málaga, descubierto en 1951, se encuentra a los pies de la Alcazaba." },
            { category: "Curiosidades de Málaga", question: "¿Cuál es el nombre de la flor típica de Málaga, hecha con jazmines?", answers: ["Clavel", "Rosa", "Biznaga", "Orquídea"], correct: 2, explanation: "La biznaga es un ramillete artesanal de jazmines, muy representativo de Málaga." },
            { category: "Curiosidades de Málaga", question: "¿Cómo se conoce popularmente a los habitantes de Málaga?", answers: ["Gatos", "Pescaitos", "Boquerones", "Chulos"], correct: 2, explanation: "A los malagueños se les conoce cariñosamente como 'boquerones', por el pescado típico de la zona." },
            { category: "Curiosidades de Málaga", question: "¿Qué apodo recibe la Catedral de Málaga por su torre incompleta?", answers: ["La Coja", "La Tuerta", "La Manquita", "La Incompleta"], correct: 2, explanation: "La Catedral de Málaga es conocida como 'La Manquita' porque su torre sur nunca fue terminada." },
            { category: "Curiosidades de Málaga", question: "¿Qué tipo de clima predomina en Málaga?", answers: ["Oceánico", "Continental", "Desértico", "Mediterráneo subtropical"], correct: 3, explanation: "Málaga goza de un clima mediterráneo subtropical, con inviernos suaves y veranos cálidos." },
            { category: "Curiosidades de Málaga", question: "¿Qué celebración famosa tiene lugar en Málaga en agosto?", answers: ["Semana Santa", "Carnaval", "Feria de Málaga", "Navidad"], correct: 2, explanation: "La Feria de Málaga es una de las fiestas más importantes y concurridas de la ciudad, celebrada en agosto." },
            { category: "Comida de Málaga", question: "¿Cuál es el plato de pescado a la brasa más típico de Málaga?", answers: ["Paella", "Pulpo a la gallega", "Espetos de sardinas", "Calamares a la romana"], correct: 2, explanation: "Los espetos de sardinas, ensartadas en cañas y asadas a la brasa en la playa, son un icono de la gastronomía malagueña." },
            { category: "Comida de Málaga", question: "¿Qué sopa fría malagueña se elabora con almendras, ajo y pan?", answers: ["Gazpacho", "Salmorejo", "Ajoblanco", "Porra antequerana"], correct: 2, explanation: "El ajoblanco es una deliciosa sopa fría de origen malagueño, ideal para el verano." },
            { category: "Comida de Málaga", question: "¿Cómo se llama la fritura variada de pescado típica de Málaga?", answers: ["Mariscada", "Pescado a la sal", "Fritura Malagueña", "Gambas al pil-pil"], correct: 2, explanation: "La fritura malagueña es un surtido de pescado frito, muy popular en los chiringuitos de la costa." },
            { category: "Comida de Málaga", question: "¿Qué producto dulce y seco de la vid es muy famoso en Málaga?", answers: ["Uvas", "Vino dulce", "Pasas de Málaga", "Mosto"], correct: 2, explanation: "Las pasas de Málaga, especialmente las de la variedad Moscatel, tienen Denominación de Origen." },
            { category: "Comida de Málaga", question: "¿Qué tipo de vino dulce es famoso en Málaga?", answers: ["Rioja", "Ribera del Duero", "Jerez", "Vino de Málaga"], correct: 3, explanation: "El Vino de Málaga, con sus distintas variedades y dulzuras, es un producto vinícola con gran tradición." },
            { category: "Deporte en Málaga", question: "¿Cuál es el equipo de fútbol más representativo de la ciudad de Málaga?", answers: ["Real Betis", "Sevilla FC", "Málaga Club de Fútbol", "Granada CF"], correct: 2, explanation: "El Málaga Club de Fútbol es el equipo de fútbol más emblemático de la ciudad." },
            { category: "Deporte en Málaga", question: "¿En qué deporte destaca el Unicaja de Málaga?", answers: ["Fútbol", "Baloncesto", "Balonmano", "Voleibol"], correct: 1, explanation: "El Unicaja es uno de los equipos de baloncesto más importantes de España y Europa." },
            { category: "Deporte en Málaga", question: "¿Qué estadio es la sede del Málaga CF?", answers: ["Santiago Bernabéu", "Camp Nou", "Estadio La Rosaleda", "Estadio de La Cartuja"], correct: 2, explanation: "El Estadio La Rosaleda es el hogar del Málaga Club de Fútbol." },
            { category: "Deporte en Málaga", question: "¿Málaga ha sido sede de algún evento deportivo internacional importante?", answers: ["No, nunca", "Sí, solo eventos locales", "Sí, por ejemplo, la Copa Davis de tenis", "Solo competiciones de natación"], correct: 2, explanation: "Málaga ha albergado eventos de prestigio internacional, como fases finales de la Copa Davis de tenis." },
            { category: "Deporte en Málaga", question: "¿Qué deporte acuático es popular en la costa de Málaga, además de la natación?", answers: ["Esquí alpino", "Patinaje sobre hielo", "Surf", "Ciclismo de montaña"], correct: 2, explanation: "La costa de Málaga ofrece buenas condiciones para deportes acuáticos como el surf, el paddle surf o el windsurf." },
            // New questions about Policía Nacional
            { category: "Policía Nacional", question: "¿Cuál es el número de teléfono para llamar a la Policía Nacional en caso de emergencia?", answers: ["091", "112", "062", "900"], correct: 0, explanation: "El 091 es el número directo de la Policía Nacional para emergencias. El 112 es el número de emergencias general en Europa." },
            { category: "Policía Nacional", question: "¿Qué animal es el símbolo de la Policía Nacional?", answers: ["Un león", "Un águila", "Un perro", "Un caballo"], correct: 1, explanation: "El águila es el símbolo oficial de la Policía Nacional, representando fuerza y vigilancia." },
            { category: "Policía Nacional", question: "¿Qué color principal tiene el uniforme de la Policía Nacional?", answers: ["Verde", "Azul", "Negro", "Marrón"], correct: 1, explanation: "El uniforme de la Policía Nacional es principalmente de color azul oscuro." },
            { category: "Policía Nacional", question: "¿Los policías nacionales ayudan a las personas cuando están en peligro?", answers: ["Sí, siempre", "Solo a veces", "No, nunca", "Solo si es de día"], correct: 0, explanation: "Sí, los policías nacionales están para ayudar a todas las personas en situaciones de peligro o necesidad." },
            { category: "Policía Nacional", question: "¿Cómo se llama el coche que usa la policía para patrullar y responder a emergencias?", answers: ["Coche de bomberos", "Ambulancia", "Coche patrulla", "Taxi"], correct: 2, explanation: "El coche que usa la policía para sus funciones se llama coche patrulla." },
            { category: "Policía Nacional", question: "¿Qué llevan los policías en la cabeza para protegerse?", answers: ["Gorra", "Sombrero", "Casco", "Pañuelo"], correct: 0, explanation: "Los policías suelen llevar una gorra como parte de su uniforme." },
            { category: "Policía Nacional", question: "¿Qué hacen los policías si ven a alguien haciendo algo malo?", answers: ["Ignorarlo", "Darle un premio", "Detenerlo", "Aplaudirle"], correct: 2, explanation: "Si un policía ve a alguien cometiendo un delito, su deber es detenerlo para proteger a los demás." },
            { category: "Policía Nacional", question: "¿Los perros policía ayudan a encontrar cosas o personas?", answers: ["No, solo son mascotas", "Sí, son muy buenos olfateando", "Solo ladran", "Solo juegan"], correct: 1, explanation: "Sí, los perros policía tienen un olfato increíble y son entrenados para encontrar drogas, explosivos o personas desaparecidas." },
            { category: "Policía Nacional", question: "¿Qué es lo más importante que hace la Policía Nacional por nosotros?", answers: ["Contar chistes", "Cuidar la seguridad de todos", "Cocinar", "Bailar"], correct: 1, explanation: "Lo más importante que hace la Policía Nacional es cuidar de la seguridad de todos los ciudadanos y mantener el orden." },
            { category: "Policía Nacional", question: "¿Si te pierdes en la calle, a quién debes buscar para pedir ayuda?", answers: ["A un desconocido", "A un policía", "A un árbol", "A un pájaro"], correct: 1, explanation: "Si te pierdes, debes buscar a un policía, ellos te ayudarán a encontrar a tus padres o a tu casa." }
        ];
        let triviaQuestions = []; // This will hold the shuffled questions
        let currentTriviaQuestionIndex;
        let triviaGameMode; // 'single' or 'multi'
        let triviaCurrentPlayer; // 1 or 2
        let triviaPlayer1Score;
        let triviaPlayer2Score;
        let triviaPlayer1Name;
        let triviaPlayer2Name;
        const triviaPlayerTurnDisplay = document.getElementById('trivia-player-turn');
        const triviaScoreContainer = document.getElementById('trivia-score-container'); // Changed ID
        const triviaCurrentPlayerTurnDisplay = document.getElementById('trivia-current-player-turn');
        const triviaProgressBar = document.getElementById('trivia-progress-bar'); // Get the progress bar element


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startTrivia(mode, selectedPlayer = null) {
            triviaGameMode = mode;
            currentTriviaQuestionIndex = -1;
            triviaPlayer1Score = 0;
            triviaPlayer2Score = 0;
            triviaCurrentPlayer = 1; // Always start with Player 1
            
            // Shuffle the trivia questions at the start of each game
            triviaQuestions = [...initialTriviaQuestions]; // Copy the original array
            shuffleArray(triviaQuestions);

            // Hide player turn display initially
            triviaPlayerTurnDisplay.classList.add('hidden');
            triviaScoreContainer.innerHTML = ''; // Clear content of the score container

            if (triviaGameMode === 'single') {
                triviaPlayer1Name = selectedPlayer;
                triviaPlayer2Name = null; // No second player in single mode
                triviaScoreContainer.textContent = `${triviaPlayer1Name}: 0`; // Set initial score for single player
            } else { // 'multi'
                triviaPlayer1Name = 'Hugo';
                triviaPlayer2Name = 'Saúl';
                triviaPlayerTurnDisplay.classList.remove('hidden'); // Show player turn for multi-player
                // Set initial score for multi-player mode
                triviaScoreContainer.innerHTML = `${triviaPlayer1Name}: <span id="trivia-player1-score">0</span> | ${triviaPlayer2Name}: <span id="trivia-player2-score">0</span>`;
            }
            // Initialize progress bar to 0%
            triviaProgressBar.style.width = '0%';

            showScreen('trivia-game');
            loadNextTriviaQuestion();
        }

        function loadNextTriviaQuestion() {
            currentTriviaQuestionIndex++;
            if (currentTriviaQuestionIndex >= triviaQuestions.length) {
                endTriviaGame();
                return;
            }

            // Update progress bar width
            const progress = ((currentTriviaQuestionIndex + 1) / triviaQuestions.length) * 100;
            triviaProgressBar.style.width = `${progress}%`;


            if (triviaGameMode === 'multi') {
                triviaCurrentPlayerTurnDisplay.textContent = `Turno de ${triviaCurrentPlayer === 1 ? triviaPlayer1Name : triviaPlayer2Name}`;
                // Ensure these elements exist before trying to set textContent
                if (document.getElementById('trivia-player1-score')) {
                    document.getElementById('trivia-player1-score').textContent = triviaPlayer1Score;
                }
                if (document.getElementById('trivia-player2-score')) {
                    document.getElementById('trivia-player2-score').textContent = triviaPlayer2Score;
                }
            } else {
                triviaScoreContainer.textContent = `${triviaPlayer1Name}: ${triviaPlayer1Score}`;
            }

            const questionData = triviaQuestions[currentTriviaQuestionIndex];
            document.getElementById('trivia-category').textContent = questionData.category;
            document.getElementById('trivia-question').textContent = questionData.question;
            const answersContainer = document.getElementById('trivia-answers');
            answersContainer.innerHTML = '';

            questionData.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                // Added new class for trivia answer buttons for specific styling
                button.className = "w-full text-left bg-white p-3 rounded-lg shadow-md hover:bg-amber-100 transition active:scale-95 active:opacity-75 duration-100 trivia-answer-button"; 
                button.textContent = answer;
                button.dataset.index = index; // Store index for easy lookup
                button.onclick = () => checkTriviaAnswer(index);
                answersContainer.appendChild(button);
            });
        }
        
        function checkTriviaAnswer(selectedIndex) {
            const questionData = triviaQuestions[currentTriviaQuestionIndex];
            const correct = selectedIndex === questionData.correct;
            const answerButtons = document.querySelectorAll('#trivia-answers .trivia-answer-button');

            // Disable all buttons to prevent multiple clicks
            answerButtons.forEach(button => button.classList.add('disabled'));

            // Apply visual feedback
            answerButtons.forEach((button, index) => {
                if (index === questionData.correct) {
                    button.classList.add('correct'); // Highlight correct answer
                } else if (index === selectedIndex) {
                    button.classList.add('incorrect'); // Highlight selected incorrect answer
                }
            });
            
            if (correct) {
                if (triviaGameMode === 'single') {
                    triviaPlayer1Score += 10;
                } else {
                    if (triviaCurrentPlayer === 1) triviaPlayer1Score += 10;
                    else triviaPlayer2Score += 10;
                }
            }

            // Show modal after a short delay to let animations play
            setTimeout(() => {
                showModal('trivia', {
                    title: correct ? "¡Correcto!" : "¡Oh, no!",
                    explanation: questionData.explanation,
                    correct: correct,
                    nextCallback: () => {
                        closeModal('trivia');
                        // Clean up classes before loading next question
                        answerButtons.forEach(button => {
                            button.classList.remove('correct', 'incorrect', 'disabled');
                        });
                        if (triviaGameMode === 'multi') {
                            triviaCurrentPlayer = triviaCurrentPlayer === 1 ? 2 : 1; // Switch player
                        }
                        loadNextTriviaQuestion();
                    }
                });
            }, 1000); // 1 second delay
        }

        function endTriviaGame() {
            let finalMessage = "";
            let modalOptions = {
                game: 'trivia',
                restartCallback: () => { closeModal('gameOver'); startTrivia(triviaGameMode, triviaPlayer1Name); }
            };
            
            if (triviaGameMode === 'single') {
                saveTriviaHighScore(triviaPlayer1Name, triviaPlayer1Score);
                finalMessage = `¡${triviaPlayer1Name}, tu puntuación final es ${triviaPlayer1Score}! ¡Muy bien jugado!`;
                modalOptions.title = "¡Fin del juego!";
                modalOptions.win = true; // For single player, finishing is a win
            } else { // Multi-player
                if (triviaPlayer1Score > triviaPlayer2Score) {
                    finalMessage = `¡Felicidades ${triviaPlayer1Name}! Ganaste con ${triviaPlayer1Score} puntos contra ${triviaPlayer2Score}.`;
                    modalOptions.title = `¡${triviaPlayer1Name} ha ganado!`;
                    modalOptions.win = true;
                } else if (triviaPlayer2Score > triviaPlayer1Score) {
                    finalMessage = `¡Felicidades ${triviaPlayer2Name}! Ganaste con ${triviaPlayer2Score} puntos contra ${trivia1Score}.`;
                    modalOptions.title = `¡${triviaPlayer2Name} ha ganado!`;
                    modalOptions.win = true;
                } else {
                    finalMessage = `¡Es un empate! Ambos jugadores obtuvieron ${triviaPlayer1Score} puntos.`;
                    modalOptions.title = "¡Es un empate!";
                    modalOptions.tie = true;
                }
            }
            modalOptions.message = finalMessage;
            showModal('gameOver', modalOptions);
        }


        // --- Tic-Tac-Toe Logic ---
        let ttt_board;
        let ttt_currentPlayer;
        let ttt_gameActive;
        let ttt_gameMode; // 'ai' or 'human'
        let ttt_player1Name;
        let ttt_player2Name;
        
        function startTicTacToe(mode, selectedPlayer = null) { // Added selectedPlayer
            ttt_gameMode = mode;
            if (ttt_gameMode === 'ai') {
                ttt_player1Name = selectedPlayer; // Now uses selectedPlayer for single mode
                ttt_player2Name = '🤖'; // Always 🤖 for AI
            } else { // 'human'
                ttt_player1Name = 'Hugo';
                ttt_player2Name = 'Saúl';
            }
            showScreen('tictactoe-game');
            resetTicTacToe();
        }
        
        function resetTicTacToe() {
            ttt_board = ['', '', '', '', '', '', '', '', ''];
            ttt_currentPlayer = ttt_player1Name; // Start with Player 1's name
            ttt_gameActive = true;
            document.getElementById('tictactoe-status').textContent = `Turno de ${ttt_currentPlayer}`;
            const boardContainer = document.getElementById('tictactoe-board');
            boardContainer.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = "flex items-center justify-center text-5xl md:text-6xl bg-white rounded-lg shadow-inner hover:bg-sky-100 active:scale-95 active:opacity-75 transition-all duration-100"; /* Added active styles */
                cell.dataset.index = i;
                cell.onclick = () => handleCellClick(cell, i);
                boardContainer.appendChild(cell);
            }
        }
        
        function handleCellClick(cell, index) {
            if (ttt_board[index] !== '' || !ttt_gameActive) return;

            ttt_board[index] = ttt_currentPlayer === ttt_player1Name ? 'X' : 'O'; // Use X/O internally for logic
            cell.textContent = ttt_currentPlayer === ttt_player1Name ? '❌' : '⭕'; // Display emojis
            cell.classList.add('scale-up-center');

            const winCondition = checkWin();
            if (winCondition) {
                ttt_gameActive = false;
                // Apply win animation to winning cells
                const cells = document.querySelectorAll('#tictactoe-board button');
                winCondition.forEach(winIndex => {
                    cells[winIndex].classList.add('win-highlight');
                });

                // Delay showing modal to allow animation to play
                setTimeout(() => {
                    showModal('gameOver', {
                        title: `¡${ttt_currentPlayer} ha ganado!`,
                        message: `¡Felicidades, ${ttt_currentPlayer}! Eres el campeón del Tres en Raya.`,
                        restartCallback: () => { closeModal('gameOver'); resetTicTacToe(); },
                        game: 'tictactoe',
                        win: true // Indicate it's a win for special styling
                    });
                }, 1500); // 1.5 seconds to see the animation
                return;
            }
            if (ttt_board.every(cell => cell !== '')) {
                ttt_gameActive = false;
                showModal('gameOver', {
                    title: "¡Empate!",
                    message: "¡Nadie ganó esta vez! ¡Juega de nuevo para desempatar!",
                    restartCallback: () => { closeModal('gameOver'); resetTicTacToe(); },
                    game: 'tictactoe',
                    win: false // Not a win, so no special styling
                });
                return;
            }

            ttt_currentPlayer = ttt_currentPlayer === ttt_player1Name ? ttt_player2Name : ttt_player1Name;
            document.getElementById('tictactoe-status').textContent = `Turno de ${ttt_currentPlayer}`;
            
            if (ttt_gameMode === 'ai' && ttt_currentPlayer === ttt_player2Name && ttt_gameActive) {
                setTimeout(aiMove, 500);
            }
        }

        function checkWin() {
            const winConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let condition of winConditions) {
                const [a, b, c] = condition;
                if (ttt_board[a] && ttt_board[a] === ttt_board[b] && ttt_board[a] === ttt_board[c]) {
                    return condition; // Return the winning condition
                }
            }
            return null; // No win
        }

        function aiMove() {
            if (!ttt_gameActive) return;
            let move = -1;
            
            // Simple AI: find an empty spot
            const emptyCells = [];
            ttt_board.forEach((val, idx) => {
                if (val === '') emptyCells.push(idx);
            });
            
            if (emptyCells.length > 0) {
                 move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            }

            if (move !== -1) {
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
            }
        }
        
        // --- Memory Game Logic ---
        // Define different sets of emojis/symbols
        const memoryEmojiSets = {
            sports: ['⚽️', '🏀', '🏈', '⚾️', '🎾', '🏐', '🎱', '🏓'],
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼'],
            symbols: ['❤️', '⭐️', '⚡️', '🌈', '�', '💎', '💰', '🔑'],
            flags: ['🇪🇸', '🇫🇷', '🇩🇪', '🇮🇹', '🇬🇧', '🇺🇸', '🇯🇵', '🇨🇳']
        };
        let memoryEmojis = []; // This will hold the randomly selected set for the current game
        let currentMemoryEmojiSetKey = ''; // To store the key of the current emoji set

        let memoryCards;
        let flippedCards = [];
        let matchedPairs = 0; // Total matched pairs across all players
        let memoryAttempts; // Only for single player high score
        let memoryLockBoard = false;
        let memoryGameMode; // 'single' or 'multi'
        let memoryCurrentPlayer; // 1 or 2
        let memoryPlayer1MatchedPairs;
        let memoryPlayer2MatchedPairs;
        let memoryPlayer1Name;
        let memoryPlayer2Name;
        let memoryTimerInterval; // To store the setInterval ID for the timer
        let memoryTimeElapsed; // To store the elapsed time in seconds

        const memoryPlayerTurnDisplay = document.getElementById('memory-player-turn');
        const memoryHighscoreDisplay = document.getElementById('memory-highscore-display');
        const memoryHighscoreLabel = document.getElementById('memory-highscore-label');
        const memoryHighscoreValue = document.getElementById('memory-highscore-value');
        const memoryPlayer1MatchedDisplay = document.getElementById('memory-player1-matched');
        const memoryPlayer2MatchedDisplay = document.getElementById('memory-player2-matched');
        const memoryCurrentPlayerTurnDisplay = document.getElementById('memory-current-player-turn');
        const memoryAttemptsDisplay = document.getElementById('memory-attempts-display'); // Get the attempts display container
        const memoryTimerDisplay = document.getElementById('memory-timer-display'); // Get the timer display container
        const memoryTimerElement = document.getElementById('memory-timer'); // Get the span for the timer value
        const memoryBoardElement = document.getElementById('memory-board'); // Get the memory board element


        function startMemoryGame(mode, selectedPlayer = null) {
            memoryGameMode = mode;
            memoryAttempts = 0;
            matchedPairs = 0; // Reset total matched pairs
            memoryPlayer1MatchedPairs = 0;
            memoryPlayer2MatchedPairs = 0;
            memoryCurrentPlayer = 1; // Always start with Player 1
            document.getElementById('memory-attempts').textContent = 0;
            
            // Clear any existing timer
            stopMemoryTimer();

            // Hide all score/timer displays initially
            memoryPlayerTurnDisplay.classList.add('hidden');
            memoryHighscoreDisplay.classList.add('hidden');
            memoryAttemptsDisplay.classList.add('hidden'); // Hide attempts by default
            memoryTimerDisplay.classList.add('hidden'); // Hide timer by default

            // Randomly select an emoji set for this game
            const setKeys = Object.keys(memoryEmojiSets);
            currentMemoryEmojiSetKey = setKeys[Math.floor(Math.random() * setKeys.length)];
            memoryEmojis = memoryEmojiSets[currentMemoryEmojiSetKey];

            // Remove all previous theme classes from the board
            memoryBoardElement.classList.remove('memory-board-theme-sports', 'memory-board-theme-animals', 'memory-board-theme-symbols', 'memory-board-theme-flags');
            // Add the new theme class to the board
            memoryBoardElement.classList.add(`memory-board-theme-${currentMemoryEmojiSetKey}`);


            if (memoryGameMode === 'single') {
                memoryPlayer1Name = selectedPlayer;
                memoryPlayer2Name = null;
                const highscore = localStorage.getItem(`highscore_memory_${memoryPlayer1Name}`);
                console.log(`[Memocartas] Retrieving high score for ${memoryPlayer1Name}:`, highscore); // DEBUG
                
                memoryHighscoreLabel.textContent = `Mejor Tiempo (${memoryPlayer1Name}):`; // Label for time
                // Format stored time (seconds) into MM:SS for display
                memoryHighscoreValue.textContent = highscore !== null ? formatTime(parseInt(highscore)) : 'N/A';
                
                memoryHighscoreDisplay.classList.remove('hidden');
                memoryTimerDisplay.classList.remove('hidden'); // Show timer for single player
                
                memoryTimeElapsed = 0; // Reset timer
                memoryTimerElement.textContent = '00:00'; // Reset timer display
                // Timer will start after shuffle animation
            } else { // 'multi'
                memoryPlayer1Name = 'Hugo';
                memoryPlayer2Name = 'Saúl';
                memoryPlayerTurnDisplay.classList.remove('hidden');
                memoryAttemptsDisplay.classList.remove('hidden'); // Show attempts for multi-player
            }
            
            const cardValues = [...memoryEmojis, ...memoryEmojis];
            cardValues.sort(() => Math.random() - 0.5); // Shuffle
            
            const board = document.getElementById('memory-board');
            board.innerHTML = '';
            memoryCards = [];

            // Add a class to the board to indicate shuffling, potentially disable clicks
            board.classList.add('shuffling-in-progress'); // New class to manage state

            cardValues.forEach(value => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card aspect-square perspective is-shuffling'; // Add shuffling class
                cardElement.dataset.value = value;
                
                cardElement.innerHTML = `
                    <div class="card-inner relative w-full h-full">
                        <!-- La cara de la carta que está boca abajo inicialmente -->
                        <div class="card-face absolute w-full h-full bg-rose-400 rounded-lg flex items-center justify-center text-4xl shadow-md">
                            ⭐
                        </div>
                        <!-- La cara de la carta que se muestra al voltear -->
                        <div class="card-back absolute w-full h-full bg-white rounded-lg flex items-center justify-center text-4xl shadow-md">
                            ${value}
                        </div>
                    </div>
                `;
                
                board.appendChild(cardElement);
                memoryCards.push(cardElement);
                
                // DO NOT attach click listener immediately, wait for shuffle animation to finish
            });

            showScreen('memory-game');

            // Wait for the shuffling animation to complete before enabling clicks and starting the timer
            setTimeout(() => {
                board.classList.remove('shuffling-in-progress'); // Remove the shuffling class
                memoryCards.forEach(card => {
                    card.classList.remove('is-shuffling'); // Remove animation class
                    card.addEventListener('click', () => flipCard(card)); // Attach click listener
                });
                if (memoryGameMode === 'single') {
                    startMemoryTimer(); // Start timer only after animation
                }
            }, 1200); // Match this with the CSS animation duration
        }

        function startMemoryTimer() {
            memoryTimerInterval = setInterval(() => {
                memoryTimeElapsed++;
                memoryTimerElement.textContent = formatTime(memoryTimeElapsed);
            }, 1000);
        }

        function stopMemoryTimer() {
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }
        
        function flipCard(card) {
            if (memoryLockBoard || card.classList.contains('is-flipped') || flippedCards.length === 2) {
                return;
            }

            card.classList.add('is-flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                memoryLockBoard = true;
                // Only increment attempts in single-player mode for high score tracking
                if (memoryGameMode === 'single') {
                    // Attempts are not used for single-player high score anymore, but can still be counted
                    // if needed for display. For now, we'll keep it simple and only use time for single player HS.
                } else { // Multi-player still uses attempts
                    memoryAttempts++;
                    document.getElementById('memory-attempts').textContent = memoryAttempts;
                    console.log("[Memocartas] Attempts incremented:", memoryAttempts); // DEBUG
                }
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [cardOne, cardTwo] = flippedCards;
            const isMatch = cardOne.dataset.value === cardTwo.dataset.value;

            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            flippedCards.forEach(card => {
                card.removeEventListener('click', flipCard);
                card.classList.add('is-matched'); // Add animation class
            });
            matchedPairs++; // Increment total matched pairs

            if (memoryGameMode === 'multi') {
                if (memoryCurrentPlayer === 1) memoryPlayer1MatchedPairs++;
                else memoryPlayer2MatchedPairs++;
                memoryCurrentPlayerTurnDisplay.textContent = `Turno de ${memoryCurrentPlayer === 1 ? memoryPlayer1Name : memoryPlayer2Name}`;
                memoryPlayer1MatchedDisplay.textContent = memoryPlayer1MatchedPairs;
                memoryPlayer2MatchedDisplay.textContent = memoryPlayer2MatchedPairs;
            }

            resetTurn();
            if (matchedPairs === memoryEmojis.length) { // Check against total unique emojis
                endMemoryGame();
            }
        }

        function unflipCards() {
            setTimeout(() => {
                flippedCards.forEach(card => card.classList.remove('is-flipped'));
                if (memoryGameMode === 'multi') {
                    memoryCurrentPlayer = memoryCurrentPlayer === 1 ? 2 : 1; // Switch player
                    memoryCurrentPlayerTurnDisplay.textContent = `Turno de ${memoryCurrentPlayer === 1 ? memoryPlayer1Name : memoryPlayer2Name}`;
                }
                resetTurn();
            }, 1000);
        }

        function resetTurn() {
            flippedCards = [];
            memoryLockBoard = false;
        }

        function endMemoryGame() {
            stopMemoryTimer(); // Stop the timer when the game ends
            let finalMessage = "";
            let restartCallback = () => { closeModal('gameOver'); startMemoryGame(memoryGameMode, memoryPlayer1Name); };

            if (memoryGameMode === 'single') {
                saveMemoryHighScore(memoryPlayer1Name, memoryTimeElapsed, true); // Save time as high score
                finalMessage = `¡${memoryPlayer1Name}, completaste el juego en ${formatTime(memoryTimeElapsed)}! ¡Qué memoria!`;
            } else {
                if (memoryPlayer1MatchedPairs > memoryPlayer2MatchedPairs) {
                    finalMessage = `¡Felicidades ${memoryPlayer1Name}! Ganaste con ${memoryPlayer1MatchedPairs} parejas contra ${memoryPlayer2MatchedPairs}.`;
                } else if (memoryPlayer2MatchedPairs > memoryPlayer1MatchedPairs) {
                    finalMessage = `¡Felicidades ${memoryPlayer2Name}! Ganaste con ${memory2MatchedPairs} parejas contra ${memory1MatchedPairs}.`;
                } else {
                    finalMessage = `¡Es un empate! Ambos jugadores encontraron ${memory1MatchedPairs} parejas.`;
                }
            }

            showModal('gameOver', {
                title: "¡Juego Terminado!",
                message: finalMessage,
                restartCallback: restartCallback,
                game: 'memory'
            });
        }

        // --- Guess the Number Game Logic ---
        let guessNumberSecret;
        let guessNumberAttempts;
        let guessNumberPlayerName;
        let guessNumberGameActive;

        const guessNumberInput = document.getElementById('guess-number-input');
        const guessNumberFeedback = document.getElementById('guess-number-feedback');
        const guessNumberAttemptsDisplay = document.getElementById('guess-number-attempts');
        const guessNumberHighscoreValue = document.getElementById('guess-number-highscore-value');

        function startGameGuessNumber(mode, selectedPlayer) {
            // For now, only single player is supported for this game
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Adivina el Número.");
                return;
            }
            guessNumberPlayerName = selectedPlayer;
            resetGuessNumberGame();
            showScreen('guess-number-game');
        }

        function resetGuessNumberGame() {
            guessNumberSecret = Math.floor(Math.random() * 100) + 1; // Number between 1 and 100
            guessNumberAttempts = 0;
            guessNumberGameActive = true;

            guessNumberInput.value = '';
            guessNumberFeedback.textContent = '';
            guessNumberAttemptsDisplay.textContent = guessNumberAttempts;
            guessNumberInput.disabled = false;
            
            // Load and display high score
            const highscore = localStorage.getItem(`highscore_guess_number_${guessNumberPlayerName}`);
            guessNumberHighscoreValue.textContent = highscore !== null ? highscore : 'N/A';
            console.log(`[Adivina el Número] Nuevo juego iniciado. Número secreto: ${guessNumberSecret}`); // For debugging
        }

        function checkGuess() {
            if (!guessNumberGameActive) return;

            const guess = parseInt(guessNumberInput.value);

            if (isNaN(guess) || guess < 1 || guess > 100) {
                guessNumberFeedback.textContent = "Por favor, introduce un número entre 1 y 100.";
                guessNumberFeedback.style.color = '#EF4444'; /* red-500 */
                return;
            }

            guessNumberAttempts++;
            guessNumberAttemptsDisplay.textContent = guessNumberAttempts;

            if (guess === guessNumberSecret) {
                guessNumberFeedback.textContent = `¡Correcto! Adivinaste el número ${guessNumberSecret}.`;
                guessNumberFeedback.style.color = '#10B981'; /* emerald-600 */
                guessNumberGameActive = false;
                saveGuessNumberHighScore(guessNumberPlayerName, guessNumberAttempts);
                setTimeout(() => {
                    showModal('gameOver', {
                        title: "¡Has ganado!",
                        message: `¡Felicidades ${guessNumberPlayerName}! Adivinaste el número ${guessNumberSecret} en ${guessNumberAttempts} intentos.`,
                        restartCallback: () => { closeModal('gameOver'); resetGuessNumberGame(); },
                        game: 'guess-number',
                        win: true
                    });
                }, 1000);
            } else if (guess < guessNumberSecret) {
                guessNumberFeedback.textContent = "¡Más alto!";
                guessNumberFeedback.style.color = '#FBBF24'; /* amber-500 */
            } else {
                guessNumberFeedback.textContent = "¡Más bajo!";
                guessNumberFeedback.style.color = '#FBBF24'; /* amber-500 */
            }

            guessNumberInput.value = ''; // Clear input for next guess
        }

        function saveGuessNumberHighScore(playerName, attempts) {
            const key = `highscore_guess_number_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '999'); // Lower attempts is better
            console.log(`[Adivina el Número] Guardando puntuación alta para ${playerName}. Intentos: ${attempts}, Mejor actual: ${currentHighScore}`);
            if (attempts < currentHighScore) {
                localStorage.setItem(key, attempts);
                console.log(`[Adivina el Número] Nueva puntuación alta guardada: ${attempts} para ${playerName}`);
            } else {
                console.log(`[Adivina el Número] No hay nueva puntuación alta para ${playerName}. Intentos: ${attempts}, Mejor actual: ${currentHighScore}`);
            }
        }

        // --- Simon Says Game Logic ---
        const simonColors = ['red', 'green', 'blue', 'yellow'];
        let simonSequence = [];
        let playerSequence = [];
        let simonLevel = 0;
        let simonGameActive = false;
        let simonPlayerName;
        let simonButtonDelay = 800; // Initial delay for sequence playback
        let simonPlaybackIndex = 0; // To track current position in sequence playback

        const simonFeedback = document.getElementById('simon-feedback');
        const simonLevelDisplay = document.getElementById('simon-level');
        const simonHighscoreValue = document.getElementById('simon-highscore-value');
        const simonStartButton = document.getElementById('simon-start-button');
        const simonButtons = {
            red: document.getElementById('simon-red'),
            green: document.getElementById('simon-green'),
            blue: document.getElementById('simon-blue'),
            yellow: document.getElementById('simon-yellow')
        };

        // Add event listeners to Simon buttons
        Object.values(simonButtons).forEach(button => {
            button.addEventListener('click', (event) => handleSimonButtonClick(event.target.id.replace('simon-', '')));
        });

        function startSimonGame(mode, selectedPlayer) {
            // For now, only single player is supported for this game
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Simon Dice.");
                return;
            }
            simonPlayerName = selectedPlayer;
            resetSimonGame();
            showScreen('simon-game');
        }

        function resetSimonGame() {
            simonSequence = [];
            playerSequence = [];
            simonLevel = 0;
            simonGameActive = false;
            simonButtonDelay = 800; // Reset speed
            simonPlaybackIndex = 0;

            simonLevelDisplay.textContent = simonLevel;
            simonFeedback.textContent = '¡Pulsa "Empezar" para jugar!';
            simonFeedback.style.color = 'inherit'; // Reset color
            simonStartButton.disabled = false; // Enable start button
            enableSimonButtons(false); // Disable game buttons initially

            // Load and display high score
            const highscore = localStorage.getItem(`highscore_simon_${simonPlayerName}`);
            simonHighscoreValue.textContent = highscore !== null ? highscore : 'N/A';
            console.log(`[Simon Dice] Juego reiniciado para ${simonPlayerName}.`);
        }

        // New function to start a round (generate and then play)
        function startSimonRound() {
            simonStartButton.disabled = true; // Disable start button once game starts
            generateSimonSequence(); // Generate the first sequence
            playSimonSequence(); // Play the generated sequence
        }

        function generateSimonSequence() {
            const randomColor = simonColors[Math.floor(Math.random() * simonColors.length)];
            simonSequence.push(randomColor);
            simonLevel++;
            simonLevelDisplay.textContent = simonLevel;
            playerSequence = []; // Reset player's input for new round
            simonFeedback.textContent = '¡Mira y recuerda!';
            simonFeedback.style.color = 'inherit';
            enableSimonButtons(false); // Disable player input during playback

            // Adjust speed based on level
            if (simonLevel > 4) simonButtonDelay = 600;
            if (simonLevel > 8) simonButtonDelay = 400;
            if (simonLevel > 12) simonButtonDelay = 300;
        }

        function playSimonSequence() {
            if (simonPlaybackIndex < simonSequence.length) {
                const colorToHighlight = simonSequence[simonPlaybackIndex];
                const button = simonButtons[colorToHighlight];

                button.classList.add('highlight');
                // Play sound if implemented here

                setTimeout(() => {
                    button.classList.remove('highlight');
                    simonPlaybackIndex++;
                    setTimeout(playSimonSequence, 100); // Small delay between highlights
                }, simonButtonDelay);
            } else {
                // Sequence playback finished, enable player input
                simonPlaybackIndex = 0; // Reset for next playback
                simonFeedback.textContent = '¡Tu turno!';
                simonFeedback.style.color = '#1E40AF'; /* blue-800 */
                enableSimonButtons(true);
                simonGameActive = true;
            }
        }

        function handleSimonButtonClick(color) {
            if (!simonGameActive) return;

            playerSequence.push(color);
            const button = simonButtons[color];
            button.classList.add('highlight'); // Visual feedback for player click

            setTimeout(() => {
                button.classList.remove('highlight');
            }, 150); // Short highlight for player click

            checkSimonSequence();
        }

        function checkSimonSequence() {
            const lastIndex = playerSequence.length - 1;
            if (playerSequence[lastIndex] !== simonSequence[lastIndex]) {
                // Game Over
                simonGameActive = false;
                enableSimonButtons(false);
                saveSimonHighScore(simonPlayerName, simonLevel - 1); // Save previous level as score
                
                showModal('gameOver', {
                    title: "¡Juego Terminado!",
                    message: `¡Oh no, ${simonPlayerName}! Llegaste al Nivel ${simonLevel - 1}. ¡Inténtalo de nuevo para mejorar tu memoria!`,
                    restartCallback: () => { closeModal('gameOver'); resetSimonGame(); },
                    game: 'simon',
                    win: false // Indicate it's a loss
                });
                return;
            }

            if (playerSequence.length === simonSequence.length) {
                // Round completed successfully
                simonGameActive = false;
                enableSimonButtons(false);
                simonFeedback.textContent = '¡Genial! Preparando siguiente nivel...';
                simonFeedback.style.color = '#10B981'; /* emerald-600 */
                setTimeout(() => {
                    generateSimonSequence();
                    playSimonSequence();
                }, 1000); // Short pause before next round
            }
        }

        function enableSimonButtons(enable) {
            Object.values(simonButtons).forEach(button => {
                button.disabled = !enable;
            });
        }

        function saveSimonHighScore(playerName, score) {
            const key = `highscore_simon_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '0');
            console.log(`[Simon Dice] Saving high score for ${playerName}. New score: ${score}, Current best: ${currentHighScore}`);
            if (score > currentHighScore) {
                localStorage.setItem(key, score);
                console.log(`[Simon Dice] New high score saved: ${score} for ${playerName}`);
            } else {
                console.log(`[Simon Dice] No new high score for ${playerName}. Score: ${score}, Current best: ${currentHighScore}`);
            }
        }

        // --- Paint by Number Game Logic ---
        const paintPatterns = [
            {
                name: "Corazón",
                colors: {
                    1: '#EF4444', // Red
                    0: '#f3f4f6' // Background (gray-100)
                },
                grid: [
                    [0, 1, 1, 0, 1, 1, 0],
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1],
                    [0, 1, 1, 1, 1, 1, 0],
                    [0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 1, 0, 0, 0]
                ]
            },
            {
                name: "Estrella",
                colors: {
                    1: '#F59E0B', // Amber
                    0: '#f3f4f6'
                },
                grid: [
                    [0, 0, 1, 0, 0],
                    [0, 1, 1, 1, 0],
                    [1, 1, 1, 1, 1],
                    [0, 1, 0, 1, 0],
                    [1, 0, 0, 0, 1]
                ]
            },
            {
                name: "Casa",
                colors: {
                    1: '#92400E', // Amber-800 (Techo)
                    2: '#FDBA74', // Orange-300 (Paredes)
                    3: '#A16207', // Amber-700 (Puerta)
                    0: '#f3f4f6'
                },
                grid: [
                    [0, 0, 1, 0, 0],
                    [0, 1, 1, 1, 0],
                    [1, 2, 2, 2, 1],
                    [1, 2, 3, 2, 1],
                    [1, 2, 2, 2, 1]
                ]
            },
            {
                name: "Flor",
                colors: {
                    1: '#FBBF24', // Amarillo (Centro)
                    2: '#34D399', // Verde (Tallo)
                    3: '#60A5FA', // Azul claro (Pétalo 1)
                    4: '#F87171', // Rojo claro (Pétalo 2)
                    5: '#A78BFA', // Púrpura (Pétalo 3)
                    6: '#FCD34D', // Amarillo claro (Pétalo 4)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 3, 0, 0],
                    [0, 3, 1, 4, 0],
                    [3, 1, 1, 1, 4],
                    [0, 5, 1, 6, 0],
                    [0, 0, 5, 0, 0],
                    [0, 0, 2, 0, 0],
                    [0, 0, 2, 0, 0]
                ]
            },
            {
                name: "Manzana",
                colors: {
                    1: '#DC2626', // Rojo oscuro
                    2: '#16A34A', // Verde oscuro (Hoja)
                    3: '#7C2D12', // Marrón (Tallo)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 1, 1, 0, 0],
                    [0, 1, 1, 1, 1, 0],
                    [1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1],
                    [0, 1, 1, 1, 1, 0],
                    [0, 0, 3, 2, 0, 0]
                ]
            },
            {
                name: "Coche",
                colors: {
                    1: '#3B82F6', // Azul (Carrocería)
                    2: '#1F2937', // Gris oscuro (Ruedas)
                    3: '#9CA3AF', // Gris claro (Ventanas)
                    4: '#FCD34D', // Amarillo (Faros)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 0, 1, 1, 0, 0, 0],
                    [0, 0, 1, 1, 1, 1, 1, 0],
                    [0, 1, 1, 3, 3, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1, 4],
                    [1, 1, 1, 1, 1, 1, 1, 1],
                    [0, 2, 2, 0, 0, 2, 2, 0]
                ]
            },
            {
                name: "Sol",
                colors: {
                    1: '#FBBF24', // Amarillo (Centro)
                    2: '#F59E0B', // Naranja (Rayos)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 2, 0, 0],
                    [2, 1, 1, 1, 2],
                    [0, 1, 1, 1, 0],
                    [2, 1, 1, 1, 2],
                    [0, 0, 2, 0, 0]
                ]
            }
        ];

        let paintByNumberCurrentPattern;
        let paintByNumberPlayerName;
        let paintByNumberPaintedCells; // Keep track of painted cells
        let paintByNumberTotalCellsToPaint;
        let paintByNumberCurrentSelectedColor = null;
        let paintByNumberCurrentSelectedNumber = null;
        let paintByNumberStartTime;
        let paintByNumberTimerInterval;

        const paintGridContainer = document.getElementById('paint-grid-container');
        const colorPalette = document.getElementById('color-palette');
        const paintByNumberProgressDisplay = document.getElementById('paint-by-number-progress');
        // Removed paintByNumberHighscoreValue as its display element is removed
        // const paintByNumberHighscoreValue = document.getElementById('paint-by-number-highscore-value');

        function startPaintByNumberGame(mode, selectedPlayer) {
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Pintar por Números.");
                return;
            }
            paintByNumberPlayerName = selectedPlayer;
            resetPaintByNumberGame();
            showScreen('paint-by-number-game');
        }

        function resetPaintByNumberGame() {
            // Randomly select a pattern
            paintByNumberCurrentPattern = paintPatterns[Math.floor(Math.random() * paintPatterns.length)];
            
            paintByNumberPaintedCells = 0;
            paintByNumberTotalCellsToPaint = 0;
            paintByNumberCurrentSelectedColor = null;
            paintByNumberCurrentSelectedNumber = null;
            
            paintByNumberProgressDisplay.textContent = '0%';
            
            stopPaintByNumberTimer(); // Ensure timer is stopped on reset
            // Removed the line trying to update paintByNumberHighscoreValue.textContent
            // paintByNumberHighscoreValue.textContent = localStorage.getItem(`highscore_paint_by_number_${paintByNumberPlayerName}`) || 'N/A';

            renderPaintGrid();
            renderColorPalette();
            
            // Start timer only after grid and palette are rendered
            paintByNumberStartTime = Date.now();
            paintByNumberTimerInterval = setInterval(updatePaintByNumberTimer, 1000);
        }

        function renderPaintGrid() {
            paintGridContainer.innerHTML = '';
            paintGridContainer.style.gridTemplateColumns = `repeat(${paintByNumberCurrentPattern.grid[0].length}, 1fr)`;
            paintByNumberTotalCellsToPaint = 0;

            paintByNumberCurrentPattern.grid.forEach((row, rowIndex) => {
                row.forEach((cellValue, colIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'paint-grid-cell';
                    cell.textContent = cellValue !== 0 ? cellValue : ''; // Show number for non-background cells
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = colIndex;
                    cell.dataset.originalValue = cellValue; // Store original value for checking
                    cell.dataset.painted = 'false'; // Track if cell is painted

                    // If it's a background cell (0), it's considered "painted" for progress calculation
                    if (cellValue === 0) {
                        cell.classList.add('painted');
                        cell.style.backgroundColor = paintByNumberCurrentPattern.colors[0];
                        cell.textContent = ''; // Hide '0'
                        paintByNumberPaintedCells++; // Count background cells as painted
                    } else {
                        paintByNumberTotalCellsToPaint++; // Only count non-background cells for painting
                        cell.addEventListener('click', () => handlePaintGridCellClick(cell, rowIndex, colIndex));
                    }
                    paintGridContainer.appendChild(cell);
                });
            });
            updatePaintByNumberProgress(); // Initial progress update
        }

        function renderColorPalette() {
            colorPalette.innerHTML = '';
            const numbersUsed = [...new Set(paintByNumberCurrentPattern.grid.flat().filter(num => num !== 0))]; // Get unique numbers, excluding 0
            
            numbersUsed.sort((a, b) => a - b); // Sort numbers numerically

            numbersUsed.forEach(number => {
                const color = paintByNumberCurrentPattern.colors[number];
                const button = document.createElement('button');
                button.className = 'color-palette-button';
                button.style.backgroundColor = color;
                button.textContent = number;
                button.dataset.number = number;
                button.dataset.color = color;
                button.addEventListener('click', () => selectPaintColor(button, number, color));
                colorPalette.appendChild(button);
            });
        }

        function selectPaintColor(button, number, color) {
            // Remove 'selected' class from all buttons
            document.querySelectorAll('.color-palette-button').forEach(btn => btn.classList.remove('selected'));
            // Add 'selected' class to the clicked button
            button.classList.add('selected');
            
            paintByNumberCurrentSelectedColor = color;
            paintByNumberCurrentSelectedNumber = number;
            console.log(`[Pintar por Números] Color seleccionado: ${color} (Número: ${number})`);
        }

        function handlePaintGridCellClick(cell, row, col) {
            if (!paintByNumberCurrentSelectedColor || cell.dataset.painted === 'true') {
                // console.log("[Pintar por Números] No hay color seleccionado o celda ya pintada.");
                return;
            }

            const originalValue = parseInt(cell.dataset.originalValue);
            if (originalValue === paintByNumberCurrentSelectedNumber) {
                cell.style.backgroundColor = paintByNumberCurrentSelectedColor;
                cell.classList.add('painted');
                cell.textContent = ''; // Hide the number
                cell.dataset.painted = 'true';
                paintByNumberPaintedCells++;
                updatePaintByNumberProgress();
            } else {
                // Optional: visual feedback for incorrect guess
                cell.style.backgroundColor = '#EF4444'; // Flash red
                setTimeout(() => {
                    cell.style.backgroundColor = '#f3f4f6'; // Revert to original unpainted color
                }, 200);
                console.log(`[Pintar por Números] Intento incorrecto en [${row},${col}]. Esperado: ${originalValue}, Seleccionado: ${paintByNumberCurrentSelectedNumber}`);
            }
        }

        function updatePaintByNumberProgress() {
            // Calculate total cells in the grid, including background cells (0)
            const totalCellsInGrid = paintByNumberCurrentPattern.grid.length * paintByNumberCurrentPattern.grid[0].length;
            const progressPercentage = Math.floor((paintByNumberPaintedCells / totalCellsInGrid) * 100);
            paintByNumberProgressDisplay.textContent = `${progressPercentage}%`;

            if (progressPercentage === 100) {
                endPaintByNumberGame();
            }
        }

        function updatePaintByNumberTimer() {
            const elapsedTime = Math.floor((Date.now() - paintByNumberStartTime) / 1000);
            // No direct timer display on screen, but used for high score
            // console.log(`[Pintar por Números] Tiempo transcurrido: ${elapsedTime} segundos`);
        }

        function endPaintByNumberGame() {
            stopPaintByNumberTimer();
            const finalTimeSeconds = Math.floor((Date.now() - paintByNumberStartTime) / 1000);
            savePaintByNumberHighScore(paintByNumberPlayerName, finalTimeSeconds);

            // Highlight all painted cells
            const allCells = document.querySelectorAll('#paint-grid-container .paint-grid-cell');
            allCells.forEach(cell => {
                if (cell.dataset.painted === 'true') {
                    cell.classList.add('highlight-completed');
                }
            });

            // Add a delay before showing the modal, accounting for the highlight animation
            setTimeout(() => {
                showModal('gameOver', {
                    title: "¡Imagen Completada!",
                    message: `¡Felicidades ${paintByNumberPlayerName}! Completaste el dibujo "${paintByNumberCurrentPattern.name}" en ${formatTime(finalTimeSeconds)}.`,
                    restartCallback: () => { closeModal('gameOver'); resetPaintByNumberGame(); },
                    game: 'paint-by-number',
                    win: true
                });
                // Optional: Remove highlight class after modal is shown or game is reset
                allCells.forEach(cell => {
                    cell.classList.remove('highlight-completed');
                });
            }, 2500); // 2 seconds initial delay + 0.5 seconds animation = 2.5 seconds total
        }

        function savePaintByNumberHighScore(playerName, timeInSeconds) {
            const key = `highscore_paint_by_number_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '999999'); // Lower time is better
            console.log(`[Pintar por Números] Guardando puntuación alta para ${playerName}. Tiempo: ${timeInSeconds}, Mejor actual: ${currentHighScore}`);
            if (timeInSeconds < currentHighScore) {
                localStorage.setItem(key, timeInSeconds);
                console.log(`[Pintar por Números] Nueva puntuación alta guardada: ${timeInSeconds} para ${playerName}`);
            } else {
                console.log(`[Pintar por Números] No hay nueva puntuación alta para ${playerName}. Tiempo: ${timeInSeconds}, Mejor actual: ${currentHighScore}`);
            }
        }

        function stopPaintByNumberTimer() {
            if (paintByNumberTimerInterval) {
                clearInterval(paintByNumberTimerInterval);
                paintByNumberTimerInterval = null;
            }
        }

        // Initial load
        window.onload = () => {
            showScreen('main-menu');
        };
    </script>
</body>
</html>
