<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuSa Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Ensure UTF-8 encoding for proper character display */
        @charset "UTF-8";

        /* Lista de URLs de portadas disponibles:
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada1.png
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada2.png
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada3.png
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada4.png
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada5.png
         * https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada6.png
         */
        body {
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* Base amber-100 color - this will be overwritten by JS for random image */
            background-color: #FEF3C7; 
            overflow: hidden; /* Hide overflow from animations */
            position: relative; /* For pseudo-element positioning */
            /* New styles for background image */
            background-size: cover; /* Cover the entire viewport */
            background-position: center center; /* Center the image */
            background-repeat: no-repeat; /* Do not repeat the image */
            background-attachment: fixed; /* Keep background fixed when scrolling */
            transition: background-image 1s ease-in-out; /* Smooth transition for background image change */
        }

        h1, h2, h3, .font-display {
            font-family: 'Fredoka One', cursive;
        }
        .card {
            perspective: 1000px; /* Added for 3D flip effect */
        }
        .card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            z-index: 2; /* Ensures this face (star) is on top initially */
        }
        .card-back {
            transform: rotateY(180deg);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            z-index: 1; /* Ensures this face (emoji) is behind initially */
        }
        .btn-game {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, filter 0.2s ease-out; /* Added filter to transition */
        }
        .btn-game:hover {
            transform: translateY(-8px) scale(1.02); /* More pronounced bounce and slight scale */
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15), 0 5px 8px -3px rgba(0, 0, 0, 0.08); /* Larger shadow */
        }
        .btn-game:active {
            transform: translateY(0px) scale(0.95); /* More pronounced press */
            box-shadow: 0 2px 5px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.05); /* Reduced shadow for pressed look */
            filter: brightness(0.85); /* Slightly darker */
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .scale-up-center {
            animation: scale-up-center 0.4s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;
        }
        @keyframes scale-up-center {
            0% { transform: scale(0.5); }
            100% { transform: scale(1); }
        }

        /* New animation for Tic-Tac-Toe pieces */
        @keyframes piece-pop {
            0% {
                transform: scale(0.4);
                opacity: 0.5;
            }
            80% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
            }
        }
        .piece-pop-in {
            animation: piece-pop 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }

        /* New styles for confetti celebration */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999; /* Ensure it's on top */
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #f59e0b; /* amber-500 */
            top: -20px; /* Start above the screen */
            opacity: 0;
            animation: fall 4s linear forwards;
        }
        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* New animation for matched cards */
        .card.is-matched {
            animation: card-pop 0.3s ease-out;
        }
        @keyframes card-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Themed backgrounds for app-container */
        .bg-trivia-theme {
            background-color: #ECFDF5; /* emerald-50, very light green */
            transition: background-color 0.3s ease-in-out; /* Smooth transition for background color */
        }
        .bg-tictactoe-theme {
            background-color: #EFF6FF; /* sky-50, very light blue */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-memory-theme {
            background-color: #FFF1F2; /* rose-50, very light red */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-guess-number-theme {
            background-color: #F0FDF4; /* green-50, very light green */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-simon-theme {
            background-color: #FDF2F8; /* pink-50, very light pink */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-paint-by-number-theme {
            background-color: #FDF6F0; /* orange-50, very light orange */
            transition: background-color 0.3s ease-in-out;
        }
        .bg-retos-theme { /* New theme for Retos */
            background-color: #EEF2FF; /* indigo-50, very light indigo */
            transition: background-color 0.3s ease-in-out;
        }

        /* New styles for Trivia answer feedback */
        /* Animación shake para feedback de error en Adivina el Número */
        .shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-2px); }
            20%, 80% { transform: translateX(4px); }
            30%, 50%, 70% { transform: translateX(-8px); }
            40%, 60% { transform: translateX(8px); }
        }
        .trivia-answer-button.correct {
            background-color: #34D399; /* emerald-500 */
            color: white;
            box-shadow: 0 0 15px #34D399; /* Green glow */
            transform: scale(1.02);
            transition: all 0.3s ease-out;
        }
        .trivia-answer-button.incorrect {
            background-color: #EF4444; /* red-500 */
            color: white;
            opacity: 0.6;
            transform: scale(0.98);
            transition: all 0.3s ease-out;
        }
        .trivia-answer-button.disabled {
            pointer-events: none; /* Disable clicks during feedback */
        }

        /* Estilos para el termómetro de Adivina el Número */
        .thermometer {
            width: 40px;
            height: 200px;
            background: #f3f4f6;
            border-radius: 20px;
            position: relative;
            margin: 20px auto;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .thermometer-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #ef4444, #f59e0b, #22c55e);
            transition: height 0.5s ease, background-color 0.5s ease;
            border-radius: 20px;
        }

        .thermometer::before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #f3f4f6;
            border-radius: 50%;
        }

        /* Estilos para las flechas animadas */
        .guess-arrow {
            font-size: 2.5rem;
            animation: bounce 1s infinite;
            display: inline-block;
            margin: 0 10px;
            color: #f59e0b;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Estilos para el indicador de proximidad */
        .proximity-indicator {
            height: 10px;
            background: linear-gradient(to right, #ef4444, #f59e0b, #22c55e);
            border-radius: 5px;
            margin: 10px 0;
            position: relative;
        }

        .proximity-marker {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #1f2937;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.5s ease;
        }

        .proximity-pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Estilos para el código de colores de distancia */
        .distance-very-close { color: #22c55e; } /* Verde */
        .distance-close { color: #f59e0b; } /* Amarillo */
        .distance-far { color: #ef4444; } /* Rojo */

        /* New styles for Tic-Tac-Toe win animation */
        .win-highlight {
            animation: pulse-glow 1s infinite alternate; /* Pulse and glow animation */
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0px #34D399; /* No glow */
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px #34D399, 0 0 30px #34D399; /* Strong glow */
                transform: scale(1.05); /* Slight pulse */
            }
            100% {
                box-shadow: 0 0 0px #34D399; /* No glow */
                transform: scale(1);
            }
        }

        /* New styles for Memory card shuffling animation */
        .card.is-shuffling {
            animation: shuffle-card 1.2s ease-out forwards;
            opacity: 0; /* Start invisible */
        }

        @keyframes shuffle-card {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(0.8);
                opacity: 0;
            }
            25% {
                transform: translate(10px, -5px) rotate(5deg) scale(0.9);
                opacity: 0.5;
            }
            50% {
                transform: translate(-10px, 5px) rotate(-5deg) scale(1.05);
                opacity: 1;
            }
            75% {
                transform: translate(5px, -10px) rotate(3deg) scale(0.95);
                opacity: 0.7;
            }
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        /* New animations for Trivia game over */
        .win-animation {
            animation: win-celebrate 1.5s ease-out forwards;
        }

        @keyframes win-celebrate {
            0% {
                transform: scale(0.8);
                opacity: 0;
                color: #34D399; /* emerald-500 */
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
                color: #10B981; /* darker emerald */
                text-shadow: 0 0 15px #34D399;
            }
            100% {
                transform: scale(1);
                opacity: 1;
                color: #34D399;
                text-shadow: none;
            }
        }

        .lose-animation {
            animation: lose-shake 0.8s ease-in-out forwards;
            color: #EF4444; /* red-500 */
        }

        @keyframes lose-shake {
            0% { transform: translateX(0); opacity: 1; }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
            100% { transform: translateX(0); opacity: 0.7; }
        }

        .tie-animation {
            animation: tie-pulse 1s infinite alternate;
            color: #FBBF24; /* amber-500 */
        }

        @keyframes tie-pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.05); opacity: 0.9; }
        }

        /* New styles for Memory board themes */
        .memory-board-theme-sports {
            background-color: #D1FAE5; /* emerald-100 */
            border-radius: 1rem; /* Rounded corners for the board */
            padding: 0.5rem; /* Little padding inside */
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-animals {
            background-color: #FEFCE8; /* yellow-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-symbols {
            background-color: #FEE2E2; /* red-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-flags {
            background-color: #E0F2FE; /* blue-100 */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-food { /* New theme style */
            background-color: #FDF6E3; /* Orange-50, very light orange */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }
        .memory-board-theme-space { /* New theme style */
            background-color: #EEF2FF; /* Indigo-50, very light indigo */
            border-radius: 1rem;
            padding: 0.5rem;
            transition: background-color 0.3s ease-in-out;
        }

        /* Simon Says specific styles */
        .simon-button {
            width: 100%;
            height: 100%;
            border-radius: 1rem; /* Rounded corners */
            transition: background-color 0.2s ease-out, transform 0.1s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .simon-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .simon-button.highlight {
            filter: brightness(1.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        /* Specific colors for Simon buttons */
        .simon-red { background-color: #EF4444; } /* Red */
        .simon-green { background-color: #22C55E; } /* Green */
        .simon-blue { background-color: #3B82F6; } /* Blue */
        .simon-yellow { background-color: #F59E0B; } /* Yellow */

        .simon-red.highlight { background-color: #F87171; }
        .simon-green.highlight { background-color: #4ADE80; }
        .simon-blue.highlight { background-color: #60A5FA; }
        .simon-yellow.highlight { background-color: #FCD34D; }

        /* Paint by Number specific styles */
        .paint-grid-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: #f3f4f6; /* gray-100 */
            transition: background-color 0.1s ease-out;
            cursor: pointer;
        }
        .paint-grid-cell.painted {
            border: 1px solid rgba(0,0,0,0.2);
            color: transparent; /* Hide number when painted */
        }
        .color-palette-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px; /* full rounded */
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-palette-button.selected {
            border-color: #3B82F6; /* blue-500 */
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); /* blue-500 with transparency */
        }

        /* New animation for completed paint cells */
        @keyframes paint-cell-flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.3); } /* Brighter flash */
            100% { filter: brightness(1); }
        }
        .paint-grid-cell.highlight-completed {
            animation: paint-cell-flash 0.5s ease-out forwards; /* Quick flash */
        }
        /* Style for SVG icons */
        .game-icon {
            width: 2.5rem; /* Equivalent to text-4xl for visual size */
        }

        /* Animación shake para feedback de error en Adivina el Número */
        /* ...existing code... */
    </style>
</head>
<body class="bg-amber-100 text-slate-800 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-2xl overflow-y-auto max-h-[90vh]">
        
        <!-- Main Menu Screen -->
        <div id="main-menu" class="p-6 md:p-8 flex flex-col">
            <div class="flex-none">
                <h1 class="text-5xl md:text-6xl text-center font-display text-amber-600 drop-shadow-lg">HuSa Games</h1>
                <p class="text-center text-slate-600 mt-2 mb-8">Los Juegos de Hugo y Saúl</p>
            </div>
            
            <div class="space-y-4 overflow-y-auto pr-2 flex-grow">
                <button onclick="showScreen('trivia-menu')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.44 12.9 13 13.5 13 14h-2v-.5c0-1.1.45-2.2 1.17-2.92l.9-.92C13.44 9.4 14 8.7 14 8c0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.5-.78 2.79-2.07 3.5z"/>
                    </svg>
                    Preguntas y Respuestas
                </button>
                <button onclick="showScreen('tictactoe-menu')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM11 19H5v-6h6v6zm0-8H5V5h6v6zm8 8h-6v-6h6v6zm0-8h-6V5h6v6z"/>
                    </svg>
                    Tres en Raya
                </button>
                <button onclick="showScreen('memory-menu')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H4c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-7-2h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
                    </svg>
                    Memocartas
                </button>
                <button onclick="showScreen('guess-number-menu')" class="btn-game w-full bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM10 8H9v2H7v1h2v2h1v-2h2v-1h-2V8z"/>
                    </svg>
                    Adivina el Número
                </button>
                <button onclick="showScreen('simon-menu')" class="btn-game w-full bg-fuchsia-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm-4 0h2v6H7zm8 0h2v6h-2z"/>
                    </svg>
                    Simon Dice
                </button>
                <button onclick="showScreen('paint-by-number-menu')" class="btn-game w-full bg-orange-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M7 14c1.66 0 2.99-1.34 2.99-3L10 3H7c-.55 0-1 .45-1 1v7c0 1.66 1.34 3 3 3zm14-4c0-1.66-1.34-3-3-3h-4V3h4c.55 0 1 .45 1 1v7c0 1.66 1.34 3 3 3zm-7 7c-1.66 0-3-1.34-3-3h-4v-4h4c1.66 0 3 1.34 3 3zm-7-7c0-1.66 1.34-3 3-3h4V3h-4c-.55 0-1 .45-1 1v7c0 1.66 1.34 3 3 3z"/>
                    </svg>
                    Pintar por Números
                </button>
                <!-- New button for Retos game -->
                <button onclick="showScreen('retos-menu')" class="btn-game w-full bg-indigo-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <svg class="game-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    Retos
                </button>
            </div>
        </div>

        <!-- Trivia Menu Screen -->
        <div id="trivia-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-emerald-600">Preguntas y Respuestas</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('trivia')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="showMultiPlayerModeSelection('trivia')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
            </div>
        </div>

        <!-- Generic Single Player Mode Selection Screen -->
        <div id="single-player-mode-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button id="single-player-mode-back-button" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 id="single-player-mode-title" class="text-3xl font-display text-emerald-600">¿Quién juega?</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige tu nombre o "Familia":</p>
            <div class="space-y-4">
                <button onclick="startGameForPlayer(currentSelectedGameType, 'Hugo')" class="btn-game w-full bg-emerald-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/hugo.png" alt="Avatar de Hugo" class="w-12 h-12 rounded-full mr-3 object-cover">
                    Hugo
                </button>
                <button onclick="startGameForPlayer(currentSelectedGameType, 'Saúl')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/saul.png" alt="Avatar de Saúl" class="w-12 h-12 rounded-full mr-3 object-cover">
                    Saúl
                </button>
                <button onclick="showFamilyMemberSelection(currentSelectedGameType)" class="btn-game w-full bg-purple-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👨‍👩‍👧‍👦</span> Familia
                </button>
            </div>
        </div>

        <!-- Generic Family Member Selection Screen -->
        <div id="family-member-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showSinglePlayerModeSelection(currentSelectedGameType)" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 id="family-member-title" class="text-3xl font-display text-emerald-600">Elige un familiar:</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Selecciona quién jugará:</p>
            <div id="family-member-buttons" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Family player buttons will be generated by JS -->
            </div>
        </div>

        <!-- Trivia Game Screen -->
        <div id="trivia-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('trivia-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-emerald-600">Trivia</h2>
                <!-- This div will now dynamically show single or multi-player scores -->
                <div id="trivia-score-container" class="text-lg font-bold bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full">
                    <!-- Content set by JS -->
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="trivia-progress-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
            </div>
            <!-- This div is for multi-player turn indicator, will remain -->
            <div id="trivia-player-turn" class="text-center text-emerald-700 font-semibold mb-3 hidden">
                <span id="trivia-current-player-turn"></span>
            </div>
            <div id="trivia-content">
                <div class="bg-white p-4 rounded-lg shadow-inner mb-4">
                    <p id="trivia-category" class="text-sm text-slate-500 mb-2"></p>
                    <p id="trivia-question" class="text-lg font-semibold"></p>
                </div>
                <div id="trivia-answers" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>
        
        <!-- Tic-Tac-Toe Menu Screen -->
        <div id="tictactoe-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-sky-600">Tres en Raya</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('tictactoe')" class="btn-game w-full bg-sky-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="showMultiPlayerModeSelection('tictactoe')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
            </div>
        </div>

        <!-- Tic-Tac-Toe Game Screen -->
        <div id="tictactoe-game" class="hidden p-6">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('tictactoe-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                 <h2 id="tictactoe-status" class="text-xl text-center font-display text-sky-600"></h2>
                <div class="flex items-center space-x-4">
                    <button onclick="resetTicTacToe()" class="text-sky-500 hover:text-sky-700 font-bold active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar</button>
                    <button id="tictactoe-mute-button" onclick="toggleTicTacToeMute()" class="text-2xl text-slate-500 hover:text-slate-700 active:scale-95 transition-all duration-100">
                        🔊
                    </button>
                </div>
            </div>
            <div id="tictactoe-board" class="relative grid grid-cols-3 gap-2 aspect-square max-w-sm mx-auto">
                <canvas id="tictactoe-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                <!-- Cells will be generated by JS -->
            </div>
        </div>

        <!-- Memory Menu Screen -->
        <div id="memory-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-rose-600">Memocartas</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('memory')" class="btn-game w-full bg-rose-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="showMultiPlayerModeSelection('memory')" class="btn-game w-full bg-purple-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
            </div>
        </div>

        <!-- Multi Player Mode Selection Screen -->
        <div id="multi-player-mode-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="history.back()" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-3xl font-display text-emerald-600">Elegir Jugadores</h2>
            </div>
            
            <!-- Indicador de jugadores seleccionados -->
            <div class="bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg mb-6 text-center">
                <div class="flex items-center justify-center text-2xl font-display">
                    <span id="selected-player1-display" class="text-emerald-600 opacity-50">Jugador 1</span>
                    <span id="vs-display" class="mx-4 text-amber-500 opacity-50">vs</span>
                    <span id="selected-player2-display" class="text-sky-600 opacity-50">Jugador 2</span>
                </div>
            </div>

            <!-- Contenedor con scroll para las selecciones de jugadores -->
            <div class="overflow-y-auto max-h-[50vh] pr-2 space-y-6">
                <!-- Primer Jugador -->
                <div class="mb-6">
                    <p class="text-lg font-semibold text-slate-700 mb-3">Jugador 1:</p>
                    <div class="player1-buttons space-y-2">
                        <button onclick="selectFirstPlayer('Hugo')" data-player="Hugo" class="btn-game w-full bg-emerald-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/hugo.png" alt="Avatar de Hugo" class="w-10 h-10 rounded-full mr-3 object-cover">
                            Hugo
                        </button>
                        <button onclick="selectFirstPlayer('Saúl')" data-player="Saúl" class="btn-game w-full bg-sky-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/saul.png" alt="Avatar de Saúl" class="w-10 h-10 rounded-full mr-3 object-cover">
                            Saúl
                        </button>
                        <button onclick="showFamilyMemberSelectionForMulti(1)" data-player="familia" class="btn-game w-full bg-purple-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <span class="mr-3">👨‍👩‍👧‍👦</span> Familia
                        </button>
                    </div>
                </div>

                <!-- Segundo Jugador -->
                <div class="mb-6">
                    <p class="text-lg font-semibold text-slate-700 mb-3">Jugador 2:</p>
                    <div class="player2-buttons space-y-2">
                        <button onclick="selectSecondPlayer('Hugo')" data-player="Hugo" class="btn-game w-full bg-emerald-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/hugo.png" alt="Avatar de Hugo" class="w-10 h-10 rounded-full mr-3 object-cover">
                            Hugo
                        </button>
                        <button onclick="selectSecondPlayer('Saúl')" data-player="Saúl" class="btn-game w-full bg-sky-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <img src="https://ivandlpn.github.io/Aplicaciones/HUSA/img/jugadores/saul.png" alt="Avatar de Saúl" class="w-10 h-10 rounded-full mr-3 object-cover">
                            Saúl
                        </button>
                        <button onclick="showFamilyMemberSelectionForMulti(2)" data-player="familia" class="btn-game w-full bg-purple-500 text-white p-3 rounded-xl shadow-lg flex items-center justify-center text-xl font-display transition-all">
                            <span class="mr-3">👨‍👩‍👧‍👦</span> Familia
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botón de inicio (inicialmente deshabilitado) -->
            <button id="start-multiplayer-game" onclick="startMultiPlayerGame()" class="w-full bg-amber-500 text-white p-4 rounded-xl shadow-lg text-2xl font-display opacity-50 cursor-not-allowed mt-4" disabled>
                ¡Empezar a Jugar!
            </button>
        </div>

        <!-- Memory Setup Selection Screen -->
        <div id="memory-setup-selection" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button id="memory-setup-back-button" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-rose-600">Configurar Memocartas</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige la dificultad:</p>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="selectMemoryDifficulty(12, 4)" class="btn-game bg-rose-300 text-white p-4 rounded-xl shadow-lg text-xl font-display">Fácil (4x3)</button>
                <button onclick="selectMemoryDifficulty(16, 4)" class="btn-game bg-rose-400 text-white p-4 rounded-xl shadow-lg text-xl font-display">Normal (4x4)</button>
                <button onclick="selectMemoryDifficulty(20, 5)" class="btn-game bg-rose-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Difícil (5x4)</button>
                <button onclick="selectMemoryDifficulty(24, 6)" class="btn-game bg-rose-600 text-white p-4 rounded-xl shadow-lg text-xl font-display">Muy Difícil (6x4)</button>
            </div>

            <p class="text-center text-slate-600 mb-6">Elige el tema:</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="selectMemoryTheme('sports')" class="btn-game bg-emerald-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Deportes ⚽️</button>
                <button onclick="selectMemoryTheme('animals')" class="btn-game bg-yellow-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Animales 🐶</button>
                <button onclick="selectMemoryTheme('symbols')" class="btn-game bg-purple-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Símbolos ❤️</button>
                <button onclick="selectMemoryTheme('flags')" class="btn-game bg-blue-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Banderas 🇪🇸</button>
                <button onclick="selectMemoryTheme('food')" class="btn-game bg-orange-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Comida 🍔</button> <!-- New theme button -->
                <button onclick="selectMemoryTheme('space')" class="btn-game w-full bg-indigo-500 text-white p-4 rounded-xl shadow-lg text-xl font-display">Espacio 🚀</button> <!-- New theme button -->
            </div>
            <button id="start-memory-game-button" onclick="confirmStartMemoryGame()" class="mt-8 w-full bg-amber-500 text-white p-4 rounded-xl shadow-lg text-2xl font-display opacity-50 cursor-not-allowed" disabled>
                ¡Empezar a Jugar!
            </button>
        </div>

        <!-- Memory Game Screen -->
        <div id="memory-game" class="hidden p-4">
             <div class="flex justify-between items-center mb-2">
                <button onclick="showScreen('memory-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-rose-600">Memocartas</h2>
                 <div class="flex items-center space-x-4">
                    <div id="memory-attempts-display" class="text-lg font-bold bg-rose-100 text-rose-800 px-3 py-1 rounded-full">
                        Intentos: <span id="memory-attempts">0</span>
                    </div>
                    <div id="memory-timer-display" class="text-lg font-bold bg-rose-100 text-rose-800 px-3 py-1 rounded-full hidden">
                        <span id="memory-player-name-display"></span>Tiempo: <span id="memory-timer">00:00</span>
                    </div>
                    <!-- Mute button for memory game -->
                    <button id="memory-mute-button" onclick="toggleMemoryMute()" class="text-2xl text-slate-500 hover:text-slate-700 active:scale-95 transition-all duration-100">
                        🔊
                    </button>
                 </div>
            </div>
            <div id="memory-player-turn" class="text-center text-rose-700 font-semibold mb-3 hidden">
                <span id="memory-current-player-turn"></span><br>
                <span class="text-base font-semibold">Hugo: <span id="memory-player1-matched">0</span> | Saúl: <span id="memory-player2-matched">0</span></span>
            </div>
            <div id="memory-board" class="grid grid-cols-4 gap-2 md:gap-3">
                <!-- Cards will be generated by JS -->
            </div>
        </div>

        <!-- Guess the Number Menu Screen -->
        <div id="guess-number-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-green-600">Adivina el Número</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('guess-number')" class="btn-game w-full bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button onclick="showMultiPlayerModeSelection('guess-number')" class="btn-game w-full bg-lime-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores
                </button>
                <!-- Nuevo botón para Modo Matemático -->
                <button onclick="startGameGuessNumber('math')" class="btn-game w-full bg-blue-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">🧮</span> Modo Matemático
                </button>
            </div>
        </div>

        <!-- Guess the Number Game Screen -->
        <div id="guess-number-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('guess-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-green-600">Adivina el Número</h2>
                <div class="text-lg font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full">
                    Intentos: <span id="guess-number-attempts">0</span>
                </div>
            </div>
            <div id="guess-number-player-turn" class="text-center text-green-700 font-semibold mb-3 hidden">
                <span id="guess-number-current-player-turn"></span>
            </div>
            <div id="guess-number-highscore-display" class="text-center text-green-600 font-semibold mb-3">
                <span id="guess-number-player-name-display"></span>Mejor: <span id="guess-number-highscore-value">N/A</span>
            </div>
            <div id="guess-number-mode-display" class="text-center text-blue-600 font-semibold mb-3">
                <span id="guess-number-mode-text"></span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-4 text-center">
                <p id="guess-number-range" class="text-lg font-semibold mb-2">Estoy pensando en un número entre 1 y 100.</p>
                <div class="flex items-center justify-center space-x-4">
                    <!-- Termómetro -->
                    <div class="thermometer">
                        <div class="thermometer-fill" id="guess-thermometer" style="height: 0%"></div>
                    </div>
                    <!-- Contenedor central con feedback y flechas -->
                    <div class="flex-1">
                        <div class="flex items-center justify-center">
                            <span id="guess-arrow-left" class="guess-arrow hidden">⬆️</span>
                            <p id="guess-number-feedback" class="text-xl font-bold text-slate-700 min-h-[2rem] flex items-center justify-center transition-all duration-300"></p>
                            <span id="guess-arrow-right" class="guess-arrow hidden">⬇️</span>
                        </div>
                        <!-- Indicador de proximidad -->
                        <div class="proximity-indicator mt-4">
                            <div id="proximity-marker" class="proximity-marker"></div>
                        </div>
                    </div>
                </div>
                <div id="math-hints-container" class="mt-4 space-y-2">
                    <!-- Las pistas matemáticas se mostrarán aquí -->
                </div>
            </div>
            <div class="flex space-x-2 mb-4">
                <input type="number" id="guess-number-input" class="flex-grow p-3 rounded-lg border-2 border-green-300 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 text-center text-2xl font-bold transition-all duration-300" placeholder="Tu número" min="1" max="100">
                <button onclick="checkGuess()" id="guess-number-submit" class="bg-green-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">¡Adivinar!</button>
            </div>
            <button id="guess-number-hint-button" onclick="requestHint()" class="w-full bg-blue-500 text-white p-2 rounded-lg shadow-md mb-2 active:scale-95 active:opacity-75 transition-all duration-100">Pedir Pista (<span id="guess-number-hints-left">1</span>)</button>
            <button onclick="resetGuessNumberGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Juego</button>
        </div>

        <!-- Simon Says Menu Screen -->
        <div id="simon-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-fuchsia-600">Simon Dice</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('simon')" class="btn-game w-full bg-fuchsia-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Simon Says Game Screen -->
        <div id="simon-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('simon-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-fuchsia-600">
                    <span class="inline-block" style="color: white; filter: brightness(150%) grayscale(100%) invert(100%);">🎮</span>&nbsp;&nbsp;Simon Dice
                </h2>
                <div class="text-lg font-bold bg-fuchsia-100 text-fuchsia-800 px-3 py-1 rounded-full">
                    Nivel: <span id="simon-level">0</span>
                </div>
            </div>
            <div id="simon-highscore-display" class="text-center text-fuchsia-600 font-semibold mb-3">
                <span id="simon-player-name-display"></span>Mejor: <span id="simon-highscore-value">N/A</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-4 text-center aspect-square flex items-center justify-center flex-col">
                <p id="simon-feedback" class="text-xl font-bold text-slate-700 min-h-[2rem] flex items-center justify-center mb-4">¡Pulsa "Empezar" para jugar!</p>
                <div id="simon-buttons-container" class="grid grid-cols-2 gap-4 w-full max-w-xs aspect-square">
                    <button id="simon-red" class="simon-button simon-red"></button>
                    <button id="simon-green" class="simon-button simon-green"></button>
                    <button id="simon-blue" class="simon-button simon-blue"></button>
                    <button id="simon-yellow" class="simon-button simon-yellow"></button>
                </div>
                <button id="simon-start-button" onclick="startSimonRound()" class="mt-6 bg-fuchsia-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Empezar</button>
            </div>
            <button onclick="resetSimonGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Juego</button>
        </div>

        <!-- Paint by Number Menu Screen -->
        <div id="paint-by-number-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-orange-600">Pintar por Números</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('paint-by-number')" class="btn-game w-full bg-orange-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Paint by Number Game Screen -->
        <div id="paint-by-number-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('paint-by-number-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-orange-600">Pintar</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-lg font-bold bg-orange-100 text-orange-800 px-3 py-1 rounded-full">
                        <span id="paint-by-number-player-name-display"></span>Progreso: <span id="paint-by-number-progress">0%</span>
                    </div>
                     <!-- Mute button for paint by number game -->
                    <button id="paint-mute-button" onclick="togglePaintMute()" class="text-2xl text-slate-500 hover:text-slate-700 active:scale-95 transition-all duration-100">
                        🔊
                    </button>
                </div>
            </div>
            <div id="paint-grid-container" class="w-full aspect-square bg-white rounded-lg shadow-inner overflow-hidden mb-4 grid">
                <!-- Grid cells will be generated by JS -->
            </div>
            <div id="color-palette" class="flex justify-center space-x-2 md:space-x-4 mb-4">
                <!-- Color buttons will be generated by JS -->
            </div>
            <button onclick="resetPaintByNumberGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Reiniciar Imagen</button>
        </div>

        <!-- Retos Menu Screen (NEW) -->
        <div id="retos-menu" class="hidden p-6 md:p-8">
            <div class="flex justify-start items-center mb-6">
                <button onclick="showScreen('main-menu')" class="bg-amber-400 hover:bg-amber-500 text-white p-2 rounded-full shadow-md transition-transform transform hover:scale-105 active:scale-95 focus:outline-none mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-display text-indigo-600">Retos</h2>
            </div>
            <p class="text-center text-slate-600 mb-6">Elige modo de juego:</p>
            <div class="space-y-4">
                <button onclick="showSinglePlayerModeSelection('retos')" class="btn-game w-full bg-indigo-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display">
                    <span class="mr-3">👤</span> 1 Jugador
                </button>
                <button class="btn-game w-full bg-gray-400 text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display cursor-not-allowed opacity-70">
                    <span class="mr-3">🧑‍🤝‍🧑</span> 2 Jugadores (Próximamente)
                </button>
            </div>
        </div>

        <!-- Retos Game Screen (NEW) -->
        <div id="retos-game" class="hidden p-6 md:p-8">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('retos-menu')" class="text-slate-500 hover:text-amber-600 text-2xl active:scale-95 active:opacity-75 transition-all duration-100">←</button>
                <h2 class="text-3xl font-display text-indigo-600">Retos</h2>
                <div class="text-lg font-bold bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full">
                    Retos: <span id="retos-completed-count">0</span>
                </div>
            </div>
            <div id="retos-highscore-display" class="text-center text-indigo-600 font-semibold mb-3">
                <span id="retos-player-name-display"></span>Mejor: <span id="retos-highscore-value">N/A</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-inner mb-4 text-center">
                <p id="retos-category" class="text-sm text-slate-500 mb-2"></p>
                <p id="retos-challenge" class="text-xl font-semibold mb-4 min-h-[4rem] flex items-center justify-center"></p>
                <!-- Bomb visual and timer -->
                <div class="flex flex-col items-center justify-center mb-4">
                    <div id="retos-bomb-display" class="text-7xl mb-2">💣</div>
                    <div class="text-5xl font-extrabold text-indigo-700">
                        <span id="retos-timer">00</span><span class="text-3xl">s</span>
                    </div>
                </div>
                <p id="retos-feedback" class="text-lg text-slate-700 min-h-[1.5rem]"></p>
            </div>
            <div class="grid grid-cols-1 gap-4"> <!-- Changed to 1 column grid -->
                <button id="retos-done-button" onclick="completeReto()" class="bg-emerald-500 text-white p-4 rounded-xl shadow-lg text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100" disabled>
                    ¡Desactivar Bomba! 💣
                </button>
                <!-- Removed the "No lo hice" button -->
            </div>
            <button id="retos-start-next-button" onclick="startNextReto()" class="w-full bg-amber-500 text-white p-3 rounded-lg shadow-md text-xl font-display mt-4 active:scale-95 active:opacity-75 transition-all duration-100">
                Empezar Reto
            </button>
            <button onclick="resetRetosGame()" class="w-full bg-gray-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100 mt-2">Reiniciar Juego</button>
        </div>


        <!-- Modal for Trivia Feedback -->
        <div id="trivia-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
                <h3 id="modal-title" class="text-4xl font-display mb-2"></h3>
                <p id="modal-explanation" class="text-slate-600 mb-6"></p>
                <button id="modal-next-btn" class="w-full bg-amber-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Siguiente</button>
            </div>
        </div>

        <!-- Modal for Game Over -->
        <div id="gameover-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
                <h3 id="gameover-title" class="text-4xl font-display mb-2"></h3>
                <p id="gameover-message" class="text-slate-600 mb-6"></p>
                <div class="flex flex-col space-y-2">
                    <button id="gameover-restart-btn" class="w-full bg-amber-500 text-white p-3 rounded-lg shadow-md text-xl font-display active:scale-95 active:opacity-75 transition-all duration-100">Jugar de nuevo</button>
                    <button id="gameover-menu-btn" class="w-full bg-slate-200 text-slate-700 p-2 rounded-lg active:scale-95 active:opacity-75 transition-all duration-100">Volver al menú</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Lista de imágenes de fondo
        const backgroundImages = [
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada1.png',
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada2.png',
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada3.png',
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada4.png',
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada5.png',
            'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada6.png'
        ];

        let currentBackgroundIndex = -1;
        let selectedPlayer1 = null;
        let selectedPlayer2 = null;
        let currentGameType = null;

        // Función para cambiar el fondo
        function changeBackground() {
            let storedIndex = sessionStorage.getItem('backgroundIndex');
            let newIndex;
            
            // Solo cambiar el fondo si no hay uno almacenado o es un reinicio de juego
            if (!storedIndex || !document.referrer) {
                do {
                    newIndex = Math.floor(Math.random() * backgroundImages.length);
                } while (newIndex === currentBackgroundIndex && backgroundImages.length > 1);
                
                currentBackgroundIndex = newIndex;
                sessionStorage.setItem('backgroundIndex', newIndex);
                document.body.style.backgroundImage = `url('${backgroundImages[currentBackgroundIndex]}')`;
            } else {
                // Usar el fondo almacenado
                currentBackgroundIndex = parseInt(storedIndex);
                document.body.style.backgroundImage = `url('${backgroundImages[currentBackgroundIndex]}')`;
            }
        }

        // Funciones para el modo multijugador
        function showMultiPlayerModeSelection(gameType) {
            currentGameType = gameType;
            selectedPlayer1 = null;
            selectedPlayer2 = null;
            document.getElementById('start-multiplayer-game').disabled = true;
            document.getElementById('start-multiplayer-game').classList.add('opacity-50', 'cursor-not-allowed');
            showScreen('multi-player-mode-selection');
        }

        function selectFirstPlayer(player) {
            // Remover selección visual previa
            document.querySelectorAll('.player1-buttons button').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-amber-400', 'scale-105');
            });
            
            // Añadir selección visual al botón elegido
            const selectedButton = document.querySelector(`.player1-buttons button[data-player="${player}"]`);
            if (selectedButton) {
                selectedButton.classList.add('ring-4', 'ring-amber-400', 'scale-105');
            }
            
            selectedPlayer1 = player;
            checkMultiPlayerSelection();
            
            // Actualizar el estado visual del jugador seleccionado
            updatePlayerSelectionDisplay();
        }

        function selectSecondPlayer(player) {
            if (player === selectedPlayer1) {
                alert('Por favor, elige un jugador diferente al Jugador 1');
                return;
            }
            
            // Remover selección visual previa
            document.querySelectorAll('.player2-buttons button').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-amber-400', 'scale-105');
            });
            
            // Añadir selección visual al botón elegido
            const selectedButton = document.querySelector(`.player2-buttons button[data-player="${player}"]`);
            if (selectedButton) {
                selectedButton.classList.add('ring-4', 'ring-amber-400', 'scale-105');
            }
            
            selectedPlayer2 = player;
            checkMultiPlayerSelection();
            
            // Actualizar el estado visual del jugador seleccionado
            updatePlayerSelectionDisplay();
        }

        function updatePlayerSelectionDisplay() {
            const player1Display = document.getElementById('selected-player1-display');
            const player2Display = document.getElementById('selected-player2-display');
            const vsDisplay = document.getElementById('vs-display');

            if (selectedPlayer1) {
                player1Display.textContent = selectedPlayer1;
                player1Display.classList.remove('opacity-50');
            } else {
                player1Display.textContent = 'Jugador 1';
                player1Display.classList.add('opacity-50');
            }

            if (selectedPlayer2) {
                player2Display.textContent = selectedPlayer2;
                player2Display.classList.remove('opacity-50');
            } else {
                player2Display.textContent = 'Jugador 2';
                player2Display.classList.add('opacity-50');
            }

            if (selectedPlayer1 && selectedPlayer2) {
                vsDisplay.classList.remove('opacity-50');
            } else {
                vsDisplay.classList.add('opacity-50');
            }
        }

        function showFamilyMemberSelectionForMulti(playerNumber) {
            // Guardar el número de jugador actual para saber a quién asignar la selección
            sessionStorage.setItem('multiPlayerNumber', playerNumber.toString());
            showFamilyMemberSelection(currentGameType);
        }

        function selectFamilyMemberForMulti(familyMember) {
            const playerNumber = parseInt(sessionStorage.getItem('multiPlayerNumber'));
            if (playerNumber === 1) {
                selectFirstPlayer(familyMember);
            } else {
                selectSecondPlayer(familyMember);
            }
            showScreen('multi-player-mode-selection');
        }

        function checkMultiPlayerSelection() {
            const startButton = document.getElementById('start-multiplayer-game');
            if (selectedPlayer1 && selectedPlayer2 && selectedPlayer1 !== selectedPlayer2) {
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        let currentTurn = null;

        function startMultiPlayerGame() {
            // Establecer el primer turno aleatorio
            currentTurn = Math.random() < 0.5 ? selectedPlayer1 : selectedPlayer2;
            
            switch (currentGameType) {
                case 'trivia':
                    startTrivia('multi', selectedPlayer1, selectedPlayer2, currentTurn);
                    break;
                case 'tictactoe':
                    startTicTacToe('human', selectedPlayer1, selectedPlayer2, currentTurn);
                    break;
                case 'memory':
                    showMemorySetupSelection(null, selectedPlayer1, selectedPlayer2, currentTurn);
                    break;
                case 'guess-number':
                    startGameGuessNumber('multi', selectedPlayer1, selectedPlayer2, currentTurn);
                    break;
            }
        }

        function switchTurn() {
            currentTurn = currentTurn === selectedPlayer1 ? selectedPlayer2 : selectedPlayer1;
            updateTurnDisplay();
        }

        function updateTurnDisplay() {
            const turnDisplay = document.querySelector('.current-turn-display');
            if (turnDisplay) {
                turnDisplay.textContent = `Turno de: ${currentTurn}`;
                turnDisplay.className = `current-turn-display text-lg font-bold ${
                    currentTurn === selectedPlayer1 ? 'text-emerald-600' : 'text-sky-600'
                }`;
            }
        }

        function showTurnIndicator(container) {
            // Crear o actualizar el indicador de turno
            let turnIndicator = container.querySelector('.current-turn-display');
            if (!turnIndicator) {
                turnIndicator = document.createElement('div');
                turnIndicator.className = 'current-turn-display text-lg font-bold mb-4 text-center';
                container.insertBefore(turnIndicator, container.firstChild);
            }
            updateTurnDisplay();
        }

        // Función para inicializar el fondo al cargar o reiniciar
        function initializeBackground() {
            // Si no hay un fondo guardado, elegir uno aleatorio
            if (!sessionStorage.getItem('currentBackground')) {
                changeBackground();
            }
        }

        // Ejecutar al cargar la página
        initializeBackground();

        // Agregar al evento de reinicio del juego
        document.addEventListener('DOMContentLoaded', function() {
            // Eliminar el índice de fondo almacenado cuando se regresa al menú principal
            const menuButtons = document.querySelectorAll('[onclick*="showScreen(\'main-menu\')"]');
            menuButtons.forEach(button => {
                const originalOnClick = button.getAttribute('onclick');
                button.setAttribute('onclick', `sessionStorage.removeItem('backgroundIndex'); ${originalOnClick}`);
            });
            
            // Cambiar el fondo en los reinicios
            const restartButtons = document.querySelectorAll('[onclick*="restart"], [onclick*="reset"]');
            restartButtons.forEach(button => {
                const originalOnClick = button.getAttribute('onclick');
                button.setAttribute('onclick', `sessionStorage.removeItem('backgroundIndex'); ${originalOnClick}; changeBackground();`);
            });
        });
    </script>

    <div id="confetti-container"></div>

    <!-- Audio elements for Simon Says -->
    <audio id="simon-sound-red" preload="auto"></audio>
    <audio id="simon-sound-green" preload="auto"></audio>
    <audio id="simon-sound-blue" preload="auto"></audio>
    <audio id="simon-sound-yellow" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        const screens = {
            mainMenu: document.getElementById('main-menu'),
            triviaMenu: document.getElementById('trivia-menu'),
            singlePlayerModeSelection: document.getElementById('single-player-mode-selection'), // Generic single player mode selection
            familyMemberSelection: document.getElementById('family-member-selection'), // Generic family member selection
            triviaGame: document.getElementById('trivia-game'),
            tictactoeMenu: document.getElementById('tictactoe-menu'),
            tictactoeGame: document.getElementById('tictactoe-game'),
            memoryMenu: document.getElementById('memory-menu'),
            memorySetupSelection: document.getElementById('memory-setup-selection'),
            memoryGame: document.getElementById('memory-game'),
            guessNumberMenu: document.getElementById('guess-number-menu'),
            guessNumberGame: document.getElementById('guess-number-game'),
            simonMenu: document.getElementById('simon-menu'),
            simonGame: document.getElementById('simon-game'),
            paintByNumberMenu: document.getElementById('paint-by-number-menu'),
            paintByNumberGame: document.getElementById('paint-by-number-game'),
            retosMenu: document.getElementById('retos-menu'), // NEW
            retosGame: document.getElementById('retos-game'), // NEW
        };
        
        const modals = {
            trivia: document.getElementById('trivia-modal'),
            gameOver: document.getElementById('gameover-modal')
        };

        let currentScreen = 'main-menu'; // Tracks the ID of the currently visible screen
        let currentSelectedGameType = ''; // To store which game type is currently in player selection flow

        function showScreen(screenId) {
            const targetScreen = document.getElementById(screenId);
            if (!targetScreen) return;

            const currentScreenElement = document.getElementById(currentScreen);
            const appContainer = document.getElementById('app-container'); // Get app container

            // Remove all specific theme classes and default translucent white/blur
            appContainer.classList.remove('bg-trivia-theme', 'bg-tictactoe-theme', 'bg-memory-theme', 'bg-guess-number-theme', 'bg-simon-theme', 'bg-paint-by-number-theme', 'bg-retos-theme', 'bg-white/70', 'backdrop-blur-sm', 'bg-white');

            // Apply theme based on screenId
            if (screenId === 'main-menu') {
                appContainer.classList.add('bg-white/70', 'backdrop-blur-sm');
            } else if (screenId.startsWith('trivia')) {
                appContainer.classList.add('bg-trivia-theme');
            } else if (screenId.startsWith('tictactoe')) {
                appContainer.classList.add('bg-tictactoe-theme');
            } else if (screenId.startsWith('memory')) {
                appContainer.classList.add('bg-memory-theme');
            } else if (screenId.startsWith('guess-number')) {
                appContainer.classList.add('bg-guess-number-theme');
            } else if (screenId.startsWith('simon')) {
                appContainer.classList.add('bg-simon-theme');
            } else if (screenId.startsWith('paint-by-number')) {
                appContainer.classList.add('bg-paint-by-number-theme');
            } else if (screenId.startsWith('retos')) { // NEW
                appContainer.classList.add('bg-retos-theme');
            }
            else if (screenId === 'single-player-mode-selection' || screenId === 'family-member-selection') {
                // For player selection screens, use a solid white background
                appContainer.classList.add('bg-white');
            }
            
            if (currentScreenElement && currentScreenElement !== targetScreen) {
                // Apply fade-out animation to the current screen
                currentScreenElement.classList.add('fade-out');
                currentScreenElement.classList.remove('fade-in'); // Ensure no lingering fade-in

                // After the fade-out animation completes, hide the current screen and show the new one
                setTimeout(() => {
                    currentScreenElement.classList.add('hidden');
                    currentScreenElement.classList.remove('fade-out'); // Clean up fade-out class

                    // Show the target screen with fade-in animation
                    targetScreen.classList.remove('hidden');
                    targetScreen.classList.add('fade-in');
                    targetScreen.classList.remove('fade-out'); // Ensure no lingering fade-out

                    currentScreen = screenId; // Update the current screen tracker
                }, 300); // This timeout duration should match the CSS animation duration
            } else if (currentScreenElement !== targetScreen) { // This handles the initial load or if currentScreen is somehow not set
                // Directly show the target screen with fade-in animation
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('fade-in');
                targetScreen.classList.remove('fade-out'); // Clean up
                currentScreen = screenId; // Update the current screen tracker
            }
            // If targetScreen is already currentScreen, do nothing.
        }

        function showModal(modalId, options = {}) {
            const modal = modals[modalId];
            if (!modal) return;

            if (modalId === 'trivia') {
                document.getElementById('modal-title').textContent = options.title;
                document.getElementById('modal-title').className = `text-4xl font-display mb-2 ${options.correct ? 'text-emerald-500' : 'text-rose-500'}`;
                document.getElementById('modal-explanation').innerHTML = options.explanation;
                document.getElementById('modal-next-btn').onclick = options.nextCallback;
            } else if (modalId === 'gameOver') {
                const titleElement = document.getElementById('gameover-title');
                const messageElement = document.getElementById('gameover-message');

                // Clear any previous animation classes
                titleElement.classList.remove('win-animation', 'lose-animation', 'tie-animation');
                messageElement.classList.remove('win-animation', 'lose-animation', 'tie-animation');


                titleElement.textContent = options.title;
                messageElement.textContent = options.message;

                // Reset styles first to avoid bleed-over from previous calls
                titleElement.style.fontSize = '';
                titleElement.style.color = '';
                titleElement.style.textShadow = '';
                titleElement.style.fontFamily = '';
                messageElement.style.fontSize = '';
                messageElement.style.color = '';
                messageElement.style.textShadow = '';

                if (options.game === 'tictactoe' && options.win) { // Apply special styling for Tic-Tac-Toe win
                    titleElement.style.fontSize = '3.5rem';
                    titleElement.style.color = '#34D399'; /* Emerald green */
                    titleElement.style.textShadow = '0 0 10px #34D399, 0 0 20px #34D399, 0 0 30px #34D399';
                    titleElement.style.fontFamily = "'Press Start 2P', cursive";

                    messageElement.style.fontSize = '1.5rem';
                    messageElement.style.color = '#10B981'; /* Darker emerald */
                    messageElement.style.textShadow = '0 0 5px #10B981';
                } else if (options.game === 'trivia') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        messageElement.classList.add('win-animation');
                    } else if (options.lose) {
                        titleElement.classList.add('lose-animation');
                        messageElement.classList.add('lose-animation');
                    } else if (options.tie) {
                        titleElement.classList.add('tie-animation');
                        messageElement.classList.add('tie-animation');
                    }
                } else if (options.game === 'guess-number') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#16A34A'; /* green-600 */
                    } else { // Should not happen in guess number, but for consistency
                        titleElement.classList.add('lose-animation');
                        titleElement.style.color = '#DC2626'; /* red-600 */
                    }
                } else if (options.game === 'simon') {
                    if (options.win) { // Simon game win means reached a new high level
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#C026D3'; /* fuchsia-600 */
                    } else { // Simon game lose
                        titleElement.classList.add('lose-animation');
                        titleElement.style.color = '#DC2626'; /* red-600 */
                    }
                } else if (options.game === 'paint-by-number') {
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#F97316'; /* orange-600 */
                    } else {
                        // Not really a lose state for paint by number, but for consistency
                        titleElement.classList.add('tie-animation');
                        titleElement.style.color = '#FBBF24'; /* amber-500 */
                    }
                } else if (options.game === 'retos') { // NEW
                    if (options.win) {
                        titleElement.classList.add('win-animation');
                        titleElement.style.color = '#4F46E5'; /* indigo-600 */
                    } else {
                        titleElement.classList.add('lose-animation');
                        titleElement.style.color = '#EF4444'; /* red-500 */
                    }
                }

                document.getElementById('gameover-restart-btn').onclick = options.restartCallback;
                document.getElementById('gameover-menu-btn').onclick = () => {
                    closeModal('gameOver');
                    // Determine which menu to go back to based on the game
                    if (options.game === 'trivia') showScreen('trivia-menu');
                    else if (options.game === 'memory') showScreen('memory-menu');
                    else if (options.game === 'tictactoe') showScreen('tictactoe-menu');
                    else if (options.game === 'guess-number') showScreen('guess-number-menu');
                    else if (options.game === 'simon') showScreen('simon-menu');
                    else if (options.game === 'paint-by-number') showScreen('paint-by-number-menu');
                    else if (options.game === 'retos') showScreen('retos-menu'); // NEW
                    else showScreen('main-menu'); // Default fallback
                };
            }
            
            modal.classList.remove('hidden', 'fade-out'); // Use generic fade-out
            modal.classList.add('fade-in'); // Use generic fade-in
        }

        function closeModal(modalId) {
            const modal = modals[modalId];
            if (!modal) return;
            
            modal.classList.add('fade-out'); // Use generic fade-out
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('fade-in', 'fade-out'); // Clean up generic classes
            }, 300);
        }

        function saveTriviaHighScore(playerName, score) {
            const key = `highscore_trivia_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '0');
            console.log(`[Trivia] Saving high score for ${playerName}. New score: ${score}, Current best: ${currentHighScore}`);
            if (score > currentHighScore) {
                localStorage.setItem(key, score);
                console.log(`[Trivia] New high score saved: ${score} for ${playerName}`);
            } else {
                console.log(`[Trivia] No new high score for ${playerName}. Score: ${score}, Current best: ${currentHighScore}`);
            }
        }

        function saveMemoryHighScore(playerName, value, isTime = false) {
            const key = `highscore_memory_${playerName}`;
            // For time, lower is better. For attempts, lower is better.
            // So, for time, we store seconds. For attempts, we store count.
            // The comparison logic remains the same: if new value is less than current, update.
            const currentHighScore = parseInt(localStorage.getItem(key) || (isTime ? '999999' : '999')); // Default high value for time/attempts
            console.log(`[Memocartas] Saving high score for ${playerName}. New value: ${value}, Current best: ${currentHighScore}, Is Time: ${isTime}`);
            if (value < currentHighScore) {
                localStorage.setItem(key, value);
                console.log(`[Memocartas] New high score saved: ${value} for ${playerName}`);
            } else {
                console.log(`[Memocartas] No new high score for ${playerName}. Value: ${value}, Current best: ${currentHighScore}`);
            }
        }

        // --- Global Player List and Selection Logic ---
        const allFamilyPlayers = ['Hugo', 'Saúl', 'Papá', 'Mamá', 'Yoyo', 'Yaya', 'Abuela', 'Abuelo', 'Tito Samu', 'Tita Lidia', 'Tito Iván', 'Tita Tere', 'Tito Freek', 'Prima Gema', 'Primo Oliver'];
        const corePlayers = ['Hugo', 'Saúl'];
        const otherFamilyPlayers = allFamilyPlayers.filter(player => !corePlayers.includes(player));

        const playerButtonColors = [
            'bg-emerald-500', 'bg-sky-500', 'bg-purple-500', 'bg-pink-500', 'bg-yellow-500',
            'bg-lime-500', 'bg-red-500', 'bg-blue-500', 'bg-orange-500', 'bg-teal-500',
            'bg-indigo-500', 'bg-emerald-500', 'bg-sky-500', 'bg-rose-500', 'bg-green-500'
        ];

        function getPlayerColorClass(playerName) {
            const index = allFamilyPlayers.indexOf(playerName);
            if (index !== -1) {
                return playerButtonColors[index % playerButtonColors.length];
            }
            return 'bg-gray-500'; // Default color if not found
        }

        function showSinglePlayerModeSelection(gameType) {
            currentSelectedGameType = gameType;
            const titleElement = document.getElementById('single-player-mode-title');
            const backButton = document.getElementById('single-player-mode-back-button');

            // Set title and back button based on game type
            if (gameType === 'trivia') {
                titleElement.textContent = 'Preguntas y Respuestas';
                titleElement.classList.add('text-emerald-600');
                titleElement.classList.remove('text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('trivia-menu');
            } else if (gameType === 'tictactoe') {
                titleElement.textContent = 'Tres en Raya';
                titleElement.classList.add('text-sky-600');
                titleElement.classList.remove('text-emerald-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('tictactoe-menu');
            } else if (gameType === 'memory') {
                titleElement.textContent = 'Memocartas';
                titleElement.classList.add('text-rose-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('memory-menu');
            } else if (gameType === 'guess-number') {
                titleElement.textContent = 'Adivina el Número';
                titleElement.classList.add('text-green-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('guess-number-menu');
            } else if (gameType === 'simon') {
                titleElement.textContent = 'Simon Dice';
                titleElement.classList.add('text-fuchsia-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-orange-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('simon-menu');
            } else if (gameType === 'paint-by-number') {
                titleElement.textContent = 'Pintar por Números';
                titleElement.classList.add('text-orange-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-indigo-600');
                backButton.onclick = () => showScreen('paint-by-number-menu');
            } else if (gameType === 'retos') { // NEW
                titleElement.textContent = 'Retos';
                titleElement.classList.add('text-indigo-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600');
                backButton.onclick = () => showScreen('retos-menu');
            }

            showScreen('single-player-mode-selection');
        }

        function showFamilyMemberSelection(gameType) {
            currentSelectedGameType = gameType;
            const container = document.getElementById('family-member-buttons');
            container.innerHTML = ''; // Clear previous buttons

            const titleElement = document.getElementById('family-member-title');
            if (gameType === 'trivia') {
                titleElement.classList.add('text-emerald-600');
                titleElement.classList.remove('text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
            } else if (gameType === 'tictactoe') {
                titleElement.classList.add('text-sky-600');
                titleElement.classList.remove('text-emerald-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
            } else if (gameType === 'memory') {
                titleElement.classList.add('text-rose-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
            } else if (gameType === 'guess-number') {
                titleElement.classList.add('text-green-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-fuchsia-600', 'text-orange-600', 'text-indigo-600');
            } else if (gameType === 'simon') {
                titleElement.classList.add('text-fuchsia-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-orange-600', 'text-indigo-600');
            } else if (gameType === 'paint-by-number') {
                titleElement.classList.add('text-orange-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-indigo-600');
            } else if (gameType === 'retos') { // NEW
                titleElement.classList.add('text-indigo-600');
                titleElement.classList.remove('text-emerald-600', 'text-sky-600', 'text-rose-600', 'text-green-600', 'text-fuchsia-600', 'text-orange-600');
            }

            otherFamilyPlayers.forEach(player => {
                const button = document.createElement('button');
                button.className = `btn-game w-full ${getPlayerColorClass(player)} text-white p-4 rounded-xl shadow-lg flex items-center justify-center text-2xl font-display`;
                button.textContent = player;
                button.onclick = () => startGameForPlayer(gameType, player);
                container.appendChild(button);
            });
            showScreen('family-member-selection');
        }

        function startGameForPlayer(gameType, playerName) {
            if (gameType === 'trivia') {
                startTrivia('single', playerName);
            } else if (gameType === 'tictactoe') {
                startTicTacToe('ai', playerName);
            } else if (gameType === 'memory') {
                showMemorySetupSelection(playerName); // Memory has an intermediate setup screen
            } else if (gameType === 'guess-number') {
                startGameGuessNumber('single', playerName);
            } else if (gameType === 'simon') {
                startSimonGame('single', playerName);
            } else if (gameType === 'paint-by-number') {
                startPaintByNumberGame('single', playerName);
            } else if (gameType === 'retos') { // NEW
                startRetosGame('single', playerName);
            }
        }

        // --- Trivia Game Logic ---
        const initialTriviaQuestions = [ // Renamed to initialTriviaQuestions
            { category: "Ciencia", question: "¿Cuál es el planeta más grande de nuestro sistema solar?", answers: ["Júpiter", "Saturno", "Tierra", "Marte"], correct: 0, explanation: "Júpiter es tan grande que todos los demás planetas del sistema solar podrían caber dentro de él." },
            { category: "Ciencia", question: "¿Qué parte de la planta absorbe el agua y los nutrientes del suelo?", answers: ["Las hojas", "Las flores", "Las raíces", "El tallo"], correct: 2, explanation: "Las raíces son las encargadas de absorber el agua y los nutrientes que la planta necesita para crecer." },
            { category: "Ciencia", question: "¿Qué gas necesitan las plantas para hacer la fotosíntesis?", answers: ["Oxígeno", "Dióxido de carbono", "Nitrógeno", "Hidrógeno"], correct: 1, explanation: "Las plantas absorben dióxido de carbono del aire para realizar la fotosíntesis y producen oxígeno como resultado." },
            { category: "Ciencia", question: "¿Cuál es el hueso más largo del cuerpo humano?", answers: ["El fémur", "La columna vertebral", "El cráneo", "La tibia"], correct: 0, explanation: "El fémur, que está en el muslo, es el hueso más largo del cuerpo humano." },
            { category: "Ciencia", question: "¿Qué planeta es conocido como 'el planeta rojo'?", answers: ["Venus", "Marte", "Júpiter", "Saturno"], correct: 1, explanation: "Marte es conocido como 'el planeta rojo' debido al óxido de hierro en su superficie que le da ese color característico." },
            { category: "Ciencia", question: "¿Qué tipo de animal es una ballena?", answers: ["Un pez", "Un anfibio", "Un mamífero", "Un reptil"], correct: 2, explanation: "¡Correcto! Las ballenas son mamíferos marinos, no peces. Respiran aire, dan a luz crías vivas y amamantan a sus bebés." },
            { category: "Ciencia", question: "¿Qué fuerza nos mantiene pegados al suelo de la Tierra?", answers: ["El magnetismo", "La gravedad", "La fricción", "La presión atmosférica"], correct: 1, explanation: "La gravedad es la fuerza invisible que nos mantiene pegados a la Tierra y hace que los objetos caigan cuando los soltamos." },
            { category: "Ciencia", question: "¿Qué parte del cuerpo bombea la sangre?", answers: ["Los pulmones", "El cerebro", "El corazón", "El estómago"], correct: 2, explanation: "El corazón es el órgano encargado de bombear la sangre por todo el cuerpo a través de los vasos sanguíneos." },
            { category: "Ciencia", question: "¿Qué gas es el más abundante en la atmósfera de la Tierra?", answers: ["Oxígeno", "Dióxido de carbono", "Nitrógeno", "Hidrógeno"], correct: 2, explanation: "El nitrógeno es el gas más abundante en la atmósfera terrestre, representando aproximadamente el 78% del aire que respiramos." },
            { category: "Ciencia", question: "¿Qué tipo de energía usa una bicicleta para moverse?", answers: ["Energía eléctrica", "Energía nuclear", "Energía eólica", "Energía mecánica"], correct: 3, explanation: "Una bicicleta convierte la energía mecánica del pedaleo en movimiento hacia adelante." },
            { category: "Tecnología", question: "¿Qué significa la sigla 'GB' cuando hablamos de almacenamiento en un teléfono o computadora?", answers: ["GigaByte", "GigaBit", "GigaBase", "Gran Botón"], correct: 0, explanation: "GB significa GigaByte, que es una unidad de almacenamiento digital. 1 GB equivale a aproximadamente 1,000 millones de bytes." },
            { category: "Tecnología", question: "¿Qué empresa creó el sistema operativo Windows?", answers: ["Apple", "Microsoft", "Google", "Samsung"], correct: 1, explanation: "Microsoft es la empresa que creó y desarrolla el sistema operativo Windows, que es uno de los más usados en computadoras personales." },
            { category: "Tecnología", question: "¿Qué dispositivo nos permite conectarnos a Internet de forma inalámbrica en casa?", answers: ["Monitor", "Teclado", "Router WiFi", "Impresora"], correct: 2, explanation: "El router WiFi es el dispositivo que crea una red inalámbrica en casa, permitiendo que otros dispositivos se conecten a Internet sin cables." },
            { category: "Tecnología", question: "¿Qué es un 'smartphone'?", answers: ["Un teléfono antiguo con cable", "Un teléfono inteligente con pantalla táctil", "Un reloj digital", "Una tableta grande"], correct: 1, explanation: "Un smartphone es un teléfono inteligente con pantalla táctil, que puede ejecutar aplicaciones y conectarse a Internet, además de hacer llamadas." },
            { category: "Tecnología", question: "¿Qué significan las siglas 'URL' en Internet?", answers: ["Universal Resource Locator", "United Radio Link", "User Registration Link", "Ultra Rapid Link"], correct: 0, explanation: "URL significa 'Localizador Uniforme de Recursos' (Universal Resource Locator), que es básicamente la dirección de una página web en Internet." },
            { category: "Tecnología", question: "¿Qué botón del teclado se usa para borrar el carácter que está a la izquierda del cursor?", answers: ["Enter", "Shift", "Barra espaciadora", "Retroceso (Backspace)"], correct: 3, explanation: "La tecla Retroceso o Backspace (a menudo marcada con una flecha hacia la izquierda) borra el carácter que está a la izquierda del cursor." },
            { category: "Tecnología", question: "¿Qué dispositivo de entrada nos permite controlar el puntero en la pantalla de la computadora?", answers: ["El teclado", "El ratón (mouse)", "La impresora", "El monitor"], correct: 1, explanation: "El ratón o mouse es el dispositivo que nos permite mover el puntero en la pantalla y hacer clic en los elementos." },
            { category: "Tecnología", question: "¿Qué significa 'descargar' un archivo de Internet撈", answers: ["Eliminar un archivo", "Copiar un archivo de Internet a tu dispositivo", "Mover un archivo a la papelera", "Comprimir un archivo"], correct: 1, explanation: "Descargar significa copiar un archivo o información de Internet a tu computadora, teléfono u otro dispositivo." },
            { category: "Tecnología", question: "¿Qué aplicación te permite hacer videollamadas con otras personas?", answers: ["Word", "Excel", "Zoom o Meet", "PowerPoint"], correct: 2, explanation: "Aplicaciones como Zoom, Google Meet o Microsoft Teams permiten hacer videollamadas con varias personas a la vez." },
            { category: "Tecnología", question: "¿Qué debes hacer si recibes un mensaje de un desconocido pidiendo información personal?", answers: ["Responder con mis datos", "Compartirlo con mis amigos", "No responder y avisar a un adulto", "Hacer clic en los enlaces que envíe"], correct: 2, explanation: "Nunca debes compartir información personal con desconocidos. Es importante no responder y avisar a un adulto de confianza." },
            { category: "Geografía de España", question: "¿Cuál es la capital de España?", answers: ["Barcelona", "Madrid", "Valencia", "Sevilla"], correct: 1, explanation: "Madrid es la capital de España y la ciudad más poblada del país, situada en el centro de la península ibérica." },
            { category: "Geografía de España", question: "¿Qué gran cadena montañosa separa España de Francia?", answers: ["Los Pirineos", "Los Alpes", "Sierra Nevada", "Sistema Central"], correct: 0, explanation: "Los Pirineos son una cordillera que forma una frontera natural entre España y Francia, extendiéndose desde el mar Cantábrico hasta el mar Mediterráneo." },
            { category: "Geografía de España", question: "¿Cuál es el río más largo de España?", answers: ["Tajo", "Ebro", "Guadiana", "Guadalquivir"], correct: 1, explanation: "El río Ebro es el más largo de España, con 930 km de longitud, y desemboca en el mar Mediterráneo formando un gran delta en Tarragona." },
            { category: "Geografía de España", question: "¿Qué islas españolas se encuentran en el océano Atlántico?", answers: ["Islas Baleares", "Islas Cíes", "Islas Canarias", "Islas Columbretes"], correct: 2, explanation: "Las Islas Canarias son un archipiélago español en el océano Atlántico, frente a la costa noroeste de África." },
            { category: "Geografía de España", question: "¿Qué comunidad autónoma es conocida como 'La Tierra de los Mil Vinos'?", answers: ["La Rioja", "Andalucía", "Galicia", "Castilla y León"], correct: 0, explanation: "La Rioja es famosa por sus vinos de alta calidad, con una tradición vinícola que se remonta a la época romana." },
            { category: "Geografía de España", question: "¿En qué comunidad autónoma se encuentra la ciudad de Santiago de Compostela?", answers: ["Asturias", "Galicia", "Cantabria", "País Vasco"], correct: 1, explanation: "Santiago de Compostela es la capital de Galicia y un importante lugar de peregrinación por ser el final del Camino de Santiago." },
            { category: "Geografía de España", question: "¿Qué mar baña la costa este de España?", answers: ["Océano Atlántico", "Mar Cantábrico", "Mar Mediterráneo", "Mar de Alborán"], correct: 2, explanation: "El mar Mediterráneo baña la costa este y sureste de España, desde Cataluña hasta Andalucía." },
            { category: "Geografía de España", question: "¿Cuál es el pico más alto de la península ibérica?", answers: ["Monte Perdido", "Teide", "Mulhacén", "Aneto"], correct: 3, explanation: "El Aneto, con 3.404 metros, es el pico más alto de los Pirineos y de la península ibérica. El Teide es más alto pero está en Canarias." },
            { category: "Geografía de España", question: "¿Qué comunidad autónoma está formada por las provincias de Cáceres y Badajoz?", answers: ["Castilla-La Mancha", "Andalucía", "Extremadura", "Castilla y León"], correct: 2, explanation: "Extremadura es la comunidad formada por las provincias de Cáceres y Badajoz, en el oeste de España, haciendo frontera con Portugal." },
            { category: "Geografía de España", question: "¿Qué gran desierto se encuentra en la provincia de Almería?", answers: ["Desierto de Tabernas", "Desierto de Monegros", "Desierto de Bárdenas", "Desierto de Gorafe"], correct: 0, explanation: "El desierto de Tabernas en Almería es el único desierto propiamente dicho de Europa y ha sido escenario de numerosas películas del oeste." },
            { category: "Geografía de Andalucía", question: "¿Cuál es la capital de Andalucía?", answers: ["Sevilla", "Málaga", "Granada", "Córdoba"], correct: 0, explanation: "Sevilla es la capital de la comunidad autónoma de Andalucía y una de las ciudades más importantes del sur de España." },
            { category: "Geografía de Andalucía", question: "¿Qué río andaluz es el más largo de Andalucía y el quinto de la península?", answers: ["Guadalquivir", "Guadiana", "Genil", "Guadalhorce"], correct: 0, explanation: "El río Guadalquivir, con 657 km, es el río más largo de Andalucía. Pasa por ciudades como Córdoba y Sevilla." },
            { category: "Geografía de Andalucía", question: "¿Qué cadena montañosa separa Andalucía de la meseta central?", answers: ["Sierra Morena", "Sierra Nevada", "Sierra de Grazalema", "Sierra de Cazorla"], correct: 0, explanation: "Sierra Morena actúa como frontera natural entre Andalucía y la meseta central de España." },
            { category: "Geografía de Andalucía", question: "¿En qué provincia andaluza se encuentra el Parque Nacional de Doñana?", answers: ["Huelva", "Cádiz", "Sevilla", "Málaga"], correct: 0, explanation: "El Parque Nacional de Doñana se encuentra principalmente en la provincia de Huelva, aunque también se extiende por Sevilla y Cádiz." },
            { category: "Geografía de Andalucía", question: "¿Qué estrecho separa España de África y conecta el océano Atlántico con el mar Mediterráneo?", answers: ["Estrecho de Gibraltar", "Estrecho de Bonifacio", "Estrecho de Mesina", "Estrecho de Magallanes"], correct: 0, explanation: "El estrecho de Gibraltar separa España de Marruecos y conecta el océano Atlántico con el mar Mediterráneo." },
            { category: "Geografía de Andalucía", question: "¿Qué montaña de Sierra Nevada es el pico más alto de la península ibérica?", answers: ["Mulhacén", "Veleta", "Alcazaba", "Chullo"], correct: 0, explanation: "El Mulhacén, con 3.479 metros, es el pico más alto de la península ibérica y el segundo más alto de España tras el Teide." },
            { category: "Geografía de Andalucía", question: "¿Qué mar baña la costa de la provincia de Almería?", answers: ["Mar Mediterráneo", "Océano Atlántico", "Mar Cantábrico", "Mar de Alborán"], correct: 3, explanation: "La provincia de Almería está bañada por el mar de Alborán, que es la parte más occidental del mar Mediterráneo." },
            { category: "Geografía de Andalucía", question: "¿Qué parque natural andaluz es conocido como 'la sierra de la nieve'?", answers: ["Sierra de Grazalema", "Sierra de Cazorla", "Sierra de Aracena", "Sierra de las Nieves"], correct: 3, explanation: "La Sierra de las Nieves, en Málaga, es un parque natural conocido por sus bosques de pinsapos y sus paisajes nevados en invierno." },
            { category: "Geografía de Andalucía", question: "¿Qué provincia andaluza es la más poblada?", answers: ["Sevilla", "Málaga", "Cádiz", "Granada"], correct: 0, explanation: "Sevilla es la provincia más poblada de Andalucía, seguida de Málaga y Cádiz." },
            { category: "Geografía de Andalucía", question: "¿Qué río pasa por la ciudad de Córdoba?", answers: ["Guadiana", "Guadalquivir", "Genil", "Guadalhorce"], correct: 1, explanation: "El río Guadalquivir pasa por Córdoba, donde se encuentra el famoso Puente Romano que lo cruza." },
            { category: "Cuerpo Humano", question: "¿Cuál es el órgano más grande del cuerpo humano?", answers: ["El cerebro", "El corazón", "La piel", "El hígado"], correct: 2, explanation: "La piel es el órgano más grande del cuerpo humano. En un adulto puede pesar hasta 4 kg y cubrir una superficie de 2 m²." },
            { category: "Cuerpo Humano", question: "¿Cuántos huesos tiene el cuerpo humano de un adulto?", answers: ["106", "206", "306", "156"], correct: 1, explanation: "El cuerpo humano de un adulto tiene 206 huesos. Los bebés nacen con unos 300 huesos que se van fusionando a medida que crecen." },
            { category: "Cuerpo Humano", question: "¿Qué parte del cuerpo produce la bilis para ayudar a digerir las grasas?", answers: ["El estómago", "El páncreas", "El hígado", "El intestino delgado"], correct: 2, explanation: "El hígado produce la bilis, que se almacena en la vesícula biliar y ayuda a descomponer las grasas durante la digestión." },
            { category: "Cuerpo Humano", question: "¿Qué glóbulos de la sangre son los encargados de combatir las infecciones?", answers: ["Glóbulos rojos", "Plaquetas", "Glóbulos blancos", "Plasma"], correct: 2, explanation: "Los glóbulos blancos o leucocitos son las células de la sangre que nos protegen de las infecciones y enfermedades." },
            { category: "Cuerpo Humano", question: "¿Cuál es el músculo más fuerte del cuerpo humano en relación a su tamaño?", answers: ["El cuádriceps", "El glúteo mayor", "La lengua", "El bíceps"], correct: 2, explanation: "La lengua es el músculo más fuerte en relación a su tamaño. Aunque es pequeña, es muy poderosa y trabaja constantemente." },
            { category: "Cuerpo Humano", question: "¿Qué parte del ojo controla la cantidad de luz que entra en él?", answers: ["El cristalino", "La retina", "El iris", "La córnea"], correct: 2, explanation: "El iris es la parte coloreada del ojo que controla el tamaño de la pupila, regulando así la cantidad de luz que entra en el ojo." },
            { category: "Cuerpo Humano", question: "¿Cuál de estos órganos NO forma parte del sistema respiratorio?", answers: ["Tráquea", "Pulmones", "Diafragma", "Estómago"], correct: 3, explanation: "El estómago es parte del sistema digestivo, no del respiratorio. La tráquea, los pulmones y el diafragma sí forman parte del sistema respiratorio." },
            { category: "Cuerpo Humano", question: "¿Cuántos dientes tiene normalmente una persona adulta, incluyendo las muelas del juicio?", answers: ["24", "28", "32", "36"], correct: 2, explanation: "Un adulto normalmente tiene 32 dientes, incluyendo las 4 muelas del juicio, aunque no a todo el mundo le salen." },
            { category: "Cuerpo Humano", question: "¿Qué hueso protege el cerebro?", answers: ["El esternón", "La columna vertebral", "El cráneo", "Las costillas"], correct: 2, explanation: "El cráneo es el conjunto de huesos que forman la cabeza y protegen el cerebro de posibles golpes o lesiones." },
            { category: "Cuerpo Humano", question: "¿Qué parte del cuerpo contiene aproximadamente el 70% de agua?", answers: ["Los huesos", "La sangre", "El cerebro", "La piel"], correct: 2, explanation: "El cerebro humano está compuesto por aproximadamente un 70% de agua, por eso es importante mantenerse bien hidratado para pensar con claridad." },
            { category: "Inglés", question: "¿Cómo se dice 'perro' en inglés?", answers: ["Cat", "Dog", "Bird", "Fish"], correct: 1, explanation: "'Dog' es la palabra en inglés para 'perro'. 'Cat' es gato, 'bird' es pájaro y 'fish' es pez." },
            { category: "Inglés", question: "¿Cuál es la traducción correcta de 'libro' al inglés?", answers: ["Book", "Look", "Cook", "Took"], correct: 0, explanation: "'Book' significa 'libro' en inglés. Las otras opciones son verbos: 'look' (mirar), 'cook' (cocinar) y 'took' (tomó)." },
            { category: "Inglés", question: "¿Cómo se dice 'gracias' en inglés?", answers: ["Hello", "Please", "Thank you", "Sorry"], correct: 2, explanation: "'Thank you' significa 'gracias' en inglés. 'Hello' es hola, 'please' es por favor y 'sorry' es lo siento." },
            { category: "Inglés", question: "¿Qué palabra en inglés significa 'grande'?", answers: ["Small", "Big", "Little", "Tiny"], correct: 1, explanation: "'Big' significa 'grande' en inglés. 'Small' y 'little' significan pequeño, y 'tiny' significa muy pequeño." },
            { category: "Inglés", question: "¿Cómo se dice 'rojo' en inglés?", answers: ["Blue", "Green", "Red", "Yellow"], correct: 2, explanation: "'Red' es la palabra en inglés para 'rojo'. 'Blue' es azul, 'green' es verde y 'yellow' es amarillo." },
            { category: "Inglés", question: "¿Qué palabra inglesa completa la frase: 'I ___ a student'?", answers: ["Is", "Am", "Are", "Be"], correct: 1, explanation: "La frase correcta es 'I am a student' (Yo soy un estudiante). En inglés, 'I' siempre va con 'am'." },
            { category: "Inglés", question: "¿Cómo se dice 'hermano' en inglés?", answers: ["Sister", "Mother", "Father", "Brother"], correct: 3, explanation: "''Brother' significa 'hermano' en inglés. 'Sister' es hermana, 'mother' es madre y 'father' es padre." },
            { category: "Inglés", question: "¿Qué palabra inglesa significa 'feliz'?", answers: ["Sad", "Happy", "Angry", "Tired"], correct: 1, explanation: "'Happy' significa 'feliz' en inglés. 'Sad' es triste, 'angry' es enojado y 'tired' es cansado." },
            { category: "Inglés", question: "¿Cómo se dice 'uno' en inglés?", answers: ["Two", "One", "Three", "Four"], correct: 1, explanation: "'One' es 'uno' en inglés. 'Two' es dos, 'three' es tres y 'four' es cuatro." },
            { category: "Inglés", question: "¿Qué palabra inglesa completa la frase: 'The cat is ___ the table'?", answers: ["On", "In", "At", "By"], correct: 0, explanation: "La frase correcta es 'The cat is on the table' (El gato está sobre la mesa). 'On' se usa para indicar que algo está sobre una superficie." },
            { category: "Inteligencia Artificial", question: "¿Qué significa la abreviatura 'IA'?", answers: ["Inteligencia Asistida", "Inteligencia Artificial", "Informática Avanzada", "Interfaz Automatizada"], correct: 1, explanation: "IA significa 'Inteligencia Artificial', que es la capacidad de las máquinas para realizar tareas que normalmente requieren inteligencia humana, como aprender y resolver problemas." },
            { category: "Inteligencia Artificial", question: "¿Qué es un chatbot?", answers: ["Un robot que limpia la casa", "Un programa que simula conversaciones humanas", "Un tipo de videojuego", "Un teléfono inteligente"], correct: 1, explanation: "Un chatbot es un programa de computadora que simula conversaciones con personas, a menudo usando IA para responder preguntas o ayudar con tareas." },
            { category: "Inteligencia Artificial", question: "¿Qué tipo de IA puede reconocer lo que hay en una imagen?", answers: ["Reconocimiento de voz", "Visión por computadora", "Robótica avanzada", "Análisis de datos"], correct: 1, explanation: "La visión por computadora es el campo de la IA que permite a las computadoras entender e interpretar imágenes, como reconocer objetos en fotos." },
            { category: "Inteligencia Artificial", question: "¿Qué es el aprendizaje automático o 'machine learning'?", answers: ["Cuando los robots construyen máquinas", "Cuando las computadoras aprenden de la experiencia sin ser programadas explícitamente", "Cuando los teléfonos se cargan solos", "Cuando los videojuegos se juegan solos"], correct: 1, explanation: "El aprendizaje automático es cuando las computadoras aprenden patrones de los datos y mejoran con la experiencia, sin necesidad de ser programadas para cada tarea específica." },
            { category: "Inteligencia Artificial", question: "¿Qué tipo de IA puede entender y responder al lenguaje hablado?", answers: ["Robótica", "Procesamiento de lenguaje natural", "Redes neuronales", "Realidad virtual"], correct: 1, explanation: "El procesamiento de lenguaje natural (PLN) es el campo de la IA que permite a las computadoras entender, interpretar y responder al lenguaje humano hablado o escrito." },
            { category: "Inteligencia Artificial", question: "¿Qué es un asistente virtual como Siri o Alexa?", answers: ["Un robot con forma humana", "Un programa de IA que responde a comandos de voz", "Un tipo de videojuego", "Un dispositivo para cargar el teléfono"], correct: 1, explanation: "Asistentes como Siri o Alexa son programas de IA que usan reconocimiento de voz y procesamiento de lenguaje natural para responder preguntas y realizar tareas mediante comandos de voz." },
            { category: "Inteligencia Artificial", question: "¿Qué es una red neuronal artificial?", answers: ["Un tipo de red social", "Un sistema informático inspirado en el cerebro humano", "Un nuevo tipo de internet", "Un juego de ordenador"], correct: 1, explanation: "Una red neuronal artificial es un sistema informático modelado a partir del cerebro humano, que puede aprender a reconocer patrones y tomar decisiones basadas en datos." },
            { category: "Inteligencia Artificial", question: "¿Qué es un robot?", answers: ["Solo un juguete", "Un programa de computadora", "Una máquina que puede realizar tareas automáticamente", "Un tipo de teléfono"], correct: 2, explanation: "Un robot es una máquina programable que puede realizar tareas de manera automática, a veces con la ayuda de IA. No todos los robots tienen forma humana." },
            { category: "Inteligencia Artificial", question: "¿Qué es el reconocimiento facial?", answers: ["Una forma de identificar personas en fotos usando IA", "Un tipo de maquillaje", "Una red social", "Un juego de adivinanzas"], correct: 0, explanation: "El reconocimiento facial es una tecnología de IA que puede identificar o verificar a una persona a partir de una imagen o video, analizando patrones en sus rasgos faciales." },
            { category: "Inteligencia Artificial", question: "¿Qué es un algoritmo en IA?", answers: ["Un tipo de robot", "Un conjunto de pasos para resolver un problema", "Un lenguaje de programación", "Un dispositivo de almacenamiento"], correct: 1, explanation: "Un algoritmo es un conjunto de instrucciones paso a paso que una computadora sigue para resolver un problema o realizar una tarea. En IA, los algoritmos ayudan a las máquinas a aprender de los datos." },
            { category: "Deportes", question: "Verdadero o Falso: Los Juegos Olímpicos se celebran cada 5 años.", answers: ["Verdadero", "Falso"], correct: 1, explanation: "Falso. Los Juegos Olímpicos de Verano e Invierno se celebran cada 4 años." },
            
            // New questions about Málaga
            { category: "Historia de Málaga", question: "¿Qué famoso artista nació en Málaga?", answers: ["Pablo Picasso", "Salvador Dalí", "Francisco Goya", "Diego Velázquez"], correct: 0, explanation: "Pablo Picasso, uno de los artistas más influyentes del siglo XX, nació en Málaga." },
            { category: "Historia de Málaga", question: "¿Cómo se llama la fortaleza palaciega de origen musulmán en Málaga?", answers: ["La Alhambra", "La Alcazaba", "El Generalife", "El Real Alcázar"], correct: 1, explanation: "La Alcazaba es una impresionante fortaleza palaciega de la época musulmana en Málaga." },
            { category: "Historia de Málaga", question: "¿Qué civilización fundó Malaka, el primer asentamiento en la actual Málaga?", answers: ["Romanos", "Griegos", "Fenicios", "Visigodos"], correct: 2, explanation: "Los fenicios fundaron Malaka, el origen de la ciudad de Málaga, alrededor del siglo VIII a.C." },
            { category: "Historia de Málaga", question: "¿Qué importante evento histórico ocurrió en Málaga en 1487?", answers: ["La Batalla de Las Navas de Tolosa", "La Conquista por los Reyes Católicos", "La Invasión Napoleónica", "La Peste Negra"], correct: 1, explanation: "En 1487, Málaga fue conquistada por los Reyes Católicos, marcando el fin del dominio musulmán en la ciudad." },
            { category: "Historia de Málaga", question: "¿Qué ruinas romanas se encuentran al pie de la Alcazaba de Málaga?", answers: ["Anfiteatro de Mérida", "Acueducto de Segovia", "Teatro Romano", "Templo de Diana"], correct: 2, explanation: "El Teatro Romano de Málaga, descubierto en 1951, se encuentra a los pies de la Alcazaba." },
            { category: "Curiosidades de Málaga", question: "¿Cuál es el nombre de la flor típica de Málaga, hecha con jazmines?", answers: ["Clavel", "Rosa", "Biznaga", "Orquídea"], correct: 2, explanation: "La biznaga es un ramillete artesanal de jazmines, muy representativo de Málaga." },
            { category: "Curiosidades de Málaga", question: "¿Cómo se conoce popularmente a los habitantes de Málaga?", answers: ["Gatos", "Pescaitos", "Boquerones", "Chulos"], correct: 2, explanation: "A los malagueños se les conoce cariñosamente como 'boquerones', por el pescado típico de la zona." },
            { category: "Curiosidades de Málaga", question: "¿Qué apodo recibe la Catedral de Málaga por su torre incompleta?", answers: ["La Coja", "La Tuerta", "La Manquita", "La Incompleta"], correct: 2, explanation: "La Catedral de Málaga es conocida como 'La Manquita' porque su torre sur nunca fue terminada." },
            { category: "Curiosidades de Málaga", question: "¿Qué tipo de clima predomina en Málaga?", answers: ["Oceánico", "Continental", "Desértico", "Mediterráneo subtropical"], correct: 3, explanation: "Málaga goza de un clima mediterráneo subtropical, con inviernos suaves y veranos cálidos." },
            { category: "Curiosidades de Málaga", question: "¿Qué celebración famosa tiene lugar en Málaga en agosto?", answers: ["Semana Santa", "Carnaval", "Feria de Málaga", "Navidad"], correct: 2, explanation: "La Feria de Málaga es una de las fiestas más importantes y concurridas de la ciudad, celebrada en agosto." },
            { category: "Comida de Málaga", question: "¿Cuál es el plato de pescado a la brasa más típico de Málaga?", answers: ["Paella", "Pulpo a la gallega", "Espetos de sardinas", "Calamares a la romana"], correct: 2, explanation: "Los espetos de sardinas, ensartadas en cañas y asadas a la brasa en la playa, son un icono de la gastronomía malagueña." },
            { category: "Comida de Málaga", question: "¿Qué sopa fría malagueña se elabora con almendras, ajo y pan?", answers: ["Gazpacho", "Salmorejo", "Ajoblanco", "Porra antequerana"], correct: 2, explanation: "El ajoblanco es una deliciosa sopa fría de origen malagueña, ideal para el verano." },
            { category: "Comida de Málaga", question: "¿Cómo se llama la fritura variada de pescado típica de Málaga?", answers: ["Mariscada", "Pescado a la sal", "Fritura Malagueña", "Gambas al pil-pil"], correct: 2, explanation: "La fritura malagueña es un surtido de pescado frito, muy popular en los chiringuitos de la costa." },
            { category: "Comida de Málaga", question: "¿Qué producto dulce y seco de la vid es muy famoso en Málaga?", answers: ["Uvas", "Vino dulce", "Pasas de Málaga", "Mosto"], correct: 2, explanation: "Las pasas de Málaga, especialmente las de la variedad Moscatel, tienen Denominación de Origen." },
            { category: "Comida de Málaga", question: "¿Qué tipo de vino dulce es famoso en Málaga?", answers: ["Rioja", "Ribera del Duero", "Jerez", "Vino de Málaga"], correct: 3, explanation: "El Vino de Málaga, con sus distintas variedades y dulzuras, es un producto vinícola con gran tradición." },
            { category: "Deporte en Málaga", question: "¿Cuál es el equipo de fútbol más representativo de la ciudad de Málaga?", answers: ["Real Betis", "Sevilla FC", "Málaga Club de Fútbol", "Granada CF"], correct: 2, explanation: "El Málaga Club de Fútbol es el equipo de fútbol más emblemático de la ciudad." },
            { category: "Deporte en Málaga", question: "¿En qué deporte destaca el Unicaja de Málaga?", answers: ["Fútbol", "Baloncesto", "Balonmano", "Voleibol"], correct: 1, explanation: "El Unicaja es uno de los equipos de baloncesto más importantes de España y Europa." },
            { category: "Deporte en Málaga", question: "¿Qué estadio es la sede del Málaga CF?", answers: ["Santiago Bernabéu", "Camp Nou", "Estadio La Rosaleda", "Estadio de La Cartuja"], correct: 2, explanation: "El Estadio La Rosaleda es el hogar del Málaga Club de Fútbol." },
            { category: "Deporte en Málaga", question: "¿Málaga ha sido sede de algún evento deportivo internacional importante?", answers: ["No, nunca", "Sí, solo eventos locales", "Sí, por ejemplo, la Copa Davis de tenis", "Solo competiciones de natación"], correct: 2, explanation: "Málaga ha albergado eventos de prestigio internacional, como fases finales de la Copa Davis de tenis." },
            { category: "Deporte en Málaga", question: "¿Qué deporte acuático es popular en la costa de Málaga, además de la natación?", answers: ["Esquí alpino", "Patinaje sobre hielo", "Surf", "Ciclismo de montaña"], correct: 2, explanation: "La costa de Málaga ofrece buenas condiciones para deportes acuáticos como el surf, el paddle surf o el windsurf." },
            {
    "category": "Historia del club",
    "question": "¿En qué año fue fundado el actual Juventud de Torremolinos C.F.?",
    "answers": ["1932", "1942", "1958", "1969"],
    "correct": 2,
    "explanation": "El Juventud de Torremolinos C.F. fue fundado en **1958** por D. Pedro Navarro Bruna [1]. Anteriormente existieron otros clubes como el C.F. Torremolinos (1932) [2] y el C.D. Torremolinos (1942) [3]."
  },
  {
    "category": "Historia del club",
    "question": "¿Quién fundó el Juventud de Torremolinos C.F. tal como lo conocemos hoy en día?",
    "answers": ["D. Miguel Cerdán", "Don Antonio Moya", "D. Pedro Navarro Bruna", "Vicente Peña Castillo"],
    "correct": 2,
    "explanation": "El Juventud de Torremolinos C.F. fue fundado en 1958 por **D. Pedro Navarro Bruna** [1]. D. Miguel Cerdán fundó el C.F. Torremolinos en 1932 [2], Don Antonio Moya fundó el C.D. Torremolinos en 1942 [3], y Vicente Peña Castillo fundó el equipo juvenil 'Los Leones' en 1969 [4]."
  },
  {
    "category": "Instalaciones",
    "question": "¿Cuál es el nombre del estadio principal donde juega el Juventud Torremolinos C.F.?",
    "answers": ["Estadio Ciudad de Málaga", "Estadio Municipal “El Pozuelo”", "Estadio La Rosaleda", "Campo de Aviación"],
    "correct": 1,
    "explanation": "El equipo juega en el **Estadio Municipal “El Pozuelo”** [5-7]."
  },
  {
    "category": "Instalaciones",
    "question": "¿Cuál es la capacidad de espectadores del Estadio Municipal “El Pozuelo”?",
    "answers": ["1.000 personas", "2.000 personas", "3.000 personas", "5.000 personas"],
    "correct": 2,
    "explanation": "El Estadio Municipal “El Pozuelo” tiene una capacidad de **3.000 personas** [6-8]."
  },
  {
    "category": "Logros deportivos",
    "question": "¿Cuál fue el reciente ascenso histórico logrado por el Juventud Torremolinos C.F. en mayo de 2025?",
    "answers": ["Ascenso a Segunda División B", "Ascenso a la Liga SmartBank", "Ascenso a Primera RFEF/Primera Federación", "Ascenso a Tercera División"],
    "correct": 2,
    "explanation": "El Juventud Torremolinos C.F. logró un histórico **ascenso a Primera RFEF/Primera Federación** en mayo de 2025 [9-11], siendo la primera vez en su historia que militan en esta categoría [5] y su segundo ascenso consecutivo [9-13]."
  },
  {
    "category": "Equipo técnico",
    "question": "¿Quién es el entrenador principal del primer equipo del Juventud Torremolinos para la temporada 2024/2025?",
    "answers": ["Luis Pellicer", "Ibon Pérez", "José Miguel Ramírez", "Antonio Calderón Burgos"],
    "correct": 3,
    "explanation": "El entrenador principal del primer equipo para la temporada 2024/2025 es **Antonio Calderón Burgos** [7, 14, 15]. Luis Pellicer fue un entrenador anterior que los llevó a Tercera División [16], e Ibon Pérez era el entrenador en 2021 [17]. José Miguel Ramírez Quintero es el segundo entrenador [14, 15]."
  },
  {
    "category": "Partidos",
    "question": "¿Cuál fue el resultado del partido del Juventud Torremolinos C.F. que aseguró su ascenso directo a Primera RFEF?",
    "answers": ["Ganó 3-0", "Empató 1-1", "Perdió 2-1", "Ganó 5-0"],
    "correct": 3,
    "explanation": "El Juventud Torremolinos se impuso por un contundente **5-0 a la Deportiva Minera** para asegurar su ascenso directo [11, 13, 18], combinado con la derrota de La Unión Atlético por 2-1 ante la Balompédica Linense por 2-1 [13, 18, 19]."
  },
  {
    "category": "Gestión del club",
    "question": "¿Qué grupo se hizo cargo del club Juventud Torremolinos hace unos años?",
    "answers": ["Grupo Sol Sports", "ACA Football Partners", "Grupo Málaga CF", "Inversiones Torremolinos"],
    "correct": 1,
    "explanation": "El grupo japonés **ACA Football Partners** se hizo cargo del club dos años y medio antes de su ascenso histórico en mayo de 2025, cuando el club acababa de descender a Tercera RFEF [7, 10]."
  },
  {
    "category": "Cantera",
    "question": "¿Cuál fue el nombre del equipo juvenil fundado en 1969 que se considera el creador de la cantera local del Juventud de Torremolinos?",
    "answers": ["Juvenil A", "Nuevo Atlético Torremolinos", "Los Leones", "Benjamín B"],
    "correct": 2,
    "explanation": "El equipo juvenil **'Los Leones'** fue fundado en **1969** por Vicente Peña Castillo [4] y se considera el creador de la cantera local del Juventud de Torremolinos [4], pasando a formar parte del club en 1975 [4]. El Nuevo Atlético Torremolinos fue otro equipo absorbido en 1972 [20, 21], pero no el creador de la cantera." },
  {
    "category": "Historia del club",
    "question": "¿Cuál fue el primer club de fútbol fundado en Torremolinos, en 1932?",
    "answers": ["Juventud de Torremolinos C.F.", "C.D. Torremolinos", "C.F. Torremolinos", "Balompié Torremolinos"],
    "correct": 2,
    "explanation": "El primer club de fútbol fundado en Torremolinos, en **1932**, fue el **C.F. Torremolinos**, fundado por D. Miguel Cerdán [2]. El C.D. Torremolinos apareció en 1942 [3], y el Juventud de Torremolinos C.F. en 1958 [1]. Balompié Torremolinos fue un nombre temporal del Juventud [21, 22]."
  },
            // New questions about Policía Nacional
            { category: "Policía Nacional", question: "¿Cuál es el número de teléfono para llamar a la Policía Nacional en caso de emergencia?", answers: ["091", "112", "062", "900"], correct: 0, explanation: "El 091 es el número directo de la Policía Nacional para emergencias. El 112 es el número de emergencias general en Europa." },
            { category: "Policía Nacional", question: "¿Qué animal es el símbolo de la Policía Nacional?", answers: ["Un león", "Un águila", "Un perro", "Un caballo"], correct: 1, explanation: "El águila es el símbolo oficial de la Policía Nacional, representando fuerza y vigilancia." },
            { category: "Policía Nacional", question: "¿Qué color principal tiene el uniforme de la Policía Nacional?", answers: ["Verde", "Azul", "Negro", "Marrón"], correct: 1, explanation: "El uniforme de la Policía Nacional es principalmente de color azul oscuro." },
            { category: "Policía Nacional", question: "¿Los policías nacionales ayudan a las personas cuando están en peligro?", answers: ["Sí, siempre", "Solo a veces", "No, nunca", "Solo si es de día"], correct: 0, explanation: "Sí, los policías nacionales están para ayudar a todas las personas en situaciones de peligro o necesidad." },
            { category: "Policía Nacional", question: "¿Cómo se llama el coche que usa la policía para patrullar y responder a emergencias?", answers: ["Coche de bomberos", "Ambulancia", "Coche patrulla", "Taxi"], correct: 2, explanation: "El coche que usa la policía para sus funciones se llama coche patrulla." },
            { category: "Policía Nacional", question: "¿Qué llevan los policías en la cabeza para protegerse?", answers: ["Gorra", "Sombrero", "Casco", "Pañuelo"], correct: 0, explanation: "Los policías suelen llevar una gorra como parte de su uniforme." },
            { category: "Policía Nacional", question: "¿Qué hacen los policías si ven a alguien haciendo algo malo?", answers: ["Ignorarlo", "Darle un premio", "Detenerlo", "Aplaudirle"], correct: 2, explanation: "Si un policía ve a alguien cometiendo un delito, su deber es detenerlo para proteger a los demás." },
            { category: "Policía Nacional", question: "¿Los perros policía ayudan a encontrar cosas o personas?", answers: ["No, solo son mascotas", "Sí, son muy buenos olfateando", "Solo ladran", "Solo juegan"], correct: 1, explanation: "Sí, los perros policía tienen un olfato increíble y son entrenados para encontrar drogas, explosivos o personas desaparecidas." },
            { category: "Policía Nacional", question: "¿Qué es lo más importante que hace la Policía Nacional por nosotros?", answers: ["Contar chistes", "Cuidar la seguridad de todos", "Cocinar", "Bailar"], correct: 1, explanation: "Lo más importante que hace la Policía Nacional es cuidar de la seguridad de todos los ciudadanos y mantener el orden." },
            { category: "Policía Nacional", question: "¿Si te pierdes en la calle, a quién debes buscar para pedir ayuda?", answers: ["A un desconocido", "A un policía", "A un árbol", "A un pájaro"], correct: 1, explanation: "Si te pierdes, debes buscar a un policía, ellos te ayudarán a encontrar a tus padres o a tu casa." }
        ];
        let triviaQuestions = []; // This will hold the shuffled questions
        let currentTriviaQuestionIndex;
        let triviaGameMode; // 'single' or 'multi'
        let triviaCurrentPlayer; // 1 or 2
        let triviaPlayer1Score;
        let triviaPlayer2Score;
        let triviaPlayer1Name;
        let triviaPlayer2Name;
        const triviaPlayerTurnDisplay = document.getElementById('trivia-player-turn');
        const triviaScoreContainer = document.getElementById('trivia-score-container'); // Changed ID
        const triviaCurrentPlayerTurnDisplay = document.getElementById('trivia-current-player-turn');
        const triviaProgressBar = document.getElementById('trivia-progress-bar'); // Get the progress bar element


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startTrivia(mode, selectedPlayer = null) {
            triviaGameMode = mode;
            currentTriviaQuestionIndex = -1;
            triviaPlayer1Score = 0;
            triviaPlayer2Score = 0;
            triviaCurrentPlayer = 1; // Always start with Player 1
            
            // Shuffle the trivia questions at the start of each game
            triviaQuestions = [...initialTriviaQuestions]; // Copy the original array
            shuffleArray(triviaQuestions);

            // Hide player turn display initially
            triviaPlayerTurnDisplay.classList.add('hidden');
            triviaScoreContainer.innerHTML = ''; // Clear content of the score container

            if (triviaGameMode === 'single') {
                triviaPlayer1Name = selectedPlayer;
                triviaPlayer2Name = null; // No second player in single mode
                triviaScoreContainer.textContent = `${triviaPlayer1Name}: 0`; // Set initial score for single player
            } else { // 'multi'
                triviaPlayer1Name = 'Hugo';
                triviaPlayer2Name = 'Saúl';
                triviaPlayerTurnDisplay.classList.remove('hidden'); // Show player turn for multi-player
                // Set initial score for multi-player mode
                triviaScoreContainer.innerHTML = `${triviaPlayer1Name}: <span id="trivia-player1-score">0</span> | ${triviaPlayer2Name}: <span id="trivia-player2-score">0</span>`;
            }
            // Initialize progress bar to 0%
            triviaProgressBar.style.width = '0%';

            showScreen('trivia-game');
            loadNextTriviaQuestion();
        }

        function loadNextTriviaQuestion() {
            currentTriviaQuestionIndex++;
            if (currentTriviaQuestionIndex >= triviaQuestions.length) {
                endTriviaGame();
                return;
            }

            // Update progress bar width
            const progress = ((currentTriviaQuestionIndex + 1) / triviaQuestions.length) * 100;
            triviaProgressBar.style.width = `${progress}%`;


            if (triviaGameMode === 'multi') {
                triviaCurrentPlayerTurnDisplay.textContent = `Turno de ${triviaCurrentPlayer === 1 ? triviaPlayer1Name : triviaPlayer2Name}`;
                // Ensure these elements exist before trying to set textContent
                if (document.getElementById('trivia-player1-score')) {
                    document.getElementById('trivia-player1-score').textContent = triviaPlayer1Score;
                }
                if (document.getElementById('trivia-player2-score')) {
                    document.getElementById('trivia-player2-score').textContent = triviaPlayer2Score;
                }
            } else {
                triviaScoreContainer.textContent = `${triviaPlayer1Name}: ${triviaPlayer1Score}`;
            }

            const questionData = triviaQuestions[currentTriviaQuestionIndex];
            document.getElementById('trivia-category').textContent = questionData.category;
            document.getElementById('trivia-question').textContent = questionData.question;
            const answersContainer = document.getElementById('trivia-answers');
            answersContainer.innerHTML = '';

            questionData.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                // Added new class for trivia answer buttons for specific styling
                button.className = "w-full text-left bg-white p-3 rounded-lg shadow-md hover:bg-amber-100 transition active:scale-95 active:opacity-75 duration-100 trivia-answer-button"; 
                button.textContent = answer;
                button.dataset.index = index; // Store index for easy lookup
                button.onclick = () => checkTriviaAnswer(index);
                answersContainer.appendChild(button);
            });
        }
        
        function checkTriviaAnswer(selectedIndex) {
            const questionData = triviaQuestions[currentTriviaQuestionIndex];
            const correct = selectedIndex === questionData.correct;
            const answerButtons = document.querySelectorAll('#trivia-answers .trivia-answer-button');

            // Disable all buttons to prevent multiple clicks
            answerButtons.forEach(button => button.classList.add('disabled'));

            // Apply visual feedback
            answerButtons.forEach((button, index) => {
                if (index === questionData.correct) {
                    button.classList.add('correct'); // Highlight correct answer
                } else if (index === selectedIndex) {
                    button.classList.add('incorrect'); // Highlight selected incorrect answer
                }
            });
            
            if (correct) {
                if (triviaGameMode === 'single') {
                    triviaPlayer1Score += 10;
                } else {
                    if (triviaCurrentPlayer === 1) triviaPlayer1Score += 10;
                    else triviaPlayer2Score += 10;
                }
            }

            // Show modal after a short delay to let animations play
            setTimeout(() => {
                showModal('trivia', {
                    title: correct ? "¡Correcto!" : "¡Oh, no!",
                    explanation: questionData.explanation,
                    correct: correct,
                    nextCallback: () => {
                        closeModal('trivia');
                        // Clean up classes before loading next question
                        answerButtons.forEach(button => {
                            button.classList.remove('correct', 'incorrect', 'disabled');
                        });
                        if (triviaGameMode === 'multi') {
                            triviaCurrentPlayer = triviaCurrentPlayer === 1 ? 2 : 1; // Switch player
                        }
                        loadNextTriviaQuestion();
                    }
                });
            }, 1000); // 1 second delay
        }

        function endTriviaGame() {
            let finalMessage = "";
            let modalOptions = {
                game: 'trivia',
                restartCallback: () => { closeModal('gameOver'); startTrivia(triviaGameMode, triviaPlayer1Name); }
            };
            
            if (triviaGameMode === 'single') {
                saveTriviaHighScore(triviaPlayer1Name, triviaPlayer1Score);
                finalMessage = `¡${triviaPlayer1Name}, tu puntuación final es ${triviaPlayer1Score}! ¡Muy bien jugado!`;
                modalOptions.title = "¡Fin del juego!";
                modalOptions.win = true; // For single player, finishing is a win
            } else { // Multi-player
                if (triviaPlayer1Score > triviaPlayer2Score) {
                    finalMessage = `¡Felicidades ${triviaPlayer1Name}! Ganaste con ${triviaPlayer1Score} puntos contra ${triviaPlayer2Score}.`;
                    modalOptions.title = `¡${triviaPlayer1Name} ha ganado!`;
                    modalOptions.win = true;
                } else if (triviaPlayer2Score > triviaPlayer1Score) {
                    // FIX: Corrected variable names here
                    finalMessage = `¡Felicidades ${triviaPlayer2Name}! Ganaste con ${triviaPlayer2Score} puntos contra ${triviaPlayer1Score}.`;
                    modalOptions.title = `¡${triviaPlayer2Name} ha ganado!`;
                    modalOptions.win = true;
                } else {
                    finalMessage = `¡Es un empate! Ambos jugadores obtuvieron ${triviaPlayer1Score} puntos.`;
                    modalOptions.title = "¡Es un empate!";
                    modalOptions.tie = true;
                }
            }
            modalOptions.message = finalMessage;
            showModal('gameOver', modalOptions);
        }


        // --- Tic-Tac-Toe Logic ---
        let ttt_board;
        let ttt_currentPlayer;
        let ttt_gameActive;
        let ttt_gameMode; // 'ai' or 'human'
        let ttt_player1Name;
        let ttt_player2Name;
        let isTicTacToeMuted = false; // Mute state for Tic-Tac-Toe

        // Sound definitions for Tic-Tac-Toe
        const ttt_sounds = {
            click: new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.05 }
            }).toDestination(),
            win: new Tone.PolySynth(Tone.Synth).toDestination(),
            tie: new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 }
            }).toDestination()
        };

        function playTicTacToeSound(type) {
            Tone.start();
            if (isTicTacToeMuted) return;

            if (type === 'click') {
                ttt_sounds.click.triggerAttackRelease('C5', '8n');
            } else if (type === 'win') {
                ttt_sounds.win.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '8n', Tone.now());
            } else if (type === 'tie') {
                ttt_sounds.tie.triggerAttackRelease('E4', '4n');
            }
        }

        function toggleTicTacToeMute() {
            isTicTacToeMuted = !isTicTacToeMuted;
            const muteButton = document.getElementById('tictactoe-mute-button');
            muteButton.textContent = isTicTacToeMuted ? '🔇' : '🔊';
        }
        
        function startTicTacToe(mode, selectedPlayer = null) { // Added selectedPlayer
            ttt_gameMode = mode;
            if (ttt_gameMode === 'ai') {
                ttt_player1Name = selectedPlayer; // Now uses selectedPlayer for single mode
                ttt_player2Name = '🤖'; // Always 🤖 for AI
            } else { // 'human'
                ttt_player1Name = 'Hugo';
                ttt_player2Name = 'Saúl';
            }
            showScreen('tictactoe-game');
            resetTicTacToe();
        }
        
        function resetTicTacToe() {
            ttt_board = ['', '', '', '', '', '', '', '', ''];
            ttt_currentPlayer = ttt_player1Name; // Start with Player 1's name
            ttt_gameActive = true;
            document.getElementById('tictactoe-status').textContent = `Turno de ${ttt_currentPlayer}`;
            const boardContainer = document.getElementById('tictactoe-board');
            boardContainer.innerHTML = '';

            // Clear the canvas
            const canvas = document.getElementById('tictactoe-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } else {
                 // Re-create the canvas if it was removed
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'tictactoe-canvas';
                newCanvas.className = 'absolute top-0 left-0 w-full h-full pointer-events-none';
                boardContainer.prepend(newCanvas);
            }

            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('button');
                cell.className = "flex items-center justify-center text-5xl md:text-6xl bg-white rounded-lg shadow-inner hover:bg-sky-100 active:scale-95 active:opacity-75 transition-all duration-100"; /* Added active styles */
                cell.dataset.index = i;
                cell.onclick = () => handleCellClick(cell, i);
                boardContainer.appendChild(cell);
            }
        }
        
        function handleCellClick(cell, index) {
            if (ttt_board[index] !== '' || !ttt_gameActive) return;

            playTicTacToeSound('click'); // Play click sound

            // Determine the mark for the current player

            // Determine the mark for the current player
            const currentPlayerMark = ttt_currentPlayer === ttt_player1Name ? 'X' : 'O';
            const opponentMark = ttt_currentPlayer === ttt_player1Name ? 'O' : 'X'; // Opponent's mark

            ttt_board[index] = currentPlayerMark; // Use X/O internally for logic
            cell.textContent = ttt_currentPlayer === ttt_player1Name ? '❌' : '⭕'; // Display emojis
            cell.classList.add('piece-pop-in'); // Apply the pop animation

            const winCondition = checkWin();
            if (winCondition) {
                ttt_gameActive = false;
                // Apply win animation to winning cells
                const cells = document.querySelectorAll('#tictactoe-board button');
                winCondition.forEach(winIndex => {
                    cells[winIndex].classList.add('win-highlight');
                });

                // Delay showing modal to allow animation to play
                setTimeout(() => {
                    playTicTacToeSound('win'); // Play win sound
                    triggerConfetti(); // Trigger confetti on win
                    showModal('gameOver', {
                        title: `¡${ttt_currentPlayer} ha ganado!`,
                        message: `¡Felicidades, ${ttt_currentPlayer}! Eres el campeón del Tres en Raya.`,
                        restartCallback: () => { closeModal('gameOver'); resetTicTacToe(); },
                        game: 'tictactoe',
                        win: true // Indicate it's a win for special styling
                    });
                }, 1500); // 1.5 seconds to see the animation
                return;
            }
            if (ttt_board.every(cell => cell !== '')) {
                ttt_gameActive = false;
                playTicTacToeSound('tie'); // Play tie sound
                showModal('gameOver', {
                    title: "¡Empate!",
                    message: "¡Nadie ganó esta vez! ¡Juega de nuevo para desempatar!",
                    restartCallback: () => { closeModal('gameOver'); resetTicTacToe(); },
                    game: 'tictactoe',
                    win: false // Not a win, so no special styling
                });
                return;
            }

            ttt_currentPlayer = ttt_currentPlayer === ttt_player1Name ? ttt_player2Name : ttt_player1Name;
            document.getElementById('tictactoe-status').textContent = `Turno de ${ttt_currentPlayer}`;
            
            if (ttt_gameMode === 'ai' && ttt_currentPlayer === ttt_player2Name && ttt_gameActive) {
                setTimeout(aiMove, 500);
            }
        }

        function checkWin() {
            const winConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let i = 0; i < winConditions.length; i++) {
                const [a, b, c] = winConditions[i];
                if (ttt_board[a] && ttt_board[a] === ttt_board[b] && ttt_board[a] === ttt_board[c]) {
                    drawWinningLine(winConditions[i]); // Call the new drawing function
                    return winConditions[i]; // Return the winning condition
                }
            }
            return null; // No win
        }

        function drawWinningLine(winningCombination) {
            const canvas = document.getElementById('tictactoe-canvas');
            const ctx = canvas.getContext('2d');
            const board = document.getElementById('tictactoe-board');
            const boardSize = board.offsetWidth;
            
            // Set canvas dimensions to match the board
            canvas.width = boardSize;
            canvas.height = boardSize;

            const [a, b, c] = winningCombination;
            const cellSize = boardSize / 3;

            // Function to get center coordinates of a cell index
            const getCellCenter = (index) => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                const x = col * cellSize + cellSize / 2;
                const y = row * cellSize + cellSize / 2;
                return { x, y };
            };

            const start = getCellCenter(a);
            const end = getCellCenter(c);

            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.strokeStyle = '#ef4444'; // red-500
            ctx.lineWidth = 10;
            ctx.lineCap = 'round';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 5;
            ctx.stroke();
        }

        // Helper function to find a winning or blocking move
        function findWinningMove(board, playerMark) {
            const winConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            for (let i = 0; i < winConditions.length; i++) {
                const [a, b, c] = winConditions[i];
                // Check if two spots are already filled by the player and the third is empty
                if (board[a] === playerMark && board[b] === playerMark && board[c] === '') return c;
                if (board[a] === playerMark && board[c] === playerMark && board[b] === '') return b;
                if (board[b] === playerMark && board[c] === playerMark && board[a] === '') return a;
            }
            return -1; // No winning move found
        }

        function aiMove() {
            if (!ttt_gameActive) return;

            const aiMark = 'O'; // AI is always 'O'
            const playerMark = 'X'; // Player is always 'X'
            let move = -1;
            const emptyCells = [];
            ttt_board.forEach((val, idx) => {
                if (val === '') emptyCells.push(idx);
            });

            // 1. Check if AI can win
            move = findWinningMove(ttt_board, aiMark);
            if (move !== -1) {
                console.log("AI: Found winning move at", move);
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
                return;
            }

            // 2. Check if player can win and block them
            move = findWinningMove(ttt_board, playerMark);
            if (move !== -1) {
                console.log("AI: Blocking player win at", move);
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
                return;
            }

            // 3. Take the center if available
            if (ttt_board[4] === '') {
                move = 4;
                console.log("AI: Taking center at", move);
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
                return;
            }

            // 4. Take a corner if available
            const corners = [0, 2, 6, 8];
            const availableCorners = emptyCells.filter(idx => corners.includes(idx));
            if (availableCorners.length > 0) {
                move = availableCorners[Math.floor(Math.random() * availableCorners.length)];
                console.log("AI: Taking corner at", move);
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
                return;
            }

            // 5. Take any available side if available (last resort)
            const sides = [1, 3, 5, 7];
            const availableSides = emptyCells.filter(idx => sides.includes(idx));
            if (availableSides.length > 0) {
                move = availableSides[Math.floor(Math.random() * availableSides.length)];
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
                return;
            }

            // Fallback (should not be reached if board is not full)
            if (emptyCells.length > 0) {
                move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                console.log("AI: Taking random empty cell (fallback) at", move);
                const cell = document.querySelector(`#tictactoe-board button[data-index='${move}']`);
                handleCellClick(cell, move);
            }
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous confetti
            const colors = ['#f59e0b', '#ef4444', '#3b82f6', '#22c55e', '#ec4899']; // amber, red, blue, green, pink
            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = `${Math.random() * 2}s`;
                piece.style.width = `${Math.floor(Math.random() * 8) + 8}px`;
                piece.style.height = `${Math.floor(Math.random() * 15) + 10}px`;
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(piece);
            }
        }
        
        // --- Memory Game Logic ---
        // Define different sets of emojis/symbols
        const memoryEmojiSets = {
            sports: ['⚽️', '🏀', '🏈', '⚾️', '🎾', '🏐', '🎱', '🏓', '⛳️', '🏒', '🥊', '🏊‍♂️'], // 12 emojis
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐸'], // 12 emojis
            symbols: ['❤️', '⭐️', '⚡️', '🌈', '💡', '💎', '💰', '🔑', '🚀', '⏳', '💡', '🏆'], // 12 emojis
            flags: ['🇪🇸', '🇫🇷', '🇩🇪', '🇮🇹', '🇬🇧', '🇺🇸', '🇯🇵', '🇨🇳', '🇧🇷', '🇨🇦', '🇦🇺', '🇮🇳'], // 12 emojis
            food: ['🍎', '🍌', '🍕', '🍔', '🍟', '🍦', '🍩', '🍪', '🍓', '🍇', '🍉', '🍍'], // New food theme
            space: ['🚀', '🌕', '⭐️', '🪐', '☄️', '🌌', '🔭', '🛰️', '👽', '👨‍🚀', '👩‍🚀', '💫'] // New space theme
        };
        let memoryEmojis = []; // This will hold the randomly selected set for the current game
        let currentMemoryEmojiSetKey = ''; // To store the key of the current emoji set

        let memoryCards;
        let flippedCards = [];
        let matchedPairs = 0; // Total matched pairs across all players
        let memoryAttempts; // Only for single player high score
        let memoryLockBoard = false;
        let memoryGameMode; // 'single' or 'multi'
        let memoryCurrentPlayer; // 1 or 2
        let memoryPlayer1MatchedPairs;
        let memoryPlayer2MatchedPairs;
        let memoryPlayer1Name;
        let memoryPlayer2Name;
        let memoryTimerInterval; // To store the setInterval ID for the timer
        let memoryTimeElapsed; // To store the elapsed time in seconds
        let isMemoryMuted = false; // New variable to track mute state

        // Global variables for memory game setup
        let selectedMemoryPlayerName = null; // Will be 'Hugo', 'Saúl', or null for 2 players
        let selectedMemoryBoardSize = null; // e.g., 12, 16, 20, 24
        let selectedMemoryGridCols = null; // e.g., 4, 5, 6
        let selectedMemoryEmojiSetKey = null;

        const memoryPlayerTurnDisplay = document.getElementById('memory-player-turn');
        const memoryPlayer1MatchedDisplay = document.getElementById('memory-player1-matched');
        const memoryPlayer2MatchedDisplay = document.getElementById('memory-player2-matched');
        const memoryCurrentPlayerTurnDisplay = document.getElementById('memory-current-player-turn');
        const memoryAttemptsDisplay = document.getElementById('memory-attempts-display'); // Get the attempts display container
        const memoryTimerDisplay = document.getElementById('memory-timer-display'); // Get the timer display container
        const memoryTimerElement = document.getElementById('memory-timer'); // Get the span for the timer value
        const memoryBoardElement = document.getElementById('memory-board'); // Get the memory board element
        const memoryMuteButton = document.getElementById('memory-mute-button'); // Get the mute button element
        const memoryPlayerNameDisplay = document.getElementById('memory-player-name-display'); // New element for player name

        // Global Tone.js objects for memory game sounds
        const memorySounds = {
            flip: new Tone.MembraneSynth().toDestination(), // For card flip
            match: new Tone.PolySynth(Tone.Synth).toDestination(), // Changed to PolySynth
            noMatch: new Tone.PolySynth(Tone.Synth).toDestination(), // Changed to PolySynth
            fanfare: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.05,
                    decay: 0.8,
                    sustain: 0.0,
                    release: 0.5
                }
            }).toDestination() // New PolySynth for fanfare
        };

        // Notes for memory game sounds
        const memoryNotes = {
            flip: "C5", // A quick, high note for flip
            match: ["C5", "E5", "G5"], // Rising arpeggio for match
            noMatch: ["C4", "A3"], // Descending for no match
            fanfare: ["C4", "E4", "G4", "C5", "E5", "G5"] // Fanfare chord
        };

        function playMemorySound(type) {
            // Start Tone.js audio context on first user interaction with the game
            Tone.start(); 
            if (isMemoryMuted) return; // Do not play sound if muted

            if (type === 'flip') {
                memorySounds.flip.triggerAttackRelease(memoryNotes.flip, "16n"); // Short pluck
            } else if (type === 'match') {
                memorySounds.match.triggerAttackRelease(memoryNotes.match, "8n"); // Arpeggio
            } else if (type === 'noMatch') {
                memorySounds.noMatch.triggerAttackRelease(memoryNotes.noMatch, "8n"); // Descending
            } else if (type === 'fanfare') {
                // Play fanfare chord for a longer duration
                memorySounds.fanfare.triggerAttackRelease(memoryNotes.fanfare, "1.5s");
            }
        }

        function toggleMemoryMute() {
            isMemoryMuted = !isMemoryMuted;
            if (isMemoryMuted) {
                Tone.Master.mute = true; // Mute all Tone.js output
                memoryMuteButton.textContent = '🔇'; // Muted icon
            } else {
                Tone.Master.mute = false; // Unmute all Tone.js output
                memoryMuteButton.textContent = '🔊'; // Unmuted icon
            }
        }

        function showMemorySetupSelection(playerName = null) {
            selectedMemoryPlayerName = playerName; // Store the player name if coming from single player selection
            selectedMemoryBoardSize = null; // Reset selection
            selectedMemoryGridCols = null;
            selectedMemoryEmojiSetKey = null;
            document.getElementById('start-memory-game-button').disabled = true;
            document.getElementById('start-memory-game-button').classList.add('opacity-50', 'cursor-not-allowed');

            // Clear selected styles for difficulty and theme buttons
            document.querySelectorAll('#memory-setup-selection .btn-game[onclick^="selectMemoryDifficulty"]').forEach(btn => {
                btn.classList.remove('border-4', 'border-amber-500', 'scale-105');
            });
            document.querySelectorAll('#memory-setup-selection .btn-game[onclick^="selectMemoryTheme"]').forEach(btn => {
                btn.classList.remove('border-4', 'border-amber-500', 'scale-105');
            });

            // Update back button for memory setup screen
            document.getElementById('memory-setup-back-button').onclick = () => {
                showScreen(selectedMemoryPlayerName ? 'single-player-mode-selection' : 'memory-menu');
            };

            showScreen('memory-setup-selection');
        }

        function selectMemoryDifficulty(size, cols) {
            selectedMemoryBoardSize = size;
            selectedMemoryGridCols = cols;
            // Visually indicate selection
            document.querySelectorAll('#memory-setup-selection .btn-game[onclick^="selectMemoryDifficulty"]').forEach(btn => {
                btn.classList.remove('border-4', 'border-amber-500', 'scale-105');
            });
            event.target.classList.add('border-4', 'border-amber-500', 'scale-105');
            checkMemorySetupReady();
        }

        function selectMemoryTheme(key) {
            selectedMemoryEmojiSetKey = key;
            // Visually indicate selection
            document.querySelectorAll('#memory-setup-selection .btn-game[onclick^="selectMemoryTheme"]').forEach(btn => {
                btn.classList.remove('border-4', 'border-amber-500', 'scale-105');
            });
            event.target.classList.add('border-4', 'border-amber-500', 'scale-105');
            checkMemorySetupReady();
        }

        function checkMemorySetupReady() {
            const startButton = document.getElementById('start-memory-game-button');
            if (selectedMemoryBoardSize !== null && selectedMemoryEmojiSetKey !== null) {
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function confirmStartMemoryGame() {
            // Determine mode based on whether selectedMemoryPlayerName is set
            const mode = selectedMemoryPlayerName ? 'single' : 'multi';
            startMemoryGame(mode, selectedMemoryPlayerName, selectedMemoryBoardSize, selectedMemoryGridCols, selectedMemoryEmojiSetKey);
        }

        function startMemoryGame(mode, selectedPlayerName, boardSize, gridCols, emojiSetKey) {
            memoryGameMode = mode;
            memoryAttempts = 0;
            flippedCards = []; // Reset flipped cards from previous game
            matchedPairs = 0; // Reset total matched pairs
            memoryPlayer1MatchedPairs = 0;
            memoryPlayer2MatchedPairs = 0;
            memoryCurrentPlayer = 1; // Always start with Player 1
            document.getElementById('memory-attempts').textContent = 0;
            
            // Clear any existing timer
            stopMemoryTimer();

            // Hide all score/timer displays initially
            memoryPlayerTurnDisplay.classList.add('hidden');
            memoryAttemptsDisplay.classList.add('hidden'); // Hide attempts by default
            memoryTimerDisplay.classList.add('hidden'); // Hide timer by default

            // Use selected emoji set and board size
            memoryEmojis = memoryEmojiSets[emojiSetKey];
            const numPairs = boardSize / 2;
            // Ensure we only take enough emojis for the selected board size
            const selectedEmojisForGame = memoryEmojis.slice(0, numPairs);

            // Remove all previous theme classes from the board
            memoryBoardElement.classList.remove('memory-board-theme-sports', 'memory-board-theme-animals', 'memory-board-theme-symbols', 'memory-board-theme-flags', 'memory-board-theme-food', 'memory-board-theme-space');
            // Add the new theme class to the board
            memoryBoardElement.classList.add(`memory-board-theme-${emojiSetKey}`);
            // Set grid columns dynamically
            memoryBoardElement.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;


            if (memoryGameMode === 'single') {
                memoryPlayer1Name = selectedPlayerName;
                memoryPlayer2Name = null;
                memoryTimerDisplay.classList.remove('hidden'); // Show timer for single player
                memoryPlayerNameDisplay.textContent = `${memoryPlayer1Name}: `; // Display player name
                
                memoryTimeElapsed = 0; // Reset timer
                memoryTimerElement.textContent = '00:00'; // Reset timer display
                // Timer will start after shuffle animation
            } else { // 'multi'
                memoryPlayer1Name = 'Hugo';
                memoryPlayer2Name = 'Saúl';
                memoryPlayerTurnDisplay.classList.remove('hidden');
                memoryAttemptsDisplay.classList.remove('hidden'); // Show attempts for multi-player
            }
            
            const cardValues = [...selectedEmojisForGame, ...selectedEmojisForGame];
            cardValues.sort(() => Math.random() - 0.5); // Shuffle
            
            const board = document.getElementById('memory-board');
            board.innerHTML = '';
            memoryCards = [];

            // Add a class to the board to indicate shuffling, potentially disable clicks
            board.classList.add('shuffling-in-progress'); // New class to manage state

            cardValues.forEach(value => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card aspect-square perspective is-shuffling'; // Add shuffling class
                cardElement.dataset.value = value;
                
                cardElement.innerHTML = `
                    <div class="card-inner relative w-full h-full">
                        <!-- La cara de la carta que está boca abajo inicialmente -->
                        <div class="card-face absolute w-full h-full bg-rose-400 rounded-lg flex items-center justify-center text-4xl shadow-md">
                            ⭐
                        </div>
                        <!-- La cara de la carta que se muestra al voltear -->
                        <div class="card-back absolute w-full h-full bg-white rounded-lg flex items-center justify-center text-4xl shadow-md">
                            ${value}
                        </div>
                    </div>
                `;
                
                board.appendChild(cardElement);
                memoryCards.push(cardElement);
                
                // DO NOT attach click listener immediately, wait for shuffle animation to finish
            });

            showScreen('memory-game');

            // Wait for the shuffling animation to complete before enabling clicks and starting the timer
            setTimeout(() => {
                board.classList.remove('shuffling-in-progress'); // Remove the shuffling class
                memoryCards.forEach(card => {
                    card.classList.remove('is-shuffling'); // Remove animation class
                    card.addEventListener('click', () => flipCard(card)); // Attach click listener
                });
                if (memoryGameMode === 'single') {
                    startMemoryTimer(); // Start timer only after animation
                }
            }, 1200); // Match this with the CSS animation duration
        }

        function startMemoryTimer() {
            memoryTimerInterval = setInterval(() => {
                memoryTimeElapsed++;
                memoryTimerElement.textContent = formatTime(memoryTimeElapsed);
            }, 1000);
        }

        function stopMemoryTimer() {
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }
        
        function flipCard(card) {
            if (memoryLockBoard || card.classList.contains('is-flipped') || flippedCards.length === 2) {
                return;
            }

            card.classList.add('is-flipped');
            flippedCards.push(card);
            playMemorySound('flip'); // Play sound on flip

            if (flippedCards.length === 2) {
                memoryAttempts++; // Increment attempts for both single and multi-player
                document.getElementById('memory-attempts').textContent = memoryAttempts; // Update display
                memoryLockBoard = true;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [cardOne, cardTwo] = flippedCards;
            const isMatch = cardOne.dataset.value === cardTwo.dataset.value;

            if (isMatch) {
                playMemorySound('match'); // Play match sound
                disableCards();
            } else {
                playMemorySound('noMatch'); // Play no-match sound
                unflipCards();
            }
        }

        function disableCards() {
            flippedCards.forEach(card => {
                card.removeEventListener('click', flipCard);
                card.classList.add('is-matched'); // Add animation class
            });
            matchedPairs++; // Increment total matched pairs

            if (memoryGameMode === 'multi') {
                if (memoryCurrentPlayer === 1) memoryPlayer1MatchedPairs++;
                else memoryPlayer2MatchedPairs++;
                memoryCurrentPlayerTurnDisplay.textContent = `Turno de ${memoryCurrentPlayer === 1 ? memoryPlayer1Name : memoryPlayer2Name}`;
                memoryPlayer1MatchedDisplay.textContent = memoryPlayer1MatchedPairs;
                memoryPlayer2MatchedDisplay.textContent = memoryPlayer2MatchedPairs;
            }

            resetTurn();
            if (matchedPairs === (selectedMemoryBoardSize / 2)) { // Check against total unique emojis
                endMemoryGame();
            }
        }

        function unflipCards() {
            setTimeout(() => {
                flippedCards.forEach(card => card.classList.remove('is-flipped'));
                if (memoryGameMode === 'multi') {
                    memoryCurrentPlayer = memoryCurrentPlayer === 1 ? 2 : 1; // Switch player
                    memoryCurrentPlayerTurnDisplay.textContent = `Turno de ${memoryCurrentPlayer === 1 ? memoryPlayer1Name : memoryPlayer2Name}`;
                }
                resetTurn();
            }, 1000);
        }

        function resetTurn() {
            flippedCards = [];
            memoryLockBoard = false;
        }

        function endMemoryGame() {
            stopMemoryTimer(); // Stop the timer when the game ends
            playMemorySound('fanfare'); // Play fanfare on game win
            let finalMessage = "";
            let restartCallback = () => { closeModal('gameOver'); confirmStartMemoryGame(); }; // Restart with same settings

            if (memoryGameMode === 'single') {
                saveMemoryHighScore(memoryPlayer1Name, memoryTimeElapsed, true); // Save time as high score
                finalMessage = `¡${memoryPlayer1Name}, completaste el juego en ${formatTime(memoryTimeElapsed)}! ¡Qué memoria!`;
            } else {
                if (memoryPlayer1MatchedPairs > memoryPlayer2MatchedPairs) {
                    finalMessage = `¡Felicidades ${memoryPlayer1Name}! Ganaste con ${memoryPlayer1MatchedPairs} parejas contra ${memoryPlayer2MatchedPairs} de ${memoryPlayer2Name}.`; // FIX: Corrected variable names and added player names
                } else if (memoryPlayer2MatchedPairs > memoryPlayer1MatchedPairs) { // FIX: Corrected variable name
                    finalMessage = `¡Felicidades ${memoryPlayer2Name}! Ganaste con ${memoryPlayer2MatchedPairs} parejas contra ${memoryPlayer1MatchedPairs} de ${memoryPlayer1Name}.`; // FIX: Corrected variable names and added player names
                } else {
                    finalMessage = `¡Es un empate! Ambos jugadores encontraron ${memoryPlayer1MatchedPairs} parejas.`;
                }
            }

            showModal('gameOver', {
                title: "¡Juego Terminado!",
                message: finalMessage,
                restartCallback: restartCallback,
                game: 'memory'
            });
        }

        // --- Guess the Number Game Logic ---
        let guessNumberSecret;
        let guessNumberAttempts;
        let guessNumberPlayerName; // Used for single player
        let guessNumberGameActive;
        let guessNumberHintsLeft; // New variable for hints (single player)
        let guessNumberPlayer1HintsLeft; // New variable for Player 1 hints (multi-player)
        let guessNumberPlayer2HintsLeft; // New variable for Player 2 hints (multi-player)
        let guessNumberGameMode; // 'single' or 'multi'
        let guessNumberCurrentPlayer; // Stores the name of the current player in multi-mode
        let guessNumberPlayer1Name; // Player 1 name in multi-mode
        let guessNumberPlayer2Name; // Player 2 name in multi-mode

        const guessNumberInput = document.getElementById('guess-number-input');
        const guessNumberFeedback = document.getElementById('guess-number-feedback');
        const guessNumberAttemptsDisplay = document.getElementById('guess-number-attempts');
        const guessNumberHighscoreDisplay = document.getElementById('guess-number-highscore-display'); // Entire highscore div
        const guessNumberHighscoreValue = document.getElementById('guess-number-highscore-value');
        const guessNumberHintButton = document.getElementById('guess-number-hint-button'); // New hint button element
        const guessNumberHintsLeftDisplay = document.getElementById('guess-number-hints-left'); // New hint counter display
        const guessNumberPlayerTurnDisplay = document.getElementById('guess-number-player-turn'); // New player turn display
        const guessNumberCurrentPlayerTurnDisplay = document.getElementById('guess-number-current-player-turn'); // Span inside player turn display
        const guessNumberPlayerNameDisplay = document.getElementById('guess-number-player-name-display'); // New element for player name


        // Variables para el modo matemático
        let mathGameHints = [];
        let mathGameDifficulty = 'normal';

        function startGameGuessNumber(mode, player1Name, player2Name = null) {
            guessNumberGameMode = mode;
            guessNumberPlayer1Name = player1Name;
            guessNumberPlayer2Name = player2Name;
            
            // Si es modo matemático, inicializar variables específicas
            if (mode === 'math') {
                initializeMathGame();
            } else {
                resetGuessNumberGame();
            }
            showScreen('guess-number-game');
        }

        function initializeMathGame() {
            guessNumberGameActive = true;
            guessNumberAttempts = 0;
            mathGameHints = [];
            guessNumberSecret = Math.floor(Math.random() * 100) + 1;
            
            // Generar pistas matemáticas
            generateMathHints();
            
            // Actualizar la interfaz
            document.getElementById('guess-number-mode-text').textContent = '🧮 Modo Matemático';
            document.getElementById('guess-number-range').textContent = 'Adivina el número usando las pistas matemáticas:';
            guessNumberFeedback.textContent = '';
            guessNumberAttemptsDisplay.textContent = '0';
            guessNumberInput.value = '';
            guessNumberInput.disabled = false;
            
            // Mostrar las pistas matemáticas
            displayMathHints();
        }

        function generateMathHints() {
            const hints = [];
            
            // Divisibilidad
            hints.push(`El número ${guessNumberSecret % 2 === 0 ? 'es' : 'no es'} par`);
            hints.push(`El número ${guessNumberSecret % 5 === 0 ? 'es' : 'no es'} múltiplo de 5`);
            
            // Suma de dígitos
            const digitSum = Array.from(String(guessNumberSecret)).reduce((sum, digit) => sum + parseInt(digit), 0);
            hints.push(`La suma de sus dígitos es ${digitSum}`);
            
            // Factores
            const factors = [];
            for (let i = 1; i <= guessNumberSecret; i++) {
                if (guessNumberSecret % i === 0) {
                    factors.push(i);
                }
            }
            if (factors.length > 2) {
                const randomFactor = factors[Math.floor(Math.random() * (factors.length - 2)) + 1];
                hints.push(`Es divisible por ${randomFactor}`);
            }
            
            // Distancia a números cuadrados
            const sqrtFloor = Math.floor(Math.sqrt(guessNumberSecret));
            const nearestSquare = sqrtFloor * sqrtFloor;
            const distanceToSquare = Math.abs(guessNumberSecret - nearestSquare);
            hints.push(`Está a ${distanceToSquare} números de distancia del cuadrado perfecto ${nearestSquare}`);
            
            // Números cercanos con propiedades especiales
            const nearestMultipleOf10 = Math.round(guessNumberSecret / 10) * 10;
            hints.push(`Está a ${Math.abs(guessNumberSecret - nearestMultipleOf10)} números de ${nearestMultipleOf10}`);
            
            // Mezclar las pistas
            mathGameHints = hints.sort(() => Math.random() - 0.5);
        }

        function displayMathHints() {
            const container = document.getElementById('math-hints-container');
            container.innerHTML = '';
            
            mathGameHints.forEach((hint, index) => {
                const hintElement = document.createElement('div');
                hintElement.className = 'p-2 bg-blue-100 rounded-lg text-blue-800 font-medium';
                hintElement.textContent = `Pista ${index + 1}: ${hint}`;
                container.appendChild(hintElement);
            });
        }

        function resetGuessNumberGame() {
            guessNumberSecret = Math.floor(Math.random() * 100) + 1; // Number between 1 and 100
            guessNumberAttempts = 0;
            guessNumberGameActive = true;
            
            guessNumberInput.value = '';
            guessNumberFeedback.textContent = '';
            guessNumberAttemptsDisplay.textContent = guessNumberAttempts;
            guessNumberInput.disabled = false;
            guessNumberHintButton.disabled = false; // Explicitly enable the button here
            
            // Reiniciar elementos visuales
            const thermometer = document.getElementById('guess-thermometer');
            const proximityMarker = document.getElementById('proximity-marker');
            const arrowLeft = document.getElementById('guess-arrow-left');
            const arrowRight = document.getElementById('guess-arrow-right');
            
            thermometer.style.height = '0%';
            proximityMarker.style.left = '0%';
            proximityMarker.classList.remove('proximity-pulse');
            arrowLeft.classList.add('hidden');
            arrowRight.classList.add('hidden');

            if (guessNumberGameMode === 'single') {
                guessNumberPlayerName = guessNumberPlayer1Name; // Set the single player name
                guessNumberHintsLeft = 1; // 1 hint for single player
                guessNumberHighscoreDisplay.classList.remove('hidden');
                guessNumberPlayerTurnDisplay.classList.add('hidden');
                guessNumberPlayerNameDisplay.textContent = `${guessNumberPlayerName}: `; // Display player name
                const highscore = localStorage.getItem(`highscore_guess_number_${guessNumberPlayerName}`);
                guessNumberHighscoreValue.textContent = highscore !== null ? highscore : 'N/A';
            } else { // 'multi'
                guessNumberHighscoreDisplay.classList.add('hidden');
                guessNumberPlayerTurnDisplay.classList.remove('hidden');
                guessNumberPlayer1HintsLeft = 1; // 1 hint for player 1
                guessNumberPlayer2HintsLeft = 1; // 1 hint for player 2
                guessNumberCurrentPlayer = guessNumberPlayer1Name; // Start with Player 1
                guessNumberCurrentPlayerTurnDisplay.textContent = `Turno de ${guessNumberCurrentPlayer}`;
            }
            updateGuessNumberHintDisplay(); // This will then set the correct count and re-disable if needed (e.g., if hints are 0)
            console.log(`[Adivina el Número] Nuevo juego iniciado. Número secreto: ${guessNumberSecret}`); // For debugging
        }

        function getHintsLeftForCurrentPlayer() {
            if (guessNumberGameMode === 'single') {
                return guessNumberHintsLeft;
            } else {
                return (guessNumberCurrentPlayer === guessNumberPlayer1Name) ? guessNumberPlayer1HintsLeft : guessNumberPlayer2HintsLeft;
            }
        }

        function updateGuessNumberHintDisplay() {
            guessNumberHintsLeftDisplay.textContent = getHintsLeftForCurrentPlayer();
            guessNumberHintButton.disabled = (getHintsLeftForCurrentPlayer() <= 0);
        }

        function updateVisualFeedback(guess, difference) {
            // Actualizar termómetro
            const thermometer = document.getElementById('guess-thermometer');
            const proximityMarker = document.getElementById('proximity-marker');
            const arrowLeft = document.getElementById('guess-arrow-left');
            const arrowRight = document.getElementById('guess-arrow-right');
            
            // Calcular proximidad (0-100%)
            const maxDifference = 100;
            const proximity = Math.max(0, 100 - (Math.abs(difference) / maxDifference * 100));
            
            // Actualizar altura del termómetro
            thermometer.style.height = `${proximity}%`;
            
            // Actualizar posición del marcador de proximidad
            proximityMarker.style.left = `${proximity}%`;
            
            // Actualizar clase de pulso basada en la proximidad
            proximityMarker.classList.toggle('proximity-pulse', proximity > 80);
            
            // Mostrar/ocultar flechas
            arrowLeft.classList.toggle('hidden', guess >= guessNumberSecret);
            arrowRight.classList.toggle('hidden', guess <= guessNumberSecret);
            
            // Actualizar colores basados en la proximidad
            if (proximity > 80) {
                feedback.classList.remove('distance-far', 'distance-close');
                feedback.classList.add('distance-very-close');
            } else if (proximity > 50) {
                feedback.classList.remove('distance-far', 'distance-very-close');
                feedback.classList.add('distance-close');
            } else {
                feedback.classList.remove('distance-close', 'distance-very-close');
                feedback.classList.add('distance-far');
            }
        }

        function checkGuess() {
            if (!guessNumberGameActive) return;

            const guess = parseInt(guessNumberInput.value);
            const feedback = document.getElementById('guess-number-feedback');
            const input = document.getElementById('guess-number-input');
            const submitBtn = document.getElementById('guess-number-submit');
            
            // Manejar el modo matemático de manera especial
            const isMathMode = guessNumberGameMode === 'math';

            // Reset styles
            feedback.style.color = '';
            feedback.classList.remove('scale-up-center', 'shake');
            input.classList.remove('ring-2', 'ring-green-400', 'ring-red-400', 'animate-pulse');
            submitBtn.classList.remove('animate-bounce');

            if (isNaN(guess) || guess < 1 || guess > 100) {
                feedback.textContent = "Por favor, introduce un número entre 1 y 100.";
                feedback.style.color = '#EF4444';
                feedback.classList.add('shake');
                input.classList.add('ring-2', 'ring-red-400');
                return;
            }

            guessNumberAttempts++;
            guessNumberAttemptsDisplay.textContent = guessNumberAttempts;

            if (guess === guessNumberSecret) {
                feedback.textContent = `¡Correcto! Adivinaste el número ${guessNumberSecret}.`;
                feedback.style.color = '#10B981';
                feedback.classList.add('scale-up-center');
                input.classList.add('ring-2', 'ring-green-400', 'animate-pulse');
                submitBtn.classList.add('animate-bounce');
                guessNumberGameActive = false;
                guessNumberInput.disabled = true;
                guessNumberHintButton.disabled = true;

                let winnerName = guessNumberGameMode === 'single' ? guessNumberPlayerName : guessNumberCurrentPlayer;
                if (guessNumberGameMode === 'single') {
                    saveGuessNumberHighScore(winnerName, guessNumberAttempts);
                }
                setTimeout(() => {
                    const modalMessage = isMathMode ? 
                        `¡Excelente trabajo matemático! Resolviste el acertijo del número ${guessNumberSecret} en ${guessNumberAttempts} intentos.` :
                        `¡Felicidades ${winnerName}! Adivinaste el número ${guessNumberSecret} en ${guessNumberAttempts} intentos.`;
                    
                    showModal('gameOver', {
                        title: "¡Has ganado!",
                        message: modalMessage,
                        restartCallback: () => { 
                            closeModal('gameOver'); 
                            if (isMathMode) {
                                initializeMathGame();
                            } else {
                                resetGuessNumberGame(); 
                            }
                        },
                        game: 'guess-number',
                        win: true
                    });
                }, 1000);
            } else if (guess < guessNumberSecret) {
                feedback.textContent = "¡Más alto!";
                feedback.style.color = '#FBBF24';
                feedback.classList.add('scale-up-center');
                input.classList.add('ring-2', 'ring-yellow-400');
                updateVisualFeedback(guess, guessNumberSecret - guess);
            } else {
                feedback.textContent = "¡Más bajo!";
                feedback.style.color = '#FBBF24';
                feedback.classList.add('scale-up-center');
                input.classList.add('ring-2', 'ring-yellow-400');
                updateVisualFeedback(guess, guessNumberSecret - guess);
            }
            if (guessNumberGameMode === 'multi') {
                guessNumberCurrentPlayer = (guessNumberCurrentPlayer === guessNumberPlayer1Name) ? guessNumberPlayer2Name : guessNumberPlayer1Name;
                guessNumberCurrentPlayerTurnDisplay.textContent = `Turno de ${guessNumberCurrentPlayer}`;
            }
            updateGuessNumberHintDisplay();
            guessNumberInput.value = '';
            setTimeout(() => {
                feedback.classList.remove('scale-up-center', 'shake');
                input.classList.remove('ring-2', 'ring-green-400', 'ring-red-400', 'ring-yellow-400', 'animate-pulse');
                submitBtn.classList.remove('animate-bounce');
            }, 700);
        }

        function requestHint() {
            let currentHints = getHintsLeftForCurrentPlayer();

            if (!guessNumberGameActive || currentHints <= 0) {
                guessNumberFeedback.textContent = "Ya no te quedan Pistas."; // Changed message
                guessNumberFeedback.style.color = '#EF4444';
                return;
            }

            if (guessNumberGameMode === 'single') {
                guessNumberHintsLeft--;
            } else {
                if (guessNumberCurrentPlayer === guessNumberPlayer1Name) {
                    guessNumberPlayer1HintsLeft--;
                } else {
                    guessNumberPlayer2HintsLeft--;
                }
            }
            updateGuessNumberHintDisplay(); // Update display immediately

            let hintMessage = "";
            const hintType = Math.random() < 0.5 ? 'parity' : 'multipleOf5'; // Randomly choose hint type

            if (hintType === 'parity') {
                hintMessage = `El número secreto es ${guessNumberSecret % 2 === 0 ? 'par' : 'impar'}.`;
            } else { // multipleOf5
                hintMessage = `El número secreto ${guessNumberSecret % 5 === 0 ? 'es' : 'no es'} múltiplo de 5.`;
            }
            
            guessNumberFeedback.textContent = `Pista: ${hintMessage}`;
            guessNumberFeedback.style.color = '#3B82F6'; /* blue-500 */
        }

        function saveGuessNumberHighScore(playerName, attempts) {
            // This function is now only called for single-player mode
            const key = `highscore_guess_number_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '999'); // Lower attempts is better
            console.log(`[Adivina el Número] Guardando puntuación alta para ${playerName}. Intentos: ${attempts}, Mejor actual: ${currentHighScore}`);
            if (attempts < currentHighScore) {
                localStorage.setItem(key, attempts);
                console.log(`[Adivina el Número] Nueva puntuación alta guardada: ${attempts} para ${playerName}`);
            } else {
                console.log(`[Adivina el Número] No hay nueva puntuación alta para ${playerName}. Intentos: ${attempts}, Mejor actual: ${currentHighScore}`);
            }
        }

        // --- Simon Says Game Logic ---
        const simonColors = ['red', 'green', 'blue', 'yellow'];
        let simonSequence = [];
        let playerSequence = [];
        let simonLevel = 0;
        let simonGameActive = false;
        let simonPlayerName;
        let simonButtonDelay = 800; // Initial delay for sequence playback
        let simonPlaybackIndex = 0; // To track current position in sequence playback
        let simonDifficulty = 'normal'; // Difficulty level: 'easy', 'normal', 'hard', 'expert'
        
        // Configuración de dificultades
        const simonDifficultySettings = {
            easy: {
                baseDelay: 1000,
                speedReduction: 50,
                minDelay: 500,
                colorBrightness: 1
            },
            normal: {
                baseDelay: 800,
                speedReduction: 100,
                minDelay: 300,
                colorBrightness: 0.9
            },
            hard: {
                baseDelay: 600,
                speedReduction: 150,
                minDelay: 200,
                colorBrightness: 0.8
            },
            expert: {
                baseDelay: 400,
                speedReduction: 200,
                minDelay: 150,
                colorBrightness: 0.7,
                fadeEffect: true
            }
        };

        const simonFeedback = document.getElementById('simon-feedback');
        const simonLevelDisplay = document.getElementById('simon-level');
        const simonHighscoreValue = document.getElementById('simon-highscore-value');
        const simonStartButton = document.getElementById('simon-start-button');
        const simonButtons = {
            red: document.getElementById('simon-red'),
            green: document.getElementById('simon-green'),
            blue: document.getElementById('simon-blue'),
            yellow: document.getElementById('simon-yellow')
        };
        const simonPlayerNameDisplay = document.getElementById('simon-player-name-display'); // New element for player name

        // Get audio elements
        const simonSounds = {
            red: new Tone.Synth().toDestination(),
            green: new Tone.Synth().toDestination(),
            blue: new Tone.Synth().toDestination(),
            yellow: new Tone.Synth().toDestination()
        };

        // Assign different notes to each color
        const simonNotes = {
            red: "C4",
            green: "E4",
            blue: "G4",
            yellow: "A4"
        };

        function playSimonSound(color) {
            if (simonSounds[color] && simonNotes[color]) {
                simonSounds[color].triggerAttackRelease(simonNotes[color], "8n"); // Play note for 1/8th note duration
            }
        }


        // Add event listeners to Simon buttons
        Object.values(simonButtons).forEach(button => {
            button.addEventListener('click', (event) => handleSimonButtonClick(event.target.id.replace('simon-', '')));
        });

        function showSimonDifficultySelection(mode, selectedPlayer) {
            simonPlayerName = selectedPlayer;
            
            // Crear la pantalla de selección de dificultad
            const difficultyScreen = `
                <div class="flex flex-col items-center justify-center p-8 bg-amber-50 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Elige la Dificultad</h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="selectDifficultyAndStart('easy')" class="simon-difficulty-btn easy">
                            <span class="text-lg">😊 Fácil</span><br>
                            <span class="text-sm">Secuencia lenta y colores brillantes</span>
                        </button>
                        <button onclick="selectDifficultyAndStart('normal')" class="simon-difficulty-btn normal">
                            <span class="text-lg">😃 Normal</span><br>
                            <span class="text-sm">Velocidad estándar</span>
                        </button>
                        <button onclick="selectDifficultyAndStart('hard')" class="simon-difficulty-btn hard">
                            <span class="text-lg">😈 Difícil</span><br>
                            <span class="text-sm">Secuencia rápida</span>
                        </button>
                        <button onclick="selectDifficultyAndStart('expert')" class="simon-difficulty-btn expert">
                            <span class="text-lg">🔥 Experto</span><br>
                            <span class="text-sm">Ultra rápido y colores que se desvanecen</span>
                        </button>
                    </div>
                    <button onclick="showScreen('player-selection')" class="btn-game">
                        ← Volver
                    </button>
                </div>
            `;
            
            document.getElementById('simon-difficulty-selection').innerHTML = difficultyScreen;
            showScreen('simon-difficulty-selection');
        }

        function selectDifficultyAndStart(difficulty) {
            simonDifficulty = difficulty;
            startSimonGame('single', simonPlayerName);
        }

        function startSimonGame(mode, selectedPlayer) {
            // For now, only single player is supported for this game
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Simon Dice.");
                return;
            }
            simonPlayerName = selectedPlayer;
            resetSimonGame();
            showScreen('simon-game');
        }

        function resetSimonGame() {
            simonSequence = [];
            playerSequence = [];
            simonLevel = 0;
            simonGameActive = false;
            simonButtonDelay = 800; // Reset speed
            simonPlaybackIndex = 0;

            simonLevelDisplay.textContent = simonLevel;
            simonFeedback.textContent = '¡Pulsa "Empezar" para jugar!';
            simonFeedback.style.color = 'inherit'; // Reset color
            simonStartButton.disabled = false; // Enable start button
            enableSimonButtons(false); // Disable game buttons initially

            // Load and display high score
            simonPlayerNameDisplay.textContent = `${simonPlayerName}: `; // Display player name
            const highscore = localStorage.getItem(`highscore_simon_${simonPlayerName}`);
            simonHighscoreValue.textContent = highscore !== null ? highscore : 'N/A';
            console.log(`[Simon Dice] Juego reiniciado para ${simonPlayerName}.`);
        }

        // New function to start a round (generate and then play)
        function startSimonRound() {
            // Start Tone.js audio context on user interaction
            Tone.start(); 
            simonStartButton.disabled = true; // Disable start button once game starts
            generateSimonSequence(); // Generate the first sequence
            playSimonSequence(); // Play the generated sequence
        }

        function generateSimonSequence() {
            const randomColor = simonColors[Math.floor(Math.random() * simonColors.length)];
            simonSequence.push(randomColor);
            simonLevel++;
            simonLevelDisplay.textContent = simonLevel;
            playerSequence = []; // Reset player's input for new round
            simonFeedback.textContent = '¡Mira y recuerda!';
            simonFeedback.style.color = 'inherit';
            enableSimonButtons(false); // Disable player input during playback

            // Ajustar velocidad según dificultad y nivel
            const settings = simonDifficultySettings[simonDifficulty];
            simonButtonDelay = Math.max(
                settings.minDelay,
                settings.baseDelay - (simonLevel * settings.speedReduction)
            );

            // Aplicar efecto de desvanecimiento en modo experto
            if (settings.fadeEffect) {
                Object.values(simonButtons).forEach(button => {
                    button.classList.add('simon-fade-out');
                });
            }
        }

        function playSimonSequence() {
            if (simonPlaybackIndex < simonSequence.length) {
                const colorToHighlight = simonSequence[simonPlaybackIndex];
                const button = simonButtons[colorToHighlight];

                button.classList.add('highlight');
                playSimonSound(colorToHighlight); // Play sound when highlighting

                setTimeout(() => {
                    button.classList.remove('highlight');
                    simonPlaybackIndex++;
                    setTimeout(playSimonSequence, 100); // Small delay between highlights
                }, simonButtonDelay);
            } else {
                // Sequence playback finished, enable player input
                simonPlaybackIndex = 0; // Reset for next playback
                simonFeedback.textContent = '¡Tu turno!';
                simonFeedback.style.color = '#1E40AF'; /* blue-800 */
                enableSimonButtons(true);
                simonGameActive = true;
            }
        }

        function handleSimonButtonClick(color) {
            if (!simonGameActive) return;

            playerSequence.push(color);
            const button = simonButtons[color];
            button.classList.add('highlight'); // Visual feedback for player click
            playSimonSound(color); // Play sound on player click

            setTimeout(() => {
                button.classList.remove('highlight');
            }, 150); // Short highlight for player click

            checkSimonSequence();
        }

        function checkSimonSequence() {
            const lastIndex = playerSequence.length - 1;
            if (playerSequence[lastIndex] !== simonSequence[lastIndex]) {
                // Game Over
                simonGameActive = false;
                enableSimonButtons(false);
                saveSimonHighScore(simonPlayerName, simonLevel - 1); // Save previous level as score
                
                showModal('gameOver', {
                    title: "¡Juego Terminado!",
                    message: `¡Oh no, ${simonPlayerName}! Llegaste al Nivel ${simonLevel - 1}. ¡Inténtalo de nuevo para mejorar tu memoria!`,
                    restartCallback: () => { closeModal('gameOver'); resetSimonGame(); },
                    game: 'simon',
                    win: false // Indicate it's a loss
                });
                return;
            }

            if (playerSequence.length === simonSequence.length) {
                // Round completed successfully
                simonGameActive = false;
                enableSimonButtons(false);
                simonFeedback.textContent = '¡Genial! Preparando siguiente nivel...';
                simonFeedback.style.color = '#10B981'; /* emerald-600 */
                setTimeout(() => {
                    generateSimonSequence();
                    playSimonSequence();
                }, 1000); // Short pause before next round
            }
        }

        function enableSimonButtons(enable) {
            Object.values(simonButtons).forEach(button => {
                button.disabled = !enable;
            });
        }

        function saveSimonHighScore(playerName, score) {
            const key = `highscore_simon_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '0');
            console.log(`[Simon Dice] Saving high score for ${playerName}. New score: ${score}, Current best: ${currentHighScore}`);
            if (score > currentHighScore) {
                localStorage.setItem(key, score);
                console.log(`[Simon Dice] New high score saved: ${score} for ${playerName}`);
            } else {
                console.log(`[Simon Dice] No new high score for ${playerName}. Score: ${score}, Current best: ${currentHighScore}`);
            }
        }

        // --- Paint by Number Game Logic ---
        const paintPatterns = [
            {
                name: "Corazón",
                colors: {
                    1: '#EF4444', // Red
                    0: '#f3f4f6' // Background (gray-100)
                },
                grid: [
                    [0, 1, 1, 0, 1, 1, 0],
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1],
                    [0, 1, 1, 1, 1, 1, 0],
                    [0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 1, 0, 0, 0]
                ]
            },
            {
                name: "Estrella",
                colors: {
                    1: '#F59E0B', // Amber
                    0: '#f3f4f6'
                },
                grid: [
                    [0, 0, 1, 0, 0],
                    [0, 1, 1, 1, 0],
                    [1, 1, 1, 1, 1],
                    [0, 1, 0, 1, 0],
                    [1, 0, 0, 0, 1]
                ]
            },
            {
                name: "Casa",
                colors: {
                    1: '#92400E', // Amber-800 (Techo)
                    2: '#FDBA74', // Orange-300 (Paredes)
                    3: '#A16207', // Amber-700 (Puerta)
                    0: '#f3f4f6'
                },
                grid: [
                    [0, 0, 1, 0, 0],
                    [0, 1, 1, 1, 0],
                    [1, 2, 2, 2, 1],
                    [1, 2, 3, 2, 1],
                    [1, 2, 2, 2, 1]
                ]
            },
            {
                name: "Flor",
                colors: {
                    1: '#FBBF24', // Amarillo (Centro)
                    2: '#34D399', // Verde (Tallo)
                    3: '#60A5FA', // Azul claro (Pétalo 1)
                    4: '#F87171', // Rojo claro (Pétalo 2)
                    5: '#A78BFA', // Púrpura (Pétalo 3)
                    6: '#FCD34D', // Amarillo claro (Pétalo 4)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 3, 0, 0],
                    [0, 3, 1, 4, 0],
                    [3, 1, 1, 1, 4],
                    [0, 5, 1, 6, 0],
                    [0, 0, 5, 0, 0],
                    [0, 0, 2, 0, 0],
                    [0, 0, 2, 0, 0]
                ]
            },
            {
                name: "Manzana",
                colors: {
                    1: '#DC2626', // Rojo oscuro
                    2: '#16A34A', // Verde oscuro (Hoja)
                    3: '#7C2D12', // Marrón (Tallo)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 1, 1, 0, 0],
                    [0, 1, 1, 1, 1, 0],
                    [1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1],
                    [0, 1, 1, 1, 1, 0],
                    [0, 0, 3, 2, 0, 0]
                ]
            },
            {
                name: "Coche",
                colors: {
                    1: '#3B82F6', // Azul (Carrocería)
                    2: '#1F2937', // Gris oscuro (Ruedas)
                    3: '#9CA3AF', // Gris claro (Ventanas)
                    4: '#FCD34D', // Amarillo (Faros)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 0, 1, 1, 0, 0, 0],
                    [0, 0, 1, 1, 1, 1, 1, 0],
                    [0, 1, 1, 3, 3, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1, 4],
                    [1, 1, 1, 1, 1, 1, 1, 1],
                    [0, 2, 2, 0, 0, 2, 2, 0]
                ]
            },
            {
                name: "Sol",
                colors: {
                    1: '#FBBF24', // Amarillo (Centro)
                    2: '#F59E0B', // Naranja (Rayos)
                    0: '#f3f4f6' // Fondo
                },
                grid: [
                    [0, 0, 2, 0, 0],
                    [2, 1, 1, 1, 2],
                    [0, 1, 1, 1, 0],
                    [2, 1, 1, 1, 2],
                    [0, 0, 2, 0, 0]
                ]
            }
        ];

        let paintByNumberCurrentPattern;
        let paintByNumberPlayerName;
        let paintByNumberPaintedCells; // Keep track of painted cells
        let paintByNumberTotalCellsToPaint;
        let paintByNumberCurrentSelectedColor = null;
        let paintByNumberCurrentSelectedNumber = null;
        let paintByNumberStartTime;
        let paintByNumberTimerInterval;
        let isPaintMuted = false; // New variable to track mute state for Paint by Number

        const paintGridContainer = document.getElementById('paint-grid-container');
        const colorPalette = document.getElementById('color-palette');
        const paintByNumberProgressDisplay = document.getElementById('paint-by-number-progress');
        const paintByNumberPlayerNameDisplay = document.getElementById('paint-by-number-player-name-display'); // New element for player name
        const paintMuteButton = document.getElementById('paint-mute-button'); // Get the mute button element

        // Global Tone.js objects for Paint by Number sounds
        const paintSounds = {
            selectColor: new Tone.Synth().toDestination(),
            correctPaint: new Tone.Synth().toDestination(),
            incorrectPaint: new Tone.Synth().toDestination(),
            completion: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.05,
                    decay: 0.8,
                    sustain: 0.0,
                    release: 0.5
                }
            }).toDestination()
        };

        // Notes for Paint by Number sounds
        const paintNotes = {
            selectColor: "C4",
            correctPaint: "G5", // Higher pitch for success
            incorrectPaint: "C3", // Lower pitch for error
            completion: ["C4", "E4", "G4", "C5"] // Celebratory chord
        };

        // Background music for Paint by Number
        const paintMusicPlayer = new Tone.Synth({
            oscillator: { type: "triangle" },
            envelope: {
                attack: 2,
                decay: 1,
                sustain: 0.5,
                release: 5
            }
        }).toDestination();

        function playPaintSound(type) {
            // Start Tone.js audio context on first user interaction with the game
            Tone.start(); 
            if (isPaintMuted) return; // Do not play sound if muted

            if (type === 'selectColor') {
                paintSounds.selectColor.triggerAttackRelease(paintNotes.selectColor, "16n");
            } else if (type === 'correctPaint') {
                paintSounds.correctPaint.triggerAttackRelease(paintNotes.correctPaint, "16n");
            } else if (type === 'incorrectPaint') {
                paintSounds.incorrectPaint.triggerAttackRelease(paintNotes.incorrectPaint, "16n");
            } else if (type === 'completion') {
                paintSounds.completion.triggerAttackRelease(paintNotes.completion, "2s");
            }
        }

        function togglePaintMute() {
            isPaintMuted = !isPaintMuted;
            if (isPaintMuted) {
                Tone.Master.mute = true; // Mute all Tone.js output
                paintMuteButton.textContent = '🔇'; // Muted icon
            } else {
                Tone.Master.mute = false; // Unmute all Tone.js output
                paintMuteButton.textContent = '🔊'; // Unmuted icon
            }
        }

        function startPaintByNumberGame(mode, selectedPlayer) {
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Pintar por Números.");
                return;
            }
            paintByNumberPlayerName = selectedPlayer;
            resetPaintByNumberGame();
            showScreen('paint-by-number-game');
            // Start background music loop
            Tone.start(); // Ensure audio context is started
            paintMusicPlayer.triggerAttackRelease("C4", "8n"); // Play a simple note to start the synth
            paintMusicPlayer.loop = true;
            paintMusicPlayer.loopStart = 0;
            paintMusicPlayer.loopEnd = "4n"; // Loop every quarter note for a simple pulse
            paintMusicPlayer.frequency.value = "C4"; // Set a base frequency
            paintMusicPlayer.volume.value = -15; // Set a low volume for background music
            Tone.Transport.start(); // Start the transport for looping
        }

        function resetPaintByNumberGame() {
            // Randomly select a pattern
            paintByNumberCurrentPattern = paintPatterns[Math.floor(Math.random() * paintPatterns.length)];
            
            paintByNumberPaintedCells = 0;
            paintByNumberTotalCellsToPaint = 0;
            paintByNumberCurrentSelectedColor = null;
            paintByNumberCurrentSelectedNumber = null;
            
            paintByNumberProgressDisplay.textContent = '0%';
            paintByNumberPlayerNameDisplay.textContent = `${paintByNumberPlayerName}: `; // Display player name
            
            stopPaintByNumberTimer(); // Ensure timer is stopped on reset
            // Removed the line trying to update paintByNumberHighscoreValue.textContent
            // paintByNumberHighscoreValue.textContent = localStorage.getItem(`highscore_paint_by_number_${paintByNumberPlayerName}`) || 'N/A';

            renderPaintGrid();
            renderColorPalette();
            
            // Start timer only after grid and palette are rendered
            paintByNumberStartTime = Date.now();
            paintByNumberTimerInterval = setInterval(updatePaintByNumberTimer, 1000);

            // Ensure music is playing if not muted
            if (!isPaintMuted) {
                Tone.Transport.start();
                if (!paintMusicPlayer.state === 'started') {
                    paintMusicPlayer.triggerAttackRelease("C4", "8n"); // Re-trigger if needed
                }
            }
        }

        function renderPaintGrid() {
            paintGridContainer.innerHTML = '';
            paintGridContainer.style.gridTemplateColumns = `repeat(${paintByNumberCurrentPattern.grid[0].length}, 1fr)`;
            paintByNumberTotalCellsToPaint = 0;

            paintByNumberCurrentPattern.grid.forEach((row, rowIndex) => {
                row.forEach((cellValue, colIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'paint-grid-cell';
                    cell.textContent = cellValue !== 0 ? cellValue : ''; // Show number for non-background cells
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = colIndex;
                    cell.dataset.originalValue = cellValue; // Store original value for checking
                    cell.dataset.painted = 'false'; // Track if cell is painted

                    // If it's a background cell (0), it's considered "painted" for progress calculation
                    if (cellValue === 0) {
                        cell.classList.add('painted');
                        cell.style.backgroundColor = paintByNumberCurrentPattern.colors[0];
                        cell.textContent = ''; // Hide '0'
                        // paintByNumberPaintedCells++; // FIX: Do not increment here, this is only for cells that need to be painted by user
                    } else {
                        paintByNumberTotalCellsToPaint++; // Only count non-background cells for painting
                        cell.addEventListener('click', () => handlePaintGridCellClick(cell, rowIndex, colIndex));
                    }
                    paintGridContainer.appendChild(cell);
                });
            });
            // FIX: Initialize paintByNumberPaintedCells based on actual painted cells (including background)
            // This ensures progress is correct from the start if there are background cells.
            paintByNumberPaintedCells = document.querySelectorAll('#paint-grid-container .paint-grid-cell.painted').length;
            updatePaintByNumberProgress(); // Initial progress update
        }

        function renderColorPalette() {
            colorPalette.innerHTML = '';
            const numbersUsed = [...new Set(paintByNumberCurrentPattern.grid.flat().filter(num => num !== 0))]; // Get unique numbers, excluding 0
            
            numbersUsed.sort((a, b) => a - b); // Sort numbers numerically

            numbersUsed.forEach(number => {
                const color = paintByNumberCurrentPattern.colors[number];
                const button = document.createElement('button');
                button.className = 'color-palette-button';
                button.style.backgroundColor = color;
                button.textContent = number;
                button.dataset.number = number;
                button.dataset.color = color;
                button.addEventListener('click', () => selectPaintColor(button, number, color));
                colorPalette.appendChild(button);
            });
        }

        function selectPaintColor(button, number, color) {
            // Remove 'selected' class from all buttons
            document.querySelectorAll('.color-palette-button').forEach(btn => btn.classList.remove('selected'));
            // Add 'selected' class to the clicked button
            button.classList.add('selected');
            
            paintByNumberCurrentSelectedColor = color;
            paintByNumberCurrentSelectedNumber = number;
            playPaintSound('selectColor'); // Play sound on color selection
            console.log(`[Pintar por Números] Color seleccionado: ${color} (Número: ${number})`);
        }

        function handlePaintGridCellClick(cell, row, col) {
            if (!paintByNumberCurrentSelectedColor || cell.dataset.painted === 'true') {
                // console.log("[Pintar por Números] No hay color seleccionado o celda ya pintada.");
                return;
            }

            const originalValue = parseInt(cell.dataset.originalValue);
            if (originalValue === paintByNumberCurrentSelectedNumber) {
                cell.style.backgroundColor = paintByNumberCurrentSelectedColor;
                cell.classList.add('painted');
                cell.textContent = ''; // Hide the number
                cell.dataset.painted = 'true';
                paintByNumberPaintedCells++; // Increment only when user paints a cell
                playPaintSound('correctPaint'); // Play sound for correct paint
                updatePaintByNumberProgress();
            } else {
                // Optional: visual feedback for incorrect guess
                cell.style.backgroundColor = '#EF4444'; // Flash red
                playPaintSound('incorrectPaint'); // Play sound for incorrect paint
                setTimeout(() => {
                    cell.style.backgroundColor = '#f3f4f6'; // Revert to original unpainted color
                }, 200);
                console.log(`[Pintar por Números] Intento incorrecto en [${row},${col}]. Esperado: ${originalValue}, Seleccionado: ${paintByNumberCurrentSelectedNumber}`);
            }
        }

        function updatePaintByNumberProgress() {
            // Calculate total cells in the grid, including background cells (0)
            const totalCellsInGrid = paintByNumberCurrentPattern.grid.length * paintByNumberCurrentPattern.grid[0].length;
            const progressPercentage = Math.floor((paintByNumberPaintedCells / totalCellsInGrid) * 100);
            paintByNumberProgressDisplay.textContent = `${progressPercentage}%`;

            if (progressPercentage === 100) {
                endPaintByNumberGame();
            }
        }

        function updatePaintByNumberTimer() {
            const elapsedTime = Math.floor((Date.now() - paintByNumberStartTime) / 1000);
            // No direct timer display on screen, but used for high score
            // console.log(`[Pintar por Números] Tiempo transcurrido: ${elapsedTime} segundos`);
        }

        function endPaintByNumberGame() {
            stopPaintByNumberTimer();
            Tone.Transport.stop(); // Stop background music
            playPaintSound('completion'); // Play completion sound
            const finalTimeSeconds = Math.floor((Date.now() - paintByNumberStartTime) / 1000);
            savePaintByNumberHighScore(paintByNumberPlayerName, finalTimeSeconds);

            // Highlight all painted cells
            const allCells = document.querySelectorAll('#paint-grid-container .paint-grid-cell');
            allCells.forEach(cell => {
                // Only highlight cells that were meant to be painted (not background 0 cells)
                if (parseInt(cell.dataset.originalValue) !== 0) {
                    cell.classList.add('highlight-completed');
                }
            });

            // Add a delay before showing the modal, accounting for the highlight animation
            setTimeout(() => {
                showModal('gameOver', {
                    title: "¡Imagen Completada!",
                    message: `¡Felicidades ${paintByNumberPlayerName}! Completaste el dibujo "${paintByNumberCurrentPattern.name}" en ${formatTime(finalTimeSeconds)}.`,
                    restartCallback: () => { closeModal('gameOver'); resetPaintByNumberGame(); },
                    game: 'paint-by-number',
                    win: true
                });
                // Optional: Remove highlight class after modal is shown or game is reset
                allCells.forEach(cell => {
                    cell.classList.remove('highlight-completed');
                });
            }, 2500); // 2 seconds initial delay + 0.5 seconds animation = 2.5 seconds total
        }

        function savePaintByNumberHighScore(playerName, timeInSeconds) {
            const key = `highscore_paint_by_number_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '999999'); // Lower time is better
            console.log(`[Pintar por Números] Guardando puntuación alta para ${playerName}. Tiempo: ${timeInSeconds}, Mejor actual: ${currentHighScore}`);
            if (timeInSeconds < currentHighScore) {
                localStorage.setItem(key, timeInSeconds);
                console.log(`[Pintar por Números] Nueva puntuación alta guardada: ${timeInSeconds} para ${playerName}`);
            } else {
                console.log(`[Pintar por Números] No hay nueva puntuación alta para ${playerName}. Tiempo: ${timeInSeconds}, Mejor actual: ${currentHighScore}`);
            }
        }

        function stopPaintByNumberTimer() {
            if (paintByNumberTimerInterval) {
                clearInterval(paintByNumberTimerInterval);
                paintByNumberTimerInterval = null;
            }
        }

        // --- Retos Game Logic (NEW) ---
        // Define all possible challenges for the Retos game
        const allRetosChallenges = [
            { type: "color_bomb", timeLimitSeconds: 5 },
            { type: "starting_letter", timeLimitSeconds: 5 },
            { type: "shape_bomb", timeLimitSeconds: 5 },
            { type: "temperature_bomb", timeLimitSeconds: 5 },
            { type: "sound_bomb", timeLimitSeconds: 5 },
            { type: "category_bomb", timeLimitSeconds: 5 },
            // New challenges below
            { type: "physical_squats", timeLimitSeconds: 8, reps: 3 },
            { type: "physical_pushups", timeLimitSeconds: 10, reps: 3 },
            { type: "physical_jumping_jacks", timeLimitSeconds: 8, reps: 5 },
            { type: "find_object_count", timeLimitSeconds: 10 },
            { type: "make_animal_sound", timeLimitSeconds: 7 },
            { type: "touch_texture", timeLimitSeconds: 7 },
            { type: "action_verb", timeLimitSeconds: 5 },
            { type: "balance_challenge", timeLimitSeconds: 7 },
            { type: "mimic_emotion", timeLimitSeconds: 5 },
            { type: "find_number", timeLimitSeconds: 8 }
        ];

        // Data for new challenges
        const bombColors = ['rojo', 'azul', 'verde', 'amarillo', 'naranja', 'morado', 'rosa', 'negro', 'blanco'];
        const alphabetLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'L', 'M', 'N', 'O', 'P', 'R', 'S', 'T', 'U', 'V', 'Z'];
        const shapes = ['cuadrado', 'redondo', 'triangular', 'rectangular', 'ovalado'];
        const temperatures = ['frío', 'caliente'];
        const sounds = ['que suene', 'que vibre', 'que cruja', 'que haga clic'];
        const categories = ['una fruta', 'un juguete', 'una prenda de ropa', 'un utensilio de cocina', 'un libro', 'un animal', 'una planta'];
        const animals = ['perro', 'gato', 'león', 'elefante', 'pájaro', 'serpiente'];
        const textures = ['suave', 'rugoso', 'liso'];
        const actions = ['salta', 'gira', 'aplaude', 'corre en el sitio'];
        const emotions = ['feliz', 'triste', 'enfadado', 'sorprendido', 'asustado'];
        const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];


        let retosPlayerName;
        let retosCompletedCount;
        let retosGameActive;
        let retosCurrentChallenge; // Stores the current challenge object
        let retosTimerInterval;
        let retosCurrentTimeLeft;
        let retosCurrentChallengeDetail; // Stores the randomly chosen color or letter for the challenge
        let shuffledRetosChallenges = []; // To store the shuffled challenges for the current game

        const retosCategoryDisplay = document.getElementById('retos-category');
        const retosChallengeDisplay = document.getElementById('retos-challenge');
        const retosTimerDisplay = document.getElementById('retos-timer');
        const retosFeedbackDisplay = document.getElementById('retos-feedback');
        const retosCompletedCountDisplay = document.getElementById('retos-completed-count');
        const retosHighscoreValue = document.getElementById('retos-highscore-value');
        const retosPlayerNameDisplay = document.getElementById('retos-player-name-display');
        const retosDoneButton = document.getElementById('retos-done-button');
        const retosStartNextButton = document.getElementById('retos-start-next-button');
        const retosBombDisplay = document.getElementById('retos-bomb-display'); // New bomb display element

        // Tone.js sounds for Retos
        const retosSounds = {
            start: new Tone.Synth().toDestination(),
            success: new Tone.Synth().toDestination(), // General success, not defuse
            fail: new Tone.Synth().toDestination(),
            countdown: new Tone.Synth().toDestination(), // For timer tick
            bombExplode: new Tone.NoiseSynth({
                noise: {
                    type: "white"
                },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0,
                    release: 0.1
                }
            }).toDestination(), // New for explosion
            bombDefuse: new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.05,
                    decay: 0.8,
                    sustain: 0.0,
                    release: 0.5
                }
            }).toDestination() // New for defuse
        };

        const retosNotes = {
            start: "C6", // High pitch for game start
            success: "G5", // Success sound
            fail: "C3", // Low pitch for failure
            countdown: "C4", // Tick sound
            bombDefuse: ["C4", "E4", "G4", "C5"] // Defuse chord
        };

        function playRetosSound(type) {
            Tone.start(); // Ensure audio context is started
            if (type === 'start') {
                retosSounds.start.triggerAttackRelease(retosNotes.start, "16n");
            } else if (type === 'success') {
                retosSounds.success.triggerAttackRelease(retosNotes.success, "8n");
            } else if (type === 'fail') {
                retosSounds.fail.triggerAttackRelease(retosNotes.fail, "4n");
            } else if (type === 'countdown') {
                retosSounds.countdown.triggerAttackRelease(retosNotes.countdown, "32n"); // Short tick
            } else if (type === 'bombExplode') {
                retosSounds.bombExplode.triggerAttackRelease("4n"); // Short burst of noise
            } else if (type === 'bombDefuse') {
                retosSounds.bombDefuse.triggerAttackRelease(retosNotes.bombDefuse, "1.5s");
            }
        }

        function startRetosGame(mode, selectedPlayer) {
            // For now, only single player is supported for this game
            if (mode !== 'single') {
                console.error("Modo de juego no soportado para Retos.");
                return;
            }
            retosPlayerName = selectedPlayer;
            resetRetosGame();
            showScreen('retos-game');
        }

        function resetRetosGame() {
            retosCompletedCount = 0;
            retosGameActive = false;
            retosCurrentChallenge = null; // No challenge loaded yet
            stopRetosTimer();
            // Shuffle all challenges for a new game
            shuffledRetosChallenges = [...allRetosChallenges];
            shuffleArray(shuffledRetosChallenges);

            retosCompletedCountDisplay.textContent = retosCompletedCount;
            retosPlayerNameDisplay.textContent = `${retosPlayerName}: `;
            const highscore = localStorage.getItem(`highscore_retos_${retosPlayerName}`);
            retosHighscoreValue.textContent = highscore !== null ? highscore : 'N/A';

            retosCategoryDisplay.textContent = '';
            retosChallengeDisplay.textContent = 'Pulsa "Empezar Reto" para jugar.';
            retosTimerDisplay.textContent = '00';
            retosFeedbackDisplay.textContent = '';
            retosBombDisplay.textContent = '💣'; // Reset bomb visual

            retosDoneButton.disabled = true;
            retosStartNextButton.disabled = false; // Enable start button
            retosStartNextButton.textContent = 'Empezar Reto';

            console.log(`[Retos] Juego reiniciado para ${retosPlayerName}.`);
        }

        function startNextReto() {
            playRetosSound('start');
            retosGameActive = true;
            
            // Get the next challenge from the shuffled array
            if (shuffledRetosChallenges.length === 0) {
                // If all challenges have been played, reshuffle
                shuffledRetosChallenges = [...allRetosChallenges];
                shuffleArray(shuffledRetosChallenges);
            }
            retosCurrentChallenge = shuffledRetosChallenges.shift(); // Take one from the front

            retosCurrentTimeLeft = retosCurrentChallenge.timeLimitSeconds;
            retosTimerDisplay.textContent = String(retosCurrentTimeLeft).padStart(2, '0');

            retosDoneButton.disabled = false;
            retosStartNextButton.disabled = true; // Disable until reto is done/failed

            let challengeText = '';
            let categoryText = '';

            if (retosCurrentChallenge.type === "color_bomb") {
                retosCurrentChallengeDetail = bombColors[Math.floor(Math.random() * bombColors.length)];
                categoryText = `Categoría: ¡Bomba de Color!`;
                challengeText = `¡Toca un objeto de color ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "starting_letter") {
                retosCurrentChallengeDetail = alphabetLetters[Math.floor(Math.random() * alphabetLetters.length)];
                categoryText = `Categoría: ¡Bomba de Letra!`;
                challengeText = `¡Toca un objeto que empiece por la letra "${retosCurrentChallengeDetail}" y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "shape_bomb") {
                retosCurrentChallengeDetail = shapes[Math.floor(Math.random() * shapes.length)];
                categoryText = `Categoría: ¡Bomba de Forma!`;
                challengeText = `¡Toca un objeto de forma ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "temperature_bomb") {
                retosCurrentChallengeDetail = temperatures[Math.floor(Math.random() * temperatures.length)];
                categoryText = `Categoría: ¡Bomba de Temperatura!`;
                challengeText = `¡Toca un objeto que esté ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "sound_bomb") {
                retosCurrentChallengeDetail = sounds[Math.floor(Math.random() * sounds.length)];
                categoryText = `Categoría: ¡Bomba de Sonido!`;
                challengeText = `¡Toca un objeto ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "category_bomb") {
                retosCurrentChallengeDetail = categories[Math.floor(Math.random() * categories.length)];
                categoryText = `Categoría: ¡Bomba de Categoría!`;
                challengeText = `¡Toca ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "physical_squats") {
                categoryText = `Categoría: ¡Reto Físico!`;
                challengeText = `¡Haz ${retosCurrentChallenge.reps} sentadillas y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "physical_pushups") {
                categoryText = `Categoría: ¡Reto Físico!`;
                challengeText = `¡Haz ${retosCurrentChallenge.reps} flexiones y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "physical_jumping_jacks") {
                categoryText = `Categoría: ¡Reto Físico!`;
                challengeText = `¡Haz ${retosCurrentChallenge.reps} saltos de estrella y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "find_object_count") {
                const count = Math.floor(Math.random() * 3) + 2; // 2, 3, or 4
                const color = bombColors[Math.floor(Math.random() * bombColors.length)];
                retosCurrentChallengeDetail = { count, color };
                categoryText = `Categoría: ¡Bomba de Observación!`;
                challengeText = `¡Encuentra ${count} objetos de color ${color} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "make_animal_sound") {
                retosCurrentChallengeDetail = animals[Math.floor(Math.random() * animals.length)];
                categoryText = `Categoría: ¡Reto Creativo!`;
                challengeText = `¡Haz el sonido de un ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "touch_texture") {
                retosCurrentChallengeDetail = textures[Math.floor(Math.random() * textures.length)];
                categoryText = `Categoría: ¡Bomba de Textura!`;
                challengeText = `¡Toca algo ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "action_verb") {
                retosCurrentChallengeDetail = actions[Math.floor(Math.random() * actions.length)];
                categoryText = `Categoría: ¡Reto de Acción!`;
                challengeText = `¡${retosCurrentChallengeDetail.charAt(0).toUpperCase() + retosCurrentChallengeDetail.slice(1)} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "balance_challenge") {
                categoryText = `Categoría: ¡Reto de Equilibrio!`;
                challengeText = `¡Mantente a la pata coja durante 3 segundos y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "mimic_emotion") {
                retosCurrentChallengeDetail = emotions[Math.floor(Math.random() * emotions.length)];
                categoryText = `Categoría: ¡Reto de Expresión!`;
                challengeText = `¡Haz una cara de ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            } else if (retosCurrentChallenge.type === "find_number") {
                retosCurrentChallengeDetail = numbers[Math.floor(Math.random() * numbers.length)];
                categoryText = `Categoría: ¡Bomba Numérica!`;
                challengeText = `¡Encuentra el número ${retosCurrentChallengeDetail} y vuelve para desactivar la bomba!`;
            }


            retosCategoryDisplay.textContent = categoryText;
            retosChallengeDisplay.textContent = challengeText;
            retosFeedbackDisplay.textContent = '';
            retosBombDisplay.textContent = '💣'; // Show bomb emoji

            startRetosTimer();
        }

        function startRetosTimer() {
            stopRetosTimer(); // Clear any existing timer
            retosTimerInterval = setInterval(() => {
                retosCurrentTimeLeft--;
                retosTimerDisplay.textContent = String(retosCurrentTimeLeft).padStart(2, '0');
                playRetosSound('countdown'); // Play tick sound

                if (retosCurrentTimeLeft <= 0) {
                    stopRetosTimer();
                    failReto(true); // Automatically fail if time runs out
                }
            }, 1000);
        }

        function stopRetosTimer() {
            if (retosTimerInterval) {
                clearInterval(retosTimerInterval);
                retosTimerInterval = null;
            }
        }

        function completeReto() {
            if (!retosGameActive) return;
            stopRetosTimer();
            playRetosSound('bombDefuse'); // Play defuse sound
            retosCompletedCount++;
            retosCompletedCountDisplay.textContent = retosCompletedCount;
            
            let feedbackMessage = "";
            if (retosCurrentChallenge.type === "color_bomb") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste el color ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "starting_letter") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste un objeto que empieza por "${retosCurrentChallengeDetail}"!`;
            } else if (retosCurrentChallenge.type === "shape_bomb") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste un objeto de forma ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "temperature_bomb") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste un objeto ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "sound_bomb") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste un objeto ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "category_bomb") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "physical_squats") {
                feedbackMessage = `¡Bomba desactivada! ¡Hiciste ${retosCurrentChallenge.reps} sentadillas!`;
            } else if (retosCurrentChallenge.type === "physical_pushups") {
                feedbackMessage = `¡Bomba desactivada! ¡Hiciste ${retosCurrentChallenge.reps} flexiones!`;
            } else if (retosCurrentChallenge.type === "physical_jumping_jacks") {
                feedbackMessage = `¡Bomba desactivada! ¡Hiciste ${retosCurrentChallenge.reps} saltos de estrella!`;
            } else if (retosCurrentChallenge.type === "find_object_count") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste ${retosCurrentChallengeDetail.count} objetos de color ${retosCurrentChallengeDetail.color}!`;
            } else if (retosCurrentChallenge.type === "make_animal_sound") {
                feedbackMessage = `¡Bomba desactivada! ¡Hiciste el sonido de un ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "touch_texture") {
                feedbackMessage = `¡Bomba desactivada! ¡Tocaste algo ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "action_verb") {
                feedbackMessage = `¡Bomba desactivada! ¡${retosCurrentChallengeDetail.charAt(0).toUpperCase() + retosCurrentChallengeDetail.slice(1)}!`;
            } else if (retosCurrentChallenge.type === "balance_challenge") {
                feedbackMessage = `¡Bomba desactivada! ¡Mantuviste el equilibrio!`;
            } else if (retosCurrentChallenge.type === "mimic_emotion") {
                feedbackMessage = `¡Bomba desactivada! ¡Hiciste una cara de ${retosCurrentChallengeDetail}!`;
            } else if (retosCurrentChallenge.type === "find_number") {
                feedbackMessage = `¡Bomba desactivada! ¡Encontraste el número ${retosCurrentChallengeDetail}!`;
            }

            retosFeedbackDisplay.textContent = feedbackMessage;
            retosFeedbackDisplay.style.color = '#10B981'; /* emerald-600 */
            retosBombDisplay.textContent = '✅'; // Defused bomb emoji
            endRetoRound(true); // Pass true for success
        }

        function failReto(timeUp = false) {
            if (!retosGameActive) return;
            stopRetosTimer();
            playRetosSound('bombExplode'); // Play explode sound
            
            let feedbackMessage = "";
            if (retosCurrentChallenge.type === "color_bomb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No tocaste un objeto de color ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "starting_letter") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste un objeto que empieza por "${retosCurrentChallengeDetail}" a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "shape_bomb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste un objeto de forma ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "temperature_bomb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste un objeto ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "sound_bomb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste un objeto ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "category_bomb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "physical_squats") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No hiciste ${retosCurrentChallenge.reps} sentadillas a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "physical_pushups") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No hiciste ${retosCurrentChallenge.reps} flexiones a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "physical_jumping_jacks") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No hiciste ${retosCurrentChallenge.reps} saltos de estrella a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "find_object_count") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste ${retosCurrentChallengeDetail.count} objetos de color ${retosCurrentChallengeDetail.color} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "make_animal_sound") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No hiciste el sonido de un ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "touch_texture") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No tocaste algo ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "action_verb") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "balance_challenge") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No mantuviste el equilibrio a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "mimic_emotion") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No hiciste una cara de ${retosCurrentChallengeDetail} a tiempo. ❌`;
            } else if (retosCurrentChallenge.type === "find_number") {
                feedbackMessage = timeUp ? "¡BOOM! ¡La bomba explotó! 💥" : `¡Reto fallido! No encontraste el número ${retosCurrentChallengeDetail} a tiempo. ❌`;
            }

            retosFeedbackDisplay.textContent = feedbackMessage;
            retosFeedbackDisplay.style.color = '#EF4444'; /* red-500 */
            retosBombDisplay.textContent = '💥'; // Exploded bomb emoji
            endRetoRound(false); // Pass false for failure
        }

        function endRetoRound(success) {
            retosGameActive = false;
            retosDoneButton.disabled = true;
            retosStartNextButton.disabled = false;
            retosStartNextButton.textContent = 'Siguiente Reto';
            
            // Only save high score if the reto was completed successfully
            if (success) {
                saveRetosHighScore(retosPlayerName, retosCompletedCount);
            }
        }

        function saveRetosHighScore(playerName, score) {
            const key = `highscore_retos_${playerName}`;
            const currentHighScore = parseInt(localStorage.getItem(key) || '0');
            console.log(`[Retos] Saving high score for ${playerName}. New score: ${score}, Current best: ${currentHighScore}`);
            if (score > currentHighScore) {
                localStorage.setItem(key, score);
                console.log(`[Retos] New high score saved: ${score} for ${playerName}`);
                retosHighscoreValue.textContent = score; // Update display immediately
            } else {
                console.log(`[Retos] No new high score for ${playerName}. Score: ${score}, Current best: ${currentHighScore}`);
            }
        }

        // Initial load and background image logic
        window.onload = () => {
            const backgroundImages = [
                'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada3.png',
                'https://ivandlpn.github.io/Aplicaciones/HUSA/img/portada/portada2.png'
            ];
            const randomIndex = Math.floor(Math.random() * backgroundImages.length);
            const selectedImage = backgroundImages[randomIndex];
            document.body.style.backgroundImage = `url('${selectedImage}')`;

            showScreen('main-menu');
        };
    </script>
</body>
</html>
