<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Inter√©s Compuesto Fiel</title>
    <!-- Carga de Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9; /* Fondo claro */
            color: #333; /* Color de texto principal */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ocupa al menos el alto de la ventana */
        }

        .container {
            width: 100%;
            max-width: 900px; /* Ancho m√°ximo del contenedor */
            background-color: #ffffff;
            border-radius: 12px; /* Bordes redondeados */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Sombra suave */
            padding: 30px;
            box-sizing: border-box; /* Incluye padding y borde en el ancho/alto */
        }

        header h1 {
            text-align: center;
            color: #2c3e50; /* Color oscuro para el t√≠tulo */
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
        }

        /* --- Estilos del Formulario --- */
        .calculator-form {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Dos columnas */
            gap: 20px; /* Espacio entre elementos */
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
            display: flex; /* Para alinear el texto y el icono de informaci√≥n */
            align-items: center;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s; /* Transici√≥n suave al enfocar */
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #27ae60; /* Borde verde al enfocar */
        }
        
        /* Estilo para el nuevo icono de informaci√≥n */
        .info-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px; /* Tama√±o del c√≠rculo */
            height: 18px; /* Tama√±o del c√≠rculo */
            border-radius: 50%; /* Hacerlo circular */
            background-color: #5b8def; /* Color de fondo del c√≠rculo - AHORA AZUL */
            color: white; /* Color del texto 'i' */
            font-size: 12px; /* Tama√±o de la 'i' */
            font-weight: bold;
            margin-left: 5px; /* Espacio entre el texto y el icono */
            cursor: help; /* Cursor de ayuda para el tooltip */
            transition: background-color 0.2s;
        }

        .info-icon:hover {
            background-color: #4a7fd6; /* Un azul ligeramente m√°s oscuro al pasar el rat√≥n */
        }

        .calculate-btn, .compare-btn, .goals-btn, .sensitivity-btn, .export-btn { /* Clase a√±adida para el nuevo bot√≥n */
            grid-column: 1 / -1; /* Ocupa ambas columnas */
            padding: 12px;
            background-color: #27ae60; /* Color verde */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px; /* Espacio entre botones si est√°n apilados */
        }

        .calculate-btn:hover, .compare-btn:hover, .goals-btn:hover, .sensitivity-btn:hover, .export-btn:hover {
            background-color: #219150; /* Verde m√°s oscuro al pasar el rat√≥n */
        }

        /* --- Estilos de la Secci√≥n de Resultados --- */
        #results-section {
            display: none; /* Oculto por defecto, se muestra con JS */
            border-top: 1px solid #eee; /* L√≠nea divisoria */
            padding-top: 25px;
            opacity: 0; /* Inicialmente transparente para la transici√≥n */
            transition: opacity 0.5s ease-in-out; /* Transici√≥n de opacidad */
        }

        #results-section.visible {
            opacity: 1; /* Completamente visible */
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Columnas adaptables */
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: #f8f9fa; /* Fondo claro para las tarjetas */
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef; /* Borde sutil */
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; /* Transiciones para la tarjeta */
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
        }

        .summary-card .icon {
            font-size: 24px;
            margin-bottom: 8px;
            transition: transform 0.3s ease; /* Transici√≥n para el icono */
        }
        
        /* Iconos espec√≠ficos para las tarjetas de resumen */
        .summary-card:nth-child(1) .icon { content: 'üí∞'; } /* Capital final */
        .summary-card:nth-child(2) .icon { content: 'üëõ'; } /* Capital inicial */
        .summary-card:nth-child(3) .icon { content: 'üíµ'; } /* Aportaciones peri√≥dicas */
        .summary-card:nth-child(4) .icon { content: 'üìà'; } /* Intereses */
        /* El icono de rentabilidad se maneja con JS */

        .summary-card .label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            transition: color 0.3s ease, font-size 0.3s ease; /* Transici√≥n para el valor */
        }
        
        .summary-card .value.positive { color: #27ae60; } /* Verde para valores positivos */
        .summary-card .value.negative { color: #e74c3c; } /* Rojo para valores negativos */

        .investment-summary-text {
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e6f7ed; /* Un fondo suave para el texto */
            border-left: 5px solid #27ae60; /* Borde verde para destacar */
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            opacity: 0; /* Inicialmente transparente para la transici√≥n */
            transition: opacity 0.5s ease-in-out; /* Transici√≥n de opacidad */
        }

        .investment-summary-text.visible {
            opacity: 1; /* Completamente visible */
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Gr√°fico de pastel m√°s peque√±o, de barras m√°s grande */
            gap: 30px;
            margin-bottom: 30px;
            align-items: center; /* Centra verticalmente los gr√°ficos */
        }

        /* Ajuste de altura para los contenedores de gr√°ficos */
        .chart-box {
            position: relative; /* Necesario para que el canvas se ajuste */
            height: 300px; /* Altura fija para ambos gr√°ficos */
            display: flex; /* Para centrar el canvas si es necesario */
            justify-content: center;
            align-items: center;
        }

        .table-container {
            max-height: 400px; /* Altura m√°xima para la tabla con scroll */
            overflow-y: auto; /* Scroll vertical si excede la altura */
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px; /* Espacio antes del bot√≥n de exportar */
        }

        table {
            width: 100%;
            border-collapse: collapse; /* Elimina el espacio entre celdas */
        }

        th, td {
            padding: 12px;
            text-align: right; /* Alineaci√≥n de texto a la derecha para n√∫meros */
            border-bottom: 1px solid #ddd;
        }

        thead th {
            background-color: #e9ecef; /* Fondo para el encabezado de la tabla */
            position: sticky; /* Encabezado fijo al hacer scroll */
            top: 0;
            font-weight: 600;
            color: #495057;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Color de fila alternado */
        }

        tbody tr:hover {
            background-color: #e2e6ea; /* Resaltar fila al pasar el rat√≥n */
        }

        /* --- Secci√≥n de Recursos Educativos --- */
        #educational-resources {
            display: none; /* Oculto por defecto */
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #eee;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #educational-resources.visible {
            opacity: 1;
        }

        #educational-resources h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #educational-resources p {
            margin-bottom: 15px;
            line-height: 1.7;
            color: #555;
            text-align: justify;
        }

        #educational-resources .resource-link {
            display: block;
            text-align: center;
            margin-top: 20px;
        }

        #educational-resources .resource-link button {
            padding: 10px 20px;
            background-color: #3498db; /* Un azul diferente para este bot√≥n */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #educational-resources .resource-link button:hover {
            background-color: #2980b9;
        }


        /* --- Modal Styling (reused) --- */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            opacity: 0; /* Inicialmente transparente para la transici√≥n */
            transition: opacity 0.3s ease-in-out;
        }

        .modal.visible {
            display: flex; /* Se muestra con JS */
            opacity: 1; /* Completamente visible */
        }
        
        .modal-content {
            background: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 700px; /* Ajuste para el modal de comparaci√≥n */
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(30px); /* Inicialmente un poco desplazado para la animaci√≥n */
            transition: transform 0.3s ease-out; /* Transici√≥n para el desplazamiento */
        }
        
        .modal.visible .modal-content {
            transform: translateY(0); /* Vuelve a su posici√≥n original al ser visible */
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: #2c3e50;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .form-actions button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            background-color: #e0e0e0;
            color: #333;
        }
        .form-actions button:hover {
            background-color: #bdbdbd;
        }
        .form-actions button.primary {
            background-color: #27ae60;
            color: white;
        }
        .form-actions button.primary:hover {
            background-color: #219150;
        }

        .goals-options, .sensitivity-options, .comparison-options { /* A√±adido .comparison-options */
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .goals-options button, .sensitivity-options button, .comparison-options button { /* A√±adido .comparison-options button */
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .goals-options button.active, .sensitivity-options button.active, .comparison-options button.active { /* A√±adido .comparison-options button.active */
            background-color: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .goals-options button:hover:not(.active), .sensitivity-options button:hover:not(.active), .comparison-options button:hover:not(.active) { /* A√±adido .comparison-options button:hover:not(.active) */
            background-color: #e0e0e0;
        }

        .goals-input-group, .sensitivity-input-group, .comparison-input-group { /* A√±adido .comparison-input-group */
            margin-bottom: 15px;
        }

        .goals-input-group label, .sensitivity-input-group label, .comparison-input-group label { /* A√±adido .comparison-input-group label */
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .goals-input-group input,
        .goals-input-group select,
        .sensitivity-input-group input,
        .sensitivity-input-group select,
        .comparison-input-group input,
        .comparison-input-group select { /* A√±adido .comparison-input-group input, select */
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .goals-result, .sensitivity-result { /* A√±adido .sensitivity-result */
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f7ed;
            border-left: 5px solid #27ae60;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        .sensitivity-chart-container, .comparison-chart-container { /* Unificado para ambos gr√°ficos */
            height: 350px; /* Altura para el gr√°fico de sensibilidad y comparaci√≥n */
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sensitivity-parameters {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.5;
            border: 1px solid #e0e0e0;
        }
        .sensitivity-parameters strong {
            color: #2c3e50;
        }

        /* --- Comparison Modal Specific Styles --- */
        .comparison-scenario-grid { /* Usar grid para los dos escenarios */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .comparison-scenario {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f8f8;
        }
        .comparison-scenario h3 {
            text-align: center;
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
        }
        /* .comparison-chart-container ya est√° definido arriba */


        /* --- Estilos para pantallas peque√±as (responsive) --- */
        @media (max-width: 768px) {
            .calculator-form {
                grid-template-columns: 1fr; /* Una columna en pantallas peque√±as */
            }
            .charts-container {
                grid-template-columns: 1fr; /* Una columna para los gr√°ficos */
            }
            .container {
                padding: 20px; /* Menos padding en pantallas peque√±as */
            }
            .modal-content {
                padding: 1.5rem;
            }
            .comparison-scenario-grid {
                grid-template-columns: 1fr; /* Una columna en pantallas peque√±as para comparaci√≥n */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Calculadora de Inter√©s Compuesto</h1>
    </header>

    <form id="compound-interest-form">
        <div class="calculator-form">
            <div class="form-group">
                <label for="initial-capital">Capital inicial (‚Ç¨) <span class="info-icon" title="La cantidad de dinero con la que empiezas tu inversi√≥n.">i</span></label>
                <input type="number" id="initial-capital" value="1000" step="100" required>
            </div>
            <div class="form-group">
                <label for="periodic-contribution">Aportaci√≥n peri√≥dica (‚Ç¨) <span class="info-icon" title="Importe a aportar en cada per√≠odo. Usa un n√∫mero negativo para simular retiradas.">i</span></label>
                <input type="number" id="periodic-contribution" value="50" step="10">
            </div>
            <div class="form-group">
                <label for="frequency">Frecuencia <span class="info-icon" title="La periodicidad de las aportaciones o retiradas.">i</span></label>
                <select id="frequency">
                    <option value="1" selected>Anual</option>
                    <option value="2">Semestral</option>
                    <option value="4">Trimestral</option>
                    <option value="12">Mensual</option>
                    <option value="52">Semanal</option>
                    <option value="365">Diaria</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contribution-moment">Momento de la aportaci√≥n <span class="info-icon" title="Si la aportaci√≥n se realiza antes o despu√©s de la capitalizaci√≥n de intereses.">i</span></label>
                <select id="contribution-moment">
                    <option value="start" selected>Comienzo del per√≠odo</option>
                    <option value="end">Fin del per√≠odo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="interest-rate">Inter√©s anual (%) <span class="info-icon" title="Tasa de inter√©s anual esperada. Usa un n√∫mero negativo para simular el efecto de la inflaci√≥n.">i</span></label>
                <input type="number" id="interest-rate" value="5" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="years">N√∫mero de a√±os <span class="info-icon" title="La duraci√≥n total en a√±os de la inversi√≥n.">i</span></label>
                <input type="number" id="years" value="25" step="1" required> <!-- Valor por defecto cambiado a 25 -->
            </div>
            <button type="submit" class="calculate-btn">Calcular</button>
            <button type="button" class="compare-btn" id="compare-scenarios-btn">Comparar Escenarios</button>
            <button type="button" class="goals-btn" id="goals-btn">Objetivos de Ahorro</button>
            <button type="button" class="sensitivity-btn" id="sensitivity-analysis-btn">An√°lisis de Sensibilidad</button> <!-- Nuevo bot√≥n -->
        </div>
    </form>

    <div id="results-section">
        <div class="results-summary">
            <div class="summary-card">
                <div class="icon">üí∞</div>
                <div class="label">Capital final</div>
                <div class="value" id="final-capital-result"></div>
            </div>
            <div class="summary-card">
                <div class="icon">üëõ</div>
                <div class="label">Capital inicial</div>
                <div class="value" id="initial-capital-result"></div>
            </div>
            <div class="summary-card">
                <div class="icon">üíµ</div>
                <div class="label">Aportaciones peri√≥dicas</div>
                <div class="value" id="contributions-result"></div>
            </div>
            <div class="summary-card">
                <div class="icon">üìà</div>
                <div class="label">Intereses</div>
                <div class="value" id="interest-result"></div>
            </div>
            <div class="summary-card">
                <div class="icon" id="rentabilidad-icon"></div>
                <div class="label">Rentabilidad media <span class="info-icon" title="Rentabilidad media anualizada de la inversi√≥n. [(Patrimonio final - capital total aportado) / capital total aportado] / n¬∞ de a√±os. Esta f√≥rmula es una simplificaci√≥n; la rentabilidad real puede variar.">i</span></div>
                <div class="value" id="average-return-result"></div>
            </div>
        </div>

        <div id="investment-summary-text" class="investment-summary-text">
            <!-- El texto de resumen se insertar√° aqu√≠ -->
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <canvas id="distribution-chart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="evolution-chart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>A√±o</th>
                        <th>Aportaci√≥n peri√≥dica</th>
                        <th>Aportaciones acum.</th>
                        <th>Intereses</th>
                        <th>Intereses acum.</th>
                        <th>Capital total</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                </tbody>
            </table>
        </div>
        <button type="button" class="export-btn" id="export-data-btn">Exportar Datos a CSV</button> <!-- Bot√≥n de exportar -->

        <!-- Secci√≥n de Recursos Educativos -->
        <div id="educational-resources">
            <h2>Recursos Educativos: Entendiendo el Inter√©s Compuesto</h2>
            <p>
                El <strong>inter√©s compuesto</strong> es el inter√©s que se calcula no solo sobre el capital inicial, sino tambi√©n sobre los intereses acumulados de per√≠odos anteriores. Es lo que Albert Einstein supuestamente llam√≥ la "octava maravilla del mundo" o "la fuerza m√°s poderosa del universo". En t√©rminos simples, es "inter√©s sobre inter√©s".
            </p>
            <p>
                <strong>¬øPor qu√© es tan importante?</strong> El poder del inter√©s compuesto reside en su capacidad para generar un crecimiento exponencial a largo plazo. Cuanto antes empieces a invertir y m√°s tiempo dejes que tus inversiones crezcan, mayor ser√° el impacto del inter√©s compuesto en tu patrimonio. Incluso peque√±as cantidades invertidas regularmente pueden convertirse en sumas considerables con el tiempo.
            </p>
            <h3>Consejos de Inversi√≥n B√°sicos:</h3>
            <ul>
                <li><strong>Empieza temprano:</strong> El tiempo es tu mayor aliado con el inter√©s compuesto.</li>
                <li><strong>S√© constante:</strong> Las aportaciones regulares, aunque sean peque√±as, marcan una gran diferencia.</li>
                <li><strong>Invierte a largo plazo:</strong> Evita la tentaci√≥n de retirar tus fondos prematuramente.</li>
                <li><strong>Diversifica:</strong> No pongas todos tus huevos en la misma canasta.</li>
                <li><strong>Inf√≥rmate:</strong> Entender d√≥nde y c√≥mo inviertes es clave.</li>
            </ul>
            <div class="resource-link">
                <button onclick="window.open('https://es.wikipedia.org/wiki/Inter%C3%A9s_compuesto', '_blank')">Leer m√°s sobre Inter√©s Compuesto</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Comparaci√≥n de Escenarios -->
<div id="comparison-modal" class="modal">
    <div class="modal-content">
        <h2>Comparaci√≥n de Escenarios</h2>
        <div class="comparison-area">
            <div class="comparison-options">
                <button id="comp-type-final-capital" class="active">Capital Final</button>
                <button id="comp-type-evolution">Evoluci√≥n del Capital</button>
            </div>

            <div class="comparison-scenario-grid">
                <div class="comparison-scenario">
                    <h3>Escenario 1</h3>
                    <div class="form-group">
                        <label for="comp-initial-capital-1">Capital inicial (‚Ç¨)</label>
                        <input type="number" id="comp-initial-capital-1" value="1000" step="100">
                    </div>
                    <div class="form-group">
                        <label for="comp-periodic-contribution-1">Aportaci√≥n peri√≥dica (‚Ç¨)</label>
                        <input type="number" id="comp-periodic-contribution-1" value="50" step="10">
                    </div>
                    <div class="form-group">
                        <label for="comp-frequency-1">Frecuencia</label>
                        <select id="comp-frequency-1">
                            <option value="1" selected>Anual</option>
                            <option value="2">Semestral</option>
                            <option value="4">Trimestral</option>
                            <option value="12">Mensual</option>
                            <option value="52">Semanal</option>
                            <option value="365">Diaria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comp-contribution-moment-1">Momento de la aportaci√≥n</label>
                        <select id="comp-contribution-moment-1">
                            <option value="start" selected>Comienzo del per√≠odo</option>
                            <option value="end">Fin del per√≠odo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comp-interest-rate-1">Inter√©s anual (%)</label>
                        <input type="number" id="comp-interest-rate-1" value="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="comp-years-1">N√∫mero de a√±os</label>
                        <input type="number" id="comp-years-1" value="25" step="1">
                    </div>
                </div>

                <div class="comparison-scenario">
                    <h3>Escenario 2</h3>
                    <div class="form-group">
                        <label for="comp-initial-capital-2">Capital inicial (‚Ç¨)</label>
                        <input type="number" id="comp-initial-capital-2" value="2000" step="100">
                    </div>
                    <div class="form-group">
                        <label for="comp-periodic-contribution-2">Aportaci√≥n peri√≥dica (‚Ç¨)</label>
                        <input type="number" id="comp-periodic-contribution-2" value="30" step="10">
                    </div>
                    <div class="form-group">
                        <label for="comp-frequency-2">Frecuencia</label>
                        <select id="comp-frequency-2">
                            <option value="1" selected>Anual</option>
                            <option value="2">Semestral</option>
                            <option value="4">Trimestral</option>
                            <option value="12">Mensual</option>
                            <option value="52">Semanal</option>
                            <option value="365">Diaria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comp-contribution-moment-2">Momento de la aportaci√≥n</label>
                        <select id="comp-contribution-moment-2">
                            <option value="start" selected>Comienzo del per√≠odo</option>
                            <option value="end">Fin del per√≠odo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comp-interest-rate-2">Inter√©s anual (%)</label>
                        <input type="number" id="comp-interest-rate-2" value="6" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="comp-years-2">N√∫mero de a√±os</label>
                        <input type="number" id="comp-years-2" value="20" step="1">
                    </div>
                </div>
            </div>
            
            <button type="button" class="calculate-goal-btn primary" id="run-comparison-btn">Comparar</button>
            <div class="comparison-chart-container">
                <canvas id="comparison-chart"></canvas>
            </div>
            <div class="sensitivity-result" id="comparison-message" style="display: none;"></div>
        </div>
        <div class="form-actions">
            <button type="button" id="close-comparison-modal-btn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para Objetivos de Ahorro -->
<div id="goals-modal" class="modal">
    <div class="modal-content">
        <h2>Objetivos de Ahorro</h2>
        <div class="goals-area">
            <div class="goals-options">
                <button id="calc-contribution-btn" class="active">Calcular Aportaci√≥n</button>
                <button id="calc-years-btn">Calcular A√±os</button>
            </div>

            <div id="calculate-contribution-section">
                <h3>Calcular Aportaci√≥n Peri√≥dica Necesaria</h3>
                <div class="goals-input-group">
                    <label for="goal-target-capital-contrib">Capital Objetivo (‚Ç¨)</label>
                    <input type="number" id="goal-target-capital-contrib" value="100000" step="1000" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-initial-capital-contrib">Capital Inicial (‚Ç¨)</label>
                    <input type="number" id="goal-initial-capital-contrib" value="1000" step="100" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-interest-rate-contrib">Inter√©s anual (%)</label>
                    <input type="number" id="goal-interest-rate-contrib" value="5" step="0.1" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-years-contrib">N√∫mero de A√±os</label>
                    <input type="number" id="goal-years-contrib" value="25" step="1" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-frequency-contrib">Frecuencia</label>
                    <select id="goal-frequency-contrib">
                        <option value="1" selected>Anual</option>
                        <option value="2">Semestral</option>
                        <option value="4">Trimestral</option>
                        <option value="12">Mensual</option>
                        <option value="52">Semanal</option>
                        <option value="365">Diaria</option>
                    </select>
                </div>
                <div class="goals-input-group">
                    <label for="goal-contribution-moment-contrib">Momento de la aportaci√≥n</label>
                    <select id="goal-contribution-moment-contrib">
                        <option value="start" selected>Comienzo del per√≠odo</option>
                        <option value="end">Fin del per√≠odo</option>
                    </select>
                </div>
                <button type="button" class="calculate-goal-btn primary" id="calculate-contribution-value-btn">Calcular Aportaci√≥n</button>
                <div class="goals-result" id="required-contribution-result" style="display: none;"></div>
            </div>

            <div id="calculate-years-section" style="display: none;">
                <h3>Calcular A√±os Necesarios</h3>
                <div class="goals-input-group">
                    <label for="goal-target-capital-years">Capital Objetivo (‚Ç¨)</label>
                    <input type="number" id="goal-target-capital-years" value="100000" step="1000" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-initial-capital-years">Capital Inicial (‚Ç¨)</label>
                    <input type="number" id="goal-initial-capital-years" value="1000" step="100" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-periodic-contribution-years">Aportaci√≥n Peri√≥dica (‚Ç¨)</label>
                    <input type="number" id="goal-periodic-contribution-years" value="50" step="10">
                </div>
                <div class="goals-input-group">
                    <label for="goal-interest-rate-years">Inter√©s anual (%)</label>
                    <input type="number" id="goal-interest-rate-years" value="5" step="0.1" required>
                </div>
                <div class="goals-input-group">
                    <label for="goal-frequency-years">Frecuencia</label>
                    <select id="goal-frequency-years">
                        <option value="1" selected>Anual</option>
                        <option value="2">Semestral</option>
                        <option value="4">Trimestral</option>
                        <option value="12">Mensual</option>
                        <option value="52">Semanal</option>
                        <option value="365">Diaria</option>
                    </select>
                </div>
                <div class="goals-input-group">
                    <label for="goal-contribution-moment-years">Momento de la aportaci√≥n</label>
                    <select id="goal-contribution-moment-years">
                        <option value="start" selected>Comienzo del per√≠odo</option>
                        <option value="end">Fin del per√≠odo</option>
                    </select>
                </div>
                <button type="button" class="calculate-goal-btn primary" id="calculate-years-value-btn">Calcular A√±os</button>
                <div class="goals-result" id="required-years-result" style="display: none;"></div>
            </div>
        </div>
        <div class="form-actions">
            <button type="button" id="close-goals-modal-btn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Nuevo Modal para An√°lisis de Sensibilidad -->
<div id="sensitivity-modal" class="modal">
    <div class="modal-content">
        <h2>An√°lisis de Sensibilidad</h2>
        <div class="sensitivity-area">
            <div class="sensitivity-parameters">
                <h3>Par√°metros Base del C√°lculo:</h3>
                <p>Capital inicial: <strong id="sens-initial-capital"></strong></p>
                <p>Aportaci√≥n peri√≥dica: <strong id="sens-periodic-contribution"></strong></p>
                <p>Frecuencia: <strong id="sens-frequency"></strong></p>
                <p>Momento de la aportaci√≥n: <strong id="sens-contribution-moment"></strong></p>
                <p>N√∫mero de a√±os: <strong id="sens-years"></strong></p>
            </div>
            <p>Analiza c√≥mo el capital final var√≠a al cambiar la tasa de inter√©s.</p>
            <div class="sensitivity-input-group">
                <label for="sensitivity-rate-start">Tasa de Inter√©s Inicial (%)</label>
                <input type="number" id="sensitivity-rate-start" value="1" step="0.1" min="-100" max="100">
            </div>
            <div class="sensitivity-input-group">
                <label for="sensitivity-rate-end">Tasa de Inter√©s Final (%)</label>
                <input type="number" id="sensitivity-rate-end" value="10" step="0.1" min="-100" max="100">
            </div>
            <div class="sensitivity-input-group">
                <label for="sensitivity-rate-step">Paso (%)</label>
                <input type="number" id="sensitivity-rate-step" value="0.5" step="0.1" min="0.1">
            </div>
            <button type="button" class="calculate-goal-btn primary" id="run-sensitivity-analysis-btn">Ejecutar An√°lisis</button>
            <div class="sensitivity-chart-container">
                <canvas id="sensitivity-chart"></canvas>
            </div>
            <div class="sensitivity-result" id="sensitivity-message" style="display: none;"></div>
        </div>
        <div class="form-actions">
            <button type="button" id="close-sensitivity-modal-btn">Cerrar</button>
        </div>
    </div>
</div>


<script>
    // Variables globales para los gr√°ficos para poder destruirlos antes de volver a renderizar
    let distributionChartInstance = null;
    let evolutionChartInstance = null;
    let sensitivityChartInstance = null; // Nueva instancia para el gr√°fico de sensibilidad
    let comparisonChartInstance = null; // Nueva instancia para el gr√°fico de comparaci√≥n

    // Funci√≥n para formatear n√∫meros a formato de moneda local (Euro)
    function formatCurrency(number) {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(number);
    }

    // Funci√≥n principal de c√°lculo de inter√©s compuesto (reutilizable)
    function calculateCompoundInterest(initialCapital, periodicContribution, frequency, contributionMoment, annualInterestRate, years) {
        let balance = initialCapital;
        let totalContributions = 0;
        let totalInterestEarned = 0;

        for (let year = 1; year <= years; year++) {
            let yearlyInterest = 0;
            let yearlyContribution = 0;

            for (let period = 0; period < frequency; period++) {
                const contributionThisPeriod = periodicContribution;

                if (contributionMoment === 'start') {
                    balance += contributionThisPeriod;
                }

                const interestThisPeriod = balance * (annualInterestRate / frequency);
                balance += interestThisPeriod;
                yearlyInterest += interestThisPeriod;

                if (contributionMoment === 'end') {
                    balance += contributionThisPeriod;
                }
                yearlyContribution += contributionThisPeriod;
            }
            totalContributions += yearlyContribution;
            totalInterestEarned += yearlyInterest;
        }
        return {
            finalCapital: balance,
            totalContributions: totalContributions,
            netInterest: balance - (initialCapital + totalContributions)
        };
    }

    // Nueva funci√≥n para obtener la evoluci√≥n del capital por a√±o
    function calculateCompoundInterestEvolution(initialCapital, periodicContribution, frequency, contributionMoment, annualInterestRate, years) {
        let balance = initialCapital;
        const evolution = [{ year: 0, balance: initialCapital }]; // Capital inicial en el a√±o 0

        for (let year = 1; year <= years; year++) {
            for (let period = 0; period < frequency; period++) {
                const contributionThisPeriod = periodicContribution;

                if (contributionMoment === 'start') {
                    balance += contributionThisPeriod;
                }

                const interestThisPeriod = balance * (annualInterestRate / frequency);
                balance += interestThisPeriod;

                if (contributionMoment === 'end') {
                    balance += contributionThisPeriod;
                }
            }
            evolution.push({ year: year, balance: balance });
        }
        return evolution;
    }
    
    document.getElementById('compound-interest-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Evita que la p√°gina se recargue

        // 1. Recoger los datos del formulario principal
        const initialCapital = parseFloat(document.getElementById('initial-capital').value) || 0;
        const periodicContribution = parseFloat(document.getElementById('periodic-contribution').value) || 0;
        const frequency = parseInt(document.getElementById('frequency').value);
        const contributionMoment = document.getElementById('contribution-moment').value;
        const annualInterestRate = parseFloat(document.getElementById('interest-rate').value) / 100;
        const years = parseInt(document.getElementById('years').value);

        // 2. L√≥gica de c√°lculo (reutilizando la funci√≥n)
        const results = calculateCompoundInterest(initialCapital, periodicContribution, frequency, contributionMoment, annualInterestRate, years);
        const finalCapital = results.finalCapital;
        const totalContributions = results.totalContributions;
        const netInterest = results.netInterest;
        const totalInvested = initialCapital + totalContributions;

        // C√°lculo de la rentabilidad media anualizada
        let averageReturn = 0;
        if (totalInvested > 0) {
            averageReturn = (netInterest / totalInvested) / years * 100;
        } else if (initialCapital > 0 && netInterest !== 0) { 
            averageReturn = (netInterest / initialCapital) / years * 100;
        }

        // Datos para el gr√°fico de evoluci√≥n (columnas apiladas)
        const evolutionData = {
            labels: [],
            datasets: [
                { label: 'Capital Inicial', data: [], backgroundColor: '#16a085' },
                { label: 'Aportaciones Peri√≥dicas', data: [], backgroundColor: '#1abc9c' },
                { label: 'Intereses', data: [], backgroundColor: '#5b8def' }
            ]
        };

        // Recalcular para la tabla y el gr√°fico de evoluci√≥n
        let currentBalanceForEvolution = initialCapital;
        let currentTotalContributionsForEvolution = 0;
        let currentTotalInterestEarnedForEvolution = 0;

        const tableBody = document.getElementById('results-table-body');
        tableBody.innerHTML = ''; // Limpiar la tabla anterior

        for (let year = 1; year <= years; year++) {
            let yearlyInterest = 0;
            let yearlyContribution = 0;

            for (let period = 0; period < frequency; period++) {
                const contributionThisPeriod = periodicContribution;

                if (contributionMoment === 'start') {
                    currentBalanceForEvolution += contributionThisPeriod;
                }

                const interestThisPeriod = currentBalanceForEvolution * (annualInterestRate / frequency);
                currentBalanceForEvolution += interestThisPeriod;
                yearlyInterest += interestThisPeriod;

                if (contributionMoment === 'end') {
                    currentBalanceForEvolution += contributionThisPeriod;
                }
                yearlyContribution += contributionThisPeriod;
            }
            currentTotalContributionsForEvolution += yearlyContribution;
            currentTotalInterestEarnedForEvolution += yearlyInterest;
            
            evolutionData.labels.push(`A√±o ${year}`);
            evolutionData.datasets[0].data.push(initialCapital);
            evolutionData.datasets[1].data.push(currentTotalContributionsForEvolution);
            evolutionData.datasets[2].data.push(currentTotalInterestEarnedForEvolution);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${year}</td>
                <td>${formatCurrency(yearlyContribution)}</td>
                <td>${formatCurrency(initialCapital + currentTotalContributionsForEvolution)}</td>
                <td>${formatCurrency(yearlyInterest)}</td>
                <td>${formatCurrency(currentTotalInterestEarnedForEvolution)}</td>
                <td><strong>${formatCurrency(currentBalanceForEvolution)}</strong></td>
            `;
            tableBody.appendChild(row);
        }

        // 3. Mostrar resultados en la secci√≥n de resumen con animaci√≥n
        const resultsSection = document.getElementById('results-section');
        const investmentSummaryTextElement = document.getElementById('investment-summary-text');
        const educationalResourcesSection = document.getElementById('educational-resources');

        resultsSection.classList.remove('visible');
        investmentSummaryTextElement.classList.remove('visible');
        educationalResourcesSection.classList.remove('visible');

        setTimeout(() => {
            document.getElementById('final-capital-result').textContent = formatCurrency(finalCapital);
            document.getElementById('initial-capital-result').textContent = formatCurrency(initialCapital);
            document.getElementById('contributions-result').textContent = formatCurrency(totalContributions);
            document.getElementById('interest-result').textContent = formatCurrency(netInterest);
            
            const avgReturnElem = document.getElementById('average-return-result');
            const rentabilidadIcon = document.getElementById('rentabilidad-icon');

            avgReturnElem.textContent = `${averageReturn.toFixed(2)}%`;
            if(averageReturn >= 0) {
                avgReturnElem.className = 'value positive';
                rentabilidadIcon.textContent = '‚úÖ';
            } else {
                avgReturnElem.className = 'value negative';
                rentabilidadIcon.textContent = '‚ùå';
            }

            // 4. Generar y mostrar el texto de resumen de la inversi√≥n
            let summaryText = `Con un capital inicial de <strong>${formatCurrency(initialCapital)}</strong>`;
            if (periodicContribution > 0) {
                summaryText += ` y aportaciones peri√≥dicas de <strong>${formatCurrency(periodicContribution)}</strong>`;
            } else if (periodicContribution < 0) {
                summaryText += ` y retiradas peri√≥dicas de <strong>${formatCurrency(Math.abs(periodicContribution))}</strong>`;
            }
            summaryText += ` durante <strong>${years} a√±os</strong>, a una tasa de inter√©s anual del <strong>${(annualInterestRate * 100).toFixed(2)}%</strong>, tu inversi√≥n alcanzar√≠a un capital final de <strong>${formatCurrency(finalCapital)}</strong>.`;
            
            if (netInterest >= 0) {
                summaryText += ` Esto representa un total de <strong>${formatCurrency(totalContributions)}</strong> en aportaciones (o retiradas netas) y <strong>${formatCurrency(netInterest)}</strong> en intereses ganados, con una rentabilidad media anualizada del <strong>${averageReturn.toFixed(2)}%</strong>.`;
            } else {
                summaryText += ` Esto representa un total de <strong>${formatCurrency(totalContributions)}</strong> en aportaciones (o retiradas netas) y una p√©rdida de <strong>${formatCurrency(Math.abs(netInterest))}</strong> en intereses, con una rentabilidad media anualizada del <strong>${averageReturn.toFixed(2)}%</strong>.`;
            }
            investmentSummaryTextElement.innerHTML = summaryText;


            // 5. Renderizar los gr√°ficos
            renderDistributionChart(initialCapital, totalContributions, netInterest);
            renderEvolutionChart(evolutionData);

            resultsSection.style.display = 'block';
            resultsSection.classList.add('visible');
            investmentSummaryTextElement.classList.add('visible');
            educationalResourcesSection.style.display = 'block';
            educationalResourcesSection.classList.add('visible');
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }, 50);
    });

    // Funci√≥n para renderizar el gr√°fico de distribuci√≥n (pastel)
    function renderDistributionChart(initial, contributions, interest) {
        if (distributionChartInstance) {
            distributionChartInstance.destroy();
        }
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        distributionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Capital inicial', 'Aportaciones peri√≥dicas', 'Intereses'],
                datasets: [{
                    data: [initial, contributions, interest > 0 ? interest : 0], 
                    backgroundColor: ['#16a085', '#1abc9c', '#5b8def'],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Distribuci√≥n del patrimonio'
                    }
                }
            }
        });
    }

    // Funci√≥n para renderizar el gr√°fico de evoluci√≥n (barras apiladas)
    function renderEvolutionChart(data) {
        if (evolutionChartInstance) {
            evolutionChartInstance.destroy();
        }
        const ctx = document.getElementById('evolution-chart').getContext('2d');
        evolutionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'Capital inicial', data: data.datasets[0].data, backgroundColor: '#16a085' },
                    { label: 'Aportaciones peri√≥dicas', data: data.datasets[1].data, backgroundColor: '#1abc9c' },
                    { label: 'Intereses', data: data.datasets[2].data, backgroundColor: '#5b8def' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del patrimonio'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Funcionalidad del Modal de Comparaci√≥n ---
    const compareScenariosBtn = document.getElementById('compare-scenarios-btn');
    const comparisonModal = document.getElementById('comparison-modal');
    const closeComparisonModalBtn = document.getElementById('close-comparison-modal-btn');
    const runComparisonBtn = document.getElementById('run-comparison-btn');
    const comparisonMessage = document.getElementById('comparison-message');

    const compTypeFinalCapitalBtn = document.getElementById('comp-type-final-capital');
    const compTypeEvolutionBtn = document.getElementById('comp-type-evolution');
    let currentComparisonType = 'final_capital'; // Estado para el tipo de comparaci√≥n

    compareScenariosBtn.addEventListener('click', () => {
        comparisonModal.classList.add('visible');
        if (comparisonChartInstance) {
            comparisonChartInstance.destroy();
        }
        comparisonMessage.style.display = 'none';
        // Asegurarse de que el bot√≥n de Capital Final est√© activo al abrir
        compTypeFinalCapitalBtn.click(); 
    });

    closeComparisonModalBtn.addEventListener('click', () => {
        comparisonModal.classList.remove('visible');
    });

    comparisonModal.addEventListener('click', (e) => {
        if (e.target === comparisonModal) {
            comparisonModal.classList.remove('visible');
        }
    });

    compTypeFinalCapitalBtn.addEventListener('click', () => {
        currentComparisonType = 'final_capital';
        compTypeFinalCapitalBtn.classList.add('active');
        compTypeEvolutionBtn.classList.remove('active');
        if (comparisonChartInstance) { comparisonChartInstance.destroy(); }
        comparisonMessage.style.display = 'none';
    });

    compTypeEvolutionBtn.addEventListener('click', () => {
        currentComparisonType = 'evolution';
        compTypeEvolutionBtn.classList.add('active');
        compTypeFinalCapitalBtn.classList.remove('active');
        if (comparisonChartInstance) { comparisonChartInstance.destroy(); }
        comparisonMessage.style.display = 'none';
    });


    runComparisonBtn.addEventListener('click', () => {
        // Recoger datos del Escenario 1
        const sc1_initialCapital = parseFloat(document.getElementById('comp-initial-capital-1').value) || 0;
        const sc1_periodicContribution = parseFloat(document.getElementById('comp-periodic-contribution-1').value) || 0;
        const sc1_frequency = parseInt(document.getElementById('comp-frequency-1').value);
        const sc1_contributionMoment = document.getElementById('comp-contribution-moment-1').value;
        const sc1_interestRate = parseFloat(document.getElementById('comp-interest-rate-1').value) / 100;
        const sc1_years = parseInt(document.getElementById('comp-years-1').value) || 0;

        // Recoger datos del Escenario 2
        const sc2_initialCapital = parseFloat(document.getElementById('comp-initial-capital-2').value) || 0;
        const sc2_periodicContribution = parseFloat(document.getElementById('comp-periodic-contribution-2').value) || 0;
        const sc2_frequency = parseInt(document.getElementById('comp-frequency-2').value);
        const sc2_contributionMoment = document.getElementById('comp-contribution-moment-2').value;
        const sc2_interestRate = parseFloat(document.getElementById('comp-interest-rate-2').value) / 100;
        const sc2_years = parseInt(document.getElementById('comp-years-2').value) || 0;

        // Validaciones b√°sicas
        if (sc1_years <= 0 || sc2_years <= 0) {
            comparisonMessage.textContent = 'El n√∫mero de a√±os debe ser mayor que 0 para ambos escenarios.';
            comparisonMessage.style.display = 'block';
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            return;
        }

        if (currentComparisonType === 'final_capital') {
            const result1 = calculateCompoundInterest(sc1_initialCapital, sc1_periodicContribution, sc1_frequency, sc1_contributionMoment, sc1_interestRate, sc1_years);
            const result2 = calculateCompoundInterest(sc2_initialCapital, sc2_periodicContribution, sc2_frequency, sc2_contributionMoment, sc2_interestRate, sc2_years);
            
            renderComparisonChart('bar', ['Escenario 1', 'Escenario 2'], [result1.finalCapital, result2.finalCapital]);

        } else if (currentComparisonType === 'evolution') {
            const evolution1 = calculateCompoundInterestEvolution(sc1_initialCapital, sc1_periodicContribution, sc1_frequency, sc1_contributionMoment, sc1_interestRate, sc1_years);
            const evolution2 = calculateCompoundInterestEvolution(sc2_initialCapital, sc2_periodicContribution, sc2_frequency, sc2_contributionMoment, sc2_interestRate, sc2_years);

            // Asegurarse de que los labels de los a√±os cubran ambos escenarios
            const maxYears = Math.max(sc1_years, sc2_years);
            const labels = Array.from({ length: maxYears + 1 }, (_, i) => `A√±o ${i}`);

            const datasets = [
                {
                    label: 'Escenario 1',
                    data: evolution1.map(e => e.balance),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'Escenario 2',
                    data: evolution2.map(e => e.balance),
                    borderColor: '#5b8def',
                    backgroundColor: 'rgba(91, 141, 239, 0.2)',
                    fill: false,
                    tension: 0.1
                }
            ];
            renderComparisonChart('line', labels, datasets);
        }
        
        comparisonMessage.style.display = 'none';
    });

    function renderComparisonChart(chartType, labels, dataOrDatasets) {
        if (comparisonChartInstance) {
            comparisonChartInstance.destroy();
        }
        const ctx = document.getElementById('comparison-chart').getContext('2d');

        let datasets = [];
        let titleText = '';
        let yAxisTitle = '';

        if (chartType === 'bar') {
            datasets = [{
                label: 'Capital Final (‚Ç¨)',
                data: dataOrDatasets, // En este caso, dataOrDatasets es un array de valores
                backgroundColor: ['#27ae60', '#5b8def'],
                borderColor: ['#219150', '#4a7fd6'],
                borderWidth: 1
            }];
            titleText = 'Comparaci√≥n de Capital Final entre Escenarios';
            yAxisTitle = 'Capital Final (‚Ç¨)';
        } else if (chartType === 'line') {
            datasets = dataOrDatasets; // En este caso, dataOrDatasets ya es un array de datasets
            titleText = 'Evoluci√≥n del Capital entre Escenarios';
            yAxisTitle = 'Capital (‚Ç¨)';
        }

        comparisonChartInstance = new Chart(ctx, {
            type: chartType,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: chartType === 'line' // Mostrar leyenda solo para el gr√°fico de l√≠neas
                    },
                    title: {
                        display: true,
                        text: titleText
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartType === 'line' ? 'A√±o' : ''
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yAxisTitle
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }


    // --- Funcionalidad del Modal de Objetivos de Ahorro ---
    const goalsBtn = document.getElementById('goals-btn');
    const goalsModal = document.getElementById('goals-modal');
    const closeGoalsModalBtn = document.getElementById('close-goals-modal-btn');
    const calcContributionBtn = document.getElementById('calc-contribution-btn');
    const calcYearsBtn = document.getElementById('calc-years-btn');
    const calculateContributionSection = document.getElementById('calculate-contribution-section');
    const calculateYearsSection = document.getElementById('calculate-years-section');
    const requiredContributionResult = document.getElementById('required-contribution-result');
    const requiredYearsResult = document.getElementById('required-years-result');

    goalsBtn.addEventListener('click', () => {
        goalsModal.classList.add('visible');
        calcContributionBtn.click(); // Activar la secci√≥n de calcular aportaci√≥n por defecto
    });

    closeGoalsModalBtn.addEventListener('click', () => {
        goalsModal.classList.remove('visible');
        requiredContributionResult.style.display = 'none';
        requiredYearsResult.style.display = 'none';
    });

    goalsModal.addEventListener('click', (e) => {
        if (e.target === goalsModal) {
            goalsModal.classList.remove('visible');
            requiredContributionResult.style.display = 'none';
            requiredYearsResult.style.display = 'none';
        }
    });

    calcContributionBtn.addEventListener('click', () => {
        calcContributionBtn.classList.add('active');
        calcYearsBtn.classList.remove('active');
        calculateContributionSection.style.display = 'block';
        calculateYearsSection.style.display = 'none';
        requiredContributionResult.style.display = 'none';
    });

    calcYearsBtn.addEventListener('click', () => {
        calcYearsBtn.classList.add('active');
        calcContributionBtn.classList.remove('active');
        calculateYearsSection.style.display = 'block';
        calculateContributionSection.style.display = 'none';
        requiredYearsResult.style.display = 'none';
    });

    // L√≥gica de C√°lculo de Objetivos
    document.getElementById('calculate-contribution-value-btn').addEventListener('click', () => {
        const targetCapital = parseFloat(document.getElementById('goal-target-capital-contrib').value);
        const initial = parseFloat(document.getElementById('goal-initial-capital-contrib').value);
        const rate = parseFloat(document.getElementById('goal-interest-rate-contrib').value) / 100;
        const numYears = parseInt(document.getElementById('goal-years-contrib').value);
        const freq = parseInt(document.getElementById('goal-frequency-contrib').value);
        const moment = document.getElementById('goal-contribution-moment-contrib').value;

        let requiredContribution = 0;
        if (targetCapital <= initial) {
            requiredContribution = 0;
        } else if (numYears === 0) {
            requiredContribution = (targetCapital - initial); // Necesita cubrir la diferencia en el mismo periodo
        } else {
            const periods = numYears * freq;
            const effectiveRate = rate / freq;
            
            let finalCapitalFromInitial = initial * Math.pow(1 + effectiveRate, periods);

            if (finalCapitalFromInitial >= targetCapital) {
                requiredContribution = 0;
            } else {
                const capitalNeededFromContributions = targetCapital - finalCapitalFromInitial;
                if (effectiveRate > 0) {
                    const factor = (Math.pow(1 + effectiveRate, periods) - 1) / effectiveRate;
                    if (moment === 'start') {
                        requiredContribution = capitalNeededFromContributions / (factor * (1 + effectiveRate));
                    } else { // end
                        requiredContribution = capitalNeededFromContributions / factor;
                    }
                } else { // Tasa de inter√©s 0
                     requiredContribution = capitalNeededFromContributions / periods;
                }
            }
        }

        requiredContributionResult.innerHTML = `Necesitar√≠as aportar <strong>${formatCurrency(requiredContribution)}</strong> ${freq === 1 ? 'anualmente' : freq === 2 ? 'semestralmente' : freq === 4 ? 'trimestralmente' : freq === 12 ? 'mensualmente' : freq === 52 ? 'semanalmente' : 'diariamente'}.`;
        requiredContributionResult.style.display = 'block';
    });

    document.getElementById('calculate-years-value-btn').addEventListener('click', () => {
        const targetCapital = parseFloat(document.getElementById('goal-target-capital-years').value);
        const initial = parseFloat(document.getElementById('goal-initial-capital-years').value);
        const periodic = parseFloat(document.getElementById('goal-periodic-contribution-years').value);
        const rate = parseFloat(document.getElementById('goal-interest-rate-years').value) / 100;
        const freq = parseInt(document.getElementById('goal-frequency-years').value);
        const moment = document.getElementById('goal-contribution-moment-years').value;

        let yearsNeeded = 0;
        
        if (targetCapital <= initial) {
            yearsNeeded = 0;
        } else if (rate === 0 && periodic === 0) {
            yearsNeeded = (targetCapital > initial) ? Infinity : 0;
        } else {
            let currentBalance = initial;
            let yearsCount = 0;
            const maxYears = 500; // L√≠mite para evitar bucles infinitos
            
            const effectiveRate = rate / freq;

            for (let i = 0; i < maxYears; i++) {
                if (currentBalance >= targetCapital) {
                    yearsNeeded = yearsCount;
                    break;
                }

                yearsCount++;
                for (let period = 0; period < freq; period++) {
                    if (moment === 'start') {
                        currentBalance += periodic;
                    }
                    currentBalance += currentBalance * effectiveRate;
                    if (moment === 'end') {
                        currentBalance += periodic;
                    }
                }
            }
            if (currentBalance < targetCapital) {
                yearsNeeded = Infinity;
            }
        }

        if (yearsNeeded === Infinity) {
            requiredYearsResult.innerHTML = `El capital objetivo no se alcanzar√≠a con estos par√°metros.`;
        } else {
            requiredYearsResult.innerHTML = `Necesitar√≠as <strong>${yearsNeeded} a√±os</strong> para alcanzar tu capital objetivo.`;
        }
        requiredYearsResult.style.display = 'block';
    });

    // --- Funcionalidad del Modal de An√°lisis de Sensibilidad ---
    const sensitivityAnalysisBtn = document.getElementById('sensitivity-analysis-btn');
    const sensitivityModal = document.getElementById('sensitivity-modal');
    const closeSensitivityModalBtn = document.getElementById('close-sensitivity-modal-btn');
    const runSensitivityAnalysisBtn = document.getElementById('run-sensitivity-analysis-btn');
    const sensitivityMessage = document.getElementById('sensitivity-message');

    // Elementos para mostrar los par√°metros base en el modal de sensibilidad
    const sensInitialCapitalEl = document.getElementById('sens-initial-capital');
    const sensPeriodicContributionEl = document.getElementById('sens-periodic-contribution');
    const sensFrequencyEl = document.getElementById('sens-frequency');
    const sensContributionMomentEl = document.getElementById('sens-contribution-moment');
    const sensYearsEl = document.getElementById('sens-years');


    sensitivityAnalysisBtn.addEventListener('click', () => {
        // Obtener los par√°metros actuales de la calculadora principal
        const initialCapital = parseFloat(document.getElementById('initial-capital').value) || 0;
        const periodicContribution = parseFloat(document.getElementById('periodic-contribution').value) || 0;
        const frequency = document.getElementById('frequency').options[document.getElementById('frequency').selectedIndex].text; // Obtener texto
        const contributionMoment = document.getElementById('contribution-moment').options[document.getElementById('contribution-moment').selectedIndex].text; // Obtener texto
        const years = parseInt(document.getElementById('years').value);

        // Actualizar los elementos en el modal de sensibilidad
        sensInitialCapitalEl.textContent = formatCurrency(initialCapital);
        sensPeriodicContributionEl.textContent = formatCurrency(periodicContribution);
        sensFrequencyEl.textContent = frequency;
        sensContributionMomentEl.textContent = contributionMoment;
        sensYearsEl.textContent = years;

        sensitivityModal.classList.add('visible');
        // Limpiar el gr√°fico anterior si existe
        if (sensitivityChartInstance) {
            sensitivityChartInstance.destroy();
        }
        sensitivityMessage.style.display = 'none'; // Ocultar mensajes anteriores
    });

    closeSensitivityModalBtn.addEventListener('click', () => {
        sensitivityModal.classList.remove('visible');
    });

    sensitivityModal.addEventListener('click', (e) => {
        if (e.target === sensitivityModal) {
            sensitivityModal.classList.remove('visible');
        }
    });

    runSensitivityAnalysisBtn.addEventListener('click', () => {
        const rateStart = parseFloat(document.getElementById('sensitivity-rate-start').value);
        const rateEnd = parseFloat(document.getElementById('sensitivity-rate-end').value);
        const rateStep = parseFloat(document.getElementById('sensitivity-rate-step').value);

        if (isNaN(rateStart) || isNaN(rateEnd) || isNaN(rateStep) || rateStep <= 0 || rateStart > rateEnd) {
            sensitivityMessage.textContent = 'Por favor, introduce valores v√°lidos para el rango y el paso de la tasa de inter√©s.';
            sensitivityMessage.style.display = 'block';
            if (sensitivityChartInstance) {
                sensitivityChartInstance.destroy();
            }
            return;
        }

        // Obtener los par√°metros actuales de la calculadora principal para el c√°lculo de sensibilidad
        const initialCapital = parseFloat(document.getElementById('initial-capital').value) || 0;
        const periodicContribution = parseFloat(document.getElementById('periodic-contribution').value) || 0;
        const frequency = parseInt(document.getElementById('frequency').value); // Usar el valor num√©rico para el c√°lculo
        const contributionMoment = document.getElementById('contribution-moment').value;
        const years = parseInt(document.getElementById('years').value);

        const labels = [];
        const data = [];

        // Iterar a trav√©s del rango de tasas de inter√©s
        for (let r = rateStart; r <= rateEnd; r += rateStep) {
            const annualInterestRate = r / 100; // Convertir a decimal
            const result = calculateCompoundInterest(initialCapital, periodicContribution, frequency, contributionMoment, annualInterestRate, years);
            labels.push(`${r.toFixed(1)}%`);
            data.push(result.finalCapital);
        }

        renderSensitivityChart(labels, data);
        sensitivityMessage.style.display = 'none'; // Ocultar mensaje si el c√°lculo es exitoso
    });

    // Funci√≥n para renderizar el gr√°fico de sensibilidad
    function renderSensitivityChart(labels, data) {
        if (sensitivityChartInstance) {
            sensitivityChartInstance.destroy();
        }
        const ctx = document.getElementById('sensitivity-chart').getContext('2d');
        sensitivityChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Capital Final (‚Ç¨)',
                    data: data,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'An√°lisis de Sensibilidad: Capital Final vs. Tasa de Inter√©s'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Capital Final: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tasa de Inter√©s Anual (%)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Capital Final (‚Ç¨)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Funcionalidad de Exportar Datos ---
    document.getElementById('export-data-btn').addEventListener('click', () => {
        const table = document.querySelector('#results-table-body');
        if (!table || table.rows.length === 0) {
            alert('No hay datos en la tabla para exportar.');
            return;
        }

        let csvContent = "A√±o;Aportaci√≥n peri√≥dica;Aportaciones acum.;Intereses;Intereses acum.;Capital total\n"; // Encabezados CSV

        // Recorrer las filas de la tabla
        Array.from(table.rows).forEach(row => {
            const rowData = [];
            Array.from(row.cells).forEach(cell => {
                // Limpiar el texto de moneda (‚Ç¨) y reemplazar comas por puntos para n√∫meros
                let cellText = cell.textContent.replace(/‚Ç¨/g, '').trim();
                cellText = cellText.replace(/\./g, ''); // Eliminar puntos de miles
                cellText = cellText.replace(/,/g, '.'); // Reemplazar coma decimal por punto
                rowData.push(cellText);
            });
            csvContent += rowData.join(";") + "\n"; // Unir celdas con punto y coma
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) { // Feature detection for download attribute
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'interes_compuesto_resultados.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert('Tu navegador no soporta la descarga directa de archivos. Por favor, copia el texto de la tabla manualmente.');
        }
    });


    // Ejecutar el c√°lculo con los valores por defecto al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.calculate-btn').click();
    });

</script>

</body>
</html>
