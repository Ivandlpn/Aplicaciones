<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Visor Alertas AEMET en LAV ESTE</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            /* --- THEME COLORS (Light Mode) --- */
            --bg-primary: #ffffff;
            --bg-secondary: #f4f7f9;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
            --adif-blue: #003057;
            --alta-velocidad-accent: #00a4e4;

            /* -- STRIKING CELL COLORS -- */
            --level-0-bg: #e9ecef; --level-0-text: #6c757d;
            --level-1-bg: linear-gradient(135deg, #29b6f6, #0288d1);
            --level-2-bg: linear-gradient(135deg, #ffca28, #ff8f00);
            --level-3-bg: linear-gradient(135deg, #ef5350, #c62828);
            
            /* -- GLOW COLORS for HOVER -- */
            --glow-level-1: rgba(2, 136, 209, 0.7);
            --glow-level-2: rgba(255, 143, 0, 0.7);
            --glow-level-3: rgba(198, 40, 40, 0.7);
        }

        body.dark-mode {
            /* --- THEME COLORS (Dark Mode) --- */
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow-color: rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; background: var(--bg-secondary); color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .app-container {
            max-width: 1100px; margin: 2rem auto; background: var(--bg-primary);
            border-radius: 16px; box-shadow: 0 8px 40px var(--shadow-color);
            overflow: hidden; transition: background-color 0.3s;
        }

        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; background: linear-gradient(90deg, #002340, #005a9e);
            color: white; border-bottom: 5px solid var(--alta-velocidad-accent);
        }
        .app-header .logo-container { display: flex; align-items: center; gap: 1rem; }
        .app-header img { max-height: 45px; width: auto; }
        .app-header .logo-adif, .app-header .logo-aemet {
            background-color: white; padding: 6px; border-radius: 6px;
            box-sizing: border-box; max-height: 55px;
        }
        .app-header h1 { font-size: 1.5rem; font-weight: 600; margin: 0; text-align: center; }

        #theme-toggle {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: background-color 0.3s;
        }
        #theme-toggle:hover { background: rgba(255,255,255,0.2); }
        #theme-toggle .fa-sun { display: none; }
        body.dark-mode #theme-toggle .fa-sun { display: block; }
        body.dark-mode #theme-toggle .fa-moon { display: none; }

        .main-content { padding: 2.5rem; }

        .input-panel {
            background-color: var(--bg-secondary); padding: 2rem; border-radius: 12px;
            border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;
        }
        .preview-instruction {
            display: flex; align-items: center; gap: 1rem; padding: 1rem; margin-bottom: 1.5rem;
            background-color: rgba(0, 164, 228, 0.1); border-left: 4px solid var(--alta-velocidad-accent);
            color: var(--text-primary); border-radius: 8px; font-weight: 500;
        }
        .preview-instruction i { font-size: 1.5rem; color: var(--alta-velocidad-accent); }
        textarea {
            width: 100%; height: 200px; margin-bottom: 1rem; padding: 1rem;
            border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box;
            font-family: 'Consolas', 'Courier New', monospace; font-size: 0.9em; resize: vertical;
            background-color: var(--bg-primary); color: var(--text-primary); transition: all 0.3s;
        }
        textarea:focus { outline: none; border-color: var(--alta-velocidad-accent); box-shadow: 0 0 8px rgba(0, 164, 228, 0.3); }
        
        .button-group { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        button {
            background: linear-gradient(45deg, var(--alta-velocidad-accent), #007bff); color: white;
            padding: 14px 30px; border: none; border-radius: 50px; cursor: pointer;
            font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4); }
        #load-example-btn { background: #6c757d; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #share-btn { background: #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); display: none; }
        #share-btn.visible { display: inline-block; }

        .visualizer > * {
            opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .visualizer.visible > * { opacity: 1; transform: translateY(0); }
        .visualizer.visible .summary-panel { transition-delay: 0s; }
        .visualizer.visible .table-container { transition-delay: 0.2s; }
        .visualizer.visible .legend-container { transition-delay: 0.4s; }

        .summary-panel {
            padding: 1.5rem 2rem; border-radius: 12px; margin: 2.5rem 0; color: white; text-align: center;
        }
        .summary-line-info {
            font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;
            padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .summary-line-info i { margin-right: 0.75rem; opacity: 0.9; }
        .summary-date { font-size: 1.1rem; font-weight: 500; opacity: 0.9; margin-bottom: 1rem; }
        .summary-main { display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 1.4rem; font-weight: 500; }
        .summary-main i { font-size: 2.2rem; }
        .summary-level-0 { background: #6c757d; }
        .summary-level-1 { background: #17a2b8; }
        .summary-level-2 { background: #ffc107; color: var(--dark-gray); }
        .summary-level-3 { background: #dc3545; }

        .table-container { overflow-x: auto; padding: 5px; }
        table { width: 100%; border-collapse: separate; border-spacing: 5px; text-align: center; table-layout: fixed; }
        
        th {
            padding: 14px 10px; background: linear-gradient(180deg, #004e89, var(--adif-blue));
            color: white; font-weight: 700; font-size: 0.95em; letter-spacing: 0.5px;
            border-radius: 8px; border-bottom: 3px solid var(--alta-velocidad-accent); vertical-align: middle;
        }
        th i { margin-right: 8px; opacity: 0.8; }
        td { padding: 10px; border-radius: 8px; transition: all 0.25s ease-in-out; }
        th:first-child, td.pk-cell { width: 100px; }
        .pk-cell { font-weight: 700; color: white; background: linear-gradient(180deg, #004e89, var(--adif-blue)); font-size: 1.1rem; border: none; }
        .alert-cell { font-weight: 600; cursor: help; position: relative; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .alert-icon { font-size: 2em; display: block; margin: 0 auto; }
        .alert-cell-content { position: relative; }
        .alert-cell span { font-size: 0.8em; opacity: 0.9; }
        
        .trend-icon { position: absolute; top: 2px; right: 5px; font-size: 0.9em; padding: 2px; border-radius: 50%; text-shadow: none; }
        .trend-up { color: #e53e3e; background: rgba(255,255,255,0.7); }
        .trend-down { color: #38a169; background: rgba(255,255,255,0.7); }
        .trend-stable { color: #718096; background: rgba(255,255,255,0.7); }
        body.dark-mode .trend-icon { background: rgba(0,0,0,0.5); }
        
        .cell-level-0 { background: var(--level-0-bg); color: var(--level-0-text); text-shadow: none; border: none; box-shadow: none; }
        .cell-level-1 { background: var(--level-1-bg); }
        .cell-level-2 { background: var(--level-2-bg); }
        .cell-level-3 { background: var(--level-3-bg); }
        
        .alert-cell:hover { transform: scale(1.05) translateY(-2px); z-index: 10; }
        .cell-level-0:hover { box-shadow: 0 0 20px rgba(0,0,0,0.15); }
        .cell-level-1:hover { box-shadow: 0 0 25px var(--glow-level-1); }
        .cell-level-2:hover { box-shadow: 0 0 25px var(--glow-level-2); }
        .cell-level-3:hover { box-shadow: 0 0 25px var(--glow-level-3); }

        .legend-container {
            margin-top: 2.5rem; display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; padding: 1.5rem;
            background-color: var(--bg-secondary); border-radius: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 10px; font-weight: 500; color: var(--text-secondary);}
        .legend-item i { font-size: 1.5rem; width: 30px; text-align: center; }
        .legend-level-1 { color: #0288d1; } .legend-level-2 { color: #ff8f00; } .legend-level-3 { color: #c62828; }
        body.dark-mode .legend-level-1 { color: #29b6f6; } body.dark-mode .legend-level-2 { color: #ffca28; } body.dark-mode .legend-level-3 { color: #ef5350; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: var(--bg-primary); color: var(--text-primary);
            padding: 2rem; border-radius: 12px; width: 90%; max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; color: var(--adif-blue); }
        body.dark-mode .modal-header h2 { color: var(--alta-velocidad-accent); }
        .modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-secondary); }
        
        .email-preview {
            border: 1px solid var(--border-color); border-radius: 8px;
            padding: 1.5rem; max-height: 40vh; overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .modal-instructions { margin-bottom: 1.5rem; line-height: 1.6; }
        .modal-instructions b { color: var(--alta-velocidad-accent); }
        .modal-actions { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; }
        .mailto-link { color: var(--text-secondary); font-size: 0.9em; }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <img src="https://www.adifaltavelocidad.es/documents/34745/2553140/Logo+Adif+AV+color.png/6fe9b0ae-618b-bc8a-405c-b296d4356994?t=1616685949205&download=true" alt="Logo ADIF AV" class="logo-adif">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Logotipo_de_la_Agencia_Estatal_de_Meteorolog%C3%ADa_%282025%29.svg/330px-Logotipo_de_la_Agencia_Estatal_de_Meteorolog%C3%ADa_%282025%29.svg.png" alt="Logo AEMET" class="logo-aemet">
            </div>
            <h1>Visor Alertas AEMET en LAV ESTE</h1>
            <button id="theme-toggle" title="Cambiar Tema"><i class="fas fa-moon"></i><i class="fas fa-sun"></i></button>
        </header>

        <main class="main-content">
            <section class="input-panel">
                <div class="preview-instruction">
                    <i class="fa-solid fa-lightbulb"></i>
                    <span>Aqu√≠ tienes una previsualizaci√≥n. <b>Pega tus datos para actualizar la vista.</b></span>
                </div>
                <textarea id="dataInput"></textarea>
                <div class="button-group">
                    <button id="load-example-btn" onclick="loadExampleData()"><i class="fa-solid fa-file-invoice"></i> Restaurar Ejemplo</button>
                    <button onclick="processData()"><i class="fa-solid fa-bolt"></i> Analizar</button>
                    <button id="share-btn" onclick="shareByEmail()"><i class="fa-solid fa-envelope"></i> Compartir</button>
                </div>
            </section>

            <section class="visualizer" id="visualizerOutput"></section>
        </main>
    </div>

    <!-- --- MODAL PARA COMPARTIR POR CORREO --- -->
    <div class="modal-overlay" id="email-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Compartir Alerta por Correo</h2>
                <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-instructions">
                <p><b>Paso 1:</b> Haz clic en el bot√≥n para copiar el informe visual.</p>
                <p><b>Paso 2:</b> Pega el contenido en tu cliente de correo (Outlook, Gmail, etc.).</p>
            </div>
            <div class="email-preview" id="email-preview-content">
                <!-- Contenido del correo generado por JS -->
            </div>
            <div class="modal-actions">
                <a href="#" id="mailto-link" class="mailto-link">Abrir correo (texto simple)</a>
                <button id="copy-email-btn" onclick="copyEmailToClipboard()"><i class="fa-solid fa-copy"></i> Copiar Contenido del Correo</button>
            </div>
        </div>
    </div>

    <script>
        const ALERT_DATA = {
            0: { desc: "Sin alerta: < 20 mm", icon: "‚òÄÔ∏è", color: "#6c757d", bgColor: "#f8f9fa" },
            1: { desc: "Nivel 1: 20-40 mm", icon: "üíß", color: "white", bgColor: "#17a2b8" },
            2: { desc: "Nivel 2: 40-80 mm", icon: "‚õàÔ∏è", color: "#212529", bgColor: "#ffc107" },
            3: { desc: "Nivel 3: > 80 mm", icon: "‚ö°Ô∏è", color: "white", bgColor: "#dc3545" }
        };
        const TREND_EMOJIS = { up: 'üîº', down: 'üîΩ', stable: '‚è∏Ô∏è' };
        
        const MONTH_NAMES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentAlertData = null; // Variable para guardar los datos procesados

        // --- Event Listeners ---
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        });
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
            loadExampleData(); // Cargar previsualizaci√≥n al inicio
        });

        function getExampleDataString() {
            return `LINEA FERROVIARIA: TORREJ√ìN DE VELASCO - VALENCIA
__________________________________________________

Predicci√≥n para el intervalo del dia 2025-09-07 a las 14:00:00 hasta el 2025-09-08 a las 14:00:00 LA PREDICCION DE ALERTAS HORARIAS ES:

PK      PCP_1   PCP_2   PCP3    PCP_4
455       0       1       1       0
460       0       2       3       1
465       1       3       2       1
470       0       1       2       2
475       0       0       1       0`;
        }
        
        function loadExampleData() {
            document.getElementById('dataInput').value = getExampleDataString();
            processData();
        }

        function processData() {
            const dataInput = document.getElementById('dataInput').value;
            const outputDiv = document.getElementById('visualizerOutput');
            
            outputDiv.innerHTML = '';
            outputDiv.classList.remove('visible');

            const lines = dataInput.trim().split('\n');
            let railwayLine = 'L√≠nea no especificada', 
                dataLines = [], headerFound = false, maxAlertLevel = 0;
            let predictionDate = null, startDate = null;

            for (const line of lines) {
                if (line.includes('LINEA FERROVIARIA:')) {
                    railwayLine = line.split(':')[1].trim();
                } else if (line.includes('Predicci√≥n')) {
                    const dateMatch = line.match(/del dia (\d{4}-\d{2}-\d{2}) a las (\d{2}:\d{2}:\d{2})/);
                    if(dateMatch) {
                        startDate = new Date(`${dateMatch[1]}T${dateMatch[2]}`);
                        predictionDate = new Date(dateMatch[1]);
                    }
                } else if (line.includes('PK')) {
                    headerFound = true;
                } else if (headerFound && line.trim() !== '' && !line.startsWith('_')) {
                    dataLines.push(line);
                    const parts = line.trim().split(/\s+/).slice(1).map(Number);
                    const currentMax = Math.max(...parts);
                    if (currentMax > maxAlertLevel) maxAlertLevel = currentMax;
                }
            }
            
            if (dataLines.length === 0) {
                 outputDiv.innerHTML = `<p style="color: red; text-align: center; font-size: 1.2rem;">No se encontraron datos de precipitaci√≥n v√°lidos.</p>`;
                 document.getElementById('share-btn').classList.remove('visible');
                 currentAlertData = null;
                 setTimeout(() => outputDiv.classList.add('visible'), 10);
                 return;
            }
            
            // Guardar datos procesados para el correo
            currentAlertData = { railwayLine, predictionDate, maxAlertLevel, startDate, dataLines };
            
            const formattedDate = predictionDate ? `Predicci√≥n para el ${predictionDate.getUTCDate()} de ${MONTH_NAMES[predictionDate.getUTCMonth()]} de ${predictionDate.getUTCFullYear()}` : '';
            
            const summaryData = ALERT_DATA[maxAlertLevel];
            const summaryHTML = `
                <div class="summary-panel summary-level-${maxAlertLevel}">
                    <div>
                        <div class="summary-line-info"><i class="fa-solid fa-train-subway"></i><span>${railwayLine}</span></div>
                        <div class="summary-date">${formattedDate}</div>
                        <div class="summary-main"><i class="fa-solid ${summaryData.icon.replace('fa-', '')}"></i><span>Alerta M√°xima: ${summaryData.desc}</span></div>
                    </div>
                </div>`;

            let tableHTML = '';
            if (startDate) {
                let tableHead = `<thead><tr><th><i class="fa-solid fa-road"></i> PK</th>`;
                let intervalStart = new Date(startDate.getTime());
                for (let i = 0; i < 4; i++) {
                    const intervalEnd = new Date(intervalStart.getTime() + 6 * 3600000);
                    tableHead += `<th><i class="fa-regular fa-clock"></i> ${intervalStart.getHours().toString().padStart(2, '0')}:00 - ${intervalEnd.getHours().toString().padStart(2, '0')}:00</th>`;
                    intervalStart = intervalEnd;
                }
                tableHead += `</tr></thead>`;

                let tableBody = `<tbody>`;
                dataLines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    const pk = parts[0];
                    const pcps = parts.slice(1).map(Number);
                    tableBody += `<tr><td class="pk-cell">${pk}</td>`;
                    pcps.forEach((level, index) => {
                        const levelData = ALERT_DATA[level] || { desc: 'N/A', icon: 'fa-question-circle' };
                        let trendIcon = '';
                        if (index > 0) {
                            const prevLevel = pcps[index-1];
                            if (level > prevLevel) trendIcon = `<i class="fas fa-arrow-up trend-icon trend-up" title="Riesgo en aumento"></i>`;
                            else if (level < prevLevel) trendIcon = `<i class="fas fa-arrow-down trend-icon trend-down" title="Riesgo en descenso"></i>`;
                            else trendIcon = `<i class="fas fa-equals trend-icon trend-stable" title="Riesgo estable"></i>`;
                        }
                        
                        tableBody += `
                            <td class="alert-cell cell-level-${level}" title="${levelData.desc}">
                                <div class="alert-cell-content">
                                    ${trendIcon}
                                    <i class="alert-icon fa-solid fa-${levelData.icon}"></i>
                                    <span>Nivel ${level}</span>
                                </div>
                            </td>`;
                    });
                    tableBody += `</tr>`;
                });
                tableBody += `</tbody>`;
                tableHTML = `<div class="table-container"><table>${tableHead}${tableBody}</table></div>`;
            }

            const legendHTML = `
                <div class="legend-container">
                    ${Object.entries(ALERT_DATA).map(([level, data]) => `
                        <div class="legend-item legend-level-${level}">
                            <i class="fa-solid fa-${data.icon}"></i>
                            <span>${data.desc}</span>
                        </div>
                    `).join('')}
                </div>`;
            
            outputDiv.innerHTML = summaryHTML + tableHTML + legendHTML;
            document.getElementById('share-btn').classList.add('visible');
            setTimeout(() => outputDiv.classList.add('visible'), 10);
        }

        // --- EMAIL SHARING LOGIC ---
        function closeModal() {
            document.getElementById('email-modal').classList.remove('visible');
        }

        function shareByEmail() {
            if (!currentAlertData) return;
            
            const emailHTML = generateEmailHTML(currentAlertData);
            document.getElementById('email-preview-content').innerHTML = emailHTML;
            
            const emailPlainText = generateEmailPlainText(currentAlertData);
            const mailtoLink = document.getElementById('mailto-link');
            const subject = `Informe de Alertas AEMET para ${currentAlertData.railwayLine}`;
            mailtoLink.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailPlainText)}`;

            document.getElementById('email-modal').classList.add('visible');
        }

        function copyEmailToClipboard() {
            const content = document.getElementById('email-preview-content');
            const blob = new Blob([content.innerHTML], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem]).then(() => {
                const btn = document.getElementById('copy-email-btn');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> ¬°Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copiar Contenido del Correo';
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar al portapapeles:', err);
                alert('No se pudo copiar el contenido.');
            });
        }

        function generateEmailHTML(data) {
            const summaryData = ALERT_DATA[data.maxAlertLevel];
            const formattedDate = data.predictionDate ? `Predicci√≥n para el ${data.predictionDate.getUTCDate()} de ${MONTH_NAMES[data.predictionDate.getUTCMonth()]} de ${data.predictionDate.getUTCFullYear()}` : '';

            let head = `<thead style="font-family: Arial, sans-serif; color: white;"><tr><th style="padding: 12px; background-color: #003057; border-radius: 8px 0 0 0;">üõ§Ô∏è PK</th>`;
            let intervalStart = new Date(data.startDate.getTime());
            for (let i = 0; i < 4; i++) {
                const end = new Date(intervalStart.getTime() + 6 * 3600000);
                head += `<th style="padding: 12px; background-color: #003057;">üóìÔ∏è ${intervalStart.getHours().toString().padStart(2, '0')}:00 - ${end.getHours().toString().padStart(2, '0')}:00</th>`;
                intervalStart = end;
            }
            head += `</tr></thead>`;

            let body = `<tbody>`;
            data.dataLines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                const pk = parts[0];
                const pcps = parts.slice(1).map(Number);
                body += `<tr><td style="padding: 12px; background-color: #003057; color: white; font-weight: bold;">${pk}</td>`;
                pcps.forEach((level, index) => {
                    const levelData = ALERT_DATA[level];
                    let trendEmoji = '';
                    if (index > 0) {
                        const prevLevel = pcps[index-1];
                        if (level > prevLevel) trendEmoji = TREND_EMOJIS.up;
                        else if (level < prevLevel) trendEmoji = TREND_EMOJIS.down;
                        else trendEmoji = TREND_EMOJIS.stable;
                    }
                    body += `<td style="padding: 12px; text-align: center; background-color: ${levelData.bgColor}; color: ${levelData.color};">
                                <div style="font-size: 24px;">${levelData.icon} ${trendEmoji}</div>
                                <div style="font-size: 12px;">Nivel ${level}</div>
                             </td>`;
                });
                body += `</tr>`;
            });
            body += `</tbody>`;

            return `
            <div style="font-family: Arial, sans-serif; color: #333;">
                <h2 style="color: #003057; border-bottom: 2px solid #00a4e4; padding-bottom: 10px;">üöÇ Informe de Alertas: ${data.railwayLine}</h2>
                <p style="font-size: 16px; margin-bottom: 20px;">${formattedDate}</p>
                <div style="padding: 15px; border-radius: 8px; color: ${summaryData.color}; background-color: ${summaryData.bgColor}; font-size: 18px; text-align: center; margin-bottom: 20px;">
                    <b>Alerta M√°xima:</b> ${summaryData.icon} ${summaryData.desc}
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    ${head}${body}
                </table>
            </div>`;
        }

        function generateEmailPlainText(data) {
            const summaryData = ALERT_DATA[data.maxAlertLevel];
            const formattedDate = data.predictionDate ? `Predicci√≥n para el ${data.predictionDate.getUTCDate()} de ${MONTH_NAMES[data.predictionDate.getUTCMonth()]} de ${data.predictionDate.getUTCFullYear()}` : '';
            
            let text = `INFORME DE ALERTAS AEMET\n`;
            text += `====================================\n\n`;
            text += `üöÇ L√çNEA FERROVIARIA: ${data.railwayLine}\n`;
            text += `üóìÔ∏è FECHA: ${formattedDate}\n\n`;
            text += `ALERTA M√ÅXIMA: ${summaryData.icon} ${summaryData.desc}\n\n`;
            text += `DETALLE DE LA PREDICCI√ìN:\n`;
            
            data.dataLines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                const pk = parts[0];
                const pcps = parts.slice(1).map(Number);
                text += `\nPK ${pk}:\n`;
                let intervalStart = new Date(data.startDate.getTime());
                pcps.forEach(level => {
                    const end = new Date(intervalStart.getTime() + 6 * 3600000);
                    text += `  - De ${intervalStart.getHours()}:00 a ${end.getHours()}:00 -> Nivel ${level} (${ALERT_DATA[level].icon})\n`;
                    intervalStart = end;
                });
            });
            
            return text;
        }

    </script>
</body>
</html>```
